<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü - ÊúçËñ¨ÁÆ°ÁêÜ„Ç¢„Éó„É™</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234CAF50'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3Eüíä%3C/text%3E%3C/svg%3E">
    <script src="api-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding-bottom: 70px;
        }
        
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        
        .tab.active {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .medication-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .medication-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .medication-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .take-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        .take-button:hover {
            background-color: #45a049;
        }
        
        .take-button.taken {
            background-color: #ddd;
            color: #666;
            cursor: not-allowed;
        }
        
        .add-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .save-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .cancel-button {
            background-color: #f44336;
            color: white;
        }
        
        .history-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-date {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-meds {
            color: #666;
            font-size: 14px;
        }
        
        .stock-warning {
            background-color: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .camera-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            width: 100%;
        }
        
        .camera-modal .modal-content {
            max-width: 500px;
        }
        
        .camera-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .camera-video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-canvas {
            display: none;
        }
        
        .captured-image {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .camera-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .capture-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .retake-button {
            background-color: #ff9800;
            color: white;
        }
        
        .analysis-result {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .success-message {
            background-color: #4CAF50;
            color: white;
        }
        
        .warning-message {
            background-color: #ff9800;
            color: white;
        }
        
        .settings-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .settings-section h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .settings-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .time-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .missed-dose-card {
            background: #fff3cd;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .missed-dose-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: #856404;
        }
        
        .missed-dose-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .missed-dose-title {
            font-size: 16px;
            font-weight: bold;
        }
        
        .missed-dose-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .edit-modal .modal-content {
            max-width: 400px;
        }
        
        .medication-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .medication-actions button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .edit-button {
            background-color: #2196F3;
            color: white;
        }
        
        .delete-button {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü</h1>
    </div>
    
    <div class="container">
        <!-- ÊúçÁî®ÁîªÈù¢ -->
        <div id="home-page" class="page active">
            <div id="stock-warnings"></div>
            <h2>‰ªäÊó•„ÅÆÊúçËñ¨</h2>
            <div id="today-medications"></div>
        </div>
        
        <!-- Ëñ¨ÁÆ±ÁîªÈù¢ -->
        <div id="medications-page" class="page">
            <h2>Ëñ¨ÁÆ±</h2>
            <div id="medications-list"></div>
        </div>
        
        <!-- Â±•Ê≠¥ÁîªÈù¢ -->
        <div id="history-page" class="page">
            <h2>ÊúçËñ¨Â±•Ê≠¥</h2>
            <div id="history-list"></div>
        </div>
        
        <!-- Ë®≠ÂÆöÁîªÈù¢ -->
        <div id="settings-page" class="page">
            <h2>Ë®≠ÂÆö</h2>
            <div class="settings-section">
                <h3>ÊúçÁî®ÊôÇÈñìË®≠ÂÆö</h3>
                <p class="settings-description">ÂêÑÊúçÁî®„Çø„Ç§„Éü„É≥„Ç∞„ÅÆÊôÇÈñì„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <div class="form-group">
                    <label for="morning-time">ÊúùÈ£üÂæå</label>
                    <input type="time" id="morning-time" class="time-input" value="08:30">
                </div>
                <div class="form-group">
                    <label for="lunch-time">ÊòºÈ£üÂæå</label>
                    <input type="time" id="lunch-time" class="time-input" value="12:30">
                </div>
                <div class="form-group">
                    <label for="dinner-time">Â§ïÈ£üÂæå</label>
                    <input type="time" id="dinner-time" class="time-input" value="19:30">
                </div>
                <div class="form-group">
                    <label for="bedtime-time">Â∞±ÂØùÂâç</label>
                    <input type="time" id="bedtime-time" class="time-input" value="22:00">
                </div>
                <button class="save-button" onclick="saveTimeSettings()">ÊôÇÈñìË®≠ÂÆö„Çí‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- „Çø„Éñ„Éê„Éº -->
    <div class="tab-bar">
        <button class="tab active" onclick="showPage('home')">
            <div>üíä</div>
            <div>ÊúçÁî®</div>
        </button>
        <button class="tab" onclick="showPage('medications')">
            <div>üè´</div>
            <div>Ëñ¨ÁÆ±</div>
        </button>
        <button class="tab" onclick="showPage('history')">
            <div>üìä</div>
            <div>Â±•Ê≠¥</div>
        </button>
        <button class="tab" onclick="showPage('settings')">
            <div>‚öôÔ∏è</div>
            <div>Ë®≠ÂÆö</div>
        </button>
    </div>
    
    <!-- ËøΩÂä†„Éú„Çø„É≥ -->
    <button class="add-button" onclick="showAddModal()">+</button>
    
    <!-- Ëñ¨ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3>Êñ∞„Åó„ÅÑËñ¨„ÇíËøΩÂä†</h3>
            <form id="add-medication-form">
                <div class="form-group">
                    <label for="med-name">Ëñ¨„ÅÆÂêçÂâç</label>
                    <input type="text" id="med-name" required>
                </div>
                <div class="form-group">
                    <label for="med-dosage">Áî®ÈáèÔºà1Âõû„ÅÇ„Åü„ÇäÔºâ</label>
                    <input type="text" id="med-dosage" placeholder="‰æã: 1Èå†, 2ÂåÖ" required>
                </div>
                <div class="form-group">
                    <label for="med-frequency">ÊúçÁî®È†ªÂ∫¶</label>
                    <select id="med-frequency" required>
                        <option value="ÊØéÈ£üÂæå">ÊØéÈ£üÂæå</option>
                        <option value="ÊúùÈ£üÂæå">ÊúùÈ£üÂæå</option>
                        <option value="ÊòºÈ£üÂæå">ÊòºÈ£üÂæå</option>
                        <option value="Â§ïÈ£üÂæå">Â§ïÈ£üÂæå</option>
                        <option value="ÊúùÂ§ïÈ£üÂæå">ÊúùÂ§ïÈ£üÂæå</option>
                        <option value="Â∞±ÂØùÂâç">Â∞±ÂØùÂâç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="med-stock">ÁèæÂú®„ÅÆÂú®Â∫´Êï∞</label>
                    <input type="number" id="med-stock" required>
                </div>
                <div class="form-group">
                    <label for="med-purpose">Áî®ÈÄî</label>
                    <select id="med-purpose" onchange="toggleCustomPurpose()">
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="È†≠Áóõ„Çí„ÇÑ„Çè„Çâ„Åí„Çã">È†≠Áóõ„Çí„ÇÑ„Çè„Çâ„Åí„Çã</option>
                        <option value="Áóõ„ÅøÊ≠¢„ÇÅ">Áóõ„ÅøÊ≠¢„ÇÅ</option>
                        <option value="Âí≥Ê≠¢„ÇÅ">Âí≥Ê≠¢„ÇÅ</option>
                        <option value="Ëß£ÁÜ±">Ëß£ÁÜ±</option>
                        <option value="ËÉÉËÖ∏Ëñ¨">ËÉÉËÖ∏Ëñ¨</option>
                        <option value="„Ç¢„É¨„É´„ÇÆ„Éº">„Ç¢„É¨„É´„ÇÆ„Éº</option>
                        <option value="È´òË°ÄÂúß">È´òË°ÄÂúß</option>
                        <option value="Á≥ñÂ∞øÁóÖ">Á≥ñÂ∞øÁóÖ</option>
                        <option value="È™®Á≤óÊùæÁóá">È™®Á≤óÊùæÁóá</option>
                        <option value="„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà">„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà</option>
                        <option value="other">„Åù„ÅÆ‰ªñ</option>
                    </select>
                    <input type="text" id="med-purpose-custom" placeholder="Áî®ÈÄî„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" style="display:none; margin-top: 10px;">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="save-button">‰øùÂ≠ò</button>
                    <button type="button" class="cancel-button" onclick="hideAddModal()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Ëñ¨Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="edit-modal" class="modal edit-modal">
        <div class="modal-content">
            <h3>Ëñ¨ÊÉÖÂ†±„ÇíÁ∑®ÈõÜ</h3>
            <form id="edit-medication-form">
                <input type="hidden" id="edit-med-id">
                <div class="form-group">
                    <label for="edit-med-name">Ëñ¨„ÅÆÂêçÂâç</label>
                    <input type="text" id="edit-med-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-med-dosage">Áî®ÈáèÔºà1Âõû„ÅÇ„Åü„ÇäÔºâ</label>
                    <input type="text" id="edit-med-dosage" placeholder="‰æã: 1Èå†, 2ÂåÖ" required>
                </div>
                <div class="form-group">
                    <label for="edit-med-frequency">ÊúçÁî®È†ªÂ∫¶</label>
                    <select id="edit-med-frequency" required>
                        <option value="ÊØéÈ£üÂæå">ÊØéÈ£üÂæå</option>
                        <option value="ÊúùÈ£üÂæå">ÊúùÈ£üÂæå</option>
                        <option value="ÊòºÈ£üÂæå">ÊòºÈ£üÂæå</option>
                        <option value="Â§ïÈ£üÂæå">Â§ïÈ£üÂæå</option>
                        <option value="ÊúùÂ§ïÈ£üÂæå">ÊúùÂ§ïÈ£üÂæå</option>
                        <option value="Â∞±ÂØùÂâç">Â∞±ÂØùÂâç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-med-stock">ÁèæÂú®„ÅÆÂú®Â∫´Êï∞</label>
                    <input type="number" id="edit-med-stock" required>
                </div>
                <div class="form-group">
                    <label for="edit-med-purpose">Áî®ÈÄî</label>
                    <select id="edit-med-purpose" onchange="toggleEditCustomPurpose()">
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="È†≠Áóõ„Çí„ÇÑ„Çè„Çâ„Åí„Çã">È†≠Áóõ„Çí„ÇÑ„Çè„Çâ„Åí„Çã</option>
                        <option value="Áóõ„ÅøÊ≠¢„ÇÅ">Áóõ„ÅøÊ≠¢„ÇÅ</option>
                        <option value="Âí≥Ê≠¢„ÇÅ">Âí≥Ê≠¢„ÇÅ</option>
                        <option value="Ëß£ÁÜ±">Ëß£ÁÜ±</option>
                        <option value="ËÉÉËÖ∏Ëñ¨">ËÉÉËÖ∏Ëñ¨</option>
                        <option value="„Ç¢„É¨„É´„ÇÆ„Éº">„Ç¢„É¨„É´„ÇÆ„Éº</option>
                        <option value="È´òË°ÄÂúß">È´òË°ÄÂúß</option>
                        <option value="Á≥ñÂ∞øÁóÖ">Á≥ñÂ∞øÁóÖ</option>
                        <option value="È™®Á≤óÊùæÁóá">È™®Á≤óÊùæÁóá</option>
                        <option value="„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà">„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà</option>
                        <option value="other">„Åù„ÅÆ‰ªñ</option>
                    </select>
                    <input type="text" id="edit-med-purpose-custom" placeholder="Áî®ÈÄî„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" style="display:none; margin-top: 10px;">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="save-button">‰øùÂ≠ò</button>
                    <button type="button" class="cancel-button" onclick="hideEditModal()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- „Ç´„É°„É©„É¢„Éº„ÉÄ„É´ -->
    <div id="camera-modal" class="modal camera-modal">
        <div class="modal-content">
            <h3>Á©∫„ÅÆËñ¨„Ç∑„Éº„Éà„ÇíÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
            <div class="camera-container">
                <video id="camera-video" class="camera-video" autoplay></video>
                <canvas id="camera-canvas" class="camera-canvas"></canvas>
                <img id="captured-image" class="captured-image" style="display: none;">
                
                <div class="camera-controls">
                    <button id="capture-btn" class="capture-button" onclick="capturePhoto()">üì∑ ÊíÆÂΩ±</button>
                    <button id="retake-btn" class="retake-button" onclick="retakePhoto()" style="display: none;">üîÑ ÊíÆ„ÇäÁõ¥„Åó</button>
                </div>
                
                <div id="analysis-result" class="analysis-result" style="display: none;"></div>
            </div>
            
            <div class="form-buttons">
                <button id="confirm-btn" class="save-button" onclick="confirmMedication()" style="display: none;">ÊúçÁî®„ÇíÁ¢∫Ë™ç</button>
                <button class="cancel-button" onclick="hideCameraModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>
    
    <script>
        // „Éá„Éº„ÇøÁÆ°ÁêÜ
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        
        // ÊúçÁî®ÊôÇÈñìË®≠ÂÆö„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§
        const defaultTimeSettings = {
            morning: '08:30',
            lunch: '12:30',
            dinner: '19:30',
            bedtime: '22:00'
        };
        
        // ‰øùÂ≠ò„Åï„Çå„ÅüÊôÇÈñìË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        let timeSettings = JSON.parse(localStorage.getItem('timeSettings')) || defaultTimeSettings;
        
        // Ë®≠ÂÆöÁîªÈù¢„ÇíÊõ¥Êñ∞
        function updateSettingsPage() {
            document.getElementById('morning-time').value = timeSettings.morning;
            document.getElementById('lunch-time').value = timeSettings.lunch;
            document.getElementById('dinner-time').value = timeSettings.dinner;
            document.getElementById('bedtime-time').value = timeSettings.bedtime;
        }
        
        // ÊôÇÈñìË®≠ÂÆö„Çí‰øùÂ≠ò
        function saveTimeSettings() {
            timeSettings = {
                morning: document.getElementById('morning-time').value,
                lunch: document.getElementById('lunch-time').value,
                dinner: document.getElementById('dinner-time').value,
                bedtime: document.getElementById('bedtime-time').value
            };
            
            localStorage.setItem('timeSettings', JSON.stringify(timeSettings));
            alert('‚úÖ ÊúçÁî®ÊôÇÈñìË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            
            // ÈÄöÁü•„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂÜçË®≠ÂÆö
            medications.forEach(medication => {
                setMedicationReminders(medication);
            });
        }
        
        // „Ç´„É°„É©Èñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let currentMedId = null;
        let currentMealTime = null;
        let cameraStream = null;
        
        // „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà
        function showPage(pageName) {
            // „Åô„Åπ„Å¶„ÅÆ„Éö„Éº„Ç∏„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éö„Éº„Ç∏„ÇíË°®Á§∫
            document.getElementById(pageName + '-page').classList.add('active');
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
            event.target.closest('.tab').classList.add('active');
            
            // „Éö„Éº„Ç∏„Å´Âøú„Åò„Å¶„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            if (pageName === 'home') {
                updateTodayMedications();
                checkStockWarnings();
            } else if (pageName === 'medications') {
                updateMedicationsList();
            } else if (pageName === 'history') {
                updateHistoryList();
            } else if (pageName === 'settings') {
                updateSettingsPage();
            }
        }
        
        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫/ÈùûË°®Á§∫
        function showAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }
        
        function hideAddModal() {
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('add-medication-form').reset();
        }
        
        // Ëñ¨„ÅÆËøΩÂä†
        document.getElementById('add-medication-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const medication = {
                id: Date.now(),
                name: document.getElementById('med-name').value,
                dosage: document.getElementById('med-dosage').value,
                frequency: document.getElementById('med-frequency').value,
                stock: parseInt(document.getElementById('med-stock').value),
                purpose: getPurposeValue(),
                createdAt: new Date().toISOString()
            };
            
            medications.push(medication);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            hideAddModal();
            showPage('medications');
            
            // ÈÄöÁü•„ÅÆË®≠ÂÆöÔºàÂæå„ÅßÂÆüË£ÖÔºâ
            scheduleNotifications(medication);
        });
        
        // ‰ªäÊó•„ÅÆÊúçËñ¨„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateTodayMedications() {
            const container = document.getElementById('today-medications');
            container.innerHTML = '';
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // Ë®≠ÂÆö„Åï„Çå„ÅüÊôÇÈñì„Åã„ÇâÁèæÂú®„ÅÆÊúçÁî®„Çø„Ç§„Éü„É≥„Ç∞„ÇíÂà§ÂÆö
            const timeToMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            
            const morningMinutes = timeToMinutes(timeSettings.morning);
            const lunchMinutes = timeToMinutes(timeSettings.lunch);
            const dinnerMinutes = timeToMinutes(timeSettings.dinner);
            const bedtimeMinutes = timeToMinutes(timeSettings.bedtime);
            
            let mealTime = '';
            if (currentTime >= morningMinutes - 60 && currentTime < lunchMinutes - 60) {
                mealTime = 'ÊúùÈ£üÂæå';
            } else if (currentTime >= lunchMinutes - 60 && currentTime < dinnerMinutes - 60) {
                mealTime = 'ÊòºÈ£üÂæå';
            } else if (currentTime >= dinnerMinutes - 60 && currentTime < bedtimeMinutes - 60) {
                mealTime = 'Â§ïÈ£üÂæå';
            } else if (currentTime >= bedtimeMinutes - 60 || currentTime < morningMinutes - 60) {
                mealTime = 'Â∞±ÂØùÂâç';
            }
            
            // È£≤„ÅøÂøò„Çå„ÉÅ„Çß„ÉÉ„ÇØÔºàÂêÑÊúçÁî®„Çø„Ç§„Éü„É≥„Ç∞„ÅÆ1ÊôÇÈñìÂæå„Åã„Çâ„ÉÅ„Çß„ÉÉ„ÇØÔºâ
            const missedDoses = [];
            const checkMissedDose = (timing, settingKey) => {
                const targetTime = timeToMinutes(timeSettings[settingKey]);
                const timeSinceDose = currentTime - targetTime;
                
                if (timeSinceDose > 60 && timeSinceDose < 240) { // 1ÊôÇÈñìÂæå„Åã„Çâ4ÊôÇÈñì‰ª•ÂÜÖ
                    medications.forEach(med => {
                        const shouldTake = med.frequency === 'ÊØéÈ£üÂæå' || 
                                         med.frequency === timing ||
                                         (med.frequency === 'ÊúùÂ§ïÈ£üÂæå' && (timing === 'ÊúùÈ£üÂæå' || timing === 'Â§ïÈ£üÂæå'));
                        
                        if (shouldTake && !isTakenToday(med.id, timing)) {
                            missedDoses.push({
                                medication: med,
                                timing: timing,
                                missedTime: timeSettings[settingKey]
                            });
                        }
                    });
                }
            };
            
            // ‰ªäÊó•„ÅÆÈ£≤„ÅøÂøò„Çå„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const todayDate = now.toDateString();
            const checkTiming = (timing, settingKey) => {
                const targetMinutes = timeToMinutes(timeSettings[settingKey]);
                // ‰ªäÊó•„ÅÆ„Åù„ÅÆÊôÇÈñì„Åå„Åô„Åß„Å´ÈÅé„Åé„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (currentTime > targetMinutes) {
                    checkMissedDose(timing, settingKey);
                }
            };
            
            checkTiming('ÊúùÈ£üÂæå', 'morning');
            checkTiming('ÊòºÈ£üÂæå', 'lunch');
            checkTiming('Â§ïÈ£üÂæå', 'dinner');
            checkTiming('Â∞±ÂØùÂâç', 'bedtime');
            
            // È£≤„ÅøÂøò„Çå„Ç´„Éº„Éâ„ÇíË°®Á§∫
            missedDoses.forEach(missed => {
                const card = document.createElement('div');
                card.className = 'missed-dose-card';
                card.innerHTML = `
                    <div class="missed-dose-header">
                        <div class="missed-dose-icon">‚ö†Ô∏è</div>
                        <div class="missed-dose-title">${missed.medication.name}„ÅÆÊúçÁî®„ÇíÂøò„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÅãÔºü</div>
                    </div>
                    <div class="missed-dose-info">
                        ${missed.timing} (${missed.missedTime}) - ${missed.medication.dosage}
                    </div>
                    <button class="take-button" onclick="takeMedication(${missed.medication.id}, '${missed.timing}')"
                            ${isTakenToday(missed.medication.id, missed.timing) ? 'disabled' : ''}>
                        ${isTakenToday(missed.medication.id, missed.timing) ? '‚úì ÊúçÁî®Ê∏à„Åø' : '‰ªäÊúçÁî®„Åô„Çã'}
                    </button>
                    ${!isTakenToday(missed.medication.id, missed.timing) ? 
                        `<button class="camera-button" onclick="showCameraModal(${missed.medication.id}, '${missed.timing}')">üì∏ ÂÜôÁúü„ÅßÁ¢∫Ë™ç</button>` : ''}
                `;
                container.appendChild(card);
            });
            
            // ÁèæÂú®„ÅÆÊôÇÈñìÂ∏Ø„ÅÆÊúçËñ¨
            const todayMeds = medications.filter(med => {
                return med.frequency === 'ÊØéÈ£üÂæå' || 
                       med.frequency === mealTime ||
                       (med.frequency === 'ÊúùÂ§ïÈ£üÂæå' && (mealTime === 'ÊúùÈ£üÂæå' || mealTime === 'Â§ïÈ£üÂæå'));
            });
            
            if (todayMeds.length === 0 && missedDoses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÁèæÂú®ÊúçÁî®„Åô„ÇãËñ¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            todayMeds.forEach(med => {
                const taken = isTakenToday(med.id, mealTime);
                const card = document.createElement('div');
                card.className = 'medication-card';
                card.innerHTML = `
                    <div class="medication-name">${med.name}</div>
                    <div class="medication-info">${med.dosage} - ${med.frequency}</div>
                    <div class="medication-info">Âú®Â∫´: ${med.stock}ÂÄã</div>
                    <button class="take-button ${taken ? 'taken' : ''}" 
                            onclick="takeMedication(${med.id}, '${mealTime}')"
                            ${taken ? 'disabled' : ''}>
                        ${taken ? '‚úì ÊúçÁî®Ê∏à„Åø' : 'ÊúçÁî®„Åô„Çã'}
                    </button>
                    ${!taken ? `<button class="camera-button" onclick="showCameraModal(${med.id}, '${mealTime}')">üì∏ ÂÜôÁúü„ÅßÁ¢∫Ë™ç</button>` : ''}
                    ${taken ? `<button class="cancel-button" onclick="undoMedication(${med.id}, '${mealTime}')" style="margin-top: 5px; width: 100%; padding: 8px; font-size: 14px;">üîÑ Âèñ„ÇäÊ∂à„Åó</button>` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        // Ëñ¨„ÇíÊúçÁî®
        function takeMedication(medId, mealTime) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            // Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
            med.stock -= 1;
            localStorage.setItem('medications', JSON.stringify(medications));
            
            // Â±•Ê≠¥„Å´ËøΩÂä†
            const historyItem = {
                medicationId: medId,
                medicationName: med.name,
                dosage: med.dosage,
                takenAt: new Date().toISOString(),
                mealTime: mealTime
            };
            history.push(historyItem);
            localStorage.setItem('history', JSON.stringify(history));
            
            // UI„ÇíÊõ¥Êñ∞
            updateTodayMedications();
            checkStockWarnings();
        }
        
        // ‰ªäÊó•ÊúçÁî®Ê∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isTakenToday(medId, mealTime) {
            const today = new Date().toDateString();
            return history.some(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled; // Âèñ„ÇäÊ∂à„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ±•Ê≠¥„ÅÆ„Åø
            });
        }
        
        // ÊúçÁî®Ë®òÈå≤„ÅÆÂèñ„ÇäÊ∂à„ÅóÔºà„Éõ„Éº„É†ÁîªÈù¢„Åã„ÇâÔºâ
        function undoMedication(medId, mealTime) {
            if (!confirm('ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºüÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            const today = new Date().toDateString();
            const historyItem = history.find(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled;
            });
            
            if (historyItem) {
                // Â±•Ê≠¥„ÇíÂèñ„ÇäÊ∂à„ÅóÊ∏à„Åø„Å´„Éû„Éº„ÇØ
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // Âú®Â∫´„ÇíÊàª„Åô
                const med = medications.find(m => m.id === medId);
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                checkStockWarnings();
                
                alert('‚úÖ ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü„ÄÇÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // Â±•Ê≠¥„Åã„Çâ„ÅÆÂèñ„ÇäÊ∂à„Åó
        function undoHistoryItem(medId, takenAt, mealTime) {
            if (!confirm('„Åì„ÅÆÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºüÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            const historyItem = history.find(h => 
                h.medicationId === medId && 
                h.takenAt === takenAt && 
                h.mealTime === mealTime &&
                !h.cancelled
            );
            
            if (historyItem) {
                // Â±•Ê≠¥„ÇíÂèñ„ÇäÊ∂à„ÅóÊ∏à„Åø„Å´„Éû„Éº„ÇØ
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // Âú®Â∫´„ÇíÊàª„Åô
                const med = medications.find(m => m.id === parseInt(medId));
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                updateHistoryList();
                checkStockWarnings();
                
                alert('‚úÖ ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü„ÄÇÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // Âú®Â∫´Ë≠¶Âëä„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkStockWarnings() {
            const container = document.getElementById('stock-warnings');
            container.innerHTML = '';
            
            const warnings = medications.filter(med => med.stock < 7);
            if (warnings.length > 0) {
                warnings.forEach(med => {
                    const warning = document.createElement('div');
                    warning.className = 'stock-warning';
                    warning.textContent = `‚ö†Ô∏è ${med.name}„ÅÆÂú®Â∫´„ÅåÊÆã„Çä${med.stock}ÂÄã„Åß„Åô„ÄÇÈÄöÈô¢„Çí„ÅäÂøò„Çå„Å™„ÅèÔºÅ`;
                    container.appendChild(warning);
                });
            }
        }
        
        // Ëñ¨„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateMedicationsList() {
            const container = document.getElementById('medications-list');
            container.innerHTML = '';
            
            if (medications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ëñ¨„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }
            
            medications.forEach(med => {
                const card = document.createElement('div');
                card.className = 'medication-card';
                card.innerHTML = `
                    <div class="medication-name">${med.name}</div>
                    <div class="medication-info">${med.dosage} - ${med.frequency}</div>
                    <div class="medication-info">Âú®Â∫´: ${med.stock}ÂÄã</div>
                    ${med.purpose ? `<div class="medication-info">Áî®ÈÄî: ${med.purpose}</div>` : ''}
                    <div class="medication-actions">
                        <button class="edit-button" onclick="showEditModal(${med.id})">üìù Á∑®ÈõÜ</button>
                        <button class="delete-button" onclick="deleteMedication(${med.id})">üóëÔ∏è ÂâäÈô§</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
        function updateHistoryList() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÊúçËñ¨Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // Âèñ„ÇäÊ∂à„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ±•Ê≠¥„ÅÆ„ÅøË°®Á§∫
            const activeHistory = history.filter(h => !h.cancelled);
            
            if (activeHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÊúçËñ¨Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // Êó•‰ªò„Åß„Ç∞„É´„Éº„ÉóÂåñ
            const groupedHistory = {};
            activeHistory.slice().reverse().forEach(h => {
                const date = new Date(h.takenAt).toLocaleDateString('ja-JP');
                if (!groupedHistory[date]) {
                    groupedHistory[date] = [];
                }
                groupedHistory[date].push(h);
            });
            
            Object.entries(groupedHistory).forEach(([date, items]) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-meds">
                        ${items.map(item => {
                            const photoIcon = item.photoVerified ? 'üì∏' : '';
                            const time = new Date(item.takenAt).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <span>${photoIcon} ${item.medicationName} (${item.mealTime}) - ${time}</span>
                                    <button class="cancel-button" onclick="undoHistoryItem('${item.medicationId}', '${item.takenAt}', '${item.mealTime}')" 
                                            style="padding: 2px 8px; font-size: 12px; margin-left: 10px;">üîÑ Âèñ„ÇäÊ∂à„Åó</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }
        
        // ÈÄöÁü•„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´
        function scheduleNotifications(medication) {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // ÊúçËñ¨ÊôÇÈñì„ÅÆÈÄöÁü•„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
            setMedicationReminders(medication);
        }
        
        // ÊúçËñ¨„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÅÆË®≠ÂÆö
        function setMedicationReminders(medication) {
            const frequency = medication.frequency;
            const times = [];
            
            // ÊúçÁî®È†ªÂ∫¶„Å´Âøú„Åò„Å¶ÈÄöÁü•ÊôÇÈñì„ÇíË®≠ÂÆö
            switch(frequency) {
                case 'ÊØéÈ£üÂæå':
                    times.push(timeSettings.morning, timeSettings.lunch, timeSettings.dinner);
                    break;
                case 'ÊúùÈ£üÂæå':
                    times.push(timeSettings.morning);
                    break;
                case 'ÊòºÈ£üÂæå':
                    times.push(timeSettings.lunch);
                    break;
                case 'Â§ïÈ£üÂæå':
                    times.push(timeSettings.dinner);
                    break;
                case 'ÊúùÂ§ïÈ£üÂæå':
                    times.push(timeSettings.morning, timeSettings.dinner);
                    break;
                case 'Â∞±ÂØùÂâç':
                    times.push(timeSettings.bedtime);
                    break;
            }
            
            // ÂêÑÊôÇÈñì„Å´ÂØæ„Åó„Å¶ÈÄöÁü•„ÇíË®≠ÂÆö
            times.forEach(time => {
                scheduleNotificationAtTime(medication, time);
            });
        }
        
        // ÊåáÂÆöÊôÇÈñì„Å´ÈÄöÁü•„ÇíË®≠ÂÆö
        function scheduleNotificationAtTime(medication, timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const now = new Date();
            const scheduledTime = new Date();
            scheduledTime.setHours(hours, minutes, 0, 0);
            
            // „ÇÇ„Åó‰ªäÊó•„ÅÆÊôÇÈñì„ÅåÈÅé„Åé„Å¶„ÅÑ„Åü„ÇâÊòéÊó•„Å´Ë®≠ÂÆö
            if (scheduledTime <= now) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }
            
            const timeUntilNotification = scheduledTime.getTime() - now.getTime();
            
            setTimeout(() => {
                showMedicationNotification(medication, timeString);
                // ÁøåÊó•‰ª•Èôç„ÇÇÁ∂ôÁ∂ö„Åô„Çã„Åü„ÇÅÂÜç„Çπ„Ç±„Ç∏„É•„Éº„É´
                setTimeout(() => {
                    scheduleNotificationAtTime(medication, timeString);
                }, 24 * 60 * 60 * 1000); // 24ÊôÇÈñìÂæå
            }, timeUntilNotification);
        }
        
        // Ëñ¨„ÅÆÈÄöÁü•„ÇíË°®Á§∫
        function showMedicationNotification(medication, time) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`üíä „ÅäËñ¨„ÅÆÊôÇÈñì„Åß„Åô`, {
                    body: `${medication.name} (${medication.dosage}) „ÇíÊúçÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ`,
                    icon: 'üíä',
                    badge: 'üíä',
                    tag: `medication-${medication.id}`,
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'take',
                            title: 'ÊúçÁî®Ê∏à„Åø'
                        },
                        {
                            action: 'later',
                            title: 'Âæå„Åß'
                        }
                    ]
                });
                
                notification.onclick = function() {
                    window.focus();
                    // „Éõ„Éº„É†ÁîªÈù¢„ÇíË°®Á§∫
                    showPage('home');
                    this.close();
                };
                
                // 10ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                setTimeout(() => {
                    notification.close();
                }, 10000);
            }
        }
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkLowStockNotifications() {
            medications.forEach(med => {
                if (med.stock <= 7 && med.stock > 0) {
                    // 1Êó•1Âõû„Å†„ÅëÈÄöÁü•ÔºàÊúÄÂæå„ÅÆÈÄöÁü•„Åã„Çâ24ÊôÇÈñìÁµåÈÅé„Åó„Å¶„ÅÑ„Åü„ÇâÔºâ
                    const lastNotified = localStorage.getItem(`lastStockNotify-${med.id}`);
                    const now = Date.now();
                    
                    if (!lastNotified || (now - parseInt(lastNotified)) > 24 * 60 * 60 * 1000) {
                        showLowStockNotification(med);
                        localStorage.setItem(`lastStockNotify-${med.id}`, now.toString());
                    }
                }
            });
        }
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„ÇíË°®Á§∫
        function showLowStockNotification(medication) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`‚ö†Ô∏è Ëñ¨„ÅÆÂú®Â∫´„ÅåÂ∞ë„Å™„Åè„Å™„Å£„Å¶„ÅÑ„Åæ„Åô`, {
                    body: `${medication.name}„ÅÆÂú®Â∫´„ÅåÊÆã„Çä${medication.stock}ÂÄã„Åß„Åô„ÄÇÈÄöÈô¢„ÅÆÊ∫ñÂÇô„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    icon: '‚ö†Ô∏è',
                    badge: '‚ö†Ô∏è',
                    tag: `stock-${medication.id}`,
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    showPage('medications');
                    this.close();
                };
            }
        }
        
        // ÂàùÊúüÂåñ
        updateTodayMedications();
        checkStockWarnings();
        
        // Service Worker„ÅÆÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('Service Worker ÁôªÈå≤ÊàêÂäü:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker ÁôªÈå≤Â§±Êïó:', error);
                    });
            });
        }
        
        // ÈÄöÁü•Ê®©Èôê„ÅÆË¶ÅÊ±Ç
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Êó¢Â≠ò„ÅÆËñ¨„Å´ÂØæ„Åó„Å¶ÈÄöÁü•„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
        medications.forEach(medication => {
            setMedicationReminders(medication);
        });
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        checkLowStockNotifications();
        
        // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÅÆÂá¶ÁêÜ
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÈò≤„Åê
            e.preventDefault();
            // Âæå„Åß‰ΩøÁî®„Åô„Çã„Åü„ÇÅ„Å´„Ç§„Éô„É≥„Éà„Çí‰øùÂ≠ò
            deferredPrompt = e;
            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éú„Çø„É≥„ÇíË°®Á§∫
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éê„Éä„Éº„ÇíË°®Á§∫
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #2196F3;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 9999;
                cursor: pointer;
            `;
            installBanner.innerHTML = 'üì± „Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶„Ç¢„Éó„É™„Å®„Åó„Å¶‰ΩøÁî®„Åß„Åç„Åæ„ÅôÔºÅ';
            installBanner.onclick = installApp;
            document.body.appendChild(installBanner);
            
            // 10ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
            setTimeout(() => {
                if (installBanner.parentNode) {
                    installBanner.parentNode.removeChild(installBanner);
                }
            }, 10000);
        }
        
        function installApp() {
            if (deferredPrompt) {
                // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
                deferredPrompt.prompt();
                // „É¶„Éº„Ç∂„Éº„ÅÆÈÅ∏Êäû„ÇíÂæÖ„Å§
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('„É¶„Éº„Ç∂„Éº„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„ÇíÂèó„ÅëÂÖ•„Çå„Åæ„Åó„Åü');
                    } else {
                        console.log('„É¶„Éº„Ç∂„Éº„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„ÇíÊãíÂê¶„Åó„Åæ„Åó„Åü');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        async function showCameraModal(medId, mealTime) {
            currentMedId = medId;
            currentMealTime = mealTime;
            
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-video');
            const capturedImage = document.getElementById('captured-image');
            const analysisResult = document.getElementById('analysis-result');
            const confirmBtn = document.getElementById('confirm-btn');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            
            // „É™„Çª„ÉÉ„Éà
            capturedImage.style.display = 'none';
            video.style.display = 'block';
            analysisResult.style.display = 'none';
            confirmBtn.style.display = 'none';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // ËÉåÈù¢„Ç´„É°„É©„ÇíÂÑ™ÂÖà
                });
                video.srcObject = cameraStream;
                modal.style.display = 'block';
            } catch (err) {
                alert('„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Ç´„É°„É©„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                console.error('„Ç´„É°„É©„Ç®„É©„Éº:', err);
            }
        }
        
        // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫
        function hideCameraModal() {
            const modal = document.getElementById('camera-modal');
            modal.style.display = 'none';
            
            // „Ç´„É°„É©„Çπ„Éà„É™„Éº„É†„ÇíÂÅúÊ≠¢
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            currentMedId = null;
            currentMealTime = null;
        }
        
        // ÂÜôÁúüÊíÆÂΩ±
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const capturedImage = document.getElementById('captured-image');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            
            // „Ç≠„É£„É≥„Éê„Çπ„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂãïÁîª„ÅÆ„Çµ„Ç§„Ç∫„Å´Ë®≠ÂÆö
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ÂãïÁîª„Éï„É¨„Éº„É†„Çí„Ç≠„É£„É≥„Éê„Çπ„Å´ÊèèÁîª
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // „Ç≠„É£„É≥„Éê„Çπ„Åã„ÇâÁîªÂÉè„Éá„Éº„Çø„ÇíÂèñÂæó
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            // ÊíÆÂΩ±„Åó„ÅüÁîªÂÉè„ÇíË°®Á§∫
            capturedImage.src = imageDataUrl;
            capturedImage.style.display = 'block';
            video.style.display = 'none';
            
            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'block';
            
            // ÁîªÂÉèËß£Êûê„ÇíÂÆüË°å
            analyzeImage(imageDataUrl);
        }
        
        // ÊíÆ„ÇäÁõ¥„Åó
        function retakePhoto() {
            const video = document.getElementById('camera-video');
            const capturedImage = document.getElementById('captured-image');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            const analysisResult = document.getElementById('analysis-result');
            const confirmBtn = document.getElementById('confirm-btn');
            
            // Ë°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
            capturedImage.style.display = 'none';
            video.style.display = 'block';
            analysisResult.style.display = 'none';
            confirmBtn.style.display = 'none';
            
            // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
        }
        
        // È´òÂ∫¶„Å™ÁîªÂÉèËß£Êûê
        async function analyzeImage(imageDataUrl) {
            const analysisResult = document.getElementById('analysis-result');
            const confirmBtn = document.getElementById('confirm-btn');
            
            // Ëß£Êûê‰∏≠„ÅÆË°®Á§∫
            analysisResult.innerHTML = `
                <div>
                    ü§ñ AIÁîªÂÉèË™çË≠ò„ÇíÂÆüË°å‰∏≠...<br>
                    <div style="margin: 10px 0;">
                        <div style="width: 100%; background: #ddd; border-radius: 10px; overflow: hidden;">
                            <div id="progress-bar" style="width: 0%; height: 8px; background: #4CAF50; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    Ë§áÊï∞„ÅÆAI„Ç®„É≥„Ç∏„É≥„ÅßËñ¨„Ç∑„Éº„Éà„ÇíËß£Êûê‰∏≠...
                </div>
            `;
            analysisResult.className = 'analysis-result';
            analysisResult.style.display = 'block';
            
            try {
                // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                updateProgress(20);
                
                // Ë§áÊï∞„ÅÆÁîªÂÉèË™çË≠ò„Çí‰∏¶Ë°åÂÆüË°å
                const results = await Promise.allSettled([
                    analyzeWithComputerVision(imageDataUrl),
                    analyzeWithOpenAI(imageDataUrl),
                    analyzeWithLocalAI(imageDataUrl)
                ]);
                
                updateProgress(80);
                
                // ÁµêÊûú„ÇíÁµ±Âêà„Åó„Å¶ÊúÄÁµÇÂà§ÂÆö
                const finalResult = combineAnalysisResults(results);
                
                updateProgress(100);
                
                // ÁµêÊûúË°®Á§∫
                setTimeout(() => {
                    displayAnalysisResult(finalResult, analysisResult, confirmBtn);
                }, 500);
                
            } catch (error) {
                console.error('ÁîªÂÉèËß£Êûê„Ç®„É©„Éº:', error);
                displayFallbackResult(analysisResult, confirmBtn);
            }
        }
        
        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÊõ¥Êñ∞
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }
        
        // Google Vision API „Å´„Çà„ÇãÈ´òÂ∫¶Ëß£Êûê
        async function analyzeWithComputerVision(imageDataUrl) {
            const config = API_CONFIGS.googleVision;
            
            if (config.enabled && config.apiKey !== 'YOUR_GOOGLE_VISION_API_KEY') {
                try {
                    const base64Image = imageDataUrl.split(',')[1];
                    
                    const requestBody = {
                        requests: [{
                            image: { content: base64Image },
                            features: config.features
                        }]
                    };
                    
                    const response = await fetch(`${config.endpoint}?key=${config.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const result = await response.json();
                    return analyzeGoogleVisionResult(result);
                    
                } catch (error) {
                    console.error('Google Vision API „Ç®„É©„Éº:', error);
                    return fallbackLocalAnalysis(imageDataUrl, 'ComputerVision');
                }
            } else {
                // „É≠„Éº„Ç´„É´ÂàÜÊûê„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                return fallbackLocalAnalysis(imageDataUrl, 'ComputerVision');
            }
        }
        
        // Google VisionÁµêÊûú„ÅÆËß£Êûê
        function analyzeGoogleVisionResult(result) {
            if (!result.responses || !result.responses[0]) {
                throw new Error('Invalid API response');
            }
            
            const response = result.responses[0];
            const objects = response.localizedObjectAnnotations || [];
            const labels = response.labelAnnotations || [];
            const texts = response.textAnnotations || [];
            
            // Ëñ¨Èñ¢ÈÄ£„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÊ§úÂá∫
            const medicationKeywords = ['pill', 'tablet', 'capsule', 'medication', 'medicine', 'drug', 'pharmaceutical'];
            const packagingKeywords = ['blister', 'pack', 'bottle', 'container', 'packaging'];
            
            let medicationScore = 0;
            let emptyScore = 0;
            
            // „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÊ§úÂá∫„ÅÆÂàÜÊûê
            objects.forEach(obj => {
                const name = obj.name.toLowerCase();
                if (medicationKeywords.some(keyword => name.includes(keyword))) {
                    medicationScore += obj.score;
                }
                if (packagingKeywords.some(keyword => name.includes(keyword))) {
                    emptyScore += obj.score * 0.5;
                }
            });
            
            // „É©„Éô„É´„ÅÆÂàÜÊûê
            labels.forEach(label => {
                const description = label.description.toLowerCase();
                if (medicationKeywords.some(keyword => description.includes(keyword))) {
                    medicationScore += label.score * 0.7;
                }
                if (['empty', 'vacant', 'hollow'].some(keyword => description.includes(keyword))) {
                    emptyScore += label.score;
                }
            });
            
            // „ÉÜ„Ç≠„Çπ„ÉàÊ§úÂá∫ÔºàËñ¨Âêç„Å™„Å©Ôºâ
            let hasText = texts.length > 1; // texts[0]„ÅØÂÖ®‰Ωì„ÉÜ„Ç≠„Çπ„Éà
            
            const isEmpty = emptyScore > medicationScore || (medicationScore < 0.3 && !hasText);
            const confidence = Math.min((emptyScore + (1 - medicationScore)) * 100, 95);
            
            return {
                api: 'GoogleVision',
                isEmpty: isEmpty,
                confidence: Math.round(confidence),
                details: `Ëñ¨Ê§úÂá∫: ${Math.round(medicationScore * 100)}%, Á©∫ÂÆπÂô®: ${Math.round(emptyScore * 100)}%`
            };
        }
        
        // „É≠„Éº„Ç´„É´ÂàÜÊûê„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        async function fallbackLocalAnalysis(imageDataUrl, apiName) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        // ÁîªÂÉè„ÅÆÊòéÂ∫¶„ÇíÂàÜÊûê
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const brightness = calculateBrightness(imageData);
                        
                        // „Ç®„ÉÉ„Ç∏ÂØÜÂ∫¶„ÅÆË®àÁÆó
                        const edgeDensity = calculateEdgeDensity(imageData);
                        
                        // Ëâ≤„ÅÆÂùá‰∏ÄÊÄß„ÇíË®àÁÆó
                        const colorUniformity = calculateColorUniformity(imageData);
                        
                        // Á∑èÂêàÂà§ÂÆöÔºàÁ©∫„ÅÆ„Ç∑„Éº„Éà„ÅØÊòé„Çã„Åè„ÄÅ„Ç®„ÉÉ„Ç∏„ÅåÂ∞ë„Å™„Åè„ÄÅËâ≤„ÅåÂùá‰∏ÄÔºâ
                        const emptyScore = (brightness / 255) * 0.4 + 
                                         (1 - edgeDensity) * 0.3 + 
                                         colorUniformity * 0.3;
                        
                        const isEmpty = emptyScore > 0.6;
                        const confidence = Math.min(emptyScore * 100, 95);
                        
                        resolve({
                            api: apiName,
                            isEmpty: isEmpty,
                            confidence: Math.round(confidence),
                            details: `ÊòéÂ∫¶: ${Math.round(brightness)}, „Ç®„ÉÉ„Ç∏ÂØÜÂ∫¶: ${Math.round(edgeDensity * 100)}%, Âùá‰∏ÄÊÄß: ${Math.round(colorUniformity * 100)}%`
                        });
                    };
                    
                    img.src = imageDataUrl;
                }, 800);
            });
        }
        
        // „Ç®„ÉÉ„Ç∏ÂØÜÂ∫¶Ë®àÁÆó
        function calculateEdgeDensity(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            let edgeCount = 0;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const current = data[idx] + data[idx + 1] + data[idx + 2];
                    const right = data[idx + 4] + data[idx + 5] + data[idx + 6];
                    const bottom = data[idx + width * 4] + data[idx + width * 4 + 1] + data[idx + width * 4 + 2];
                    
                    if (Math.abs(current - right) > 30 || Math.abs(current - bottom) > 30) {
                        edgeCount++;
                    }
                }
            }
            
            return edgeCount / ((width - 2) * (height - 2));
        }
        
        // Ëâ≤„ÅÆÂùá‰∏ÄÊÄßË®àÁÆó
        function calculateColorUniformity(imageData) {
            const data = imageData.data;
            let totalVariance = 0;
            let pixelCount = 0;
            
            // Âπ≥ÂùáËâ≤„ÇíË®àÁÆó
            let avgR = 0, avgG = 0, avgB = 0;
            for (let i = 0; i < data.length; i += 4) {
                avgR += data[i];
                avgG += data[i + 1];
                avgB += data[i + 2];
                pixelCount++;
            }
            avgR /= pixelCount;
            avgG /= pixelCount;
            avgB /= pixelCount;
            
            // ÂàÜÊï£„ÇíË®àÁÆó
            for (let i = 0; i < data.length; i += 4) {
                const varR = Math.pow(data[i] - avgR, 2);
                const varG = Math.pow(data[i + 1] - avgG, 2);
                const varB = Math.pow(data[i + 2] - avgB, 2);
                totalVariance += (varR + varG + varB) / 3;
            }
            
            const variance = totalVariance / pixelCount;
            return Math.max(0, 1 - (variance / 10000)); // Ê≠£Ë¶èÂåñ
        }
        
        // OpenAI Vision API (GPT-4V)
        async function analyzeWithOpenAI(imageDataUrl) {
            const config = API_CONFIGS.openaiVision;
            
            if (config.enabled && config.apiKey !== 'YOUR_OPENAI_API_KEY') {
                try {
                    const requestBody = {
                        model: config.model,
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `„Åì„ÅÆÁîªÂÉè„ÅØËñ¨„ÅÆ„Ç∑„Éº„Éà„ÄÅËñ¨Ë¢ã„ÄÅ„Åæ„Åü„ÅØËñ¨Áì∂„ÅÆÂÜôÁúü„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÁÇπ„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
                                        1. Ëñ¨„ÅåÁ©∫„ÅÆÁä∂ÊÖãÔºàÊúçÁî®Ê∏à„ÅøÔºâ„Åã„Å©„ÅÜ„Åã
                                        2. Ëñ¨„ÅåÊÆã„Å£„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã
                                        3. Âà§ÂÆö„ÅÆ‰ø°È†ºÂ∫¶Ôºà0-100%Ôºâ
                                        
                                        JSONÂΩ¢Âºè„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
                                        {"isEmpty": boolean, "confidence": number, "reasoning": "Âà§ÂÆöÁêÜÁî±"}`
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageDataUrl
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    };
                    
                    const response = await fetch(config.endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const result = await response.json();
                    return parseOpenAIResult(result);
                    
                } catch (error) {
                    console.error('OpenAI Vision API „Ç®„É©„Éº:', error);
                    return fallbackLocalAnalysis(imageDataUrl, 'OpenAI');
                }
            } else {
                return fallbackLocalAnalysis(imageDataUrl, 'OpenAI');
            }
        }
        
        // OpenAIÁµêÊûú„ÅÆËß£Êûê
        function parseOpenAIResult(result) {
            try {
                const content = result.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    return {
                        api: 'OpenAI_GPT4V',
                        isEmpty: parsed.isEmpty,
                        confidence: Math.min(parsed.confidence, 95),
                        details: parsed.reasoning || 'AIËß£ÊûêÂÆå‰∫Ü'
                    };
                } else {
                    throw new Error('Invalid JSON response');
                }
            } catch (error) {
                console.error('OpenAIÁµêÊûúËß£Êûê„Ç®„É©„Éº:', error);
                return {
                    api: 'OpenAI_GPT4V',
                    isEmpty: false,
                    confidence: 30,
                    details: 'AIËß£Êûê„Ç®„É©„Éº'
                };
            }
        }
        
        // „É≠„Éº„Ç´„É´AIÂàÜÊûê
        async function analyzeWithLocalAI(imageDataUrl) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Ëâ≤ÂàÜÂ∏É„Éô„Éº„Çπ„ÅÆÂà§ÂÆö
                    const colorAnalysis = analyzeColorDistribution(imageDataUrl);
                    
                    resolve({
                        api: 'LocalAI',
                        isEmpty: colorAnalysis.whiteRatio > 0.6,
                        confidence: colorAnalysis.whiteRatio * 100,
                        details: `ÁôΩËâ≤„ÅÆÂâ≤Âêà: ${Math.round(colorAnalysis.whiteRatio * 100)}%`
                    });
                }, 600);
            });
        }
        
        // ÊòéÂ∫¶Ë®àÁÆó
        function calculateBrightness(imageData) {
            const data = imageData.data;
            let totalBrightness = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                totalBrightness += (r + g + b) / 3;
            }
            
            return totalBrightness / (data.length / 4);
        }
        
        // „Ç®„ÉÉ„Ç∏Ê§úÂá∫ÔºàÁ∞°ÊòìÁâàÔºâ
        function detectEdges(imageDataUrl) {
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ„ÄÅ„Çà„ÇäË§áÈõë„Å™„Ç®„ÉÉ„Ç∏Ê§úÂá∫„Ç¢„É´„Ç¥„É™„Ç∫„É†„Çí‰ΩøÁî®
            return Math.floor(Math.random() * 100); // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº
        }
        
        // Ëâ≤ÂàÜÂ∏ÉÂàÜÊûê
        function analyzeColorDistribution(imageDataUrl) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            return new Promise((resolve) => {
                img.onload = function() {
                    canvas.width = 100; // „Çµ„É≥„Éó„É™„É≥„Ç∞Áî®„Å´Â∞è„Åï„Åè
                    canvas.height = 100;
                    ctx.drawImage(img, 0, 0, 100, 100);
                    
                    const imageData = ctx.getImageData(0, 0, 100, 100);
                    const data = imageData.data;
                    let whitePixels = 0;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // ÁôΩ„Å£„ÅΩ„ÅÑ„Éî„ÇØ„Çª„É´„ÅÆÂà§ÂÆö
                        if (r > 200 && g > 200 && b > 200) {
                            whitePixels++;
                        }
                    }
                    
                    resolve({
                        whiteRatio: whitePixels / (data.length / 4)
                    });
                };
                
                img.src = imageDataUrl;
            });
        }
        
        // Ëß£ÊûêÁµêÊûú„ÅÆÁµ±Âêà
        function combineAnalysisResults(results) {
            const validResults = results
                .filter(result => result.status === 'fulfilled')
                .map(result => result.value);
            
            if (validResults.length === 0) {
                return {
                    isEmpty: false,
                    confidence: 0,
                    message: 'AIËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'
                };
            }
            
            // Èáç„Åø‰ªò„ÅçÊäïÁ•®
            const weights = { ComputerVision: 0.5, OpenAI: 0.3, LocalAI: 0.2 };
            let weightedScore = 0;
            let totalWeight = 0;
            
            validResults.forEach(result => {
                const weight = weights[result.api] || 0.1;
                weightedScore += (result.isEmpty ? 1 : 0) * weight * (result.confidence / 100);
                totalWeight += weight;
            });
            
            const finalScore = weightedScore / totalWeight;
            const isEmpty = finalScore > 0.6;
            const confidence = Math.round(finalScore * 100);
            
            return {
                isEmpty,
                confidence,
                results: validResults,
                message: isEmpty ? 
                    `${validResults.length}„Å§„ÅÆAI„Ç®„É≥„Ç∏„É≥„ÅåÁ©∫„ÅÆËñ¨„Ç∑„Éº„Éà„ÇíÁ¢∫Ë™ç` :
                    `${validResults.length}„Å§„ÅÆAI„Ç®„É≥„Ç∏„É≥„ÅåËñ¨„ÅÆÊÆãÂ≠ò„ÇíÊ§úÂá∫`
            };
        }
        
        // ÁµêÊûúË°®Á§∫
        function displayAnalysisResult(result, analysisResult, confirmBtn) {
            if (result.isEmpty && result.confidence > 60) {
                analysisResult.innerHTML = `
                    <div class="success-message">
                        ‚úÖ ${result.message}<br>
                        <small>‰ø°È†ºÂ∫¶: ${result.confidence}%</small><br>
                        <details style="margin-top: 10px; text-align: left;">
                            <summary>Ë©≥Á¥∞Ëß£ÊûêÁµêÊûú</summary>
                            ${result.results.map(r => `
                                <div style="margin: 5px 0; font-size: 12px;">
                                    <strong>${r.api}:</strong> ${r.isEmpty ? 'Á©∫' : 'Ëñ¨Êúâ„Çä'} 
                                    (${Math.round(r.confidence)}%) - ${r.details}
                                </div>
                            `).join('')}
                        </details>
                    </div>
                `;
                analysisResult.className = 'analysis-result success-message';
                confirmBtn.style.display = 'block';
            } else {
                analysisResult.innerHTML = `
                    <div class="warning-message">
                        ‚ö†Ô∏è ${result.message}<br>
                        <small>‰ø°È†ºÂ∫¶: ${result.confidence}%</small><br>
                        Ëñ¨„Çí„Åô„Åπ„Å¶ÊúçÁî®„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶ÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
                        <details style="margin-top: 10px; text-align: left;">
                            <summary>Ë©≥Á¥∞Ëß£ÊûêÁµêÊûú</summary>
                            ${result.results.map(r => `
                                <div style="margin: 5px 0; font-size: 12px;">
                                    <strong>${r.api}:</strong> ${r.isEmpty ? 'Á©∫' : 'Ëñ¨Êúâ„Çä'} 
                                    (${Math.round(r.confidence)}%) - ${r.details}
                                </div>
                            `).join('')}
                        </details>
                    </div>
                `;
                analysisResult.className = 'analysis-result warning-message';
                confirmBtn.style.display = 'none';
            }
            
            analysisResult.style.display = 'block';
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁµêÊûú
        function displayFallbackResult(analysisResult, confirmBtn) {
            analysisResult.innerHTML = `
                <div class="warning-message">
                    ‚ö†Ô∏è AIËß£Êûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü<br>
                    ÊâãÂãï„ÅßÁ¢∫Ë™ç„Åó„Å¶„ÄÅËñ¨„ÇíÊúçÁî®„Åó„Å¶„ÅÑ„Çå„Å∞„ÄåÊúçÁî®„ÇíÁ¢∫Ë™ç„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                </div>
            `;
            analysisResult.className = 'analysis-result warning-message';
            confirmBtn.style.display = 'block';
            analysisResult.style.display = 'block';
        }
        
        // ÊúçÁî®Á¢∫Ë™ç
        function confirmMedication() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                // Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
                med.stock -= 1;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // Â±•Ê≠¥„Å´ËøΩÂä†ÔºàÂÜôÁúüÁ¢∫Ë™çÊ∏à„Åø„Éï„É©„Ç∞‰ªò„ÅçÔºâ
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: med.dosage,
                    takenAt: new Date().toISOString(),
                    mealTime: currentMealTime,
                    photoVerified: true
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                checkStockWarnings();
                
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                hideCameraModal();
                
                // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                alert('üì∏ ÂÜôÁúü„ÅßÊúçÁî®„ÅåÁ¢∫Ë™ç„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
            }
        }
        
        // „Ç´„Çπ„Çø„É†Áî®ÈÄîÂÖ•Âäõ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleCustomPurpose() {
            const purposeSelect = document.getElementById('med-purpose');
            const customInput = document.getElementById('med-purpose-custom');
            
            if (purposeSelect.value === 'other') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Áî®ÈÄî„ÅÆÂÄ§„ÇíÂèñÂæó
        function getPurposeValue() {
            const purposeSelect = document.getElementById('med-purpose');
            const customInput = document.getElementById('med-purpose-custom');
            
            if (purposeSelect.value === 'other') {
                return customInput.value;
            } else {
                return purposeSelect.value;
            }
        }
        
        // Ëñ¨Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showEditModal(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            document.getElementById('edit-med-id').value = med.id;
            document.getElementById('edit-med-name').value = med.name;
            document.getElementById('edit-med-dosage').value = med.dosage;
            document.getElementById('edit-med-frequency').value = med.frequency;
            document.getElementById('edit-med-stock').value = med.stock;
            
            // Áî®ÈÄî„ÅÆË®≠ÂÆö
            const purposeSelect = document.getElementById('edit-med-purpose');
            const customInput = document.getElementById('edit-med-purpose-custom');
            
            if (med.purpose && !Array.from(purposeSelect.options).find(opt => opt.value === med.purpose)) {
                purposeSelect.value = 'other';
                customInput.style.display = 'block';
                customInput.value = med.purpose;
            } else {
                purposeSelect.value = med.purpose || '';
                customInput.style.display = 'none';
                customInput.value = '';
            }
            
            document.getElementById('edit-modal').style.display = 'block';
        }
        
        // Ëñ¨Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈùûË°®Á§∫
        function hideEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-medication-form').reset();
        }
        
        // Á∑®ÈõÜÊôÇ„ÅÆ„Ç´„Çπ„Çø„É†Áî®ÈÄîÂÖ•Âäõ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleEditCustomPurpose() {
            const purposeSelect = document.getElementById('edit-med-purpose');
            const customInput = document.getElementById('edit-med-purpose-custom');
            
            if (purposeSelect.value === 'other') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Á∑®ÈõÜÊôÇ„ÅÆÁî®ÈÄî„ÅÆÂÄ§„ÇíÂèñÂæó
        function getEditPurposeValue() {
            const purposeSelect = document.getElementById('edit-med-purpose');
            const customInput = document.getElementById('edit-med-purpose-custom');
            
            if (purposeSelect.value === 'other') {
                return customInput.value;
            } else {
                return purposeSelect.value;
            }
        }
        
        // Ëñ¨ÊÉÖÂ†±„ÅÆÁ∑®ÈõÜ
        document.getElementById('edit-medication-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const medId = parseInt(document.getElementById('edit-med-id').value);
            const medIndex = medications.findIndex(m => m.id === medId);
            
            if (medIndex !== -1) {
                medications[medIndex] = {
                    ...medications[medIndex],
                    name: document.getElementById('edit-med-name').value,
                    dosage: document.getElementById('edit-med-dosage').value,
                    frequency: document.getElementById('edit-med-frequency').value,
                    stock: parseInt(document.getElementById('edit-med-stock').value),
                    purpose: getEditPurposeValue()
                };
                
                localStorage.setItem('medications', JSON.stringify(medications));
                
                hideEditModal();
                updateMedicationsList();
                
                // ÈÄöÁü•„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂÜçË®≠ÂÆö
                setMedicationReminders(medications[medIndex]);
                
                alert('‚úÖ Ëñ¨ÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            }
        });
        
        // Ëñ¨„ÅÆÂâäÈô§
        function deleteMedication(medId) {
            if (!confirm('Êú¨ÂΩì„Å´„Åì„ÅÆËñ¨„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            medications = medications.filter(m => m.id !== medId);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            updateMedicationsList();
            alert('‚úÖ Ëñ¨„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
        }
        
        // ÂÆöÊúüÁöÑ„Å´ÁîªÈù¢„ÇíÊõ¥Êñ∞Ôºà1ÂàÜ„Åî„Å®Ôºâ
        setInterval(() => {
            if (document.getElementById('home-page').classList.contains('active')) {
                updateTodayMedications();
                checkStockWarnings();
            }
            // Âú®Â∫´Âàá„ÇåÈÄöÁü•„ÇÇÂÆöÊúüÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
            checkLowStockNotifications();
        }, 60000);
    </script>
</body>
</html>