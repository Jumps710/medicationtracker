<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠè–¬ã®ã‚“ã ï¼Ÿ - æœè–¬ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ãŠè–¬ã®ã‚“ã ï¼Ÿ">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234CAF50'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3EğŸ’Š%3C/text%3E%3C/svg%3E">
    <script src="api-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            padding-bottom: 70px;
        }
        
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        
        .tab.active {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .medication-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .medication-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .medication-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .take-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        .take-button:hover {
            background-color: #45a049;
        }
        
        .take-button.taken {
            background-color: #ddd;
            color: #666;
            cursor: not-allowed;
        }
        
        .add-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .save-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .cancel-button {
            background-color: #f44336;
            color: white;
        }
        
        .history-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-date {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-meds {
            color: #666;
            font-size: 14px;
        }
        
        .stock-warning {
            background-color: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .camera-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            width: 100%;
        }
        
        .camera-modal .modal-content {
            max-width: 500px;
        }
        
        .camera-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .camera-video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-canvas {
            display: none;
        }
        
        .captured-image {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .camera-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .capture-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .retake-button {
            background-color: #ff9800;
            color: white;
        }
        
        .analysis-result {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .success-message {
            background-color: #4CAF50;
            color: white;
        }
        
        .warning-message {
            background-color: #ff9800;
            color: white;
        }
        
        .settings-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .settings-section h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .settings-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .time-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .missed-dose-card {
            background: #fff3cd;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .missed-dose-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: #856404;
        }
        
        .missed-dose-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .missed-dose-title {
            font-size: 16px;
            font-weight: bold;
        }
        
        .missed-dose-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .edit-modal .modal-content {
            max-width: 400px;
        }
        
        .medication-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .medication-actions button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .edit-button {
            background-color: #2196F3;
            color: white;
        }
        
        .delete-button {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ãŠè–¬ã®ã‚“ã ï¼Ÿ</h1>
    </div>
    
    <div class="container">
        <!-- æœç”¨ç”»é¢ -->
        <div id="home-page" class="page active">
            <div id="stock-warnings"></div>
            <h2>ä»Šæ—¥ã®æœè–¬</h2>
            <div id="today-medications"></div>
        </div>
        
        <!-- è–¬ç®±ç”»é¢ -->
        <div id="medications-page" class="page">
            <h2>è–¬ç®±</h2>
            <div id="medications-list"></div>
        </div>
        
        <!-- å±¥æ­´ç”»é¢ -->
        <div id="history-page" class="page">
            <h2>æœè–¬å±¥æ­´</h2>
            <div id="history-list"></div>
        </div>
        
        <!-- è¨­å®šç”»é¢ -->
        <div id="settings-page" class="page">
            <h2>è¨­å®š</h2>
            <div class="settings-section">
                <h3>æœç”¨æ™‚é–“è¨­å®š</h3>
                <p class="settings-description">å„æœç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
                <div class="form-group">
                    <label for="morning-time">æœé£Ÿå¾Œ</label>
                    <input type="time" id="morning-time" class="time-input" value="08:30">
                </div>
                <div class="form-group">
                    <label for="lunch-time">æ˜¼é£Ÿå¾Œ</label>
                    <input type="time" id="lunch-time" class="time-input" value="12:30">
                </div>
                <div class="form-group">
                    <label for="dinner-time">å¤•é£Ÿå¾Œ</label>
                    <input type="time" id="dinner-time" class="time-input" value="19:30">
                </div>
                <div class="form-group">
                    <label for="bedtime-time">å°±å¯å‰</label>
                    <input type="time" id="bedtime-time" class="time-input" value="22:00">
                </div>
                <button class="save-button" onclick="saveTimeSettings()">æ™‚é–“è¨­å®šã‚’ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚¿ãƒ–ãƒãƒ¼ -->
    <div class="tab-bar">
        <button class="tab active" onclick="showPage('home')">
            <div>ğŸ’Š</div>
            <div>æœç”¨</div>
        </button>
        <button class="tab" onclick="showPage('medications')">
            <div>ğŸ«</div>
            <div>è–¬ç®±</div>
        </button>
        <button class="tab" onclick="showPage('history')">
            <div>ğŸ“Š</div>
            <div>å±¥æ­´</div>
        </button>
        <button class="tab" onclick="showPage('settings')">
            <div>âš™ï¸</div>
            <div>è¨­å®š</div>
        </button>
    </div>
    
    <!-- è¿½åŠ ãƒœã‚¿ãƒ³ -->
    <button class="add-button" onclick="showAddModal()">+</button>
    
    <!-- è–¬è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3>æ–°ã—ã„è–¬ã‚’è¿½åŠ </h3>
            <form id="add-medication-form">
                <div class="form-group">
                    <label for="med-name">è–¬ã®åå‰</label>
                    <input type="text" id="med-name" required>
                </div>
                <div class="form-group">
                    <label for="med-dosage">ç”¨é‡ï¼ˆ1å›ã‚ãŸã‚Šï¼‰</label>
                    <input type="text" id="med-dosage" placeholder="ä¾‹: 1éŒ , 2åŒ…" required>
                </div>
                <div class="form-group">
                    <label for="med-frequency">æœç”¨é »åº¦</label>
                    <select id="med-frequency" required>
                        <option value="æ¯é£Ÿå¾Œ">æ¯é£Ÿå¾Œ</option>
                        <option value="æœé£Ÿå¾Œ">æœé£Ÿå¾Œ</option>
                        <option value="æ˜¼é£Ÿå¾Œ">æ˜¼é£Ÿå¾Œ</option>
                        <option value="å¤•é£Ÿå¾Œ">å¤•é£Ÿå¾Œ</option>
                        <option value="æœå¤•é£Ÿå¾Œ">æœå¤•é£Ÿå¾Œ</option>
                        <option value="å°±å¯å‰">å°±å¯å‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="med-stock">ç¾åœ¨ã®åœ¨åº«æ•°</label>
                    <input type="number" id="med-stock" required>
                </div>
                <div class="form-group">
                    <label for="med-purpose">ç”¨é€”</label>
                    <select id="med-purpose" onchange="toggleCustomPurpose()">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="é ­ç—›ã‚’ã‚„ã‚ã‚‰ã’ã‚‹">é ­ç—›ã‚’ã‚„ã‚ã‚‰ã’ã‚‹</option>
                        <option value="ç—›ã¿æ­¢ã‚">ç—›ã¿æ­¢ã‚</option>
                        <option value="å’³æ­¢ã‚">å’³æ­¢ã‚</option>
                        <option value="è§£ç†±">è§£ç†±</option>
                        <option value="èƒƒè…¸è–¬">èƒƒè…¸è–¬</option>
                        <option value="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</option>
                        <option value="é«˜è¡€åœ§">é«˜è¡€åœ§</option>
                        <option value="ç³–å°¿ç—…">ç³–å°¿ç—…</option>
                        <option value="éª¨ç²—æ¾ç—‡">éª¨ç²—æ¾ç—‡</option>
                        <option value="ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ">ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                    <input type="text" id="med-purpose-custom" placeholder="ç”¨é€”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" style="display:none; margin-top: 10px;">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="save-button">ä¿å­˜</button>
                    <button type="button" class="cancel-button" onclick="hideAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- è–¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="edit-modal" class="modal edit-modal">
        <div class="modal-content">
            <h3>è–¬æƒ…å ±ã‚’ç·¨é›†</h3>
            <form id="edit-medication-form">
                <input type="hidden" id="edit-med-id">
                <div class="form-group">
                    <label for="edit-med-name">è–¬ã®åå‰</label>
                    <input type="text" id="edit-med-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-med-dosage">ç”¨é‡ï¼ˆ1å›ã‚ãŸã‚Šï¼‰</label>
                    <input type="text" id="edit-med-dosage" placeholder="ä¾‹: 1éŒ , 2åŒ…" required>
                </div>
                <div class="form-group">
                    <label for="edit-med-frequency">æœç”¨é »åº¦</label>
                    <select id="edit-med-frequency" required>
                        <option value="æ¯é£Ÿå¾Œ">æ¯é£Ÿå¾Œ</option>
                        <option value="æœé£Ÿå¾Œ">æœé£Ÿå¾Œ</option>
                        <option value="æ˜¼é£Ÿå¾Œ">æ˜¼é£Ÿå¾Œ</option>
                        <option value="å¤•é£Ÿå¾Œ">å¤•é£Ÿå¾Œ</option>
                        <option value="æœå¤•é£Ÿå¾Œ">æœå¤•é£Ÿå¾Œ</option>
                        <option value="å°±å¯å‰">å°±å¯å‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-med-stock">ç¾åœ¨ã®åœ¨åº«æ•°</label>
                    <input type="number" id="edit-med-stock" required>
                </div>
                <div class="form-group">
                    <label for="edit-med-purpose">ç”¨é€”</label>
                    <select id="edit-med-purpose" onchange="toggleEditCustomPurpose()">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="é ­ç—›ã‚’ã‚„ã‚ã‚‰ã’ã‚‹">é ­ç—›ã‚’ã‚„ã‚ã‚‰ã’ã‚‹</option>
                        <option value="ç—›ã¿æ­¢ã‚">ç—›ã¿æ­¢ã‚</option>
                        <option value="å’³æ­¢ã‚">å’³æ­¢ã‚</option>
                        <option value="è§£ç†±">è§£ç†±</option>
                        <option value="èƒƒè…¸è–¬">èƒƒè…¸è–¬</option>
                        <option value="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</option>
                        <option value="é«˜è¡€åœ§">é«˜è¡€åœ§</option>
                        <option value="ç³–å°¿ç—…">ç³–å°¿ç—…</option>
                        <option value="éª¨ç²—æ¾ç—‡">éª¨ç²—æ¾ç—‡</option>
                        <option value="ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ">ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                    <input type="text" id="edit-med-purpose-custom" placeholder="ç”¨é€”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" style="display:none; margin-top: 10px;">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="save-button">ä¿å­˜</button>
                    <button type="button" class="cancel-button" onclick="hideEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="camera-modal" class="modal camera-modal">
        <div class="modal-content">
            <h3>ç©ºã®è–¬ã‚·ãƒ¼ãƒˆã‚’æ’®å½±ã—ã¦ãã ã•ã„</h3>
            <div class="camera-container">
                <video id="camera-video" class="camera-video" autoplay></video>
                <canvas id="camera-canvas" class="camera-canvas"></canvas>
                <img id="captured-image" class="captured-image" style="display: none;">
                
                <div class="camera-controls">
                    <button id="capture-btn" class="capture-button" onclick="capturePhoto()">ğŸ“· æ’®å½±</button>
                    <button id="retake-btn" class="retake-button" onclick="retakePhoto()" style="display: none;">ğŸ”„ æ’®ã‚Šç›´ã—</button>
                </div>
                
                <div id="analysis-result" class="analysis-result" style="display: none;"></div>
            </div>
            
            <div class="form-buttons">
                <button id="confirm-btn" class="save-button" onclick="confirmMedication()" style="display: none;">æœç”¨ã‚’ç¢ºèª</button>
                <button class="cancel-button" onclick="hideCameraModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <script>
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        
        // æœç”¨æ™‚é–“è¨­å®šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        const defaultTimeSettings = {
            morning: '08:30',
            lunch: '12:30',
            dinner: '19:30',
            bedtime: '22:00'
        };
        
        // ä¿å­˜ã•ã‚ŒãŸæ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã¿
        let timeSettings = JSON.parse(localStorage.getItem('timeSettings')) || defaultTimeSettings;
        
        // è¨­å®šç”»é¢ã‚’æ›´æ–°
        function updateSettingsPage() {
            document.getElementById('morning-time').value = timeSettings.morning;
            document.getElementById('lunch-time').value = timeSettings.lunch;
            document.getElementById('dinner-time').value = timeSettings.dinner;
            document.getElementById('bedtime-time').value = timeSettings.bedtime;
        }
        
        // æ™‚é–“è¨­å®šã‚’ä¿å­˜
        function saveTimeSettings() {
            timeSettings = {
                morning: document.getElementById('morning-time').value,
                lunch: document.getElementById('lunch-time').value,
                dinner: document.getElementById('dinner-time').value,
                bedtime: document.getElementById('bedtime-time').value
            };
            
            localStorage.setItem('timeSettings', JSON.stringify(timeSettings));
            alert('âœ… æœç”¨æ™‚é–“è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            
            // é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨­å®š
            medications.forEach(medication => {
                setMedicationReminders(medication);
            });
        }
        
        // ã‚«ãƒ¡ãƒ©é–¢é€£ã®å¤‰æ•°
        let currentMedId = null;
        let currentMealTime = null;
        let cameraStream = null;
        
        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function showPage(pageName) {
            // ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById(pageName + '-page').classList.add('active');
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            event.target.closest('.tab').classList.add('active');
            
            // ãƒšãƒ¼ã‚¸ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            if (pageName === 'home') {
                updateTodayMedications();
                checkStockWarnings();
            } else if (pageName === 'medications') {
                updateMedicationsList();
            } else if (pageName === 'history') {
                updateHistoryList();
            } else if (pageName === 'settings') {
                updateSettingsPage();
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤º
        function showAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }
        
        function hideAddModal() {
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('add-medication-form').reset();
        }
        
        // è–¬ã®è¿½åŠ 
        document.getElementById('add-medication-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const medication = {
                id: Date.now(),
                name: document.getElementById('med-name').value,
                dosage: document.getElementById('med-dosage').value,
                frequency: document.getElementById('med-frequency').value,
                stock: parseInt(document.getElementById('med-stock').value),
                purpose: getPurposeValue(),
                createdAt: new Date().toISOString()
            };
            
            medications.push(medication);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            hideAddModal();
            showPage('medications');
            
            // é€šçŸ¥ã®è¨­å®šï¼ˆå¾Œã§å®Ÿè£…ï¼‰
            scheduleNotifications(medication);
        });
        
        // ä»Šæ—¥ã®æœè–¬ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateTodayMedications() {
            const container = document.getElementById('today-medications');
            container.innerHTML = '';
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // è¨­å®šã•ã‚ŒãŸæ™‚é–“ã‹ã‚‰ç¾åœ¨ã®æœç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆ¤å®š
            const timeToMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            
            const morningMinutes = timeToMinutes(timeSettings.morning);
            const lunchMinutes = timeToMinutes(timeSettings.lunch);
            const dinnerMinutes = timeToMinutes(timeSettings.dinner);
            const bedtimeMinutes = timeToMinutes(timeSettings.bedtime);
            
            let mealTime = '';
            if (currentTime >= morningMinutes - 60 && currentTime < lunchMinutes - 60) {
                mealTime = 'æœé£Ÿå¾Œ';
            } else if (currentTime >= lunchMinutes - 60 && currentTime < dinnerMinutes - 60) {
                mealTime = 'æ˜¼é£Ÿå¾Œ';
            } else if (currentTime >= dinnerMinutes - 60 && currentTime < bedtimeMinutes - 60) {
                mealTime = 'å¤•é£Ÿå¾Œ';
            } else if (currentTime >= bedtimeMinutes - 60 || currentTime < morningMinutes - 60) {
                mealTime = 'å°±å¯å‰';
            }
            
            // é£²ã¿å¿˜ã‚Œãƒã‚§ãƒƒã‚¯ï¼ˆå„æœç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®1æ™‚é–“å¾Œã‹ã‚‰ãƒã‚§ãƒƒã‚¯ï¼‰
            const missedDoses = [];
            const checkMissedDose = (timing, settingKey) => {
                const targetTime = timeToMinutes(timeSettings[settingKey]);
                const timeSinceDose = currentTime - targetTime;
                
                if (timeSinceDose > 60 && timeSinceDose < 240) { // 1æ™‚é–“å¾Œã‹ã‚‰4æ™‚é–“ä»¥å†…
                    medications.forEach(med => {
                        const shouldTake = med.frequency === 'æ¯é£Ÿå¾Œ' || 
                                         med.frequency === timing ||
                                         (med.frequency === 'æœå¤•é£Ÿå¾Œ' && (timing === 'æœé£Ÿå¾Œ' || timing === 'å¤•é£Ÿå¾Œ'));
                        
                        if (shouldTake && !isTakenToday(med.id, timing)) {
                            missedDoses.push({
                                medication: med,
                                timing: timing,
                                missedTime: timeSettings[settingKey]
                            });
                        }
                    });
                }
            };
            
            // ä»Šæ—¥ã®é£²ã¿å¿˜ã‚Œã‚’ãƒã‚§ãƒƒã‚¯
            const todayDate = now.toDateString();
            const checkTiming = (timing, settingKey) => {
                const targetMinutes = timeToMinutes(timeSettings[settingKey]);
                // ä»Šæ—¥ã®ãã®æ™‚é–“ãŒã™ã§ã«éããŸã‹ãƒã‚§ãƒƒã‚¯
                if (currentTime > targetMinutes) {
                    checkMissedDose(timing, settingKey);
                }
            };
            
            checkTiming('æœé£Ÿå¾Œ', 'morning');
            checkTiming('æ˜¼é£Ÿå¾Œ', 'lunch');
            checkTiming('å¤•é£Ÿå¾Œ', 'dinner');
            checkTiming('å°±å¯å‰', 'bedtime');
            
            // é£²ã¿å¿˜ã‚Œã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            missedDoses.forEach(missed => {
                const card = document.createElement('div');
                card.className = 'missed-dose-card';
                card.innerHTML = `
                    <div class="missed-dose-header">
                        <div class="missed-dose-icon">âš ï¸</div>
                        <div class="missed-dose-title">${missed.medication.name}ã®æœç”¨ã‚’å¿˜ã‚Œã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ</div>
                    </div>
                    <div class="missed-dose-info">
                        ${missed.timing} (${missed.missedTime}) - ${missed.medication.dosage}
                    </div>
                    <button class="take-button" onclick="takeMedication(${missed.medication.id}, '${missed.timing}')"
                            ${isTakenToday(missed.medication.id, missed.timing) ? 'disabled' : ''}>
                        ${isTakenToday(missed.medication.id, missed.timing) ? 'âœ“ æœç”¨æ¸ˆã¿' : 'ä»Šæœç”¨ã™ã‚‹'}
                    </button>
                    ${!isTakenToday(missed.medication.id, missed.timing) ? 
                        `<button class="camera-button" onclick="showCameraModal(${missed.medication.id}, '${missed.timing}')">ğŸ“¸ å†™çœŸã§ç¢ºèª</button>` : ''}
                `;
                container.appendChild(card);
            });
            
            // ç¾åœ¨ã®æ™‚é–“å¸¯ã®æœè–¬
            const todayMeds = medications.filter(med => {
                return med.frequency === 'æ¯é£Ÿå¾Œ' || 
                       med.frequency === mealTime ||
                       (med.frequency === 'æœå¤•é£Ÿå¾Œ' && (mealTime === 'æœé£Ÿå¾Œ' || mealTime === 'å¤•é£Ÿå¾Œ'));
            });
            
            if (todayMeds.length === 0 && missedDoses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ç¾åœ¨æœç”¨ã™ã‚‹è–¬ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            todayMeds.forEach(med => {
                const taken = isTakenToday(med.id, mealTime);
                const card = document.createElement('div');
                card.className = 'medication-card';
                card.innerHTML = `
                    <div class="medication-name">${med.name}</div>
                    <div class="medication-info">${med.dosage} - ${med.frequency}</div>
                    <div class="medication-info">åœ¨åº«: ${med.stock}å€‹</div>
                    <button class="take-button ${taken ? 'taken' : ''}" 
                            onclick="takeMedication(${med.id}, '${mealTime}')"
                            ${taken ? 'disabled' : ''}>
                        ${taken ? 'âœ“ æœç”¨æ¸ˆã¿' : 'æœç”¨ã™ã‚‹'}
                    </button>
                    ${!taken ? `<button class="camera-button" onclick="showCameraModal(${med.id}, '${mealTime}')">ğŸ“¸ å†™çœŸã§ç¢ºèª</button>` : ''}
                    ${taken ? `<button class="cancel-button" onclick="undoMedication(${med.id}, '${mealTime}')" style="margin-top: 5px; width: 100%; padding: 8px; font-size: 14px;">ğŸ”„ å–ã‚Šæ¶ˆã—</button>` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        // è–¬ã‚’æœç”¨
        function takeMedication(medId, mealTime) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            // åœ¨åº«ã‚’æ¸›ã‚‰ã™
            med.stock -= 1;
            localStorage.setItem('medications', JSON.stringify(medications));
            
            // å±¥æ­´ã«è¿½åŠ 
            const historyItem = {
                medicationId: medId,
                medicationName: med.name,
                dosage: med.dosage,
                takenAt: new Date().toISOString(),
                mealTime: mealTime
            };
            history.push(historyItem);
            localStorage.setItem('history', JSON.stringify(history));
            
            // UIã‚’æ›´æ–°
            updateTodayMedications();
            checkStockWarnings();
        }
        
        // ä»Šæ—¥æœç”¨æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        function isTakenToday(medId, mealTime) {
            const today = new Date().toDateString();
            return history.some(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled; // å–ã‚Šæ¶ˆã•ã‚Œã¦ã„ãªã„å±¥æ­´ã®ã¿
            });
        }
        
        // æœç”¨è¨˜éŒ²ã®å–ã‚Šæ¶ˆã—ï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰ï¼‰
        function undoMedication(medId, mealTime) {
            if (!confirm('æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿåœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            const today = new Date().toDateString();
            const historyItem = history.find(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled;
            });
            
            if (historyItem) {
                // å±¥æ­´ã‚’å–ã‚Šæ¶ˆã—æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // åœ¨åº«ã‚’æˆ»ã™
                const med = medications.find(m => m.id === medId);
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                checkStockWarnings();
                
                alert('âœ… æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚åœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã—ãŸã€‚');
            }
        }
        
        // å±¥æ­´ã‹ã‚‰ã®å–ã‚Šæ¶ˆã—
        function undoHistoryItem(medId, takenAt, mealTime) {
            if (!confirm('ã“ã®æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿåœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            const historyItem = history.find(h => 
                h.medicationId === medId && 
                h.takenAt === takenAt && 
                h.mealTime === mealTime &&
                !h.cancelled
            );
            
            if (historyItem) {
                // å±¥æ­´ã‚’å–ã‚Šæ¶ˆã—æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // åœ¨åº«ã‚’æˆ»ã™
                const med = medications.find(m => m.id === parseInt(medId));
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                updateHistoryList();
                checkStockWarnings();
                
                alert('âœ… æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚åœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã—ãŸã€‚');
            }
        }
        
        // åœ¨åº«è­¦å‘Šã‚’ãƒã‚§ãƒƒã‚¯
        function checkStockWarnings() {
            const container = document.getElementById('stock-warnings');
            container.innerHTML = '';
            
            const warnings = medications.filter(med => med.stock < 7);
            if (warnings.length > 0) {
                warnings.forEach(med => {
                    const warning = document.createElement('div');
                    warning.className = 'stock-warning';
                    warning.textContent = `âš ï¸ ${med.name}ã®åœ¨åº«ãŒæ®‹ã‚Š${med.stock}å€‹ã§ã™ã€‚é€šé™¢ã‚’ãŠå¿˜ã‚Œãªãï¼`;
                    container.appendChild(warning);
                });
            }
        }
        
        // è–¬ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateMedicationsList() {
            const container = document.getElementById('medications-list');
            container.innerHTML = '';
            
            if (medications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">è–¬ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            medications.forEach(med => {
                const card = document.createElement('div');
                card.className = 'medication-card';
                card.innerHTML = `
                    <div class="medication-name">${med.name}</div>
                    <div class="medication-info">${med.dosage} - ${med.frequency}</div>
                    <div class="medication-info">åœ¨åº«: ${med.stock}å€‹</div>
                    ${med.purpose ? `<div class="medication-info">ç”¨é€”: ${med.purpose}</div>` : ''}
                    <div class="medication-actions">
                        <button class="edit-button" onclick="showEditModal(${med.id})">ğŸ“ ç·¨é›†</button>
                        <button class="delete-button" onclick="deleteMedication(${med.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // å±¥æ­´ã‚’æ›´æ–°
        function updateHistoryList() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æœè–¬å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // å–ã‚Šæ¶ˆã•ã‚Œã¦ã„ãªã„å±¥æ­´ã®ã¿è¡¨ç¤º
            const activeHistory = history.filter(h => !h.cancelled);
            
            if (activeHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æœè–¬å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedHistory = {};
            activeHistory.slice().reverse().forEach(h => {
                const date = new Date(h.takenAt).toLocaleDateString('ja-JP');
                if (!groupedHistory[date]) {
                    groupedHistory[date] = [];
                }
                groupedHistory[date].push(h);
            });
            
            Object.entries(groupedHistory).forEach(([date, items]) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-meds">
                        ${items.map(item => {
                            const photoIcon = item.photoVerified ? 'ğŸ“¸' : '';
                            const time = new Date(item.takenAt).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <span>${photoIcon} ${item.medicationName} (${item.mealTime}) - ${time}</span>
                                    <button class="cancel-button" onclick="undoHistoryItem('${item.medicationId}', '${item.takenAt}', '${item.mealTime}')" 
                                            style="padding: 2px 8px; font-size: 12px; margin-left: 10px;">ğŸ”„ å–ã‚Šæ¶ˆã—</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }
        
        // é€šçŸ¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        function scheduleNotifications(medication) {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // æœè–¬æ™‚é–“ã®é€šçŸ¥ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            setMedicationReminders(medication);
        }
        
        // æœè–¬ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®è¨­å®š
        function setMedicationReminders(medication) {
            const frequency = medication.frequency;
            const times = [];
            
            // æœç”¨é »åº¦ã«å¿œã˜ã¦é€šçŸ¥æ™‚é–“ã‚’è¨­å®š
            switch(frequency) {
                case 'æ¯é£Ÿå¾Œ':
                    times.push(timeSettings.morning, timeSettings.lunch, timeSettings.dinner);
                    break;
                case 'æœé£Ÿå¾Œ':
                    times.push(timeSettings.morning);
                    break;
                case 'æ˜¼é£Ÿå¾Œ':
                    times.push(timeSettings.lunch);
                    break;
                case 'å¤•é£Ÿå¾Œ':
                    times.push(timeSettings.dinner);
                    break;
                case 'æœå¤•é£Ÿå¾Œ':
                    times.push(timeSettings.morning, timeSettings.dinner);
                    break;
                case 'å°±å¯å‰':
                    times.push(timeSettings.bedtime);
                    break;
            }
            
            // å„æ™‚é–“ã«å¯¾ã—ã¦é€šçŸ¥ã‚’è¨­å®š
            times.forEach(time => {
                scheduleNotificationAtTime(medication, time);
            });
        }
        
        // æŒ‡å®šæ™‚é–“ã«é€šçŸ¥ã‚’è¨­å®š
        function scheduleNotificationAtTime(medication, timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const now = new Date();
            const scheduledTime = new Date();
            scheduledTime.setHours(hours, minutes, 0, 0);
            
            // ã‚‚ã—ä»Šæ—¥ã®æ™‚é–“ãŒéãã¦ã„ãŸã‚‰æ˜æ—¥ã«è¨­å®š
            if (scheduledTime <= now) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }
            
            const timeUntilNotification = scheduledTime.getTime() - now.getTime();
            
            setTimeout(() => {
                showMedicationNotification(medication, timeString);
                // ç¿Œæ—¥ä»¥é™ã‚‚ç¶™ç¶šã™ã‚‹ãŸã‚å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                setTimeout(() => {
                    scheduleNotificationAtTime(medication, timeString);
                }, 24 * 60 * 60 * 1000); // 24æ™‚é–“å¾Œ
            }, timeUntilNotification);
        }
        
        // è–¬ã®é€šçŸ¥ã‚’è¡¨ç¤º
        function showMedicationNotification(medication, time) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`ğŸ’Š ãŠè–¬ã®æ™‚é–“ã§ã™`, {
                    body: `${medication.name} (${medication.dosage}) ã‚’æœç”¨ã—ã¦ãã ã•ã„`,
                    icon: 'ğŸ’Š',
                    badge: 'ğŸ’Š',
                    tag: `medication-${medication.id}`,
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'take',
                            title: 'æœç”¨æ¸ˆã¿'
                        },
                        {
                            action: 'later',
                            title: 'å¾Œã§'
                        }
                    ]
                });
                
                notification.onclick = function() {
                    window.focus();
                    // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
                    showPage('home');
                    this.close();
                };
                
                // 10ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
                setTimeout(() => {
                    notification.close();
                }, 10000);
            }
        }
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        function checkLowStockNotifications() {
            medications.forEach(med => {
                if (med.stock <= 7 && med.stock > 0) {
                    // 1æ—¥1å›ã ã‘é€šçŸ¥ï¼ˆæœ€å¾Œã®é€šçŸ¥ã‹ã‚‰24æ™‚é–“çµŒéã—ã¦ã„ãŸã‚‰ï¼‰
                    const lastNotified = localStorage.getItem(`lastStockNotify-${med.id}`);
                    const now = Date.now();
                    
                    if (!lastNotified || (now - parseInt(lastNotified)) > 24 * 60 * 60 * 1000) {
                        showLowStockNotification(med);
                        localStorage.setItem(`lastStockNotify-${med.id}`, now.toString());
                    }
                }
            });
        }
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’è¡¨ç¤º
        function showLowStockNotification(medication) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`âš ï¸ è–¬ã®åœ¨åº«ãŒå°‘ãªããªã£ã¦ã„ã¾ã™`, {
                    body: `${medication.name}ã®åœ¨åº«ãŒæ®‹ã‚Š${medication.stock}å€‹ã§ã™ã€‚é€šé™¢ã®æº–å‚™ã‚’ã—ã¦ãã ã•ã„ã€‚`,
                    icon: 'âš ï¸',
                    badge: 'âš ï¸',
                    tag: `stock-${medication.id}`,
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    showPage('medications');
                    this.close();
                };
            }
        }
        
        // åˆæœŸåŒ–
        updateTodayMedications();
        checkStockWarnings();
        
        // Service Workerã®ç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker ç™»éŒ²å¤±æ•—:', error);
                    });
            });
        }
        
        // é€šçŸ¥æ¨©é™ã®è¦æ±‚
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // æ—¢å­˜ã®è–¬ã«å¯¾ã—ã¦é€šçŸ¥ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        medications.forEach(medication => {
            setMedicationReminders(medication);
        });
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        checkLowStockNotifications();
        
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‡¦ç†
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é˜²ã
            e.preventDefault();
            // å¾Œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
            deferredPrompt = e;
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #2196F3;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 9999;
                cursor: pointer;
            `;
            installBanner.innerHTML = 'ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã™ï¼';
            installBanner.onclick = installApp;
            document.body.appendChild(installBanner);
            
            // 10ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
            setTimeout(() => {
                if (installBanner.parentNode) {
                    installBanner.parentNode.removeChild(installBanner);
                }
            }, 10000);
        }
        
        function installApp() {
            if (deferredPrompt) {
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                deferredPrompt.prompt();
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã‚’å¾…ã¤
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å—ã‘å…¥ã‚Œã¾ã—ãŸ');
                    } else {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ‹’å¦ã—ã¾ã—ãŸ');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        async function showCameraModal(medId, mealTime) {
            currentMedId = medId;
            currentMealTime = mealTime;
            
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-video');
            const capturedImage = document.getElementById('captured-image');
            const analysisResult = document.getElementById('analysis-result');
            const confirmBtn = document.getElementById('confirm-btn');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            
            // ãƒªã‚»ãƒƒãƒˆ
            capturedImage.style.display = 'none';
            video.style.display = 'block';
            analysisResult.style.display = 'none';
            confirmBtn.style.display = 'none';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                });
                video.srcObject = cameraStream;
                modal.style.display = 'block';
            } catch (err) {
                alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
            }
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hideCameraModal() {
            const modal = document.getElementById('camera-modal');
            modal.style.display = 'none';
            
            // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            currentMedId = null;
            currentMealTime = null;
        }
        
        // å†™çœŸæ’®å½±
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const capturedImage = document.getElementById('captured-image');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’å‹•ç”»ã®ã‚µã‚¤ã‚ºã«è¨­å®š
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // å‹•ç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            // æ’®å½±ã—ãŸç”»åƒã‚’è¡¨ç¤º
            capturedImage.src = imageDataUrl;
            capturedImage.style.display = 'block';
            video.style.display = 'none';
            
            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'block';
            
            // ç”»åƒè§£æã‚’å®Ÿè¡Œ
            analyzeImage(imageDataUrl);
        }
        
        // æ’®ã‚Šç›´ã—
        function retakePhoto() {
            const video = document.getElementById('camera-video');
            const capturedImage = document.getElementById('captured-image');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            const analysisResult = document.getElementById('analysis-result');
            const confirmBtn = document.getElementById('confirm-btn');
            
            // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            capturedImage.style.display = 'none';
            video.style.display = 'block';
            analysisResult.style.display = 'none';
            confirmBtn.style.display = 'none';
            
            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
        }
        
        // é«˜åº¦ãªç”»åƒè§£æ
        async function analyzeImage(imageDataUrl) {
            const analysisResult = document.getElementById('analysis-result');
            const confirmBtn = document.getElementById('confirm-btn');
            
            // è§£æä¸­ã®è¡¨ç¤º
            analysisResult.innerHTML = `
                <div>
                    ğŸ¤– AIç”»åƒèªè­˜ã‚’å®Ÿè¡Œä¸­...<br>
                    <div style="margin: 10px 0;">
                        <div style="width: 100%; background: #ddd; border-radius: 10px; overflow: hidden;">
                            <div id="progress-bar" style="width: 0%; height: 8px; background: #4CAF50; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    è¤‡æ•°ã®AIã‚¨ãƒ³ã‚¸ãƒ³ã§è–¬ã‚·ãƒ¼ãƒˆã‚’è§£æä¸­...
                </div>
            `;
            analysisResult.className = 'analysis-result';
            analysisResult.style.display = 'block';
            
            try {
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                updateProgress(20);
                
                // è¤‡æ•°ã®ç”»åƒèªè­˜ã‚’ä¸¦è¡Œå®Ÿè¡Œ
                const results = await Promise.allSettled([
                    analyzeWithComputerVision(imageDataUrl),
                    analyzeWithOpenAI(imageDataUrl),
                    analyzeWithLocalAI(imageDataUrl)
                ]);
                
                updateProgress(80);
                
                // çµæœã‚’çµ±åˆã—ã¦æœ€çµ‚åˆ¤å®š
                const finalResult = combineAnalysisResults(results);
                
                updateProgress(100);
                
                // çµæœè¡¨ç¤º
                setTimeout(() => {
                    displayAnalysisResult(finalResult, analysisResult, confirmBtn);
                }, 500);
                
            } catch (error) {
                console.error('ç”»åƒè§£æã‚¨ãƒ©ãƒ¼:', error);
                displayFallbackResult(analysisResult, confirmBtn);
            }
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }
        
        // Google Vision API ã«ã‚ˆã‚‹é«˜åº¦è§£æ
        async function analyzeWithComputerVision(imageDataUrl) {
            const config = API_CONFIGS.googleVision;
            
            if (config.enabled && config.apiKey !== 'YOUR_GOOGLE_VISION_API_KEY') {
                try {
                    const base64Image = imageDataUrl.split(',')[1];
                    
                    const requestBody = {
                        requests: [{
                            image: { content: base64Image },
                            features: config.features
                        }]
                    };
                    
                    const response = await fetch(`${config.endpoint}?key=${config.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const result = await response.json();
                    return analyzeGoogleVisionResult(result);
                    
                } catch (error) {
                    console.error('Google Vision API ã‚¨ãƒ©ãƒ¼:', error);
                    return fallbackLocalAnalysis(imageDataUrl, 'ComputerVision');
                }
            } else {
                // ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                return fallbackLocalAnalysis(imageDataUrl, 'ComputerVision');
            }
        }
        
        // Google Visionçµæœã®è§£æ
        function analyzeGoogleVisionResult(result) {
            if (!result.responses || !result.responses[0]) {
                throw new Error('Invalid API response');
            }
            
            const response = result.responses[0];
            const objects = response.localizedObjectAnnotations || [];
            const labels = response.labelAnnotations || [];
            const texts = response.textAnnotations || [];
            
            // è–¬é–¢é€£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ¤œå‡º
            const medicationKeywords = ['pill', 'tablet', 'capsule', 'medication', 'medicine', 'drug', 'pharmaceutical'];
            const packagingKeywords = ['blister', 'pack', 'bottle', 'container', 'packaging'];
            
            let medicationScore = 0;
            let emptyScore = 0;
            
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡ºã®åˆ†æ
            objects.forEach(obj => {
                const name = obj.name.toLowerCase();
                if (medicationKeywords.some(keyword => name.includes(keyword))) {
                    medicationScore += obj.score;
                }
                if (packagingKeywords.some(keyword => name.includes(keyword))) {
                    emptyScore += obj.score * 0.5;
                }
            });
            
            // ãƒ©ãƒ™ãƒ«ã®åˆ†æ
            labels.forEach(label => {
                const description = label.description.toLowerCase();
                if (medicationKeywords.some(keyword => description.includes(keyword))) {
                    medicationScore += label.score * 0.7;
                }
                if (['empty', 'vacant', 'hollow'].some(keyword => description.includes(keyword))) {
                    emptyScore += label.score;
                }
            });
            
            // ãƒ†ã‚­ã‚¹ãƒˆæ¤œå‡ºï¼ˆè–¬åãªã©ï¼‰
            let hasText = texts.length > 1; // texts[0]ã¯å…¨ä½“ãƒ†ã‚­ã‚¹ãƒˆ
            
            const isEmpty = emptyScore > medicationScore || (medicationScore < 0.3 && !hasText);
            const confidence = Math.min((emptyScore + (1 - medicationScore)) * 100, 95);
            
            return {
                api: 'GoogleVision',
                isEmpty: isEmpty,
                confidence: Math.round(confidence),
                details: `è–¬æ¤œå‡º: ${Math.round(medicationScore * 100)}%, ç©ºå®¹å™¨: ${Math.round(emptyScore * 100)}%`
            };
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        async function fallbackLocalAnalysis(imageDataUrl, apiName) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        // ç”»åƒã®æ˜åº¦ã‚’åˆ†æ
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const brightness = calculateBrightness(imageData);
                        
                        // ã‚¨ãƒƒã‚¸å¯†åº¦ã®è¨ˆç®—
                        const edgeDensity = calculateEdgeDensity(imageData);
                        
                        // è‰²ã®å‡ä¸€æ€§ã‚’è¨ˆç®—
                        const colorUniformity = calculateColorUniformity(imageData);
                        
                        // ç·åˆåˆ¤å®šï¼ˆç©ºã®ã‚·ãƒ¼ãƒˆã¯æ˜ã‚‹ãã€ã‚¨ãƒƒã‚¸ãŒå°‘ãªãã€è‰²ãŒå‡ä¸€ï¼‰
                        const emptyScore = (brightness / 255) * 0.4 + 
                                         (1 - edgeDensity) * 0.3 + 
                                         colorUniformity * 0.3;
                        
                        const isEmpty = emptyScore > 0.6;
                        const confidence = Math.min(emptyScore * 100, 95);
                        
                        resolve({
                            api: apiName,
                            isEmpty: isEmpty,
                            confidence: Math.round(confidence),
                            details: `æ˜åº¦: ${Math.round(brightness)}, ã‚¨ãƒƒã‚¸å¯†åº¦: ${Math.round(edgeDensity * 100)}%, å‡ä¸€æ€§: ${Math.round(colorUniformity * 100)}%`
                        });
                    };
                    
                    img.src = imageDataUrl;
                }, 800);
            });
        }
        
        // ã‚¨ãƒƒã‚¸å¯†åº¦è¨ˆç®—
        function calculateEdgeDensity(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            let edgeCount = 0;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const current = data[idx] + data[idx + 1] + data[idx + 2];
                    const right = data[idx + 4] + data[idx + 5] + data[idx + 6];
                    const bottom = data[idx + width * 4] + data[idx + width * 4 + 1] + data[idx + width * 4 + 2];
                    
                    if (Math.abs(current - right) > 30 || Math.abs(current - bottom) > 30) {
                        edgeCount++;
                    }
                }
            }
            
            return edgeCount / ((width - 2) * (height - 2));
        }
        
        // è‰²ã®å‡ä¸€æ€§è¨ˆç®—
        function calculateColorUniformity(imageData) {
            const data = imageData.data;
            let totalVariance = 0;
            let pixelCount = 0;
            
            // å¹³å‡è‰²ã‚’è¨ˆç®—
            let avgR = 0, avgG = 0, avgB = 0;
            for (let i = 0; i < data.length; i += 4) {
                avgR += data[i];
                avgG += data[i + 1];
                avgB += data[i + 2];
                pixelCount++;
            }
            avgR /= pixelCount;
            avgG /= pixelCount;
            avgB /= pixelCount;
            
            // åˆ†æ•£ã‚’è¨ˆç®—
            for (let i = 0; i < data.length; i += 4) {
                const varR = Math.pow(data[i] - avgR, 2);
                const varG = Math.pow(data[i + 1] - avgG, 2);
                const varB = Math.pow(data[i + 2] - avgB, 2);
                totalVariance += (varR + varG + varB) / 3;
            }
            
            const variance = totalVariance / pixelCount;
            return Math.max(0, 1 - (variance / 10000)); // æ­£è¦åŒ–
        }
        
        // OpenAI Vision API (GPT-4V)
        async function analyzeWithOpenAI(imageDataUrl) {
            const config = API_CONFIGS.openaiVision;
            
            if (config.enabled && config.apiKey !== 'YOUR_OPENAI_API_KEY') {
                try {
                    const requestBody = {
                        model: config.model,
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `ã“ã®ç”»åƒã¯è–¬ã®ã‚·ãƒ¼ãƒˆã€è–¬è¢‹ã€ã¾ãŸã¯è–¬ç“¶ã®å†™çœŸã§ã™ã€‚ä»¥ä¸‹ã®ç‚¹ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š
                                        1. è–¬ãŒç©ºã®çŠ¶æ…‹ï¼ˆæœç”¨æ¸ˆã¿ï¼‰ã‹ã©ã†ã‹
                                        2. è–¬ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹
                                        3. åˆ¤å®šã®ä¿¡é ¼åº¦ï¼ˆ0-100%ï¼‰
                                        
                                        JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
                                        {"isEmpty": boolean, "confidence": number, "reasoning": "åˆ¤å®šç†ç”±"}`
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: imageDataUrl
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 300
                    };
                    
                    const response = await fetch(config.endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    const result = await response.json();
                    return parseOpenAIResult(result);
                    
                } catch (error) {
                    console.error('OpenAI Vision API ã‚¨ãƒ©ãƒ¼:', error);
                    return fallbackLocalAnalysis(imageDataUrl, 'OpenAI');
                }
            } else {
                return fallbackLocalAnalysis(imageDataUrl, 'OpenAI');
            }
        }
        
        // OpenAIçµæœã®è§£æ
        function parseOpenAIResult(result) {
            try {
                const content = result.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    return {
                        api: 'OpenAI_GPT4V',
                        isEmpty: parsed.isEmpty,
                        confidence: Math.min(parsed.confidence, 95),
                        details: parsed.reasoning || 'AIè§£æå®Œäº†'
                    };
                } else {
                    throw new Error('Invalid JSON response');
                }
            } catch (error) {
                console.error('OpenAIçµæœè§£æã‚¨ãƒ©ãƒ¼:', error);
                return {
                    api: 'OpenAI_GPT4V',
                    isEmpty: false,
                    confidence: 30,
                    details: 'AIè§£æã‚¨ãƒ©ãƒ¼'
                };
            }
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«AIåˆ†æ
        async function analyzeWithLocalAI(imageDataUrl) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // è‰²åˆ†å¸ƒãƒ™ãƒ¼ã‚¹ã®åˆ¤å®š
                    const colorAnalysis = analyzeColorDistribution(imageDataUrl);
                    
                    resolve({
                        api: 'LocalAI',
                        isEmpty: colorAnalysis.whiteRatio > 0.6,
                        confidence: colorAnalysis.whiteRatio * 100,
                        details: `ç™½è‰²ã®å‰²åˆ: ${Math.round(colorAnalysis.whiteRatio * 100)}%`
                    });
                }, 600);
            });
        }
        
        // æ˜åº¦è¨ˆç®—
        function calculateBrightness(imageData) {
            const data = imageData.data;
            let totalBrightness = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                totalBrightness += (r + g + b) / 3;
            }
            
            return totalBrightness / (data.length / 4);
        }
        
        // ã‚¨ãƒƒã‚¸æ¤œå‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function detectEdges(imageDataUrl) {
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚ˆã‚Šè¤‡é›‘ãªã‚¨ãƒƒã‚¸æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨
            return Math.floor(Math.random() * 100); // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
        }
        
        // è‰²åˆ†å¸ƒåˆ†æ
        function analyzeColorDistribution(imageDataUrl) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            return new Promise((resolve) => {
                img.onload = function() {
                    canvas.width = 100; // ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ç”¨ã«å°ã•ã
                    canvas.height = 100;
                    ctx.drawImage(img, 0, 0, 100, 100);
                    
                    const imageData = ctx.getImageData(0, 0, 100, 100);
                    const data = imageData.data;
                    let whitePixels = 0;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // ç™½ã£ã½ã„ãƒ”ã‚¯ã‚»ãƒ«ã®åˆ¤å®š
                        if (r > 200 && g > 200 && b > 200) {
                            whitePixels++;
                        }
                    }
                    
                    resolve({
                        whiteRatio: whitePixels / (data.length / 4)
                    });
                };
                
                img.src = imageDataUrl;
            });
        }
        
        // è§£æçµæœã®çµ±åˆ
        function combineAnalysisResults(results) {
            const validResults = results
                .filter(result => result.status === 'fulfilled')
                .map(result => result.value);
            
            if (validResults.length === 0) {
                return {
                    isEmpty: false,
                    confidence: 0,
                    message: 'AIè§£æã«å¤±æ•—ã—ã¾ã—ãŸ'
                };
            }
            
            // é‡ã¿ä»˜ãæŠ•ç¥¨
            const weights = { ComputerVision: 0.5, OpenAI: 0.3, LocalAI: 0.2 };
            let weightedScore = 0;
            let totalWeight = 0;
            
            validResults.forEach(result => {
                const weight = weights[result.api] || 0.1;
                weightedScore += (result.isEmpty ? 1 : 0) * weight * (result.confidence / 100);
                totalWeight += weight;
            });
            
            const finalScore = weightedScore / totalWeight;
            const isEmpty = finalScore > 0.6;
            const confidence = Math.round(finalScore * 100);
            
            return {
                isEmpty,
                confidence,
                results: validResults,
                message: isEmpty ? 
                    `${validResults.length}ã¤ã®AIã‚¨ãƒ³ã‚¸ãƒ³ãŒç©ºã®è–¬ã‚·ãƒ¼ãƒˆã‚’ç¢ºèª` :
                    `${validResults.length}ã¤ã®AIã‚¨ãƒ³ã‚¸ãƒ³ãŒè–¬ã®æ®‹å­˜ã‚’æ¤œå‡º`
            };
        }
        
        // çµæœè¡¨ç¤º
        function displayAnalysisResult(result, analysisResult, confirmBtn) {
            if (result.isEmpty && result.confidence > 60) {
                analysisResult.innerHTML = `
                    <div class="success-message">
                        âœ… ${result.message}<br>
                        <small>ä¿¡é ¼åº¦: ${result.confidence}%</small><br>
                        <details style="margin-top: 10px; text-align: left;">
                            <summary>è©³ç´°è§£æçµæœ</summary>
                            ${result.results.map(r => `
                                <div style="margin: 5px 0; font-size: 12px;">
                                    <strong>${r.api}:</strong> ${r.isEmpty ? 'ç©º' : 'è–¬æœ‰ã‚Š'} 
                                    (${Math.round(r.confidence)}%) - ${r.details}
                                </div>
                            `).join('')}
                        </details>
                    </div>
                `;
                analysisResult.className = 'analysis-result success-message';
                confirmBtn.style.display = 'block';
            } else {
                analysisResult.innerHTML = `
                    <div class="warning-message">
                        âš ï¸ ${result.message}<br>
                        <small>ä¿¡é ¼åº¦: ${result.confidence}%</small><br>
                        è–¬ã‚’ã™ã¹ã¦æœç”¨ã—ã¦ã‹ã‚‰å†åº¦æ’®å½±ã—ã¦ãã ã•ã„ã€‚<br>
                        <details style="margin-top: 10px; text-align: left;">
                            <summary>è©³ç´°è§£æçµæœ</summary>
                            ${result.results.map(r => `
                                <div style="margin: 5px 0; font-size: 12px;">
                                    <strong>${r.api}:</strong> ${r.isEmpty ? 'ç©º' : 'è–¬æœ‰ã‚Š'} 
                                    (${Math.round(r.confidence)}%) - ${r.details}
                                </div>
                            `).join('')}
                        </details>
                    </div>
                `;
                analysisResult.className = 'analysis-result warning-message';
                confirmBtn.style.display = 'none';
            }
            
            analysisResult.style.display = 'block';
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœ
        function displayFallbackResult(analysisResult, confirmBtn) {
            analysisResult.innerHTML = `
                <div class="warning-message">
                    âš ï¸ AIè§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ<br>
                    æ‰‹å‹•ã§ç¢ºèªã—ã¦ã€è–¬ã‚’æœç”¨ã—ã¦ã„ã‚Œã°ã€Œæœç”¨ã‚’ç¢ºèªã€ã‚’æŠ¼ã—ã¦ãã ã•ã„
                </div>
            `;
            analysisResult.className = 'analysis-result warning-message';
            confirmBtn.style.display = 'block';
            analysisResult.style.display = 'block';
        }
        
        // æœç”¨ç¢ºèª
        function confirmMedication() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                // åœ¨åº«ã‚’æ¸›ã‚‰ã™
                med.stock -= 1;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // å±¥æ­´ã«è¿½åŠ ï¼ˆå†™çœŸç¢ºèªæ¸ˆã¿ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: med.dosage,
                    takenAt: new Date().toISOString(),
                    mealTime: currentMealTime,
                    photoVerified: true
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                checkStockWarnings();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                hideCameraModal();
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                alert('ğŸ“¸ å†™çœŸã§æœç”¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸï¼');
            }
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ç”¨é€”å…¥åŠ›ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleCustomPurpose() {
            const purposeSelect = document.getElementById('med-purpose');
            const customInput = document.getElementById('med-purpose-custom');
            
            if (purposeSelect.value === 'other') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // ç”¨é€”ã®å€¤ã‚’å–å¾—
        function getPurposeValue() {
            const purposeSelect = document.getElementById('med-purpose');
            const customInput = document.getElementById('med-purpose-custom');
            
            if (purposeSelect.value === 'other') {
                return customInput.value;
            } else {
                return purposeSelect.value;
            }
        }
        
        // è–¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showEditModal(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            document.getElementById('edit-med-id').value = med.id;
            document.getElementById('edit-med-name').value = med.name;
            document.getElementById('edit-med-dosage').value = med.dosage;
            document.getElementById('edit-med-frequency').value = med.frequency;
            document.getElementById('edit-med-stock').value = med.stock;
            
            // ç”¨é€”ã®è¨­å®š
            const purposeSelect = document.getElementById('edit-med-purpose');
            const customInput = document.getElementById('edit-med-purpose-custom');
            
            if (med.purpose && !Array.from(purposeSelect.options).find(opt => opt.value === med.purpose)) {
                purposeSelect.value = 'other';
                customInput.style.display = 'block';
                customInput.value = med.purpose;
            } else {
                purposeSelect.value = med.purpose || '';
                customInput.style.display = 'none';
                customInput.value = '';
            }
            
            document.getElementById('edit-modal').style.display = 'block';
        }
        
        // è–¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        function hideEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-medication-form').reset();
        }
        
        // ç·¨é›†æ™‚ã®ã‚«ã‚¹ã‚¿ãƒ ç”¨é€”å…¥åŠ›ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleEditCustomPurpose() {
            const purposeSelect = document.getElementById('edit-med-purpose');
            const customInput = document.getElementById('edit-med-purpose-custom');
            
            if (purposeSelect.value === 'other') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // ç·¨é›†æ™‚ã®ç”¨é€”ã®å€¤ã‚’å–å¾—
        function getEditPurposeValue() {
            const purposeSelect = document.getElementById('edit-med-purpose');
            const customInput = document.getElementById('edit-med-purpose-custom');
            
            if (purposeSelect.value === 'other') {
                return customInput.value;
            } else {
                return purposeSelect.value;
            }
        }
        
        // è–¬æƒ…å ±ã®ç·¨é›†
        document.getElementById('edit-medication-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const medId = parseInt(document.getElementById('edit-med-id').value);
            const medIndex = medications.findIndex(m => m.id === medId);
            
            if (medIndex !== -1) {
                medications[medIndex] = {
                    ...medications[medIndex],
                    name: document.getElementById('edit-med-name').value,
                    dosage: document.getElementById('edit-med-dosage').value,
                    frequency: document.getElementById('edit-med-frequency').value,
                    stock: parseInt(document.getElementById('edit-med-stock').value),
                    purpose: getEditPurposeValue()
                };
                
                localStorage.setItem('medications', JSON.stringify(medications));
                
                hideEditModal();
                updateMedicationsList();
                
                // é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†è¨­å®š
                setMedicationReminders(medications[medIndex]);
                
                alert('âœ… è–¬æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            }
        });
        
        // è–¬ã®å‰Šé™¤
        function deleteMedication(medId) {
            if (!confirm('æœ¬å½“ã«ã“ã®è–¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            medications = medications.filter(m => m.id !== medId);
            localStorage.setItem('medications', JSON.stringify(medications));
            
            updateMedicationsList();
            alert('âœ… è–¬ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
        
        // å®šæœŸçš„ã«ç”»é¢ã‚’æ›´æ–°ï¼ˆ1åˆ†ã”ã¨ï¼‰
        setInterval(() => {
            if (document.getElementById('home-page').classList.contains('active')) {
                updateTodayMedications();
                checkStockWarnings();
            }
            // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚‚å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
            checkLowStockNotifications();
        }, 60000);
    </script>
</body>
</html>