<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü - ÊúçËñ¨ÁÆ°ÁêÜ„Ç¢„Éó„É™ v2.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234CAF50'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3Eüíä%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f4f8;
            color: #2d3748;
            padding-bottom: 70px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        
        .tab.active {
            color: #667eea;
            font-weight: bold;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .medication-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .medication-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .medication-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .take-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .take-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .take-button.taken {
            background-color: #ddd;
            color: #666;
            cursor: not-allowed;
        }
        
        .add-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .save-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .cancel-button {
            background-color: #f44336;
            color: white;
        }
        
        .history-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-date {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-meds {
            color: #666;
            font-size: 14px;
        }
        
        .history-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
            cursor: pointer;
            border: 2px solid #ddd;
        }
        
        .history-photo:hover {
            border-color: #4CAF50;
        }
        
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .history-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .gallery-item {
            position: relative;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .gallery-item-info {
            padding: 10px;
            font-size: 12px;
        }
        
        .gallery-item-date {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .gallery-item-med {
            color: #666;
        }
        
        .stock-warning {
            background-color: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .camera-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            width: 100%;
        }
        
        .camera-modal .modal-content {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .camera-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .camera-video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-canvas {
            display: none;
        }
        
        .captured-image {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .camera-controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .capture-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .capture-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .retake-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        
        .retake-button:hover {
            background-color: #cbd5e0;
        }
        
        .analysis-result {
            background: #edf2f7;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }
        
        .success-message {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .warning-message {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }
        
        .form-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .form-message.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .form-message.error {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }
        
        .form-message.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü</h1>
    </div>
    
    <!-- Ë™çË®ºÁîªÈù¢ -->
    <div id="auth-container" style="display: none;">
        <div class="container">
            <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
            <div id="login-page" class="page active">
                <div class="medication-card">
                    <h2>üîê „É≠„Ç∞„Ç§„É≥</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-button">„É≠„Ç∞„Ç§„É≥</button>
                            <button type="button" onclick="showRegisterPage()" class="cancel-button">Êñ∞Ë¶èÁôªÈå≤</button>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="#" onclick="showPasswordReset()" style="color: #4CAF50; text-decoration: none;">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ„ÅØ„Åì„Å°„Çâ</a>
                        </div>
                    </form>
                    <div id="login-message" class="form-message"></div>
                </div>
            </div>

            <!-- Êñ∞Ë¶èÁôªÈå≤ÁîªÈù¢ -->
            <div id="register-page" class="page">
                <div class="medication-card">
                    <h2>üìù Êñ∞Ë¶èÁôªÈå≤</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="register-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" id="register-password" required minlength="6" placeholder="6ÊñáÂ≠ó‰ª•‰∏ä">
                        </div>
                        <div class="form-group">
                            <label for="register-password-confirm">„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</label>
                            <input type="password" id="register-password-confirm" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-button">ÁôªÈå≤</button>
                            <button type="button" onclick="showLoginPage()" class="cancel-button">„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã</button>
                        </div>
                    </form>
                    <div id="register-message" class="form-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™ÁîªÈù¢ -->
    <div id="app-container" style="display: none;">
        <div class="container">
            <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
            <div id="home-page" class="page active">
                <div id="stock-warnings"></div>
                <h2>‰ªäÊó•„ÅÆÊúçËñ¨</h2>
                <div id="today-medications"></div>
            </div>
        
        <!-- Ëñ¨ÁÆ°ÁêÜÁîªÈù¢ -->
        <div id="medications-page" class="page">
            <h2>ÁôªÈå≤Ê∏à„Åø„ÅÆËñ¨</h2>
            <div id="medications-list"></div>
        </div>
        
        <!-- Â±•Ê≠¥ÁîªÈù¢ -->
        <div id="history-page" class="page">
            <h2>ÊúçËñ¨Â±•Ê≠¥</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="showHistoryView('list')" id="list-view-btn" style="padding: 8px 15px; margin-right: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">üìã „É™„Çπ„ÉàË°®Á§∫</button>
                <button onclick="showHistoryView('gallery')" id="gallery-view-btn" style="padding: 8px 15px; background: #ddd; color: #666; border: none; border-radius: 5px; cursor: pointer;">üñºÔ∏è ÂÜôÁúü‰∏ÄË¶ß</button>
            </div>
            <div id="history-list"></div>
            <div id="history-gallery" style="display: none;"></div>
        </div>
        
        <!-- Ë®≠ÂÆöÁîªÈù¢ -->
        <div id="settings-page" class="page">
            <h2>Ë®≠ÂÆö</h2>
            
            <!-- GitHubÈÄ£Êê∫Ë®≠ÂÆö -->
            <div class="medication-card">
                <h3>üîÑ „Éá„Éº„Çø„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</h3>
                <p style="color: #666; margin-bottom: 15px;">GitHub„Å´„Éá„Éº„Çø„ÇíËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åó„Å¶Ë§áÊï∞Á´ØÊú´„ÅßÂêåÊúü„Åß„Åç„Åæ„Åô</p>
                
                <div id="github-status" style="margin-bottom: 15px;">
                    <div id="github-disconnected" style="display: block;">
                        <p style="color: #ff9800;">‚ùå GitHubÊú™ÈÄ£Êê∫</p>
                        <button onclick="connectGitHub()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">GitHubÈÄ£Êê∫„ÇíÈñãÂßã</button>
                    </div>
                    <div id="github-connected" style="display: none;">
                        <p style="color: #4CAF50;">‚úÖ GitHubÈÄ£Êê∫Ê∏à„Åø</p>
                        <div style="font-size: 14px; color: #666; margin: 10px 0;">
                            <div>„É¶„Éº„Ç∂„Éº: <span id="github-username"></span></div>
                            <div>„É™„Éù„Ç∏„Éà„É™: <span id="github-repo"></span></div>
                            <div>ÊúÄÁµÇÂêåÊúü: <span id="last-sync"></span></div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="manualBackup()" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ÊâãÂãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</button>
                            <button onclick="restoreFromGitHub()" style="background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">„Éá„Éº„ÇøÂæ©ÂÖÉ</button>
                            <button onclick="disconnectGitHub()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ÈÄ£Êê∫Ëß£Èô§</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÊôÇÈñìË®≠ÂÆö -->
            <div class="medication-card">
                <h3>‚è∞ È£ü‰∫ãÊôÇÈñì„ÅÆË®≠ÂÆö</h3>
                <p style="color: #666; margin-bottom: 15px;">ÊØéÈ£üÂæå„ÅÆÊúçËñ¨ÊôÇÈñì„ÇíË®≠ÂÆö„Åß„Åç„Åæ„Åô</p>
                <div class="form-group">
                    <label for="breakfast-time">ÊúùÈ£üÂæå„ÅÆÊôÇÈñì</label>
                    <input type="time" id="breakfast-time" value="09:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="lunch-time">ÊòºÈ£üÂæå„ÅÆÊôÇÈñì</label>
                    <input type="time" id="lunch-time" value="13:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="dinner-time">Â§ïÈ£üÂæå„ÅÆÊôÇÈñì</label>
                    <input type="time" id="dinner-time" value="19:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="bedtime">Â∞±ÂØùÂâç„ÅÆÊôÇÈñì</label>
                    <input type="time" id="bedtime" value="22:00" onchange="saveMealTimeSettings()">
                </div>
            </div>
            
            <!-- „É≠„Éº„Ç´„É´„Éá„Éº„ÇøÁÆ°ÁêÜ -->
            <div class="medication-card">
                <h3>üíæ „É≠„Éº„Ç´„É´„Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
                <p style="color: #666; margin-bottom: 15px;">Á´ØÊú´ÂÜÖ„ÅÆ„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éª„Ç§„É≥„Éù„Éº„Éà„Åß„Åç„Åæ„Åô</p>
                <div style="display: flex; gap: 10px;">
                    <button onclick="exportLocalData()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">„Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importLocalData(event)">
                    <button onclick="document.getElementById('import-file').click()" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">„Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</button>
                </div>
            </div>
            
            <!-- „Ç¢„Éó„É™ÊÉÖÂ†± -->
            <div class="medication-card">
                <h3>‚ÑπÔ∏è „Ç¢„Éó„É™ÊÉÖÂ†±</h3>
                <div style="color: #666; font-size: 14px; line-height: 1.5;">
                    <div>„Éê„Éº„Ç∏„Éß„É≥: 2.1</div>
                    <div>„Éá„Éº„Çø‰øùÂ≠òÂ†¥ÊâÄ: „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏</div>
                    <div>ÂÜôÁúü‰øùÊåÅÊúüÈñì: 3„É∂ÊúàÈñì</div>
                    <div style="margin-top: 10px;">
                        <p><strong>„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü</strong>„ÅØÊúçËñ¨ÁÆ°ÁêÜ„Çí„Çµ„Éù„Éº„Éà„Åô„ÇãPWA„Ç¢„Éó„É™„Åß„Åô„ÄÇ</p>
                        <p style="margin-top: 5px; font-size: 12px; color: #999;">
                            ‚Äª„Åì„ÅÆ„Ç¢„Éó„É™„ÅØÂåªÁôÇÊ©üÂô®„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂåªÁôÇÂà§Êñ≠„ÅØÂøÖ„ÅöÂåªÂ∏´„Å´„ÅîÁõ∏Ë´á„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- „É≠„Ç∞„Ç¢„Ç¶„Éà„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="medication-card">
                <h3>üö™ „Ç¢„Ç´„Ç¶„É≥„Éà</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="current-user-email" style="color: #666;"></span>
                    <button onclick="handleLogout()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Çø„Éñ„Éê„Éº -->
    <div class="tab-bar">
        <button class="tab active" onclick="showPage('home')">
            <div>üíä</div>
            <div>ÊúçÁî®</div>
        </button>
        <button class="tab" onclick="showPage('medications')">
            <div>üóÉÔ∏è</div>
            <div>Ëñ¨ÁÆ±</div>
        </button>
        <button class="tab" onclick="showPage('history')">
            <div>üìä</div>
            <div>Â±•Ê≠¥</div>
        </button>
        <button class="tab" onclick="showPage('settings')">
            <div>‚öôÔ∏è</div>
            <div>Ë®≠ÂÆö</div>
        </button>
    </div>
    
    <!-- ËøΩÂä†„Éú„Çø„É≥ -->
    <button class="add-button" onclick="showAddModal()">+</button>
    
    <!-- Ëñ¨ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3>Êñ∞„Åó„ÅÑËñ¨„ÇíËøΩÂä†</h3>
            <form id="add-medication-form">
                <div class="form-group">
                    <label for="med-name">Ëñ¨„ÅÆÂêçÂâç</label>
                    <input type="text" id="med-name" required>
                </div>
                <div class="form-group">
                    <label for="med-purpose">Ëñ¨„ÅÆÁî®ÈÄî</label>
                    <select id="med-purpose-select" onchange="toggleCustomPurpose()" style="width: 100%;">
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="È†≠Áóõ„ÉªËß£ÁÜ±">È†≠Áóõ„ÉªËß£ÁÜ±</option>
                        <option value="ËÉÉËÖ∏Ëñ¨">ËÉÉËÖ∏Ëñ¨</option>
                        <option value="È¢®ÈÇ™Ëñ¨">È¢®ÈÇ™Ëñ¨</option>
                        <option value="„Ç¢„É¨„É´„ÇÆ„Éº">„Ç¢„É¨„É´„ÇÆ„Éº</option>
                        <option value="„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà">„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà</option>
                        <option value="È´òË°ÄÂúß">È´òË°ÄÂúß</option>
                        <option value="Á≥ñÂ∞øÁóÖ">Á≥ñÂ∞øÁóÖ</option>
                        <option value="ÊäóÁîüÁâ©Ë≥™">ÊäóÁîüÁâ©Ë≥™</option>
                        <option value="Áù°Áú†Ëñ¨">Áù°Áú†Ëñ¨</option>
                        <option value="custom">„Åù„ÅÆ‰ªñÔºàËá™Áî±Ë®òÂÖ•Ôºâ</option>
                    </select>
                    <input type="text" id="med-purpose-custom" placeholder="Ëñ¨„ÅÆÁî®ÈÄî„ÇíÂÖ•Âäõ" style="display: none; margin-top: 10px; width: 100%;">
                </div>
                <div class="form-group">
                    <label for="med-dosage">Áî®ÈáèÔºà1Âõû„ÅÇ„Åü„ÇäÔºâ</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="med-dosage-number" required style="flex: 1;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                        <select id="med-dosage-unit" required style="flex: 1;">
                            <option value="Èå†">Èå†</option>
                            <option value="ÂåÖ">ÂåÖ</option>
                            <option value="ÊùØ">ÊùØ</option>
                            <option value="Êª¥">Êª¥</option>
                            <option value="mL">mL</option>
                            <option value="g">g</option>
                            <option value="ÂÄã">ÂÄã</option>
                            <option value="Á≤í">Á≤í</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="med-frequency">ÊúçÁî®È†ªÂ∫¶</label>
                    <select id="med-frequency" required>
                        <option value="ÊØéÈ£üÂæå">ÊØéÈ£üÂæå</option>
                        <option value="ÊúùÈ£üÂæå">ÊúùÈ£üÂæå</option>
                        <option value="ÊòºÈ£üÂæå">ÊòºÈ£üÂæå</option>
                        <option value="Â§ïÈ£üÂæå">Â§ïÈ£üÂæå</option>
                        <option value="ÊúùÂ§ïÈ£üÂæå">ÊúùÂ§ïÈ£üÂæå</option>
                        <option value="Â∞±ÂØùÂâç">Â∞±ÂØùÂâç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="med-stock">ÁèæÂú®„ÅÆÂú®Â∫´Êï∞</label>
                    <input type="number" id="med-stock" required>
                </div>
                <div class="form-group">
                    <label for="med-alert-threshold">Âú®Â∫´Ë≠¶Âëä„Åó„Åç„ÅÑÂÄ§</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="med-alert-threshold-select" onchange="toggleCustomThreshold()" style="flex: 1;">
                            <option value="1">ÊÆã„Çä1ÂÄã</option>
                            <option value="2">ÊÆã„Çä2ÂÄã</option>
                            <option value="3">ÊÆã„Çä3ÂÄã</option>
                            <option value="4">ÊÆã„Çä4ÂÄã</option>
                            <option value="5">ÊÆã„Çä5ÂÄã</option>
                            <option value="6">ÊÆã„Çä6ÂÄã</option>
                            <option value="7" selected>ÊÆã„Çä7ÂÄã</option>
                            <option value="8">ÊÆã„Çä8ÂÄã</option>
                            <option value="9">ÊÆã„Çä9ÂÄã</option>
                            <option value="10">ÊÆã„Çä10ÂÄã</option>
                            <option value="custom">„Åù„ÅÆ‰ªñÔºàÁõ¥Êé•ÂÖ•ÂäõÔºâ</option>
                        </select>
                        <input type="number" id="med-alert-threshold-custom" placeholder="ÂÄãÊï∞„ÇíÂÖ•Âäõ" min="1" style="display: none; width: 100px;">
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="save-button">‰øùÂ≠ò</button>
                    <button type="button" class="cancel-button" onclick="hideAddModal()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- „Ç´„É°„É©„É¢„Éº„ÉÄ„É´ -->
    <div id="camera-modal" class="modal camera-modal">
        <div class="modal-content">
            <h3>ÊúçÁî®ÂÜôÁúü„ÇíÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
            <div class="camera-container">
                <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoCapture(event)">
                <canvas id="camera-canvas" class="camera-canvas" style="display: none;"></canvas>
                <img id="captured-image" class="captured-image" style="display: none;">
                
                <div class="camera-controls">
                    <button id="capture-btn" class="capture-button" onclick="openCameraApp()">üì∑ ÊíÆÂΩ±</button>
                    <button id="retake-btn" class="retake-button" onclick="retakePhoto()" style="display: none;">üîÑ ÊíÆ„ÇäÁõ¥„Åó</button>
                </div>
                
                <div id="analysis-result" class="analysis-result" style="display: none;"></div>
            </div>
            
            <div id="medication-confirm-section" style="display: none;">
                <div class="medication-confirm-info">
                    <h4 id="confirm-med-name" style="margin-bottom: 10px;"></h4>
                    <div class="form-group">
                        <label for="confirm-dosage">ÊúçÁî®Êï∞Èáè</label>
                        <input type="number" id="confirm-dosage" min="1" value="1" style="width: 100px;">
                        <span id="confirm-dosage-unit" style="margin-left: 5px;"></span>
                    </div>
                    <div style="color: #666; margin-bottom: 10px;">
                        <span>ÁèæÂú®„ÅÆÂú®Â∫´: </span><span id="confirm-current-stock"></span>
                        <br>
                        <span>ÊúçÁî®Âæå„ÅÆÂú®Â∫´: </span><span id="confirm-remaining-stock" style="font-weight: bold;"></span>
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="save-button" onclick="confirmMedicationWithPhoto()">ÁôªÈå≤</button>
                    <button class="cancel-button" onclick="resetCameraModal()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </div>
            
            <div class="form-buttons" id="camera-initial-buttons">
                <button class="cancel-button" onclick="hideCameraModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // FirebaseË®≠ÂÆö„Å®„Ç§„É≥„Éù„Éº„Éà
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            sendEmailVerification,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyD6_2ioXr3LJU7PpThy7kxXbCfEFatUi_U",
            authDomain: "medication-tracker-b5d0c.firebaseapp.com",
            projectId: "medication-tracker-b5d0c",
            storageBucket: "medication-tracker-b5d0c.firebasestorage.app",
            messagingSenderId: "112454739779",
            appId: "1:112454739779:web:225df0ffd166882c1931f6",
            measurementId: "G-0LPF5Y8NPR"
        };

        // FirebaseÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.firebaseAuth = auth;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.sendEmailVerification = sendEmailVerification;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>

    <script>
        // „Ç¢„Éó„É™„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let isAuthenticated = false;
        let currentUser = null;
        
        // „Éá„Éº„ÇøÁÆ°ÁêÜ
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        
        // „Ç´„É°„É©Èñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let currentMedId = null;
        let currentMealTime = null;
        let cameraStream = null;
        
        // „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà
        function showPage(pageName) {
            // „Åô„Åπ„Å¶„ÅÆ„Éö„Éº„Ç∏„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éö„Éº„Ç∏„ÇíË°®Á§∫
            document.getElementById(pageName + '-page').classList.add('active');
            
            // Ë®≠ÂÆö„Éö„Éº„Ç∏„ÇíË°®Á§∫„Åô„ÇãÈöõ„Å´ÊôÇÈñìË®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
            if (pageName === 'settings') {
                loadMealTimeSettings();
            }
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
            event.target.closest('.tab').classList.add('active');
            
            // „Éö„Éº„Ç∏„Å´Âøú„Åò„Å¶„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            if (pageName === 'home') {
                updateTodayMedications();
                checkStockWarnings();
            } else if (pageName === 'medications') {
                updateMedicationsList();
            } else if (pageName === 'history') {
                updateHistoryList();
            } else if (pageName === 'settings') {
                updateSettingsPage();
            }
        }
        
        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫/ÈùûË°®Á§∫
        function showAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }
        
        function hideAddModal() {
            const modal = document.getElementById('add-modal');
            modal.style.display = 'none';
            modal.dataset.editId = '';
            document.getElementById('add-medication-form').reset();
            document.querySelector('#add-modal h3').textContent = 'Êñ∞„Åó„ÅÑËñ¨„ÇíËøΩÂä†';
            // „Ç´„Çπ„Çø„É†ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('med-purpose-custom').style.display = 'none';
            document.getElementById('med-purpose-custom').required = false;
        }
        
        // Ëñ¨„ÅÆÁî®ÈÄî„ÅÆ„Ç´„Çπ„Çø„É†ÂÖ•ÂäõÂàá„ÇäÊõø„Åà
        function toggleCustomPurpose() {
            const select = document.getElementById('med-purpose-select');
            const customInput = document.getElementById('med-purpose-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Âú®Â∫´Ë≠¶Âëä„Åó„Åç„ÅÑÂÄ§„ÅÆ„Ç´„Çπ„Çø„É†ÂÖ•ÂäõÂàá„ÇäÊõø„Åà
        function toggleCustomThreshold() {
            const select = document.getElementById('med-alert-threshold-select');
            const customInput = document.getElementById('med-alert-threshold-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Ëñ¨„ÅÆËøΩÂä†/Á∑®ÈõÜ
        document.getElementById('add-medication-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dosageNumber = document.getElementById('med-dosage-number').value;
            const dosageUnit = document.getElementById('med-dosage-unit').value;
            const editId = document.getElementById('add-modal').dataset.editId;
            
            // Ëñ¨„ÅÆÁî®ÈÄî„ÇíÂèñÂæó
            const purposeSelect = document.getElementById('med-purpose-select').value;
            const purposeCustom = document.getElementById('med-purpose-custom').value;
            const purpose = purposeSelect === 'custom' ? purposeCustom : purposeSelect;
            
            // Âú®Â∫´Ë≠¶Âëä„Åó„Åç„ÅÑÂÄ§„ÇíÂèñÂæó
            const thresholdSelect = document.getElementById('med-alert-threshold-select').value;
            const thresholdCustom = document.getElementById('med-alert-threshold-custom').value;
            const alertThreshold = thresholdSelect === 'custom' ? 
                parseInt(thresholdCustom) : parseInt(thresholdSelect);
            
            const medicationData = {
                name: document.getElementById('med-name').value,
                dosage: dosageNumber + dosageUnit,
                frequency: document.getElementById('med-frequency').value,
                stock: parseInt(document.getElementById('med-stock').value),
                alertThreshold: alertThreshold || 7,
                purpose: purpose || '' // Ëñ¨„ÅÆÁî®ÈÄî„ÇíËøΩÂä†
            };
            
            if (editId) {
                // Á∑®ÈõÜ„É¢„Éº„Éâ
                const medIndex = medications.findIndex(m => m.id === parseInt(editId));
                if (medIndex !== -1) {
                    medications[medIndex] = {
                        ...medications[medIndex],
                        ...medicationData
                    };
                }
            } else {
                // Êñ∞Ë¶èËøΩÂä†„É¢„Éº„Éâ
                const medication = {
                    id: Date.now(),
                    ...medicationData,
                    createdAt: new Date().toISOString()
                };
                medications.push(medication);
                
                // ÈÄöÁü•„ÅÆË®≠ÂÆö
                scheduleNotifications(medication);
            }
            
            localStorage.setItem('medications', JSON.stringify(medications));
            
            hideAddModal();
            showPage('medications');
        });
        
        // È£ü‰∫ãÊôÇÈñìË®≠ÂÆö„Çí‰øùÂ≠ò
        function saveMealTimeSettings() {
            const settings = {
                breakfast: document.getElementById('breakfast-time').value,
                lunch: document.getElementById('lunch-time').value,
                dinner: document.getElementById('dinner-time').value,
                bedtime: document.getElementById('bedtime').value
            };
            localStorage.setItem('mealTimeSettings', JSON.stringify(settings));
        }
        
        // È£ü‰∫ãÊôÇÈñìË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        function loadMealTimeSettings() {
            const saved = localStorage.getItem('mealTimeSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('breakfast-time').value = settings.breakfast || '09:00';
                document.getElementById('lunch-time').value = settings.lunch || '13:00';
                document.getElementById('dinner-time').value = settings.dinner || '19:00';
                document.getElementById('bedtime').value = settings.bedtime || '22:00';
            }
        }
        
        // ÁèæÂú®„ÅÆÈ£ü‰∫ãÊôÇÈñì„ÇíÂèñÂæó
        function getCurrentMealTime() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // ÊôÇÈñì„ÇíÂàÜ„Å´Â§âÊèõ
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const breakfastTime = toMinutes(settings.breakfast);
            const lunchTime = toMinutes(settings.lunch);
            const dinnerTime = toMinutes(settings.dinner);
            const bedtimeTime = toMinutes(settings.bedtime);
            
            // ÂêÑÈ£ü‰∫ãÊôÇÈñì„ÅÆÂâçÂæå1ÊôÇÈñì„ÇíÊúçËñ¨ÊôÇÈñì„Å®„Åô„Çã
            if (currentTime >= breakfastTime - 60 && currentTime < breakfastTime + 60) return 'ÊúùÈ£üÂæå';
            else if (currentTime >= lunchTime - 60 && currentTime < lunchTime + 60) return 'ÊòºÈ£üÂæå';
            else if (currentTime >= dinnerTime - 60 && currentTime < dinnerTime + 60) return 'Â§ïÈ£üÂæå';
            else if (currentTime >= bedtimeTime - 60 || currentTime < 360) return 'Â∞±ÂØùÂâç'; // 360 = 6:00 AM
            
            return '';
        }
        
        // ‰ªäÊó•„ÅÆÊúçËñ¨„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateTodayMedications() {
            const container = document.getElementById('today-medications');
            container.innerHTML = '';
            
            const mealTime = getCurrentMealTime();
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // ÊôÇÈñìË®≠ÂÆö„ÇíÂèñÂæó
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // ÂêÑÈ£ü‰∫ãÊôÇÈñì„ÇíÂàÜ„Å´Â§âÊèõ
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const mealTimes = {
                'ÊúùÈ£üÂæå': toMinutes(settings.breakfast),
                'ÊòºÈ£üÂæå': toMinutes(settings.lunch),
                'Â§ïÈ£üÂæå': toMinutes(settings.dinner),
                'Â∞±ÂØùÂâç': toMinutes(settings.bedtime)
            };
            
            // ÈÅéÂéª2ÊôÇÈñì‰ª•ÂÜÖ„Å´ÊúçÁî®„Åô„Åπ„Åç„Å†„Å£„ÅüËñ¨„ÇíÂèñÂæó
            const overdueWarnings = [];
            for (const [meal, time] of Object.entries(mealTimes)) {
                if (currentTime >= time + 120) { // 2ÊôÇÈñì‰ª•‰∏äÁµåÈÅé
                    const overdueMeds = medications.filter(med => {
                        return (med.frequency === 'ÊØéÈ£üÂæå' || 
                               med.frequency === meal ||
                               (med.frequency === 'ÊúùÂ§ïÈ£üÂæå' && (meal === 'ÊúùÈ£üÂæå' || meal === 'Â§ïÈ£üÂæå'))) &&
                               !isTakenToday(med.id, meal);
                    });
                    overdueWarnings.push(...overdueMeds.map(med => ({...med, mealTime: meal})));
                }
            }
            
            // ÈÅÖÂª∂Ë≠¶Âëä„ÇíË°®Á§∫
            if (overdueWarnings.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning-message';
                warningDiv.style.marginBottom = '20px';
                warningDiv.innerHTML = '<strong>‚ö†Ô∏è ÊúçÁî®ÊôÇÈñì„ÇíÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô</strong>';
                container.appendChild(warningDiv);
                
                overdueWarnings.forEach(warning => {
                    const card = document.createElement('div');
                    card.className = 'medication-card';
                    card.style.border = '2px solid #ff9800';
                    card.innerHTML = `
                        <div class="medication-name">${warning.name} - ${warning.mealTime}</div>
                        <div class="medication-info" style="color: #ff6b6b;">ÊúçÁî®ÊôÇÈñì„Åã„Çâ2ÊôÇÈñì‰ª•‰∏äÁµåÈÅé</div>
                        <div class="medication-info">${warning.dosage} - ${warning.frequency}</div>
                        ${warning.purpose ? `<div class="medication-info">Áî®ÈÄî: ${warning.purpose}</div>` : ''}
                        <div class="medication-info">Âú®Â∫´: ${warning.stock}ÂÄã</div>
                        <button class="take-button" 
                                onclick="showCameraModal(${warning.id}, '${warning.mealTime}')"
                                style="background: #ff9800;">
                            üì∏ ‰ªä„Åô„ÅêÊúçÁî®„Åô„Çã
                        </button>
                    `;
                    container.appendChild(card);
                });
                
                // ÈÅÖÂª∂Ë≠¶Âëä„ÅÆÈÄöÁü•„ÇíÈÄÅ‰ø°
                checkOverdueNotifications(overdueWarnings);
            }
            
            // ÁèæÂú®„ÅÆÊúçÁî®ÊôÇÈñì„ÅÆËñ¨„ÇíË°®Á§∫
            const todayMeds = medications.filter(med => {
                return med.frequency === 'ÊØéÈ£üÂæå' || 
                       med.frequency === mealTime ||
                       (med.frequency === 'ÊúùÂ§ïÈ£üÂæå' && (mealTime === 'ÊúùÈ£üÂæå' || mealTime === 'Â§ïÈ£üÂæå'));
            });
            
            if (todayMeds.length === 0 && overdueWarnings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÁèæÂú®ÊúçÁî®„Åô„ÇãËñ¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            todayMeds.forEach(med => {
                const taken = isTakenToday(med.id, mealTime);
                const card = document.createElement('div');
                card.className = 'medication-card';
                card.innerHTML = `
                    <div class="medication-name">${med.name}</div>
                    <div class="medication-info">${med.dosage} - ${med.frequency}</div>
                    ${med.purpose ? `<div class="medication-info">Áî®ÈÄî: ${med.purpose}</div>` : ''}
                    <div class="medication-info">Âú®Â∫´: ${med.stock}ÂÄã</div>
                    <button class="take-button ${taken ? 'taken' : ''}" 
                            onclick="showCameraModal(${med.id}, '${mealTime}')"
                            ${taken ? 'disabled' : ''}>
                        ${taken ? '‚úì ÊúçÁî®Ê∏à„Åø' : 'üì∏ ÊúçÁî®„Åô„Çã'}
                    </button>
                    ${taken ? `<button class="cancel-button" onclick="undoMedication(${med.id}, '${mealTime}')" style="margin-top: 5px; width: 100%; padding: 8px; font-size: 14px;">üîÑ Âèñ„ÇäÊ∂à„Åó</button>` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        // Ëñ¨„ÇíÊúçÁî®ÔºàÂÜôÁúüÂøÖÈ†àÔºâ
        // „Åì„ÅÆÈñ¢Êï∞„ÅØ‰ΩøÁî®„Åï„Çå„Åö„ÄÅ„Åô„Åπ„Å¶„ÅÆÊúçÁî®Ë®òÈå≤„ÅØ showCameraModal „ÇíÁµåÁî±„Åó„Å¶ÂÜôÁúü‰ªò„Åç„ÅßË°å„Çè„Çå„Åæ„Åô
        function takeMedication(medId, mealTime) {
            // ÂÜôÁúüÊíÆÂΩ±„ÅåÂøÖÈ†à„ÅÆ„Åü„ÇÅ„ÄÅÁõ¥Êé•„Ç´„É°„É©„É¢„Éº„ÉÄ„É´„ÇíËµ∑Âãï
            showCameraModal(medId, mealTime);
        }
        
        // ‰ªäÊó•ÊúçÁî®Ê∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isTakenToday(medId, mealTime) {
            const today = new Date().toDateString();
            return history.some(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled; // Âèñ„ÇäÊ∂à„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ±•Ê≠¥„ÅÆ„Åø
            });
        }
        
        // ÊúçÁî®Ë®òÈå≤„ÅÆÂèñ„ÇäÊ∂à„ÅóÔºà„Éõ„Éº„É†ÁîªÈù¢„Åã„ÇâÔºâ
        function undoMedication(medId, mealTime) {
            if (!confirm('ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºüÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            const today = new Date().toDateString();
            const historyItem = history.find(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled;
            });
            
            if (historyItem) {
                // Â±•Ê≠¥„ÇíÂèñ„ÇäÊ∂à„ÅóÊ∏à„Åø„Å´„Éû„Éº„ÇØ
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // Âú®Â∫´„ÇíÊàª„Åô
                const med = medications.find(m => m.id === medId);
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                checkStockWarnings();
                
                alert('‚úÖ ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü„ÄÇÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // Â±•Ê≠¥„Åã„Çâ„ÅÆÂèñ„ÇäÊ∂à„Åó
        function undoHistoryItem(medId, takenAt, mealTime) {
            if (!confirm('„Åì„ÅÆÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºüÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            const historyItem = history.find(h => 
                h.medicationId === medId && 
                h.takenAt === takenAt && 
                h.mealTime === mealTime &&
                !h.cancelled
            );
            
            if (historyItem) {
                // Â±•Ê≠¥„ÇíÂèñ„ÇäÊ∂à„ÅóÊ∏à„Åø„Å´„Éû„Éº„ÇØ
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // Âú®Â∫´„ÇíÊàª„Åô
                const med = medications.find(m => m.id === parseInt(medId));
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                updateHistoryList();
                checkStockWarnings();
                
                alert('‚úÖ ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü„ÄÇÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // Âú®Â∫´Ë≠¶Âëä„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkStockWarnings() {
            const container = document.getElementById('stock-warnings');
            container.innerHTML = '';
            
            const warnings = medications.filter(med => med.stock <= (med.alertThreshold || 7));
            if (warnings.length > 0) {
                warnings.forEach(med => {
                    const warning = document.createElement('div');
                    warning.className = 'stock-warning';
                    warning.textContent = `‚ö†Ô∏è ${med.name}„ÅÆÂú®Â∫´„ÅåÊÆã„Çä${med.stock}ÂÄã„Åß„Åô„ÄÇËøΩÂä†Ë≥ºÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`;
                    container.appendChild(warning);
                });
            }
        }
        
        // Ëñ¨„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateMedicationsList() {
            const container = document.getElementById('medications-list');
            container.innerHTML = '';
            
            if (medications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ëñ¨„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }
            
            medications.forEach(med => {
                const card = document.createElement('div');
                card.className = 'medication-card';
                card.innerHTML = `
                    <div class="medication-name">${med.name}</div>
                    <div class="medication-info">${med.dosage} - ${med.frequency}</div>
                    ${med.purpose ? `<div class="medication-info">Áî®ÈÄî: ${med.purpose}</div>` : ''}
                    <div class="medication-info">Âú®Â∫´: ${med.stock}ÂÄã (Ë≠¶Âëä: ${med.alertThreshold || 7}ÂÄã)</div>
                    <div style="margin-top: 10px;">
                        <button onclick="editMedication(${med.id})" style="padding: 5px 10px; margin-right: 5px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">‚úèÔ∏è Á∑®ÈõÜ</button>
                        <button onclick="deleteMedication(${med.id})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">üóëÔ∏è ÂâäÈô§</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
        function updateHistoryList() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÊúçËñ¨Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // Âèñ„ÇäÊ∂à„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ±•Ê≠¥„ÅÆ„ÅøË°®Á§∫
            const activeHistory = history.filter(h => !h.cancelled);
            
            if (activeHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÊúçËñ¨Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // Êó•‰ªò„Åß„Ç∞„É´„Éº„ÉóÂåñ
            const groupedHistory = {};
            activeHistory.slice().reverse().forEach(h => {
                const date = new Date(h.takenAt).toLocaleDateString('ja-JP');
                if (!groupedHistory[date]) {
                    groupedHistory[date] = [];
                }
                groupedHistory[date].push(h);
            });
            
            Object.entries(groupedHistory).forEach(([date, items]) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-meds">
                        ${items.map(item => {
                            const time = new Date(item.takenAt).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                            const hasPhoto = item.photo || item.photoVerified;
                            return `
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    ${hasPhoto && item.photo ? `
                                        <img class="history-photo" src="${item.photo}" 
                                             onclick="showPhotoModal('${item.photo}')" 
                                             alt="ÊúçÁî®ÂÜôÁúü">
                                    ` : hasPhoto ? `
                                        <div class="history-photo" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0;">
                                            üì∏
                                        </div>
                                    ` : ''}
                                    <div style="flex: 1;">
                                        <div>${item.medicationName} (${item.mealTime})</div>
                                        <div style="font-size: 12px; color: #888;">${time}</div>
                                    </div>
                                    <button class="cancel-button" onclick="undoHistoryItem('${item.medicationId}', '${item.takenAt}', '${item.mealTime}')" 
                                            style="padding: 2px 8px; font-size: 12px; margin-left: 10px;">üîÑ Âèñ„ÇäÊ∂à„Åó</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }
        
        // ÈÄöÁü•„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´
        function scheduleNotifications(medication) {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // ÊúçËñ¨ÊôÇÈñì„ÅÆÈÄöÁü•„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
            setMedicationReminders(medication);
        }
        
        // ÈÅÖÂª∂Ë≠¶Âëä„ÅÆÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkOverdueNotifications(overdueWarnings) {
            if ('Notification' in window && Notification.permission === 'granted') {
                overdueWarnings.forEach(warning => {
                    const notificationKey = `overdue-${warning.id}-${warning.mealTime}-${new Date().toDateString()}`;
                    
                    // ‰ªäÊó•Êó¢„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!localStorage.getItem(notificationKey)) {
                        new Notification('‚ö†Ô∏è ÊúçÁî®ÊôÇÈñì„ÇíÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô', {
                            body: `${warning.name}Ôºà${warning.mealTime}Ôºâ„ÇíÊúçÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ`,
                            icon: '/icon-192x192.png',
                            tag: notificationKey,
                            requireInteraction: true
                        });
                        
                        // ÈÄöÁü•ÈÄÅ‰ø°Ê∏à„Åø„Å®„Åó„Å¶Ë®òÈå≤
                        localStorage.setItem(notificationKey, 'sent');
                    }
                });
            }
        }
        
        // ÊúçËñ¨„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÅÆË®≠ÂÆö
        function setMedicationReminders(medication) {
            const frequency = medication.frequency;
            const times = [];
            
            // ÊúçÁî®È†ªÂ∫¶„Å´Âøú„Åò„Å¶ÈÄöÁü•ÊôÇÈñì„ÇíË®≠ÂÆö
            switch(frequency) {
                case 'ÊØéÈ£üÂæå':
                    times.push('08:30', '12:30', '19:30'); // ÊúùÊòºÂ§ïÈ£üÂæå
                    break;
                case 'ÊúùÈ£üÂæå':
                    times.push('08:30');
                    break;
                case 'ÊòºÈ£üÂæå':
                    times.push('12:30');
                    break;
                case 'Â§ïÈ£üÂæå':
                    times.push('19:30');
                    break;
                case 'ÊúùÂ§ïÈ£üÂæå':
                    times.push('08:30', '19:30');
                    break;
                case 'Â∞±ÂØùÂâç':
                    times.push('22:00');
                    break;
            }
            
            // ÂêÑÊôÇÈñì„Å´ÂØæ„Åó„Å¶ÈÄöÁü•„ÇíË®≠ÂÆö
            times.forEach(time => {
                scheduleNotificationAtTime(medication, time);
            });
        }
        
        // ÊåáÂÆöÊôÇÈñì„Å´ÈÄöÁü•„ÇíË®≠ÂÆö
        function scheduleNotificationAtTime(medication, timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const now = new Date();
            const scheduledTime = new Date();
            scheduledTime.setHours(hours, minutes, 0, 0);
            
            // „ÇÇ„Åó‰ªäÊó•„ÅÆÊôÇÈñì„ÅåÈÅé„Åé„Å¶„ÅÑ„Åü„ÇâÊòéÊó•„Å´Ë®≠ÂÆö
            if (scheduledTime <= now) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }
            
            const timeUntilNotification = scheduledTime.getTime() - now.getTime();
            
            setTimeout(() => {
                showMedicationNotification(medication, timeString);
                // ÁøåÊó•‰ª•Èôç„ÇÇÁ∂ôÁ∂ö„Åô„Çã„Åü„ÇÅÂÜç„Çπ„Ç±„Ç∏„É•„Éº„É´
                setTimeout(() => {
                    scheduleNotificationAtTime(medication, timeString);
                }, 24 * 60 * 60 * 1000); // 24ÊôÇÈñìÂæå
            }, timeUntilNotification);
        }
        
        // Ëñ¨„ÅÆÈÄöÁü•„ÇíË°®Á§∫
        function showMedicationNotification(medication, time) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`üíä „ÅäËñ¨„ÅÆÊôÇÈñì„Åß„Åô`, {
                    body: `${medication.name} (${medication.dosage}) „ÇíÊúçÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ`,
                    icon: 'üíä',
                    badge: 'üíä',
                    tag: `medication-${medication.id}`,
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'take',
                            title: 'ÊúçÁî®Ê∏à„Åø'
                        },
                        {
                            action: 'later',
                            title: 'Âæå„Åß'
                        }
                    ]
                });
                
                notification.onclick = function() {
                    window.focus();
                    // „Éõ„Éº„É†ÁîªÈù¢„ÇíË°®Á§∫
                    showPage('home');
                    this.close();
                };
                
                // 10ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                setTimeout(() => {
                    notification.close();
                }, 10000);
            }
        }
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkLowStockNotifications() {
            medications.forEach(med => {
                const threshold = med.alertThreshold || 7;
                if (med.stock <= threshold && med.stock > 0) {
                    showLowStockNotification(med);
                }
            });
        }
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„ÇíË°®Á§∫
        function showLowStockNotification(medication) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`‚ö†Ô∏è Ëñ¨„ÅÆÂú®Â∫´„ÅåÂ∞ë„Å™„Åè„Å™„Å£„Å¶„ÅÑ„Åæ„Åô`, {
                    body: `${medication.name}„ÅÆÂú®Â∫´„ÅåÊÆã„Çä${medication.stock}ÂÄã„Åß„Åô„ÄÇËøΩÂä†Ë≥ºÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    icon: '‚ö†Ô∏è',
                    badge: '‚ö†Ô∏è',
                    tag: `stock-${medication.id}`,
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    showPage('medications');
                    this.close();
                };
            }
        }
        
        // ÂàùÊúüÂåñ
        updateTodayMedications();
        checkStockWarnings();
        
        // Service Worker„ÅÆÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('Service Worker ÁôªÈå≤ÊàêÂäü:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker ÁôªÈå≤Â§±Êïó:', error);
                    });
            });
        }
        
        // ÈÄöÁü•Ê®©Èôê„ÅÆË¶ÅÊ±Ç
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Êó¢Â≠ò„ÅÆËñ¨„Å´ÂØæ„Åó„Å¶ÈÄöÁü•„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
        medications.forEach(medication => {
            setMedicationReminders(medication);
        });
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        checkLowStockNotifications();
        
        // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÅÆÂá¶ÁêÜ
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÈò≤„Åê
            e.preventDefault();
            // Âæå„Åß‰ΩøÁî®„Åô„Çã„Åü„ÇÅ„Å´„Ç§„Éô„É≥„Éà„Çí‰øùÂ≠ò
            deferredPrompt = e;
            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éú„Çø„É≥„ÇíË°®Á§∫
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éê„Éä„Éº„ÇíË°®Á§∫
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #2196F3;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 9999;
                cursor: pointer;
            `;
            installBanner.innerHTML = 'üì± „Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶„Ç¢„Éó„É™„Å®„Åó„Å¶‰ΩøÁî®„Åß„Åç„Åæ„ÅôÔºÅ';
            installBanner.onclick = installApp;
            document.body.appendChild(installBanner);
            
            // 10ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
            setTimeout(() => {
                if (installBanner.parentNode) {
                    installBanner.parentNode.removeChild(installBanner);
                }
            }, 10000);
        }
        
        function installApp() {
            if (deferredPrompt) {
                // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
                deferredPrompt.prompt();
                // „É¶„Éº„Ç∂„Éº„ÅÆÈÅ∏Êäû„ÇíÂæÖ„Å§
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('„É¶„Éº„Ç∂„Éº„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„ÇíÂèó„ÅëÂÖ•„Çå„Åæ„Åó„Åü');
                    } else {
                        console.log('„É¶„Éº„Ç∂„Éº„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„ÇíÊãíÂê¶„Åó„Åæ„Åó„Åü');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showCameraModal(medId, mealTime) {
            currentMedId = medId;
            currentMealTime = mealTime;
            
            const modal = document.getElementById('camera-modal');
            resetCameraModal();
            modal.style.display = 'block';
        }
        
        // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´„Çí„É™„Çª„ÉÉ„Éà
        function resetCameraModal() {
            const capturedImage = document.getElementById('captured-image');
            const analysisResult = document.getElementById('analysis-result');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            const confirmSection = document.getElementById('medication-confirm-section');
            const initialButtons = document.getElementById('camera-initial-buttons');
            const fileInput = document.getElementById('camera-input');
            
            // Ë°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
            capturedImage.style.display = 'none';
            analysisResult.style.display = 'none';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            confirmSection.style.display = 'none';
            initialButtons.style.display = 'block';
            fileInput.value = '';
        }
        
        // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫
        function hideCameraModal() {
            const modal = document.getElementById('camera-modal');
            modal.style.display = 'none';
            
            currentMedId = null;
            currentMealTime = null;
        }
        
        // OS„Ç´„É°„É©„Ç¢„Éó„É™„ÇíËµ∑Âãï
        function openCameraApp() {
            const fileInput = document.getElementById('camera-input');
            fileInput.click();
        }
        
        // ÂÜôÁúü„Ç≠„É£„Éó„ÉÅ„É£Âá¶ÁêÜ
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageDataUrl = e.target.result;
                
                // ÊíÆÂΩ±„Åó„ÅüÁîªÂÉè„ÇíË°®Á§∫
                const capturedImage = document.getElementById('captured-image');
                const captureBtn = document.getElementById('capture-btn');
                const retakeBtn = document.getElementById('retake-btn');
                
                capturedImage.src = imageDataUrl;
                capturedImage.style.display = 'block';
                
                // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'block';
                
                // ÁîªÂÉèËß£Êûê„ÇíÂÆüË°å
                analyzeImage(imageDataUrl);
            };
            reader.readAsDataURL(file);
        }
        
        // ÊíÆ„ÇäÁõ¥„Åó
        function retakePhoto() {
            resetCameraModal();
        }
        
        // ÁîªÂÉèÂúßÁ∏Æ„Å®‰øùÂ≠ò
        async function analyzeImage(imageDataUrl) {
            // ÁîªÂÉèÂúßÁ∏Æ
            const compressedImage = await compressImage(imageDataUrl);
            
            // ÂúßÁ∏Æ„Åó„ÅüÁîªÂÉè„Çí‰∏ÄÊôÇ‰øùÂ≠ò
            sessionStorage.setItem('tempMedicationImage', compressedImage);
            
            // ÊúçÁî®Á¢∫Ë™ç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
            showMedicationConfirmSection();
        }
        
        // ÊúçÁî®Á¢∫Ë™ç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
        function showMedicationConfirmSection() {
            const med = medications.find(m => m.id === currentMedId);
            if (!med) return;
            
            // Ëñ¨Ââ§ÊÉÖÂ†±„ÇíË°®Á§∫
            document.getElementById('confirm-med-name').textContent = med.name;
            
            // Áî®Èáè„ÇíËß£Êûê„Åó„Å¶Êï∞ÂÄ§„Å®Âçò‰Ωç„Å´ÂàÜ„Åë„Çã
            const dosageMatch = med.dosage.match(/(\d+)(.+)/);
            const dosageNumber = dosageMatch ? dosageMatch[1] : '1';
            const dosageUnit = dosageMatch ? dosageMatch[2] : 'Èå†';
            
            document.getElementById('confirm-dosage').value = dosageNumber;
            document.getElementById('confirm-dosage-unit').textContent = dosageUnit;
            document.getElementById('confirm-current-stock').textContent = med.stock + dosageUnit;
            
            // ÊúçÁî®Êï∞ÈáèÂ§âÊõ¥ÊôÇ„ÅÆÂú®Â∫´Ë®àÁÆó
            updateRemainingStock();
            document.getElementById('confirm-dosage').addEventListener('input', updateRemainingStock);
            
            // UI„ÇíÂàá„ÇäÊõø„Åà
            document.getElementById('medication-confirm-section').style.display = 'block';
            document.getElementById('camera-initial-buttons').style.display = 'none';
        }
        
        // ÊÆã„ÇäÂú®Â∫´„ÇíÊõ¥Êñ∞
        function updateRemainingStock() {
            const med = medications.find(m => m.id === currentMedId);
            if (!med) return;
            
            const dosageInput = document.getElementById('confirm-dosage');
            const takingAmount = parseInt(dosageInput.value) || 1;
            const remaining = med.stock - takingAmount;
            
            const remainingElement = document.getElementById('confirm-remaining-stock');
            remainingElement.textContent = remaining + document.getElementById('confirm-dosage-unit').textContent;
            
            // Âú®Â∫´‰∏çË∂≥„ÅÆÂ†¥Âêà„ÅØË≠¶ÂëäË°®Á§∫
            if (remaining < 0) {
                remainingElement.style.color = '#f56565';
            } else if (remaining <= med.alertThreshold) {
                remainingElement.style.color = '#ed8936';
            } else {
                remainingElement.style.color = '#38a169';
            }
        }
        
        // ÁîªÂÉèÂúßÁ∏ÆÈñ¢Êï∞
        async function compressImage(dataUrl, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Çí‰øùÊåÅ„Åó„Å™„Åå„Çâ„É™„Çµ„Ç§„Ç∫
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ÂúßÁ∏ÆÂæå„ÅÆ„Éá„Éº„ÇøURL„ÇíËøî„Åô
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        // ÁîªÂÉèÂ±•Ê≠¥„ÅÆÊõ¥Êñ∞ÔºàÂè§„ÅÑÁîªÂÉè„ÇíÂâäÈô§Ôºâ
        function cleanupOldPhotos() {
            // 3„É∂ÊúàÔºà90Êó•Ôºâ‰ª•‰∏äÂè§„ÅÑÁîªÂÉè„ÇíÊåÅ„Å§Â±•Ê≠¥„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setDate(threeMonthsAgo.getDate() - 90);
            
            let cleaned = false;
            history.forEach(item => {
                if (item.photo && new Date(item.takenAt) < threeMonthsAgo) {
                    item.photo = null; // Âè§„ÅÑÁîªÂÉè„ÇíÂâäÈô§
                    cleaned = true;
                }
            });
            
            if (cleaned) {
                localStorage.setItem('history', JSON.stringify(history));
                console.log('Âè§„ÅÑÂÜôÁúü„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åó„Åæ„Åó„Åü');
            }
        }
        
        // ÂÜôÁúü„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showPhotoModal(photoUrl) {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <img src="${photoUrl}" alt="ÊúçÁî®ÂÜôÁúü">
            `;
            modal.onclick = function() {
                modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        // ÊúçÁî®Á¢∫Ë™çÔºàÂÜôÁúü‰ªò„ÅçÔºâ
        function confirmMedication() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                // Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
                med.stock -= 1;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // ‰∏ÄÊôÇ‰øùÂ≠ò„Åó„ÅüÁîªÂÉè„ÇíÂèñÂæó
                const photo = sessionStorage.getItem('tempMedicationImage');
                
                // Â±•Ê≠¥„Å´ËøΩÂä†ÔºàÂÜôÁúü‰ªò„ÅçÔºâ
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: med.dosage,
                    takenAt: new Date().toISOString(),
                    mealTime: currentMealTime,
                    photoVerified: true,
                    photo: photo // ÂúßÁ∏ÆÊ∏à„ÅøÁîªÂÉè
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // ‰∏ÄÊôÇ‰øùÂ≠ò„Çí„ÇØ„É™„Ç¢
                sessionStorage.removeItem('tempMedicationImage');
                
                // ÁîªÂÉèÂ±•Ê≠¥„ÇÇÁÆ°ÁêÜ
                updateImageHistory();
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                checkStockWarnings();
                
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                hideCameraModal();
                
                // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                alert('üì∏ ÂÜôÁúü„ÅßÊúçÁî®„ÅåÁ¢∫Ë™ç„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
            }
        }
        
        // ÊúçÁî®Á¢∫Ë™çÔºàÂÜôÁúü‰ªò„ÅçÔºâ
        function confirmMedicationWithPhoto() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                const takingAmount = parseInt(document.getElementById('confirm-dosage').value) || 1;
                
                // Âú®Â∫´„ÉÅ„Çß„ÉÉ„ÇØ
                if (med.stock < takingAmount) {
                    alert('Âú®Â∫´„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
                    return;
                }
                
                // Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
                med.stock -= takingAmount;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // ‰∏ÄÊôÇ‰øùÂ≠ò„Åï„Çå„ÅüÂÜôÁúü„ÇíÂèñÂæó
                const tempImage = sessionStorage.getItem('tempMedicationImage');
                
                // Â±•Ê≠¥„Å´ËøΩÂä†„ÄÄ
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: takingAmount + document.getElementById('confirm-dosage-unit').textContent,
                    takenAt: new Date().toISOString(),
                    mealTime: currentMealTime,
                    photoVerified: true,
                    photo: tempImage
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // ‰∏ÄÊôÇ‰øùÂ≠ò„Çí„ÇØ„É™„Ç¢
                sessionStorage.removeItem('tempMedicationImage');
                
                // ÁîªÂÉèÂ±•Ê≠¥„ÇÇÁÆ°ÁêÜ
                cleanupOldPhotos();
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                checkStockWarnings();
                
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                hideCameraModal();
                
                // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                alert('üì∏ ÊúçÁî®„ÅåË®òÈå≤„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                
                // Â±•Ê≠¥„Éö„Éº„Ç∏„Å´ÁßªÂãï
                showPage('history');
                updateHistoryList();
            }
        }
        
        // Â±•Ê≠¥„Éì„É•„ÉºÂàá„ÇäÊõø„Åà
        function showHistoryView(viewType) {
            const listView = document.getElementById('history-list');
            const galleryView = document.getElementById('history-gallery');
            const listBtn = document.getElementById('list-view-btn');
            const galleryBtn = document.getElementById('gallery-view-btn');
            
            if (viewType === 'list') {
                listView.style.display = 'block';
                galleryView.style.display = 'none';
                listBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                listBtn.style.color = 'white';
                galleryBtn.style.background = '#e2e8f0';
                galleryBtn.style.color = '#4a5568';
                updateHistoryList();
            } else {
                listView.style.display = 'none';
                galleryView.style.display = 'block';
                listBtn.style.background = '#e2e8f0';
                listBtn.style.color = '#4a5568';
                galleryBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                galleryBtn.style.color = 'white';
                updateHistoryGallery();
            }
        }
        
        // ÂÜôÁúü„ÇÆ„É£„É©„É™„Éº„ÅÆÊõ¥Êñ∞
        function updateHistoryGallery() {
            const container = document.getElementById('history-gallery');
            container.innerHTML = '';
            
            // ÂÜôÁúü‰ªò„Åç„ÅÆÂ±•Ê≠¥„ÅÆ„Åø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const photoHistory = history.filter(h => !h.cancelled && h.photo);
            
            if (photoHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÂÜôÁúü‰ªò„Åç„ÅÆÊúçËñ¨Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // Êñ∞„Åó„ÅÑÈ†Ü„Å´Ë°®Á§∫
            container.innerHTML = '<div class="history-gallery">' + 
                photoHistory.slice().reverse().map(item => {
                    const date = new Date(item.takenAt);
                    const dateStr = date.toLocaleDateString('ja-JP');
                    const timeStr = date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    
                    return `
                        <div class="gallery-item">
                            <img src="${item.photo}" onclick="showPhotoModal('${item.photo}')" alt="ÊúçÁî®ÂÜôÁúü">
                            <div class="gallery-item-info">
                                <div class="gallery-item-date">${dateStr} ${timeStr}</div>
                                <div class="gallery-item-med">${item.medicationName}</div>
                                <div class="gallery-item-med">${item.mealTime}</div>
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
        }
        
        // Ëñ¨„ÅÆÁ∑®ÈõÜ
        function editMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            // ÁèæÂú®„ÅÆÂÄ§„Çí„Éï„Ç©„Éº„É†„Å´Ë®≠ÂÆö
            document.getElementById('med-name').value = med.name;
            
            // Áî®Èáè„ÇíÊï∞Â≠ó„Å®Âçò‰Ωç„Å´ÂàÜÂâ≤
            const dosageMatch = med.dosage.match(/(\d+)(.+)/);
            if (dosageMatch) {
                document.getElementById('med-dosage-number').value = dosageMatch[1];
                document.getElementById('med-dosage-unit').value = dosageMatch[2];
            }
            
            document.getElementById('med-frequency').value = med.frequency;
            document.getElementById('med-stock').value = med.stock;
            
            // Âú®Â∫´Ë≠¶Âëä„Åó„Åç„ÅÑÂÄ§„ÇíË®≠ÂÆö
            const threshold = med.alertThreshold || 7;
            if (threshold >= 1 && threshold <= 10) {
                document.getElementById('med-alert-threshold-select').value = threshold.toString();
                document.getElementById('med-alert-threshold-custom').style.display = 'none';
                document.getElementById('med-alert-threshold-custom').required = false;
            } else {
                document.getElementById('med-alert-threshold-select').value = 'custom';
                document.getElementById('med-alert-threshold-custom').value = threshold;
                document.getElementById('med-alert-threshold-custom').style.display = 'block';
                document.getElementById('med-alert-threshold-custom').required = true;
            }
            
            // Áî®ÈÄî„ÇíË®≠ÂÆö
            if (med.purpose) {
                const standardPurposes = ['È†≠Áóõ„ÉªËß£ÁÜ±', 'ËÉÉËÖ∏Ëñ¨', 'È¢®ÈÇ™Ëñ¨', '„Ç¢„É¨„É´„ÇÆ„Éº', '„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà', 'È´òË°ÄÂúß', 'Á≥ñÂ∞øÁóÖ', 'ÊäóÁîüÁâ©Ë≥™', 'Áù°Áú†Ëñ¨'];
                if (standardPurposes.includes(med.purpose)) {
                    document.getElementById('med-purpose-select').value = med.purpose;
                    document.getElementById('med-purpose-custom').style.display = 'none';
                    document.getElementById('med-purpose-custom').required = false;
                } else {
                    document.getElementById('med-purpose-select').value = 'custom';
                    document.getElementById('med-purpose-custom').value = med.purpose;
                    document.getElementById('med-purpose-custom').style.display = 'block';
                    document.getElementById('med-purpose-custom').required = true;
                }
            } else {
                document.getElementById('med-purpose-select').value = '';
                document.getElementById('med-purpose-custom').style.display = 'none';
                document.getElementById('med-purpose-custom').required = false;
            }
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            document.getElementById('add-modal').style.display = 'block';
            document.getElementById('add-modal').dataset.editId = medId;
            document.querySelector('#add-modal h3').textContent = 'Ëñ¨„ÅÆÊÉÖÂ†±„ÇíÁ∑®ÈõÜ';
        }
        
        // Ëñ¨„ÅÆÂâäÈô§
        function deleteMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            if (confirm(`„Äå${med.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
                medications = medications.filter(m => m.id !== medId);
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // UI„ÇíÊõ¥Êñ∞
                updateMedicationsList();
                updateTodayMedications();
                checkStockWarnings();
                
                alert('‚úÖ Ëñ¨„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // GitHubÈÄ£Êê∫Èñ¢Êï∞Áæ§
        function updateSettingsPage() {
            const githubStatus = getGitHubConnectionStatus();
            updateGitHubStatusUI(githubStatus);
        }
        
        function getGitHubConnectionStatus() {
            const status = localStorage.getItem('github-connection');
            return status ? JSON.parse(status) : null;
        }
        
        function updateGitHubStatusUI(status) {
            const disconnected = document.getElementById('github-disconnected');
            const connected = document.getElementById('github-connected');
            
            if (status) {
                disconnected.style.display = 'none';
                connected.style.display = 'block';
                document.getElementById('github-username').textContent = status.username;
                document.getElementById('github-repo').textContent = status.repo;
                document.getElementById('last-sync').textContent = status.lastSync || 'Êú™ÂêåÊúü';
            } else {
                disconnected.style.display = 'block';
                connected.style.display = 'none';
            }
        }
        
        function connectGitHub() {
            // GitHub OAuthË™çË®º„Éï„É≠„Éº„ÇíÈñãÂßã
            const clientId = 'YOUR_GITHUB_OAUTH_CLIENT_ID'; // ÂÆüÈöõ„ÅÆClient ID„Å´ÁΩÆ„ÅçÊèõ„ÅàÂøÖË¶Å
            const scope = 'repo user';
            const redirectUri = window.location.origin + window.location.pathname;
            
            // GitHubË™çË®º„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&scope=${scope}&redirect_uri=${encodeURIComponent(redirectUri)}`;
            
            // ‰∏ÄÊôÇÁöÑ„Å´„Ç∑„É≥„Éó„É´„Å™„Éó„É≠„É≥„Éó„Éà„Åß‰ª£ÊõøÔºàÂÆüÈöõ„ÅØ‰∏äË®ò„ÅÆOAuthË™çË®º„Çí‰ΩøÁî®Ôºâ
            const token = prompt('GitHub Personal Access Token„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n\nÊ®©Èôê: repo (Full control of private repositories)\n\n„Éà„Éº„ÇØ„É≥„ÅÆ‰ΩúÊàêÊñπÊ≥ï:\n1. GitHub.com ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens\n2. "Generate new token (classic)" „Çí„ÇØ„É™„ÉÉ„ÇØ\n3. "repo" „Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å¶‰ΩúÊàê');
            
            if (token) {
                // „Éà„Éº„ÇØ„É≥„ÅÆÊ§úË®º„Å®„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÂèñÂæó
                verifyGitHubToken(token);
            }
        }
        
        async function verifyGitHubToken(token) {
            try {
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error('Invalid token');
                }
                
                const userData = await userResponse.json();
                
                // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁî®„ÅÆ„É™„Éù„Ç∏„Éà„É™„Çí‰ΩúÊàê„Åæ„Åü„ÅØÁ¢∫Ë™ç
                const repoName = 'medication-tracker-backup';
                await createBackupRepository(token, repoName);
                
                // Êé•Á∂öÁä∂ÊÖã„Çí‰øùÂ≠ò
                const connectionData = {
                    token: token,
                    username: userData.login,
                    repo: repoName,
                    lastSync: null
                };
                
                localStorage.setItem('github-connection', JSON.stringify(connectionData));
                
                // UIÊõ¥Êñ∞
                updateGitHubStatusUI(connectionData);
                
                alert('‚úÖ GitHubÈÄ£Êê∫„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                
                // ÂàùÂõû„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å
                manualBackup();
                
            } catch (error) {
                console.error('GitHubÈÄ£Êê∫„Ç®„É©„Éº:', error);
                alert('‚ùå GitHubÈÄ£Êê∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éà„Éº„ÇØ„É≥„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }
        
        async function createBackupRepository(token, repoName) {
            try {
                // „É™„Éù„Ç∏„Éà„É™„ÅÆÂ≠òÂú®Á¢∫Ë™ç
                const checkResponse = await fetch(`https://api.github.com/repos/${getGitHubConnectionStatus().username || 'user'}/${repoName}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (checkResponse.ok) {
                    // „É™„Éù„Ç∏„Éà„É™„ÅåÊó¢„Å´Â≠òÂú®
                    return;
                }
                
                // „É™„Éù„Ç∏„Éà„É™„Çí‰ΩúÊàê
                const createResponse = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: repoName,
                        description: '„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü - ÊúçËñ¨Ë®òÈå≤„Éá„Éº„Çø„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó',
                        private: true,
                        auto_init: true
                    })
                });
                
                if (!createResponse.ok) {
                    throw new Error('Failed to create repository');
                }
                
            } catch (error) {
                console.error('„É™„Éù„Ç∏„Éà„É™‰ΩúÊàê„Ç®„É©„Éº:', error);
                throw error;
            }
        }
        
        async function manualBackup() {
            const status = getGitHubConnectionStatus();
            if (!status) {
                alert('‚ùå GitHubÈÄ£Êê∫„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                return;
            }
            
            try {
                // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÂèñÂæó
                const backupData = {
                    medications: JSON.parse(localStorage.getItem('medications') || '[]'),
                    records: JSON.parse(localStorage.getItem('medication-records') || '[]'),
                    backupDate: new Date().toISOString(),
                    version: '2.0'
                };
                
                // GitHub„Å´‰øùÂ≠ò
                await saveToGitHub(status.token, status.username, status.repo, 'backup.json', JSON.stringify(backupData, null, 2));
                
                // ÊúÄÁµÇÂêåÊúüÊôÇÂàª„ÇíÊõ¥Êñ∞
                status.lastSync = new Date().toLocaleString('ja-JP');
                localStorage.setItem('github-connection', JSON.stringify(status));
                updateGitHubStatusUI(status);
                
                alert('‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                
            } catch (error) {
                console.error('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', error);
                alert('‚ùå „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        async function restoreFromGitHub() {
            const status = getGitHubConnectionStatus();
            if (!status) {
                alert('‚ùå GitHubÈÄ£Êê∫„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„ÇâÂæ©ÂÖÉ„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            try {
                // GitHub„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó
                const backupData = await loadFromGitHub(status.token, status.username, status.repo, 'backup.json');
                
                if (backupData) {
                    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´Âæ©ÂÖÉ
                    localStorage.setItem('medications', JSON.stringify(backupData.medications || []));
                    localStorage.setItem('medication-records', JSON.stringify(backupData.records || []));
                    
                    // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
                    medications = backupData.medications || [];
                    medicationRecords = backupData.records || [];
                    
                    // UIÊõ¥Êñ∞
                    updateTodayMedications();
                    updateMedicationsList();
                    updateHistoryList();
                    
                    alert('‚úÖ „Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                } else {
                    alert('‚ùå „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                }
                
            } catch (error) {
                console.error('Âæ©ÂÖÉ„Ç®„É©„Éº:', error);
                alert('‚ùå „Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        async function saveToGitHub(token, username, repo, filename, content) {
            try {
                // Êó¢Â≠ò„Éï„Ç°„Ç§„É´„ÅÆSHA„ÇíÂèñÂæó
                let sha = null;
                try {
                    const getResponse = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (getResponse.ok) {
                        const existingFile = await getResponse.json();
                        sha = existingFile.sha;
                    }
                } catch (e) {
                    // „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶è‰ΩúÊàê
                }
                
                // „Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê/Êõ¥Êñ∞
                const putData = {
                    message: `„Éá„Éº„Çø„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó - ${new Date().toLocaleString('ja-JP')}`,
                    content: btoa(unescape(encodeURIComponent(content))), // UTF-8ÂØæÂøú„ÅÆBase64„Ç®„É≥„Ç≥„Éº„Éâ
                };
                
                if (sha) {
                    putData.sha = sha;
                }
                
                const putResponse = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(putData)
                });
                
                if (!putResponse.ok) {
                    throw new Error(`GitHub API error: ${putResponse.status}`);
                }
                
            } catch (error) {
                console.error('GitHub‰øùÂ≠ò„Ç®„É©„Éº:', error);
                throw error;
            }
        }
        
        async function loadFromGitHub(token, username, repo, filename) {
            try {
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return null; // „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const fileData = await response.json();
                const content = decodeURIComponent(escape(atob(fileData.content))); // UTF-8ÂØæÂøú„ÅÆBase64„Éá„Ç≥„Éº„Éâ
                return JSON.parse(content);
                
            } catch (error) {
                console.error('GitHubË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                throw error;
            }
        }
        
        function disconnectGitHub() {
            if (confirm('‚ö†Ô∏è GitHubÈÄ£Êê∫„ÇíËß£Èô§„Åó„Åæ„Åô„ÅãÔºü\n„É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÅØÊÆã„Çä„Åæ„Åô„Åå„ÄÅËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅåÁÑ°Âäπ„Å´„Å™„Çä„Åæ„Åô„ÄÇ')) {
                localStorage.removeItem('github-connection');
                updateGitHubStatusUI(null);
                alert('‚úÖ GitHubÈÄ£Êê∫„ÇíËß£Èô§„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        function exportLocalData() {
            const data = {
                medications: JSON.parse(localStorage.getItem('medications') || '[]'),
                records: JSON.parse(localStorage.getItem('medication-records') || '[]'),
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `medication-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importLocalData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('‚ö†Ô∏è ÁèæÂú®„ÅÆ„Éá„Éº„Çø„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ„Ç§„É≥„Éù„Éº„Éà„ÇíÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü')) {
                        localStorage.setItem('medications', JSON.stringify(data.medications || []));
                        localStorage.setItem('medication-records', JSON.stringify(data.records || []));
                        
                        // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
                        medications = data.medications || [];
                        medicationRecords = data.records || [];
                        
                        // UIÊõ¥Êñ∞
                        updateTodayMedications();
                        updateMedicationsList();
                        updateHistoryList();
                        
                        alert('‚úÖ „Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                    }
                } catch (error) {
                    console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                    alert('‚ùå „Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
                }
            };
            reader.readAsText(file);
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            event.target.value = '';
        }
        
        // ÂÆöÊúüÁöÑ„Å´ÁîªÈù¢„ÇíÊõ¥Êñ∞Ôºà1ÂàÜ„Åî„Å®Ôºâ
        setInterval(() => {
            if (document.getElementById('home-page').classList.contains('active')) {
                updateTodayMedications();
                checkStockWarnings();
            }
            // Âú®Â∫´Âàá„ÇåÈÄöÁü•„ÇÇÂÆöÊúüÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
            checkLowStockNotifications();
        }, 60000);
        
        // ÂÆöÊúüÁöÑ„Å´Âè§„ÅÑÂÜôÁúü„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºà1Êó•1ÂõûÔºâ
        setInterval(() => {
            cleanupOldPhotos();
        }, 24 * 60 * 60 * 1000); // 24ÊôÇÈñì„Åî„Å®
        
        // FirebaseË™çË®ºÈñ¢Êï∞Áæ§
        async function handleLogin(email, password) {
            try {
                showMessage('login-message', '„É≠„Ç∞„Ç§„É≥‰∏≠...', 'info');
                
                const userCredential = await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                if (!user.emailVerified) {
                    showMessage('login-message', '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆË™çË®º„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁ¢∫Ë™ç„É°„Éº„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    await window.signOut(window.firebaseAuth);
                    return;
                }
                
                showMessage('login-message', '„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                currentUser = user;
                isAuthenticated = true;
                
                setTimeout(() => {
                    hideAuthContainer();
                    showAppContainer();
                }, 1000);
                
            } catch (error) {
                console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                showMessage('login-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handleRegister(email, password, passwordConfirm) {
            if (password !== passwordConfirm) {
                showMessage('register-message', '„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('register-message', '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            try {
                showMessage('register-message', 'ÁôªÈå≤‰∏≠...', 'info');
                
                const userCredential = await window.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                // „É°„Éº„É´Ë™çË®ºÈÄÅ‰ø°
                await window.sendEmailVerification(user);
                
                showMessage('register-message', 'ÁôªÈå≤ÂÆå‰∫ÜÔºÅÁ¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„ÅÆ„É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
                
                // 2ÁßíÂæå„Å´„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã
                setTimeout(() => {
                    showLoginPage();
                }, 3000);
                
            } catch (error) {
                console.error('ÁôªÈå≤„Ç®„É©„Éº:', error);
                showMessage('register-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handlePasswordReset() {
            const email = prompt('ÁôªÈå≤Ê∏à„Åø„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (!email) return;

            try {
                await window.sendPasswordResetEmail(window.firebaseAuth, email);
                showMessage('login-message', '„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                console.error('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                showMessage('login-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handleLogout() {
            try {
                await window.signOut(window.firebaseAuth);
                currentUser = null;
                isAuthenticated = false;
                showAuthContainer();
                hideAppContainer();
                showMessage('login-message', '„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'info');
            } catch (error) {
                console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
            }
        }

        // UIÂàá„ÇäÊõø„ÅàÈñ¢Êï∞
        function showLoginPage() {
            document.querySelectorAll('#auth-container .page').forEach(page => page.classList.remove('active'));
            document.getElementById('login-page').classList.add('active');
            clearMessages();
        }

        function showRegisterPage() {
            document.querySelectorAll('#auth-container .page').forEach(page => page.classList.remove('active'));
            document.getElementById('register-page').classList.add('active');
            clearMessages();
        }

        function showPasswordReset() {
            handlePasswordReset();
        }

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';
        }

        function hideAuthContainer() {
            document.getElementById('auth-container').style.display = 'none';
        }

        function showAppContainer() {
            document.getElementById('app-container').style.display = 'block';
            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
            }
            // „É°„Ç§„É≥„Ç¢„Éó„É™„ÇíÂàùÊúüÂåñ
            updateTodayMedications();
            updateMedicationsList();
            checkStockWarnings();
        }

        function hideAppContainer() {
            document.getElementById('app-container').style.display = 'none';
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showMessage(elementId, message, type) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `form-message ${type}`;
            messageEl.style.display = 'block';
        }

        function clearMessages() {
            document.querySelectorAll('.form-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
        }

        // FirebaseË™çË®º„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/email-already-in-use': '„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô',
                'auth/weak-password': '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÂº±„Åô„Åé„Åæ„ÅôÔºà6ÊñáÂ≠ó‰ª•‰∏äÂøÖË¶ÅÔºâ',
                'auth/invalid-email': 'ÁÑ°Âäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„Åô',
                'auth/user-not-found': '„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
                'auth/wrong-password': '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô',
                'auth/too-many-requests': '„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§ö„Åô„Åé„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                'auth/network-request-failed': '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü',
                'auth/invalid-credential': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô'
            };
            return errorMessages[errorCode] || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
        }

        // „Éï„Ç©„Éº„É†„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', () => {
            // „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await handleLogin(email, password);
            });

            // Êñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É†
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;
                await handleRegister(email, password, passwordConfirm);
            });

            // FirebaseË™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
            window.onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user && user.emailVerified) {
                    currentUser = user;
                    isAuthenticated = true;
                    hideAuthContainer();
                    showAppContainer();
                } else {
                    currentUser = null;
                    isAuthenticated = false;
                    showAuthContainer();
                    hideAppContainer();
                }
            });
        });

        // „Ç¢„Éó„É™Ëµ∑ÂãïÊôÇ„Å´„ÇÇÂÆüË°å
        cleanupOldPhotos();
    </script>
</body>
</html>