<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠè–¬ã®ã‚“ã ï¼Ÿ - æœè–¬ç®¡ç†ã‚¢ãƒ—ãƒª v2.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ãŠè–¬ã®ã‚“ã ï¼Ÿ">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234CAF50'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3EğŸ’Š%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f4f8;
            color: #2d3748;
            padding-bottom: 70px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        
        .tab.active {
            color: #667eea;
            font-weight: bold;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .medication-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .medication-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .medication-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .take-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .take-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .take-button.taken {
            background-color: #ddd;
            color: #666;
            cursor: not-allowed;
        }
        
        .add-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .save-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .cancel-button {
            background-color: #f44336;
            color: white;
        }
        
        .history-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-date {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-meds {
            color: #666;
            font-size: 14px;
        }
        
        .history-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
            cursor: pointer;
            border: 2px solid #ddd;
        }
        
        .history-photo:hover {
            border-color: #4CAF50;
        }
        
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .history-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .gallery-item {
            position: relative;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .gallery-item-info {
            padding: 10px;
            font-size: 12px;
        }
        
        .gallery-item-date {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .gallery-item-med {
            color: #666;
        }
        
        .stock-warning {
            background-color: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .camera-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            width: 100%;
        }
        
        .camera-modal .modal-content {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .camera-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .camera-video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-canvas {
            display: none;
        }
        
        .captured-image {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .camera-controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .capture-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .capture-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .retake-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        
        .retake-button:hover {
            background-color: #cbd5e0;
        }
        
        .analysis-result {
            background: #edf2f7;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }
        
        .success-message {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .warning-message {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }
        
        .form-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .form-message.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .form-message.error {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }
        
        .form-message.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ãŠè–¬ã®ã‚“ã ï¼Ÿ</h1>
    </div>
    
    <!-- èªè¨¼ç”»é¢ -->
    <div id="auth-container" style="display: none;">
        <div class="container">
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
            <div id="login-page" class="page active">
                <div class="medication-card">
                    <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-button">ãƒ­ã‚°ã‚¤ãƒ³</button>
                            <button type="button" onclick="showRegisterPage()" class="cancel-button">æ–°è¦ç™»éŒ²</button>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="#" onclick="showPasswordReset()" style="color: #4CAF50; text-decoration: none;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã¯ã“ã¡ã‚‰</a>
                        </div>
                    </form>
                    <div id="login-message" class="form-message"></div>
                </div>
            </div>

            <!-- æ–°è¦ç™»éŒ²ç”»é¢ -->
            <div id="register-page" class="page">
                <div class="medication-card">
                    <h2>ğŸ“ æ–°è¦ç™»éŒ²</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="register-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="register-password" required minlength="6" placeholder="6æ–‡å­—ä»¥ä¸Š">
                        </div>
                        <div class="form-group">
                            <label for="register-password-confirm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                            <input type="password" id="register-password-confirm" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-button">ç™»éŒ²</button>
                            <button type="button" onclick="showLoginPage()" class="cancel-button">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹</button>
                        </div>
                    </form>
                    <div id="register-message" class="form-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªç”»é¢ -->
    <div id="app-container" style="display: none;">
        <div class="container">
            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
            <div id="home-page" class="page active">
                <div id="stock-warnings"></div>
                <h2>ä»Šæ—¥ã®æœè–¬</h2>
                <div id="today-medications"></div>
            </div>
        
        <!-- è–¬ç®¡ç†ç”»é¢ -->
        <div id="medications-page" class="page">
            <h2>ç™»éŒ²æ¸ˆã¿ã®è–¬</h2>
            <div id="medications-list"></div>
        </div>
        
        <!-- å±¥æ­´ç”»é¢ -->
        <div id="history-page" class="page">
            <h2>æœè–¬å±¥æ­´</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="showHistoryView('list')" id="list-view-btn" style="padding: 8px 15px; margin-right: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“‹ ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
                <button onclick="showHistoryView('gallery')" id="gallery-view-btn" style="padding: 8px 15px; background: #ddd; color: #666; border: none; border-radius: 5px; cursor: pointer;">ğŸ–¼ï¸ å†™çœŸä¸€è¦§</button>
            </div>
            <div id="history-list"></div>
            <div id="history-gallery" style="display: none;"></div>
        </div>
        
        <!-- è¨­å®šç”»é¢ -->
        <div id="settings-page" class="page">
            <h2>è¨­å®š</h2>
            
            <!-- GitHubé€£æºè¨­å®š -->
            <div class="medication-card">
                <h3>ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
                <p style="color: #666; margin-bottom: 15px;">GitHubã«ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦è¤‡æ•°ç«¯æœ«ã§åŒæœŸã§ãã¾ã™</p>
                
                <div id="github-status" style="margin-bottom: 15px;">
                    <div id="github-disconnected" style="display: block;">
                        <p style="color: #ff9800;">âŒ GitHubæœªé€£æº</p>
                        <button onclick="connectGitHub()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">GitHubé€£æºã‚’é–‹å§‹</button>
                    </div>
                    <div id="github-connected" style="display: none;">
                        <p style="color: #4CAF50;">âœ… GitHubé€£æºæ¸ˆã¿</p>
                        <div style="font-size: 14px; color: #666; margin: 10px 0;">
                            <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span id="github-username"></span></div>
                            <div>ãƒªãƒã‚¸ãƒˆãƒª: <span id="github-repo"></span></div>
                            <div>æœ€çµ‚åŒæœŸ: <span id="last-sync"></span></div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="manualBackup()" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                            <button onclick="restoreFromGitHub()" style="background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</button>
                            <button onclick="disconnectGitHub()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">é€£æºè§£é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ™‚é–“è¨­å®š -->
            <div class="medication-card">
                <h3>â° é£Ÿäº‹æ™‚é–“ã®è¨­å®š</h3>
                <p style="color: #666; margin-bottom: 15px;">æ¯é£Ÿå¾Œã®æœè–¬æ™‚é–“ã‚’è¨­å®šã§ãã¾ã™</p>
                <div class="form-group">
                    <label for="breakfast-time">æœé£Ÿå¾Œã®æ™‚é–“</label>
                    <input type="time" id="breakfast-time" value="09:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="lunch-time">æ˜¼é£Ÿå¾Œã®æ™‚é–“</label>
                    <input type="time" id="lunch-time" value="13:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="dinner-time">å¤•é£Ÿå¾Œã®æ™‚é–“</label>
                    <input type="time" id="dinner-time" value="19:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="bedtime">å°±å¯å‰ã®æ™‚é–“</label>
                    <input type="time" id="bedtime" value="22:00" onchange="saveMealTimeSettings()">
                </div>
            </div>
            
            <!-- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
            <div class="medication-card">
                <h3>ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                <p style="color: #666; margin-bottom: 15px;">ç«¯æœ«å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™</p>
                <div style="display: flex; gap: 10px;">
                    <button onclick="exportLocalData()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importLocalData(event)">
                    <button onclick="document.getElementById('import-file').click()" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
            
            <!-- ã‚¢ãƒ—ãƒªæƒ…å ± -->
            <div class="medication-card">
                <h3>â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</h3>
                <div style="color: #666; font-size: 14px; line-height: 1.5;">
                    <div>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.1</div>
                    <div>ãƒ‡ãƒ¼ã‚¿ä¿å­˜å ´æ‰€: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</div>
                    <div>å†™çœŸä¿æŒæœŸé–“: 3ãƒ¶æœˆé–“</div>
                    <div style="margin-top: 10px;">
                        <p><strong>ãŠè–¬ã®ã‚“ã ï¼Ÿ</strong>ã¯æœè–¬ç®¡ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹PWAã‚¢ãƒ—ãƒªã§ã™ã€‚</p>
                        <p style="margin-top: 5px; font-size: 12px; color: #999;">
                            â€»ã“ã®ã‚¢ãƒ—ãƒªã¯åŒ»ç™‚æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åŒ»ç™‚åˆ¤æ–­ã¯å¿…ãšåŒ»å¸«ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="medication-card">
                <h3>ğŸšª ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="current-user-email" style="color: #666;"></span>
                    <button onclick="handleLogout()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ã‚¿ãƒ–ãƒãƒ¼ -->
    <div class="tab-bar">
        <button class="tab active" onclick="showPage('home')">
            <div>ğŸ’Š</div>
            <div>æœç”¨</div>
        </button>
        <button class="tab" onclick="showPage('medications')">
            <div>ğŸ—ƒï¸</div>
            <div>è–¬ç®±</div>
        </button>
        <button class="tab" onclick="showPage('history')">
            <div>ğŸ“Š</div>
            <div>å±¥æ­´</div>
        </button>
        <button class="tab" onclick="showPage('settings')">
            <div>âš™ï¸</div>
            <div>è¨­å®š</div>
        </button>
    </div>
    
    <!-- è¿½åŠ ãƒœã‚¿ãƒ³ -->
    <button class="add-button" onclick="showAddModal()">+</button>
    
    <!-- è–¬è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3>æ–°ã—ã„è–¬ã‚’è¿½åŠ </h3>
            <form id="add-medication-form">
                <div class="form-group">
                    <label for="med-name">è–¬ã®åå‰</label>
                    <input type="text" id="med-name" required>
                </div>
                <div class="form-group">
                    <label for="med-purpose">è–¬ã®ç”¨é€”</label>
                    <select id="med-purpose-select" onchange="toggleCustomPurpose()" style="width: 100%;">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="é ­ç—›ãƒ»è§£ç†±">é ­ç—›ãƒ»è§£ç†±</option>
                        <option value="èƒƒè…¸è–¬">èƒƒè…¸è–¬</option>
                        <option value="é¢¨é‚ªè–¬">é¢¨é‚ªè–¬</option>
                        <option value="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</option>
                        <option value="ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ">ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ</option>
                        <option value="é«˜è¡€åœ§">é«˜è¡€åœ§</option>
                        <option value="ç³–å°¿ç—…">ç³–å°¿ç—…</option>
                        <option value="æŠ—ç”Ÿç‰©è³ª">æŠ—ç”Ÿç‰©è³ª</option>
                        <option value="ç¡çœ è–¬">ç¡çœ è–¬</option>
                        <option value="custom">ãã®ä»–ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰</option>
                    </select>
                    <input type="text" id="med-purpose-custom" placeholder="è–¬ã®ç”¨é€”ã‚’å…¥åŠ›" style="display: none; margin-top: 10px; width: 100%;">
                </div>
                <div class="form-group">
                    <label for="med-dosage">ç”¨é‡ï¼ˆ1å›ã‚ãŸã‚Šï¼‰</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="med-dosage-number" required style="flex: 1;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                        <select id="med-dosage-unit" required style="flex: 1;">
                            <option value="éŒ ">éŒ </option>
                            <option value="åŒ…">åŒ…</option>
                            <option value="æ¯">æ¯</option>
                            <option value="æ»´">æ»´</option>
                            <option value="mL">mL</option>
                            <option value="g">g</option>
                            <option value="å€‹">å€‹</option>
                            <option value="ç²’">ç²’</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="med-frequency">æœç”¨é »åº¦</label>
                    <select id="med-frequency" required>
                        <option value="æ¯é£Ÿå¾Œ">æ¯é£Ÿå¾Œ</option>
                        <option value="æœé£Ÿå¾Œ">æœé£Ÿå¾Œ</option>
                        <option value="æ˜¼é£Ÿå¾Œ">æ˜¼é£Ÿå¾Œ</option>
                        <option value="å¤•é£Ÿå¾Œ">å¤•é£Ÿå¾Œ</option>
                        <option value="æœå¤•é£Ÿå¾Œ">æœå¤•é£Ÿå¾Œ</option>
                        <option value="å°±å¯å‰">å°±å¯å‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="med-stock">ç¾åœ¨ã®åœ¨åº«æ•°</label>
                    <input type="number" id="med-stock" required>
                </div>
                <div class="form-group">
                    <label for="med-alert-threshold">åœ¨åº«è­¦å‘Šã—ãã„å€¤</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="med-alert-threshold-select" onchange="toggleCustomThreshold()" style="flex: 1;">
                            <option value="1">æ®‹ã‚Š1å€‹</option>
                            <option value="2">æ®‹ã‚Š2å€‹</option>
                            <option value="3">æ®‹ã‚Š3å€‹</option>
                            <option value="4">æ®‹ã‚Š4å€‹</option>
                            <option value="5">æ®‹ã‚Š5å€‹</option>
                            <option value="6">æ®‹ã‚Š6å€‹</option>
                            <option value="7" selected>æ®‹ã‚Š7å€‹</option>
                            <option value="8">æ®‹ã‚Š8å€‹</option>
                            <option value="9">æ®‹ã‚Š9å€‹</option>
                            <option value="10">æ®‹ã‚Š10å€‹</option>
                            <option value="custom">ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰</option>
                        </select>
                        <input type="number" id="med-alert-threshold-custom" placeholder="å€‹æ•°ã‚’å…¥åŠ›" min="1" style="display: none; width: 100px;">
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="save-button">ä¿å­˜</button>
                    <button type="button" class="cancel-button" onclick="hideAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="camera-modal" class="modal camera-modal">
        <div class="modal-content">
            <h3>æœç”¨å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„</h3>
            <div class="camera-container">
                <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoCapture(event)">
                <canvas id="camera-canvas" class="camera-canvas" style="display: none;"></canvas>
                <img id="captured-image" class="captured-image" style="display: none;">
                
                <div class="camera-controls">
                    <button id="capture-btn" class="capture-button" onclick="openCameraApp()">ğŸ“· æ’®å½±</button>
                    <button id="retake-btn" class="retake-button" onclick="retakePhoto()" style="display: none;">ğŸ”„ æ’®ã‚Šç›´ã—</button>
                </div>
                
                <div id="analysis-result" class="analysis-result" style="display: none;"></div>
            </div>
            
            <div id="medication-confirm-section" style="display: none;">
                <div class="medication-confirm-info">
                    <h4 id="confirm-med-name" style="margin-bottom: 10px;"></h4>
                    <div class="form-group">
                        <label for="confirm-dosage">æœç”¨æ•°é‡</label>
                        <input type="number" id="confirm-dosage" min="1" value="1" style="width: 100px;">
                        <span id="confirm-dosage-unit" style="margin-left: 5px;"></span>
                    </div>
                    <div style="color: #666; margin-bottom: 10px;">
                        <span>ç¾åœ¨ã®åœ¨åº«: </span><span id="confirm-current-stock"></span>
                        <br>
                        <span>æœç”¨å¾Œã®åœ¨åº«: </span><span id="confirm-remaining-stock" style="font-weight: bold;"></span>
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="save-button" onclick="confirmMedicationWithPhoto()">ç™»éŒ²</button>
                    <button class="cancel-button" onclick="resetCameraModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
            
            <div class="form-buttons" id="camera-initial-buttons">
                <button class="cancel-button" onclick="hideCameraModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Firebaseè¨­å®šã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            sendEmailVerification,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyD6_2ioXr3LJU7PpThy7kxXbCfEFatUi_U",
            authDomain: "medication-tracker-b5d0c.firebaseapp.com",
            projectId: "medication-tracker-b5d0c",
            storageBucket: "medication-tracker-b5d0c.firebasestorage.app",
            messagingSenderId: "112454739779",
            appId: "1:112454739779:web:225df0ffd166882c1931f6",
            measurementId: "G-0LPF5Y8NPR"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.firebaseAuth = auth;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.sendEmailVerification = sendEmailVerification;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>

    <script>
        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç†
        let isAuthenticated = false;
        let currentUser = null;
        
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        
        // ã‚«ãƒ¡ãƒ©é–¢é€£ã®å¤‰æ•°
        let currentMedId = null;
        let currentMealTime = null;
        let cameraStream = null;
        
        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function showPage(pageName) {
            // ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById(pageName + '-page').classList.add('active');
            
            // è¨­å®šãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹éš›ã«æ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            if (pageName === 'settings') {
                loadMealTimeSettings();
            }
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            event.target.closest('.tab').classList.add('active');
            
            // ãƒšãƒ¼ã‚¸ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            if (pageName === 'home') {
                updateTodayMedications();
                checkStockWarnings();
            } else if (pageName === 'medications') {
                updateMedicationsList();
            } else if (pageName === 'history') {
                updateHistoryList();
            } else if (pageName === 'settings') {
                updateSettingsPage();
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤º
        function showAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }
        
        function hideAddModal() {
            const modal = document.getElementById('add-modal');
            modal.style.display = 'none';
            modal.dataset.editId = '';
            document.getElementById('add-medication-form').reset();
            document.querySelector('#add-modal h3').textContent = 'æ–°ã—ã„è–¬ã‚’è¿½åŠ ';
            // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('med-purpose-custom').style.display = 'none';
            document.getElementById('med-purpose-custom').required = false;
        }
        
        // è–¬ã®ç”¨é€”ã®ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆ
        function toggleCustomPurpose() {
            const select = document.getElementById('med-purpose-select');
            const customInput = document.getElementById('med-purpose-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // åœ¨åº«è­¦å‘Šã—ãã„å€¤ã®ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆ
        function toggleCustomThreshold() {
            const select = document.getElementById('med-alert-threshold-select');
            const customInput = document.getElementById('med-alert-threshold-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // è–¬ã®è¿½åŠ /ç·¨é›†
        document.getElementById('add-medication-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dosageNumber = document.getElementById('med-dosage-number').value;
            const dosageUnit = document.getElementById('med-dosage-unit').value;
            const editId = document.getElementById('add-modal').dataset.editId;
            
            // è–¬ã®ç”¨é€”ã‚’å–å¾—
            const purposeSelect = document.getElementById('med-purpose-select').value;
            const purposeCustom = document.getElementById('med-purpose-custom').value;
            const purpose = purposeSelect === 'custom' ? purposeCustom : purposeSelect;
            
            // åœ¨åº«è­¦å‘Šã—ãã„å€¤ã‚’å–å¾—
            const thresholdSelect = document.getElementById('med-alert-threshold-select').value;
            const thresholdCustom = document.getElementById('med-alert-threshold-custom').value;
            const alertThreshold = thresholdSelect === 'custom' ? 
                parseInt(thresholdCustom) : parseInt(thresholdSelect);
            
            const medicationData = {
                name: document.getElementById('med-name').value,
                dosage: dosageNumber + dosageUnit,
                frequency: document.getElementById('med-frequency').value,
                stock: parseInt(document.getElementById('med-stock').value),
                alertThreshold: alertThreshold || 7,
                purpose: purpose || '' // è–¬ã®ç”¨é€”ã‚’è¿½åŠ 
            };
            
            if (editId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                const medIndex = medications.findIndex(m => m.id === parseInt(editId));
                if (medIndex !== -1) {
                    medications[medIndex] = {
                        ...medications[medIndex],
                        ...medicationData
                    };
                }
            } else {
                // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                const medication = {
                    id: Date.now(),
                    ...medicationData,
                    createdAt: new Date().toISOString()
                };
                medications.push(medication);
                
                // é€šçŸ¥ã®è¨­å®š
                scheduleNotifications(medication);
            }
            
            localStorage.setItem('medications', JSON.stringify(medications));
            
            hideAddModal();
            showPage('medications');
        });
        
        // é£Ÿäº‹æ™‚é–“è¨­å®šã‚’ä¿å­˜
        function saveMealTimeSettings() {
            const settings = {
                breakfast: document.getElementById('breakfast-time').value,
                lunch: document.getElementById('lunch-time').value,
                dinner: document.getElementById('dinner-time').value,
                bedtime: document.getElementById('bedtime').value
            };
            localStorage.setItem('mealTimeSettings', JSON.stringify(settings));
        }
        
        // é£Ÿäº‹æ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadMealTimeSettings() {
            const saved = localStorage.getItem('mealTimeSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('breakfast-time').value = settings.breakfast || '09:00';
                document.getElementById('lunch-time').value = settings.lunch || '13:00';
                document.getElementById('dinner-time').value = settings.dinner || '19:00';
                document.getElementById('bedtime').value = settings.bedtime || '22:00';
            }
        }
        
        // ç¾åœ¨ã®é£Ÿäº‹æ™‚é–“ã‚’å–å¾—
        function getCurrentMealTime() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // æ™‚é–“ã‚’åˆ†ã«å¤‰æ›
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const breakfastTime = toMinutes(settings.breakfast);
            const lunchTime = toMinutes(settings.lunch);
            const dinnerTime = toMinutes(settings.dinner);
            const bedtimeTime = toMinutes(settings.bedtime);
            
            // å„é£Ÿäº‹æ™‚é–“ã®å‰å¾Œ1æ™‚é–“ã‚’æœè–¬æ™‚é–“ã¨ã™ã‚‹
            if (currentTime >= breakfastTime - 60 && currentTime < breakfastTime + 60) return 'æœé£Ÿå¾Œ';
            else if (currentTime >= lunchTime - 60 && currentTime < lunchTime + 60) return 'æ˜¼é£Ÿå¾Œ';
            else if (currentTime >= dinnerTime - 60 && currentTime < dinnerTime + 60) return 'å¤•é£Ÿå¾Œ';
            else if (currentTime >= bedtimeTime - 60 || currentTime < 360) return 'å°±å¯å‰'; // 360 = 6:00 AM
            
            return '';
        }
        
        // ä»Šæ—¥ã®æœè–¬ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateTodayMedications() {
            const container = document.getElementById('today-medications');
            container.innerHTML = '';
            
            const mealTime = getCurrentMealTime();
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // æ™‚é–“è¨­å®šã‚’å–å¾—
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // å„é£Ÿäº‹æ™‚é–“ã‚’åˆ†ã«å¤‰æ›
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const mealTimes = {
                'æœé£Ÿå¾Œ': toMinutes(settings.breakfast),
                'æ˜¼é£Ÿå¾Œ': toMinutes(settings.lunch),
                'å¤•é£Ÿå¾Œ': toMinutes(settings.dinner),
                'å°±å¯å‰': toMinutes(settings.bedtime)
            };
            
            // éå»2æ™‚é–“ä»¥å†…ã«æœç”¨ã™ã¹ãã ã£ãŸè–¬ã‚’å–å¾—
            const overdueWarnings = [];
            for (const [meal, time] of Object.entries(mealTimes)) {
                if (currentTime >= time + 120) { // 2æ™‚é–“ä»¥ä¸ŠçµŒé
                    const overdueMeds = medications.filter(med => {
                        return (med.frequency === 'æ¯é£Ÿå¾Œ' || 
                               med.frequency === meal ||
                               (med.frequency === 'æœå¤•é£Ÿå¾Œ' && (meal === 'æœé£Ÿå¾Œ' || meal === 'å¤•é£Ÿå¾Œ'))) &&
                               !isTakenToday(med.id, meal);
                    });
                    overdueWarnings.push(...overdueMeds.map(med => ({...med, mealTime: meal})));
                }
            }
            
            // é…å»¶è­¦å‘Šã‚’è¡¨ç¤º
            if (overdueWarnings.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning-message';
                warningDiv.style.marginBottom = '20px';
                warningDiv.innerHTML = '<strong>âš ï¸ æœç”¨æ™‚é–“ã‚’éãã¦ã„ã¾ã™</strong>';
                container.appendChild(warningDiv);
                
                overdueWarnings.forEach(warning => {
                    const card = document.createElement('div');
                    card.className = 'medication-card';
                    card.style.border = '2px solid #ff9800';
                    card.innerHTML = `
                        <div class="medication-name">${warning.name} - ${warning.mealTime}</div>
                        <div class="medication-info" style="color: #ff6b6b;">æœç”¨æ™‚é–“ã‹ã‚‰2æ™‚é–“ä»¥ä¸ŠçµŒé</div>
                        <div class="medication-info">${warning.dosage} - ${warning.frequency}</div>
                        ${warning.purpose ? `<div class="medication-info">ç”¨é€”: ${warning.purpose}</div>` : ''}
                        <div class="medication-info">åœ¨åº«: ${warning.stock}å€‹</div>
                        <button class="take-button" 
                                onclick="showCameraModal(${warning.id}, '${warning.mealTime}')"
                                style="background: #ff9800;">
                            ğŸ“¸ ä»Šã™ãæœç”¨ã™ã‚‹
                        </button>
                    `;
                    container.appendChild(card);
                });
                
                // é…å»¶è­¦å‘Šã®é€šçŸ¥ã‚’é€ä¿¡
                checkOverdueNotifications(overdueWarnings);
            }
            
            // ç¾åœ¨ã®æœç”¨æ™‚é–“ã®è–¬ã‚’è¡¨ç¤º
            const todayMeds = medications.filter(med => {
                return med.frequency === 'æ¯é£Ÿå¾Œ' || 
                       med.frequency === mealTime ||
                       (med.frequency === 'æœå¤•é£Ÿå¾Œ' && (mealTime === 'æœé£Ÿå¾Œ' || mealTime === 'å¤•é£Ÿå¾Œ'));
            });
            
            if (todayMeds.length === 0 && overdueWarnings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ç¾åœ¨æœç”¨ã™ã‚‹è–¬ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            todayMeds.forEach(med => {
                const taken = isTakenToday(med.id, mealTime);
                const card = document.createElement('div');
                card.className = 'medication-card';
                card.innerHTML = `
                    <div class="medication-name">${med.name}</div>
                    <div class="medication-info">${med.dosage} - ${med.frequency}</div>
                    ${med.purpose ? `<div class="medication-info">ç”¨é€”: ${med.purpose}</div>` : ''}
                    <div class="medication-info">åœ¨åº«: ${med.stock}å€‹</div>
                    <button class="take-button ${taken ? 'taken' : ''}" 
                            onclick="showCameraModal(${med.id}, '${mealTime}')"
                            ${taken ? 'disabled' : ''}>
                        ${taken ? 'âœ“ æœç”¨æ¸ˆã¿' : 'ğŸ“¸ æœç”¨ã™ã‚‹'}
                    </button>
                    ${taken ? `<button class="cancel-button" onclick="undoMedication(${med.id}, '${mealTime}')" style="margin-top: 5px; width: 100%; padding: 8px; font-size: 14px;">ğŸ”„ å–ã‚Šæ¶ˆã—</button>` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        // è–¬ã‚’æœç”¨ï¼ˆå†™çœŸå¿…é ˆï¼‰
        // ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã•ã‚Œãšã€ã™ã¹ã¦ã®æœç”¨è¨˜éŒ²ã¯ showCameraModal ã‚’çµŒç”±ã—ã¦å†™çœŸä»˜ãã§è¡Œã‚ã‚Œã¾ã™
        function takeMedication(medId, mealTime) {
            // å†™çœŸæ’®å½±ãŒå¿…é ˆã®ãŸã‚ã€ç›´æ¥ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’èµ·å‹•
            showCameraModal(medId, mealTime);
        }
        
        // ä»Šæ—¥æœç”¨æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        function isTakenToday(medId, mealTime) {
            const today = new Date().toDateString();
            return history.some(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled; // å–ã‚Šæ¶ˆã•ã‚Œã¦ã„ãªã„å±¥æ­´ã®ã¿
            });
        }
        
        // æœç”¨è¨˜éŒ²ã®å–ã‚Šæ¶ˆã—ï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰ï¼‰
        function undoMedication(medId, mealTime) {
            if (!confirm('æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿåœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            const today = new Date().toDateString();
            const historyItem = history.find(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled;
            });
            
            if (historyItem) {
                // å±¥æ­´ã‚’å–ã‚Šæ¶ˆã—æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // åœ¨åº«ã‚’æˆ»ã™
                const med = medications.find(m => m.id === medId);
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                checkStockWarnings();
                
                alert('âœ… æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚åœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã—ãŸã€‚');
            }
        }
        
        // å±¥æ­´ã‹ã‚‰ã®å–ã‚Šæ¶ˆã—
        function undoHistoryItem(medId, takenAt, mealTime) {
            if (!confirm('ã“ã®æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿåœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            const historyItem = history.find(h => 
                h.medicationId === medId && 
                h.takenAt === takenAt && 
                h.mealTime === mealTime &&
                !h.cancelled
            );
            
            if (historyItem) {
                // å±¥æ­´ã‚’å–ã‚Šæ¶ˆã—æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // åœ¨åº«ã‚’æˆ»ã™
                const med = medications.find(m => m.id === parseInt(medId));
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                updateHistoryList();
                checkStockWarnings();
                
                alert('âœ… æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚åœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã—ãŸã€‚');
            }
        }
        
        // åœ¨åº«è­¦å‘Šã‚’ãƒã‚§ãƒƒã‚¯
        function checkStockWarnings() {
            const container = document.getElementById('stock-warnings');
            container.innerHTML = '';
            
            const warnings = medications.filter(med => med.stock <= (med.alertThreshold || 7));
            if (warnings.length > 0) {
                warnings.forEach(med => {
                    const warning = document.createElement('div');
                    warning.className = 'stock-warning';
                    warning.textContent = `âš ï¸ ${med.name}ã®åœ¨åº«ãŒæ®‹ã‚Š${med.stock}å€‹ã§ã™ã€‚è¿½åŠ è³¼å…¥ã—ã¦ãã ã•ã„ï¼`;
                    container.appendChild(warning);
                });
            }
        }
        
        // è–¬ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateMedicationsList() {
            const container = document.getElementById('medications-list');
            container.innerHTML = '';
            
            if (medications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">è–¬ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            medications.forEach(med => {
                const card = document.createElement('div');
                card.className = 'medication-card';
                card.innerHTML = `
                    <div class="medication-name">${med.name}</div>
                    <div class="medication-info">${med.dosage} - ${med.frequency}</div>
                    ${med.purpose ? `<div class="medication-info">ç”¨é€”: ${med.purpose}</div>` : ''}
                    <div class="medication-info">åœ¨åº«: ${med.stock}å€‹ (è­¦å‘Š: ${med.alertThreshold || 7}å€‹)</div>
                    <div style="margin-top: 10px;">
                        <button onclick="editMedication(${med.id})" style="padding: 5px 10px; margin-right: 5px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">âœï¸ ç·¨é›†</button>
                        <button onclick="deleteMedication(${med.id})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // å±¥æ­´ã‚’æ›´æ–°
        function updateHistoryList() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æœè–¬å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // å–ã‚Šæ¶ˆã•ã‚Œã¦ã„ãªã„å±¥æ­´ã®ã¿è¡¨ç¤º
            const activeHistory = history.filter(h => !h.cancelled);
            
            if (activeHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æœè–¬å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedHistory = {};
            activeHistory.slice().reverse().forEach(h => {
                const date = new Date(h.takenAt).toLocaleDateString('ja-JP');
                if (!groupedHistory[date]) {
                    groupedHistory[date] = [];
                }
                groupedHistory[date].push(h);
            });
            
            Object.entries(groupedHistory).forEach(([date, items]) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-meds">
                        ${items.map(item => {
                            const time = new Date(item.takenAt).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                            const hasPhoto = item.photo || item.photoVerified;
                            return `
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    ${hasPhoto && item.photo ? `
                                        <img class="history-photo" src="${item.photo}" 
                                             onclick="showPhotoModal('${item.photo}')" 
                                             alt="æœç”¨å†™çœŸ">
                                    ` : hasPhoto ? `
                                        <div class="history-photo" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0;">
                                            ğŸ“¸
                                        </div>
                                    ` : ''}
                                    <div style="flex: 1;">
                                        <div>${item.medicationName} (${item.mealTime})</div>
                                        <div style="font-size: 12px; color: #888;">${time}</div>
                                    </div>
                                    <button class="cancel-button" onclick="undoHistoryItem('${item.medicationId}', '${item.takenAt}', '${item.mealTime}')" 
                                            style="padding: 2px 8px; font-size: 12px; margin-left: 10px;">ğŸ”„ å–ã‚Šæ¶ˆã—</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }
        
        // é€šçŸ¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        function scheduleNotifications(medication) {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // æœè–¬æ™‚é–“ã®é€šçŸ¥ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            setMedicationReminders(medication);
        }
        
        // é…å»¶è­¦å‘Šã®é€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        function checkOverdueNotifications(overdueWarnings) {
            if ('Notification' in window && Notification.permission === 'granted') {
                overdueWarnings.forEach(warning => {
                    const notificationKey = `overdue-${warning.id}-${warning.mealTime}-${new Date().toDateString()}`;
                    
                    // ä»Šæ—¥æ—¢ã«é€šçŸ¥ã‚’é€ä¿¡ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                    if (!localStorage.getItem(notificationKey)) {
                        new Notification('âš ï¸ æœç”¨æ™‚é–“ã‚’éãã¦ã„ã¾ã™', {
                            body: `${warning.name}ï¼ˆ${warning.mealTime}ï¼‰ã‚’æœç”¨ã—ã¦ãã ã•ã„`,
                            icon: '/icon-192x192.png',
                            tag: notificationKey,
                            requireInteraction: true
                        });
                        
                        // é€šçŸ¥é€ä¿¡æ¸ˆã¿ã¨ã—ã¦è¨˜éŒ²
                        localStorage.setItem(notificationKey, 'sent');
                    }
                });
            }
        }
        
        // æœè–¬ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®è¨­å®š
        function setMedicationReminders(medication) {
            const frequency = medication.frequency;
            const times = [];
            
            // æœç”¨é »åº¦ã«å¿œã˜ã¦é€šçŸ¥æ™‚é–“ã‚’è¨­å®š
            switch(frequency) {
                case 'æ¯é£Ÿå¾Œ':
                    times.push('08:30', '12:30', '19:30'); // æœæ˜¼å¤•é£Ÿå¾Œ
                    break;
                case 'æœé£Ÿå¾Œ':
                    times.push('08:30');
                    break;
                case 'æ˜¼é£Ÿå¾Œ':
                    times.push('12:30');
                    break;
                case 'å¤•é£Ÿå¾Œ':
                    times.push('19:30');
                    break;
                case 'æœå¤•é£Ÿå¾Œ':
                    times.push('08:30', '19:30');
                    break;
                case 'å°±å¯å‰':
                    times.push('22:00');
                    break;
            }
            
            // å„æ™‚é–“ã«å¯¾ã—ã¦é€šçŸ¥ã‚’è¨­å®š
            times.forEach(time => {
                scheduleNotificationAtTime(medication, time);
            });
        }
        
        // æŒ‡å®šæ™‚é–“ã«é€šçŸ¥ã‚’è¨­å®š
        function scheduleNotificationAtTime(medication, timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const now = new Date();
            const scheduledTime = new Date();
            scheduledTime.setHours(hours, minutes, 0, 0);
            
            // ã‚‚ã—ä»Šæ—¥ã®æ™‚é–“ãŒéãã¦ã„ãŸã‚‰æ˜æ—¥ã«è¨­å®š
            if (scheduledTime <= now) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }
            
            const timeUntilNotification = scheduledTime.getTime() - now.getTime();
            
            setTimeout(() => {
                showMedicationNotification(medication, timeString);
                // ç¿Œæ—¥ä»¥é™ã‚‚ç¶™ç¶šã™ã‚‹ãŸã‚å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                setTimeout(() => {
                    scheduleNotificationAtTime(medication, timeString);
                }, 24 * 60 * 60 * 1000); // 24æ™‚é–“å¾Œ
            }, timeUntilNotification);
        }
        
        // è–¬ã®é€šçŸ¥ã‚’è¡¨ç¤º
        function showMedicationNotification(medication, time) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`ğŸ’Š ãŠè–¬ã®æ™‚é–“ã§ã™`, {
                    body: `${medication.name} (${medication.dosage}) ã‚’æœç”¨ã—ã¦ãã ã•ã„`,
                    icon: 'ğŸ’Š',
                    badge: 'ğŸ’Š',
                    tag: `medication-${medication.id}`,
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'take',
                            title: 'æœç”¨æ¸ˆã¿'
                        },
                        {
                            action: 'later',
                            title: 'å¾Œã§'
                        }
                    ]
                });
                
                notification.onclick = function() {
                    window.focus();
                    // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
                    showPage('home');
                    this.close();
                };
                
                // 10ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
                setTimeout(() => {
                    notification.close();
                }, 10000);
            }
        }
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        function checkLowStockNotifications() {
            medications.forEach(med => {
                const threshold = med.alertThreshold || 7;
                if (med.stock <= threshold && med.stock > 0) {
                    showLowStockNotification(med);
                }
            });
        }
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’è¡¨ç¤º
        function showLowStockNotification(medication) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`âš ï¸ è–¬ã®åœ¨åº«ãŒå°‘ãªããªã£ã¦ã„ã¾ã™`, {
                    body: `${medication.name}ã®åœ¨åº«ãŒæ®‹ã‚Š${medication.stock}å€‹ã§ã™ã€‚è¿½åŠ è³¼å…¥ã—ã¦ãã ã•ã„ã€‚`,
                    icon: 'âš ï¸',
                    badge: 'âš ï¸',
                    tag: `stock-${medication.id}`,
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    showPage('medications');
                    this.close();
                };
            }
        }
        
        // åˆæœŸåŒ–
        updateTodayMedications();
        checkStockWarnings();
        
        // Service Workerã®ç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker ç™»éŒ²å¤±æ•—:', error);
                    });
            });
        }
        
        // é€šçŸ¥æ¨©é™ã®è¦æ±‚
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // æ—¢å­˜ã®è–¬ã«å¯¾ã—ã¦é€šçŸ¥ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        medications.forEach(medication => {
            setMedicationReminders(medication);
        });
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        checkLowStockNotifications();
        
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‡¦ç†
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é˜²ã
            e.preventDefault();
            // å¾Œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
            deferredPrompt = e;
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #2196F3;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 9999;
                cursor: pointer;
            `;
            installBanner.innerHTML = 'ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã™ï¼';
            installBanner.onclick = installApp;
            document.body.appendChild(installBanner);
            
            // 10ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
            setTimeout(() => {
                if (installBanner.parentNode) {
                    installBanner.parentNode.removeChild(installBanner);
                }
            }, 10000);
        }
        
        function installApp() {
            if (deferredPrompt) {
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                deferredPrompt.prompt();
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã‚’å¾…ã¤
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å—ã‘å…¥ã‚Œã¾ã—ãŸ');
                    } else {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ‹’å¦ã—ã¾ã—ãŸ');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showCameraModal(medId, mealTime) {
            currentMedId = medId;
            currentMealTime = mealTime;
            
            const modal = document.getElementById('camera-modal');
            resetCameraModal();
            modal.style.display = 'block';
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetCameraModal() {
            const capturedImage = document.getElementById('captured-image');
            const analysisResult = document.getElementById('analysis-result');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            const confirmSection = document.getElementById('medication-confirm-section');
            const initialButtons = document.getElementById('camera-initial-buttons');
            const fileInput = document.getElementById('camera-input');
            
            // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            capturedImage.style.display = 'none';
            analysisResult.style.display = 'none';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            confirmSection.style.display = 'none';
            initialButtons.style.display = 'block';
            fileInput.value = '';
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hideCameraModal() {
            const modal = document.getElementById('camera-modal');
            modal.style.display = 'none';
            
            currentMedId = null;
            currentMealTime = null;
        }
        
        // OSã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
        function openCameraApp() {
            const fileInput = document.getElementById('camera-input');
            fileInput.click();
        }
        
        // å†™çœŸã‚­ãƒ£ãƒ—ãƒãƒ£å‡¦ç†
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageDataUrl = e.target.result;
                
                // æ’®å½±ã—ãŸç”»åƒã‚’è¡¨ç¤º
                const capturedImage = document.getElementById('captured-image');
                const captureBtn = document.getElementById('capture-btn');
                const retakeBtn = document.getElementById('retake-btn');
                
                capturedImage.src = imageDataUrl;
                capturedImage.style.display = 'block';
                
                // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'block';
                
                // ç”»åƒè§£æã‚’å®Ÿè¡Œ
                analyzeImage(imageDataUrl);
            };
            reader.readAsDataURL(file);
        }
        
        // æ’®ã‚Šç›´ã—
        function retakePhoto() {
            resetCameraModal();
        }
        
        // ç”»åƒåœ§ç¸®ã¨ä¿å­˜
        async function analyzeImage(imageDataUrl) {
            // ç”»åƒåœ§ç¸®
            const compressedImage = await compressImage(imageDataUrl);
            
            // åœ§ç¸®ã—ãŸç”»åƒã‚’ä¸€æ™‚ä¿å­˜
            sessionStorage.setItem('tempMedicationImage', compressedImage);
            
            // æœç”¨ç¢ºèªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            showMedicationConfirmSection();
        }
        
        // æœç”¨ç¢ºèªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        function showMedicationConfirmSection() {
            const med = medications.find(m => m.id === currentMedId);
            if (!med) return;
            
            // è–¬å‰¤æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('confirm-med-name').textContent = med.name;
            
            // ç”¨é‡ã‚’è§£æã—ã¦æ•°å€¤ã¨å˜ä½ã«åˆ†ã‘ã‚‹
            const dosageMatch = med.dosage.match(/(\d+)(.+)/);
            const dosageNumber = dosageMatch ? dosageMatch[1] : '1';
            const dosageUnit = dosageMatch ? dosageMatch[2] : 'éŒ ';
            
            document.getElementById('confirm-dosage').value = dosageNumber;
            document.getElementById('confirm-dosage-unit').textContent = dosageUnit;
            document.getElementById('confirm-current-stock').textContent = med.stock + dosageUnit;
            
            // æœç”¨æ•°é‡å¤‰æ›´æ™‚ã®åœ¨åº«è¨ˆç®—
            updateRemainingStock();
            document.getElementById('confirm-dosage').addEventListener('input', updateRemainingStock);
            
            // UIã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('medication-confirm-section').style.display = 'block';
            document.getElementById('camera-initial-buttons').style.display = 'none';
        }
        
        // æ®‹ã‚Šåœ¨åº«ã‚’æ›´æ–°
        function updateRemainingStock() {
            const med = medications.find(m => m.id === currentMedId);
            if (!med) return;
            
            const dosageInput = document.getElementById('confirm-dosage');
            const takingAmount = parseInt(dosageInput.value) || 1;
            const remaining = med.stock - takingAmount;
            
            const remainingElement = document.getElementById('confirm-remaining-stock');
            remainingElement.textContent = remaining + document.getElementById('confirm-dosage-unit').textContent;
            
            // åœ¨åº«ä¸è¶³ã®å ´åˆã¯è­¦å‘Šè¡¨ç¤º
            if (remaining < 0) {
                remainingElement.style.color = '#f56565';
            } else if (remaining <= med.alertThreshold) {
                remainingElement.style.color = '#ed8936';
            } else {
                remainingElement.style.color = '#38a169';
            }
        }
        
        // ç”»åƒåœ§ç¸®é–¢æ•°
        async function compressImage(dataUrl, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ãªãŒã‚‰ãƒªã‚µã‚¤ã‚º
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // åœ§ç¸®å¾Œã®ãƒ‡ãƒ¼ã‚¿URLã‚’è¿”ã™
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        // ç”»åƒå±¥æ­´ã®æ›´æ–°ï¼ˆå¤ã„ç”»åƒã‚’å‰Šé™¤ï¼‰
        function cleanupOldPhotos() {
            // 3ãƒ¶æœˆï¼ˆ90æ—¥ï¼‰ä»¥ä¸Šå¤ã„ç”»åƒã‚’æŒã¤å±¥æ­´ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setDate(threeMonthsAgo.getDate() - 90);
            
            let cleaned = false;
            history.forEach(item => {
                if (item.photo && new Date(item.takenAt) < threeMonthsAgo) {
                    item.photo = null; // å¤ã„ç”»åƒã‚’å‰Šé™¤
                    cleaned = true;
                }
            });
            
            if (cleaned) {
                localStorage.setItem('history', JSON.stringify(history));
                console.log('å¤ã„å†™çœŸã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ');
            }
        }
        
        // å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showPhotoModal(photoUrl) {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <img src="${photoUrl}" alt="æœç”¨å†™çœŸ">
            `;
            modal.onclick = function() {
                modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        // æœç”¨ç¢ºèªï¼ˆå†™çœŸä»˜ãï¼‰
        function confirmMedication() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                // åœ¨åº«ã‚’æ¸›ã‚‰ã™
                med.stock -= 1;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // ä¸€æ™‚ä¿å­˜ã—ãŸç”»åƒã‚’å–å¾—
                const photo = sessionStorage.getItem('tempMedicationImage');
                
                // å±¥æ­´ã«è¿½åŠ ï¼ˆå†™çœŸä»˜ãï¼‰
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: med.dosage,
                    takenAt: new Date().toISOString(),
                    mealTime: currentMealTime,
                    photoVerified: true,
                    photo: photo // åœ§ç¸®æ¸ˆã¿ç”»åƒ
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // ä¸€æ™‚ä¿å­˜ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem('tempMedicationImage');
                
                // ç”»åƒå±¥æ­´ã‚‚ç®¡ç†
                updateImageHistory();
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                checkStockWarnings();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                hideCameraModal();
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                alert('ğŸ“¸ å†™çœŸã§æœç”¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸï¼');
            }
        }
        
        // æœç”¨ç¢ºèªï¼ˆå†™çœŸä»˜ãï¼‰
        function confirmMedicationWithPhoto() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                const takingAmount = parseInt(document.getElementById('confirm-dosage').value) || 1;
                
                // åœ¨åº«ãƒã‚§ãƒƒã‚¯
                if (med.stock < takingAmount) {
                    alert('åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚');
                    return;
                }
                
                // åœ¨åº«ã‚’æ¸›ã‚‰ã™
                med.stock -= takingAmount;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // ä¸€æ™‚ä¿å­˜ã•ã‚ŒãŸå†™çœŸã‚’å–å¾—
                const tempImage = sessionStorage.getItem('tempMedicationImage');
                
                // å±¥æ­´ã«è¿½åŠ ã€€
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: takingAmount + document.getElementById('confirm-dosage-unit').textContent,
                    takenAt: new Date().toISOString(),
                    mealTime: currentMealTime,
                    photoVerified: true,
                    photo: tempImage
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // ä¸€æ™‚ä¿å­˜ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem('tempMedicationImage');
                
                // ç”»åƒå±¥æ­´ã‚‚ç®¡ç†
                cleanupOldPhotos();
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                checkStockWarnings();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                hideCameraModal();
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                alert('ğŸ“¸ æœç”¨ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸï¼');
                
                // å±¥æ­´ãƒšãƒ¼ã‚¸ã«ç§»å‹•
                showPage('history');
                updateHistoryList();
            }
        }
        
        // å±¥æ­´ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function showHistoryView(viewType) {
            const listView = document.getElementById('history-list');
            const galleryView = document.getElementById('history-gallery');
            const listBtn = document.getElementById('list-view-btn');
            const galleryBtn = document.getElementById('gallery-view-btn');
            
            if (viewType === 'list') {
                listView.style.display = 'block';
                galleryView.style.display = 'none';
                listBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                listBtn.style.color = 'white';
                galleryBtn.style.background = '#e2e8f0';
                galleryBtn.style.color = '#4a5568';
                updateHistoryList();
            } else {
                listView.style.display = 'none';
                galleryView.style.display = 'block';
                listBtn.style.background = '#e2e8f0';
                listBtn.style.color = '#4a5568';
                galleryBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                galleryBtn.style.color = 'white';
                updateHistoryGallery();
            }
        }
        
        // å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®æ›´æ–°
        function updateHistoryGallery() {
            const container = document.getElementById('history-gallery');
            container.innerHTML = '';
            
            // å†™çœŸä»˜ãã®å±¥æ­´ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const photoHistory = history.filter(h => !h.cancelled && h.photo);
            
            if (photoHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">å†™çœŸä»˜ãã®æœè–¬è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ–°ã—ã„é †ã«è¡¨ç¤º
            container.innerHTML = '<div class="history-gallery">' + 
                photoHistory.slice().reverse().map(item => {
                    const date = new Date(item.takenAt);
                    const dateStr = date.toLocaleDateString('ja-JP');
                    const timeStr = date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    
                    return `
                        <div class="gallery-item">
                            <img src="${item.photo}" onclick="showPhotoModal('${item.photo}')" alt="æœç”¨å†™çœŸ">
                            <div class="gallery-item-info">
                                <div class="gallery-item-date">${dateStr} ${timeStr}</div>
                                <div class="gallery-item-med">${item.medicationName}</div>
                                <div class="gallery-item-med">${item.mealTime}</div>
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
        }
        
        // è–¬ã®ç·¨é›†
        function editMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            // ç¾åœ¨ã®å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®š
            document.getElementById('med-name').value = med.name;
            
            // ç”¨é‡ã‚’æ•°å­—ã¨å˜ä½ã«åˆ†å‰²
            const dosageMatch = med.dosage.match(/(\d+)(.+)/);
            if (dosageMatch) {
                document.getElementById('med-dosage-number').value = dosageMatch[1];
                document.getElementById('med-dosage-unit').value = dosageMatch[2];
            }
            
            document.getElementById('med-frequency').value = med.frequency;
            document.getElementById('med-stock').value = med.stock;
            
            // åœ¨åº«è­¦å‘Šã—ãã„å€¤ã‚’è¨­å®š
            const threshold = med.alertThreshold || 7;
            if (threshold >= 1 && threshold <= 10) {
                document.getElementById('med-alert-threshold-select').value = threshold.toString();
                document.getElementById('med-alert-threshold-custom').style.display = 'none';
                document.getElementById('med-alert-threshold-custom').required = false;
            } else {
                document.getElementById('med-alert-threshold-select').value = 'custom';
                document.getElementById('med-alert-threshold-custom').value = threshold;
                document.getElementById('med-alert-threshold-custom').style.display = 'block';
                document.getElementById('med-alert-threshold-custom').required = true;
            }
            
            // ç”¨é€”ã‚’è¨­å®š
            if (med.purpose) {
                const standardPurposes = ['é ­ç—›ãƒ»è§£ç†±', 'èƒƒè…¸è–¬', 'é¢¨é‚ªè–¬', 'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼', 'ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ', 'é«˜è¡€åœ§', 'ç³–å°¿ç—…', 'æŠ—ç”Ÿç‰©è³ª', 'ç¡çœ è–¬'];
                if (standardPurposes.includes(med.purpose)) {
                    document.getElementById('med-purpose-select').value = med.purpose;
                    document.getElementById('med-purpose-custom').style.display = 'none';
                    document.getElementById('med-purpose-custom').required = false;
                } else {
                    document.getElementById('med-purpose-select').value = 'custom';
                    document.getElementById('med-purpose-custom').value = med.purpose;
                    document.getElementById('med-purpose-custom').style.display = 'block';
                    document.getElementById('med-purpose-custom').required = true;
                }
            } else {
                document.getElementById('med-purpose-select').value = '';
                document.getElementById('med-purpose-custom').style.display = 'none';
                document.getElementById('med-purpose-custom').required = false;
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('add-modal').style.display = 'block';
            document.getElementById('add-modal').dataset.editId = medId;
            document.querySelector('#add-modal h3').textContent = 'è–¬ã®æƒ…å ±ã‚’ç·¨é›†';
        }
        
        // è–¬ã®å‰Šé™¤
        function deleteMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            if (confirm(`ã€Œ${med.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                medications = medications.filter(m => m.id !== medId);
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // UIã‚’æ›´æ–°
                updateMedicationsList();
                updateTodayMedications();
                checkStockWarnings();
                
                alert('âœ… è–¬ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
            }
        }
        
        // GitHubé€£æºé–¢æ•°ç¾¤
        function updateSettingsPage() {
            const githubStatus = getGitHubConnectionStatus();
            updateGitHubStatusUI(githubStatus);
        }
        
        function getGitHubConnectionStatus() {
            const status = localStorage.getItem('github-connection');
            return status ? JSON.parse(status) : null;
        }
        
        function updateGitHubStatusUI(status) {
            const disconnected = document.getElementById('github-disconnected');
            const connected = document.getElementById('github-connected');
            
            if (status) {
                disconnected.style.display = 'none';
                connected.style.display = 'block';
                document.getElementById('github-username').textContent = status.username;
                document.getElementById('github-repo').textContent = status.repo;
                document.getElementById('last-sync').textContent = status.lastSync || 'æœªåŒæœŸ';
            } else {
                disconnected.style.display = 'block';
                connected.style.display = 'none';
            }
        }
        
        function connectGitHub() {
            // GitHub OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹
            const clientId = 'YOUR_GITHUB_OAUTH_CLIENT_ID'; // å®Ÿéš›ã®Client IDã«ç½®ãæ›ãˆå¿…è¦
            const scope = 'repo user';
            const redirectUri = window.location.origin + window.location.pathname;
            
            // GitHubèªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&scope=${scope}&redirect_uri=${encodeURIComponent(redirectUri)}`;
            
            // ä¸€æ™‚çš„ã«ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ä»£æ›¿ï¼ˆå®Ÿéš›ã¯ä¸Šè¨˜ã®OAuthèªè¨¼ã‚’ä½¿ç”¨ï¼‰
            const token = prompt('GitHub Personal Access Tokenã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\næ¨©é™: repo (Full control of private repositories)\n\nãƒˆãƒ¼ã‚¯ãƒ³ã®ä½œæˆæ–¹æ³•:\n1. GitHub.com â†’ Settings â†’ Developer settings â†’ Personal access tokens\n2. "Generate new token (classic)" ã‚’ã‚¯ãƒªãƒƒã‚¯\n3. "repo" ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ä½œæˆ');
            
            if (token) {
                // ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
                verifyGitHubToken(token);
            }
        }
        
        async function verifyGitHubToken(token) {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error('Invalid token');
                }
                
                const userData = await userResponse.json();
                
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã¾ãŸã¯ç¢ºèª
                const repoName = 'medication-tracker-backup';
                await createBackupRepository(token, repoName);
                
                // æ¥ç¶šçŠ¶æ…‹ã‚’ä¿å­˜
                const connectionData = {
                    token: token,
                    username: userData.login,
                    repo: repoName,
                    lastSync: null
                };
                
                localStorage.setItem('github-connection', JSON.stringify(connectionData));
                
                // UIæ›´æ–°
                updateGitHubStatusUI(connectionData);
                
                alert('âœ… GitHubé€£æºãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                
                // åˆå›ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
                manualBackup();
                
            } catch (error) {
                console.error('GitHubé€£æºã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ GitHubé€£æºã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        async function createBackupRepository(token, repoName) {
            try {
                // ãƒªãƒã‚¸ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
                const checkResponse = await fetch(`https://api.github.com/repos/${getGitHubConnectionStatus().username || 'user'}/${repoName}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (checkResponse.ok) {
                    // ãƒªãƒã‚¸ãƒˆãƒªãŒæ—¢ã«å­˜åœ¨
                    return;
                }
                
                // ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
                const createResponse = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: repoName,
                        description: 'ãŠè–¬ã®ã‚“ã ï¼Ÿ - æœè–¬è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—',
                        private: true,
                        auto_init: true
                    })
                });
                
                if (!createResponse.ok) {
                    throw new Error('Failed to create repository');
                }
                
            } catch (error) {
                console.error('ãƒªãƒã‚¸ãƒˆãƒªä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }
        
        async function manualBackup() {
            const status = getGitHubConnectionStatus();
            if (!status) {
                alert('âŒ GitHubé€£æºãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            
            try {
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const backupData = {
                    medications: JSON.parse(localStorage.getItem('medications') || '[]'),
                    records: JSON.parse(localStorage.getItem('medication-records') || '[]'),
                    backupDate: new Date().toISOString(),
                    version: '2.0'
                };
                
                // GitHubã«ä¿å­˜
                await saveToGitHub(status.token, status.username, status.repo, 'backup.json', JSON.stringify(backupData, null, 2));
                
                // æœ€çµ‚åŒæœŸæ™‚åˆ»ã‚’æ›´æ–°
                status.lastSync = new Date().toLocaleString('ja-JP');
                localStorage.setItem('github-connection', JSON.stringify(status));
                updateGitHubStatusUI(status);
                
                alert('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                
            } catch (error) {
                console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
        
        async function restoreFromGitHub() {
            const status = getGitHubConnectionStatus();
            if (!status) {
                alert('âŒ GitHubé€£æºãŒå¿…è¦ã§ã™ã€‚');
                return;
            }
            
            if (!confirm('âš ï¸ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                // GitHubã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const backupData = await loadFromGitHub(status.token, status.username, status.repo, 'backup.json');
                
                if (backupData) {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å¾©å…ƒ
                    localStorage.setItem('medications', JSON.stringify(backupData.medications || []));
                    localStorage.setItem('medication-records', JSON.stringify(backupData.records || []));
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    medications = backupData.medications || [];
                    medicationRecords = backupData.records || [];
                    
                    // UIæ›´æ–°
                    updateTodayMedications();
                    updateMedicationsList();
                    updateHistoryList();
                    
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                } else {
                    alert('âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                }
                
            } catch (error) {
                console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
        
        async function saveToGitHub(token, username, repo, filename, content) {
            try {
                // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®SHAã‚’å–å¾—
                let sha = null;
                try {
                    const getResponse = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (getResponse.ok) {
                        const existingFile = await getResponse.json();
                        sha = existingFile.sha;
                    }
                } catch (e) {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ/æ›´æ–°
                const putData = {
                    message: `ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— - ${new Date().toLocaleString('ja-JP')}`,
                    content: btoa(unescape(encodeURIComponent(content))), // UTF-8å¯¾å¿œã®Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                };
                
                if (sha) {
                    putData.sha = sha;
                }
                
                const putResponse = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(putData)
                });
                
                if (!putResponse.ok) {
                    throw new Error(`GitHub API error: ${putResponse.status}`);
                }
                
            } catch (error) {
                console.error('GitHubä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }
        
        async function loadFromGitHub(token, username, repo, filename) {
            try {
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return null; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const fileData = await response.json();
                const content = decodeURIComponent(escape(atob(fileData.content))); // UTF-8å¯¾å¿œã®Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
                return JSON.parse(content);
                
            } catch (error) {
                console.error('GitHubèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }
        
        function disconnectGitHub() {
            if (confirm('âš ï¸ GitHubé€£æºã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\nãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚Šã¾ã™ãŒã€è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚')) {
                localStorage.removeItem('github-connection');
                updateGitHubStatusUI(null);
                alert('âœ… GitHubé€£æºã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
            }
        }
        
        function exportLocalData() {
            const data = {
                medications: JSON.parse(localStorage.getItem('medications') || '[]'),
                records: JSON.parse(localStorage.getItem('medication-records') || '[]'),
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `medication-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function importLocalData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('âš ï¸ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                        localStorage.setItem('medications', JSON.stringify(data.medications || []));
                        localStorage.setItem('medication-records', JSON.stringify(data.records || []));
                        
                        // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                        medications = data.medications || [];
                        medicationRecords = data.records || [];
                        
                        // UIæ›´æ–°
                        updateTodayMedications();
                        updateMedicationsList();
                        updateHistoryList();
                        
                        alert('âœ… ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                    }
                } catch (error) {
                    console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
            };
            reader.readAsText(file);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            event.target.value = '';
        }
        
        // å®šæœŸçš„ã«ç”»é¢ã‚’æ›´æ–°ï¼ˆ1åˆ†ã”ã¨ï¼‰
        setInterval(() => {
            if (document.getElementById('home-page').classList.contains('active')) {
                updateTodayMedications();
                checkStockWarnings();
            }
            // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚‚å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
            checkLowStockNotifications();
        }, 60000);
        
        // å®šæœŸçš„ã«å¤ã„å†™çœŸã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ1æ—¥1å›ï¼‰
        setInterval(() => {
            cleanupOldPhotos();
        }, 24 * 60 * 60 * 1000); // 24æ™‚é–“ã”ã¨
        
        // Firebaseèªè¨¼é–¢æ•°ç¾¤
        async function handleLogin(email, password) {
            try {
                showMessage('login-message', 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...', 'info');
                
                const userCredential = await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                if (!user.emailVerified) {
                    showMessage('login-message', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'error');
                    await window.signOut(window.firebaseAuth);
                    return;
                }
                
                showMessage('login-message', 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼', 'success');
                currentUser = user;
                isAuthenticated = true;
                
                setTimeout(() => {
                    hideAuthContainer();
                    showAppContainer();
                }, 1000);
                
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('login-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handleRegister(email, password, passwordConfirm) {
            if (password !== passwordConfirm) {
                showMessage('register-message', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('register-message', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                showMessage('register-message', 'ç™»éŒ²ä¸­...', 'info');
                
                const userCredential = await window.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                // ãƒ¡ãƒ¼ãƒ«èªè¨¼é€ä¿¡
                await window.sendEmailVerification(user);
                
                showMessage('register-message', 'ç™»éŒ²å®Œäº†ï¼ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'success');
                
                // 2ç§’å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                setTimeout(() => {
                    showLoginPage();
                }, 3000);
                
            } catch (error) {
                console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('register-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handlePasswordReset() {
            const email = prompt('ç™»éŒ²æ¸ˆã¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
            if (!email) return;

            try {
                await window.sendPasswordResetEmail(window.firebaseAuth, email);
                showMessage('login-message', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage('login-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handleLogout() {
            try {
                await window.signOut(window.firebaseAuth);
                currentUser = null;
                isAuthenticated = false;
                showAuthContainer();
                hideAppContainer();
                showMessage('login-message', 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // UIåˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function showLoginPage() {
            document.querySelectorAll('#auth-container .page').forEach(page => page.classList.remove('active'));
            document.getElementById('login-page').classList.add('active');
            clearMessages();
        }

        function showRegisterPage() {
            document.querySelectorAll('#auth-container .page').forEach(page => page.classList.remove('active'));
            document.getElementById('register-page').classList.add('active');
            clearMessages();
        }

        function showPasswordReset() {
            handlePasswordReset();
        }

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';
        }

        function hideAuthContainer() {
            document.getElementById('auth-container').style.display = 'none';
        }

        function showAppContainer() {
            document.getElementById('app-container').style.display = 'block';
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
            }
            // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
            updateTodayMedications();
            updateMedicationsList();
            checkStockWarnings();
        }

        function hideAppContainer() {
            document.getElementById('app-container').style.display = 'none';
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(elementId, message, type) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `form-message ${type}`;
            messageEl.style.display = 'block';
        }

        function clearMessages() {
            document.querySelectorAll('.form-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
        }

        // Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/email-already-in-use': 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™',
                'auth/weak-password': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ï¼ˆ6æ–‡å­—ä»¥ä¸Šå¿…è¦ï¼‰',
                'auth/invalid-email': 'ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™',
                'auth/user-not-found': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                'auth/wrong-password': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™',
                'auth/too-many-requests': 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„',
                'auth/network-request-failed': 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                'auth/invalid-credential': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™'
            };
            return errorMessages[errorCode] || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await handleLogin(email, password);
            });

            // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;
                await handleRegister(email, password, passwordConfirm);
            });

            // Firebaseèªè¨¼çŠ¶æ…‹ã®ç›£è¦–
            window.onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user && user.emailVerified) {
                    currentUser = user;
                    isAuthenticated = true;
                    hideAuthContainer();
                    showAppContainer();
                } else {
                    currentUser = null;
                    isAuthenticated = false;
                    showAuthContainer();
                    hideAppContainer();
                }
            });
        });

        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ã‚‚å®Ÿè¡Œ
        cleanupOldPhotos();
    </script>
</body>
</html>