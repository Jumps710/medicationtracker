<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠè–¬ã®ã‚“ã ï¼Ÿ - æœè–¬ç®¡ç†ã‚¢ãƒ—ãƒª v2.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ãŠè–¬ã®ã‚“ã ï¼Ÿ">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234CAF50'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3EğŸ’Š%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f4f8;
            color: #2d3748;
            padding-bottom: 70px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .ad-banner {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px auto;
            max-width: 600px;
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .ad-banner.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        
        .tab.active {
            color: #667eea;
            font-weight: bold;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .medication-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .medication-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .medication-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .take-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .take-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .take-button.taken {
            background-color: #ddd;
            color: #666;
            cursor: not-allowed;
        }
        
        .skip-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
        }
        
        .skip-button:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
        
        .add-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .save-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .cancel-button {
            background-color: #f44336;
            color: white;
        }
        
        .oauth-buttons {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .oauth-button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: white;
        }
        
        .oauth-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .google-signin {
            border-color: #db4437;
            color: #db4437;
        }
        
        .google-signin:hover {
            background-color: #db4437;
            color: white;
        }
        
        .apple-signin {
            border-color: #000;
            color: #000;
        }
        
        .apple-signin:hover {
            background-color: #000;
            color: white;
        }
        
        .oauth-divider {
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 14px;
        }
        
        .history-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-date {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-meds {
            color: #666;
            font-size: 14px;
        }
        
        .history-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
            cursor: pointer;
            border: 2px solid #ddd;
        }
        
        .history-photo:hover {
            border-color: #4CAF50;
        }
        
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .history-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .gallery-item {
            position: relative;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .gallery-item-info {
            padding: 10px;
            font-size: 12px;
        }
        
        .gallery-item-date {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .gallery-item-med {
            color: #666;
        }
        
        .stock-warning {
            background-color: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .camera-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            width: 100%;
        }
        
        .camera-modal .modal-content {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .camera-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .camera-video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-canvas {
            display: none;
        }
        
        .captured-image {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .camera-controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .capture-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .capture-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .retake-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        
        .retake-button:hover {
            background-color: #cbd5e0;
        }
        
        .analysis-result {
            background: #edf2f7;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }
        
        .success-message {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .warning-message {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }
        
        .form-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .form-message.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .form-message.error {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }
        
        .form-message.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ãŠè–¬ã®ã‚“ã ï¼Ÿ</h1>
    </div>
    
    <!-- åºƒå‘ŠãƒãƒŠãƒ¼ -->
    <div class="ad-banner" id="ad-banner">
        <div id="ad-content">åºƒå‘Šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <!-- èªè¨¼ç”»é¢ -->
    <div id="auth-container" style="display: none;">
        <div class="container">
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
            <div id="login-page" class="page active">
                <div class="medication-card">
                    <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-button">ãƒ­ã‚°ã‚¤ãƒ³</button>
                            <button type="button" onclick="showRegisterPage()" class="cancel-button">æ–°è¦ç™»éŒ²</button>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="#" onclick="showPasswordReset()" style="color: #4CAF50; text-decoration: none;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã¯ã“ã¡ã‚‰</a>
                        </div>
                    </form>
                    
                    <!-- OAuthèªè¨¼ãƒœã‚¿ãƒ³ -->
                    <div class="oauth-buttons">
                        <div class="oauth-divider">ã¾ãŸã¯</div>
                        <button class="oauth-button google-signin" onclick="signInWithGoogle()">
                            <span>ğŸ”</span>
                            Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
                        </button>
                        <button class="oauth-button apple-signin" onclick="signInWithApple()">
                            <span>ğŸ</span>
                            Appleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
                        </button>
                    </div>
                    
                    <!-- åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼åŒæ„ -->
                    <div style="margin: 15px 0; font-size: 12px; color: #666; text-align: center;">
                        ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã§ã€<a href="terms-of-service.html" target="_blank" style="color: #667eea;">åˆ©ç”¨è¦ç´„</a>ãŠã‚ˆã³<a href="privacy-policy.html" target="_blank" style="color: #667eea;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
                    </div>
                    
                    <div id="login-message" class="form-message"></div>
                </div>
            </div>

            <!-- æ–°è¦ç™»éŒ²ç”»é¢ -->
            <div id="register-page" class="page">
                <div class="medication-card">
                    <h2>ğŸ“ æ–°è¦ç™»éŒ²</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="register-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="register-password" required minlength="6" placeholder="6æ–‡å­—ä»¥ä¸Š">
                        </div>
                        <div class="form-group">
                            <label for="register-password-confirm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                            <input type="password" id="register-password-confirm" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-button">ç™»éŒ²</button>
                            <button type="button" onclick="showLoginPage()" class="cancel-button">ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹</button>
                        </div>
                    </form>
                    
                    <!-- OAuthèªè¨¼ãƒœã‚¿ãƒ³ -->
                    <div class="oauth-buttons">
                        <div class="oauth-divider">ã¾ãŸã¯</div>
                        <button class="oauth-button google-signin" onclick="signInWithGoogle()">
                            <span>ğŸ”</span>
                            Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ç™»éŒ²
                        </button>
                        <button class="oauth-button apple-signin" onclick="signInWithApple()">
                            <span>ğŸ</span>
                            Appleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ç™»éŒ²
                        </button>
                    </div>
                    
                    <!-- åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼åŒæ„ -->
                    <div style="margin: 15px 0; font-size: 12px; color: #666; text-align: center;">
                        ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã€<a href="terms-of-service.html" target="_blank" style="color: #667eea;">åˆ©ç”¨è¦ç´„</a>ãŠã‚ˆã³<a href="privacy-policy.html" target="_blank" style="color: #667eea;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚
                    </div>
                    
                    <div id="register-message" class="form-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªç”»é¢ -->
    <div id="app-container" style="display: none;">
        <div class="container">
            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
            <div id="home-page" class="page active">
                <div id="stock-warnings"></div>
                <h2>ä»Šæ—¥ã®æœè–¬</h2>
                <div id="today-medications"></div>
            </div>
        
        <!-- è–¬ç®¡ç†ç”»é¢ -->
        <div id="medications-page" class="page">
            <h2>ç™»éŒ²æ¸ˆã¿ã®è–¬</h2>
            <div id="medications-list"></div>
        </div>
        
        <!-- å±¥æ­´ç”»é¢ -->
        <div id="history-page" class="page">
            <h2>æœè–¬å±¥æ­´</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="showHistoryView('list')" id="list-view-btn" style="padding: 8px 15px; margin-right: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“‹ ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
                <button onclick="showHistoryView('gallery')" id="gallery-view-btn" style="padding: 8px 15px; background: #ddd; color: #666; border: none; border-radius: 5px; cursor: pointer;">ğŸ–¼ï¸ å†™çœŸä¸€è¦§</button>
            </div>
            <div id="history-list"></div>
            <div id="history-gallery" style="display: none;"></div>
        </div>
        
        <!-- è¨­å®šç”»é¢ -->
        <div id="settings-page" class="page">
            <h2>è¨­å®š</h2>
            
            
            <!-- æ™‚é–“è¨­å®š -->
            <div class="medication-card">
                <h3>â° é£Ÿäº‹æ™‚é–“ã®è¨­å®š</h3>
                <p style="color: #666; margin-bottom: 15px;">æ¯é£Ÿå¾Œã®æœè–¬æ™‚é–“ã‚’è¨­å®šã§ãã¾ã™</p>
                <div class="form-group">
                    <label for="breakfast-time">æœé£Ÿå¾Œã®æ™‚é–“</label>
                    <input type="time" id="breakfast-time" value="09:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="lunch-time">æ˜¼é£Ÿå¾Œã®æ™‚é–“</label>
                    <input type="time" id="lunch-time" value="13:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="dinner-time">å¤•é£Ÿå¾Œã®æ™‚é–“</label>
                    <input type="time" id="dinner-time" value="19:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="bedtime">å°±å¯å‰ã®æ™‚é–“</label>
                    <input type="time" id="bedtime" value="22:00" onchange="saveMealTimeSettings()">
                </div>
            </div>
            
            
            <!-- ã‚¢ãƒ—ãƒªæƒ…å ± -->
            <div class="medication-card">
                <h3>â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</h3>
                <div style="color: #666; font-size: 14px; line-height: 1.5;">
                    <div>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2.1</div>
                    <div>ãƒ‡ãƒ¼ã‚¿ä¿å­˜å ´æ‰€: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</div>
                    <div>å†™çœŸä¿æŒæœŸé–“: 3ãƒ¶æœˆé–“</div>
                    <div style="margin-top: 10px;">
                        <p><strong>ãŠè–¬ã®ã‚“ã ï¼Ÿ</strong>ã¯æœè–¬ç®¡ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹PWAã‚¢ãƒ—ãƒªã§ã™ã€‚</p>
                        <p style="margin-top: 5px; font-size: 12px; color: #999;">
                            â€»ã“ã®ã‚¢ãƒ—ãƒªã¯åŒ»ç™‚æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åŒ»ç™‚åˆ¤æ–­ã¯å¿…ãšåŒ»å¸«ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="medication-card">
                <h3>â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h3>
                <p style="color: #666; margin-bottom: 15px;">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¦ç«¯æœ«é–“ã§åŒæœŸã§ãã¾ã™</p>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #666;">
                        æœ€å¾Œã®åŒæœŸ: <span id="last-sync-time">æœªåŒæœŸ</span>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹: <span id="online-status">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="manualSync()" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; flex: 1;">æ‰‹å‹•åŒæœŸ</button>
                    <button onclick="migrateData()" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; flex: 1;">ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                    â€»ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ãƒ‡ãƒ¼ã‚¿ãŒè‡ªå‹•çš„ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã«åŒæœŸã•ã‚Œã¾ã™
                </div>
            </div>
            
            <!-- OAuthèªè¨¼çŠ¶æ³ -->
            <div class="medication-card">
                <h3>ğŸ” OAuthèªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <strong>èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³:</strong>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
                        <li id="google-oauth-status">ğŸ” Firebase Google OAuth: <span style="color: #6c757d;">èª­ã¿è¾¼ã¿ä¸­...</span></li>
                        <li id="apple-oauth-status">ğŸ Apple Sign In: <span style="color: #ffc107;">èª­ã¿è¾¼ã¿ä¸­...</span></li>
                    </ul>
                </div>
                <div style="font-size: 12px; color: #666;">
                    <strong>Firebase SDKä½¿ç”¨:</strong> Firebase Console ã®æ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã®ã¿ã§å‹•ä½œã—ã¾ã™ã€‚
                </div>
            </div>
            
            <!-- æ³•çš„æ–‡æ›¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="medication-card">
                <h3>ğŸ“‹ è¦ç´„ãƒ»ãƒãƒªã‚·ãƒ¼</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <a href="privacy-policy.html" target="_blank" style="background: #4CAF50; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; flex: 1; text-align: center;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                    <a href="terms-of-service.html" target="_blank" style="background: #2196F3; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; flex: 1; text-align: center;">åˆ©ç”¨è¦ç´„</a>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #999; text-align: center;">
                    ã‚¹ãƒˆã‚¢å…¬é–‹ã«å¿…è¦ãªæ³•çš„æ–‡æ›¸ã§ã™
                </div>
            </div>
            
            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="medication-card">
                <h3>ğŸšª ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="current-user-email" style="color: #666;"></span>
                    <button onclick="handleLogout()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ã‚¿ãƒ–ãƒãƒ¼ -->
    <div class="tab-bar">
        <button class="tab active" onclick="showPage('home')">
            <div>ğŸ’Š</div>
            <div>æœç”¨</div>
        </button>
        <button class="tab" onclick="showPage('medications')">
            <div>ğŸ—ƒï¸</div>
            <div>è–¬ç®±</div>
        </button>
        <button class="tab" onclick="showPage('history')">
            <div>ğŸ“Š</div>
            <div>å±¥æ­´</div>
        </button>
        <button class="tab" onclick="showPage('settings')">
            <div>âš™ï¸</div>
            <div>è¨­å®š</div>
        </button>
    </div>
    
    <!-- è¿½åŠ ãƒœã‚¿ãƒ³ -->
    <button class="add-button" onclick="showAddModal()">+</button>
    
    <!-- è–¬è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3>æ–°ã—ã„è–¬ã‚’è¿½åŠ </h3>
            <form id="add-medication-form">
                <div class="form-group">
                    <label for="med-name">è–¬ã®åå‰</label>
                    <input type="text" id="med-name" required>
                </div>
                <div class="form-group">
                    <label for="med-purpose">è–¬ã®ç”¨é€”</label>
                    <select id="med-purpose-select" onchange="toggleCustomPurpose()" style="width: 100%;">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="é ­ç—›ãƒ»è§£ç†±">é ­ç—›ãƒ»è§£ç†±</option>
                        <option value="èƒƒè…¸è–¬">èƒƒè…¸è–¬</option>
                        <option value="é¢¨é‚ªè–¬">é¢¨é‚ªè–¬</option>
                        <option value="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</option>
                        <option value="ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ">ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ</option>
                        <option value="é«˜è¡€åœ§">é«˜è¡€åœ§</option>
                        <option value="ç³–å°¿ç—…">ç³–å°¿ç—…</option>
                        <option value="æŠ—ç”Ÿç‰©è³ª">æŠ—ç”Ÿç‰©è³ª</option>
                        <option value="ç¡çœ è–¬">ç¡çœ è–¬</option>
                        <option value="custom">ãã®ä»–ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰</option>
                    </select>
                    <input type="text" id="med-purpose-custom" placeholder="è–¬ã®ç”¨é€”ã‚’å…¥åŠ›" style="display: none; margin-top: 10px; width: 100%;">
                </div>
                <div class="form-group">
                    <label for="med-dosage">ç”¨é‡ï¼ˆ1å›ã‚ãŸã‚Šï¼‰</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="med-dosage-number" required style="flex: 1;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                        <select id="med-dosage-unit" required style="flex: 1;">
                            <option value="éŒ ">éŒ </option>
                            <option value="åŒ…">åŒ…</option>
                            <option value="æ¯">æ¯</option>
                            <option value="æ»´">æ»´</option>
                            <option value="mL">mL</option>
                            <option value="g">g</option>
                            <option value="å€‹">å€‹</option>
                            <option value="ç²’">ç²’</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="med-frequency">æœç”¨é »åº¦</label>
                    <select id="med-frequency" required>
                        <option value="æ¯é£Ÿå¾Œ">æ¯é£Ÿå¾Œ</option>
                        <option value="æœé£Ÿå¾Œ">æœé£Ÿå¾Œ</option>
                        <option value="æ˜¼é£Ÿå¾Œ">æ˜¼é£Ÿå¾Œ</option>
                        <option value="å¤•é£Ÿå¾Œ">å¤•é£Ÿå¾Œ</option>
                        <option value="æœå¤•é£Ÿå¾Œ">æœå¤•é£Ÿå¾Œ</option>
                        <option value="å°±å¯å‰">å°±å¯å‰</option>
                        <option value="æ¯é£Ÿå¾Œï¼‹å°±å¯å‰">æ¯é£Ÿå¾Œï¼‹å°±å¯å‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="med-stock">ç¾åœ¨ã®åœ¨åº«æ•°</label>
                    <input type="number" id="med-stock" required>
                </div>
                <div class="form-group">
                    <label for="med-alert-threshold">åœ¨åº«è­¦å‘Šã—ãã„å€¤</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="med-alert-threshold-select" onchange="toggleCustomThreshold()" style="flex: 1;">
                            <option value="1">æ®‹ã‚Š1å€‹</option>
                            <option value="2">æ®‹ã‚Š2å€‹</option>
                            <option value="3">æ®‹ã‚Š3å€‹</option>
                            <option value="4">æ®‹ã‚Š4å€‹</option>
                            <option value="5">æ®‹ã‚Š5å€‹</option>
                            <option value="6">æ®‹ã‚Š6å€‹</option>
                            <option value="7" selected>æ®‹ã‚Š7å€‹</option>
                            <option value="8">æ®‹ã‚Š8å€‹</option>
                            <option value="9">æ®‹ã‚Š9å€‹</option>
                            <option value="10">æ®‹ã‚Š10å€‹</option>
                            <option value="custom">ãã®ä»–ï¼ˆç›´æ¥å…¥åŠ›ï¼‰</option>
                        </select>
                        <input type="number" id="med-alert-threshold-custom" placeholder="å€‹æ•°ã‚’å…¥åŠ›" min="1" style="display: none; width: 100px;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="med-photo">è–¬ã®å†™çœŸï¼ˆä»»æ„ï¼‰</label>
                    <input type="file" id="med-photo" accept="image/*" onchange="handleMedicationPhotoUpload(event)">
                    <div id="med-photo-preview" style="margin-top: 10px; display: none;">
                        <img id="med-photo-thumbnail" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeMedicationPhoto()" style="margin-left: 10px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">å‰Šé™¤</button>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="save-button">ä¿å­˜</button>
                    <button type="button" class="cancel-button" onclick="hideAddModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="camera-modal" class="modal camera-modal">
        <div class="modal-content">
            <h3>æœç”¨å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„</h3>
            <div class="camera-container">
                <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoCapture(event)">
                <canvas id="camera-canvas" class="camera-canvas" style="display: none;"></canvas>
                <img id="captured-image" class="captured-image" style="display: none;">
                
                <div class="camera-controls">
                    <button id="capture-btn" class="capture-button" onclick="openCameraApp()">ğŸ“· æ’®å½±</button>
                    <button id="retake-btn" class="retake-button" onclick="retakePhoto()" style="display: none;">ğŸ”„ æ’®ã‚Šç›´ã—</button>
                </div>
                
                <div id="analysis-result" class="analysis-result" style="display: none;"></div>
            </div>
            
            <div id="medication-confirm-section" style="display: none;">
                <div class="medication-confirm-info">
                    <h4 id="confirm-med-name" style="margin-bottom: 10px;"></h4>
                    <div class="form-group">
                        <label for="confirm-dosage">æœç”¨æ•°é‡</label>
                        <input type="number" id="confirm-dosage" min="1" value="1" style="width: 100px;">
                        <span id="confirm-dosage-unit" style="margin-left: 5px;"></span>
                    </div>
                    <div style="color: #666; margin-bottom: 10px;">
                        <span>ç¾åœ¨ã®åœ¨åº«: </span><span id="confirm-current-stock"></span>
                        <br>
                        <span>æœç”¨å¾Œã®åœ¨åº«: </span><span id="confirm-remaining-stock" style="font-weight: bold;"></span>
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="save-button" onclick="confirmMedicationWithPhoto()">ç™»éŒ²</button>
                    <button class="cancel-button" onclick="resetCameraModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
            
            <div class="form-buttons" id="camera-initial-buttons">
                <button class="cancel-button" onclick="hideCameraModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Firebaseè¨­å®šã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            sendEmailVerification,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyD6_2ioXr3LJU7PpThy7kxXbCfEFatUi_U",
            authDomain: "medication-tracker-b5d0c.firebaseapp.com",
            projectId: "medication-tracker-b5d0c",
            storageBucket: "medication-tracker-b5d0c.firebasestorage.app",
            messagingSenderId: "112454739779",
            appId: "1:112454739779:web:225df0ffd166882c1931f6",
            measurementId: "G-0LPF5Y8NPR"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.firebaseAuth = auth;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.sendEmailVerification = sendEmailVerification;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>

    <script>
        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç†
        let isAuthenticated = false;
        let currentUser = null;
        
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        
        // ã‚«ãƒ¡ãƒ©é–¢é€£ã®å¤‰æ•°
        let currentMedId = null;
        let currentMealTime = null;
        let currentOverdueDate = null;
        let cameraStream = null;
        
        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function showPage(pageName) {
            // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼è¿½è·¡
            if (analyticsManager) {
                analyticsManager.trackPageView(pageName);
            }
            
            // ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById(pageName + '-page').classList.add('active');
            
            // è¨­å®šãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹éš›ã«æ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            if (pageName === 'settings') {
                loadMealTimeSettings();
            }
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            event.target.closest('.tab').classList.add('active');
            
            // ãƒšãƒ¼ã‚¸ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            if (pageName === 'home') {
                updateTodayMedications();
                checkStockWarnings();
            } else if (pageName === 'medications') {
                updateMedicationsList();
            } else if (pageName === 'history') {
                updateHistoryList();
            } else if (pageName === 'settings') {
                loadMealTimeSettings();
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º/éè¡¨ç¤º
        function showAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }
        
        function hideAddModal() {
            const modal = document.getElementById('add-modal');
            modal.style.display = 'none';
            modal.dataset.editId = '';
            document.getElementById('add-medication-form').reset();
            document.querySelector('#add-modal h3').textContent = 'æ–°ã—ã„è–¬ã‚’è¿½åŠ ';
            // ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('med-purpose-custom').style.display = 'none';
            document.getElementById('med-purpose-custom').required = false;
        }
        
        // è–¬ã®ç”¨é€”ã®ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆ
        function toggleCustomPurpose() {
            const select = document.getElementById('med-purpose-select');
            const customInput = document.getElementById('med-purpose-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // åœ¨åº«è­¦å‘Šã—ãã„å€¤ã®ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆ
        function toggleCustomThreshold() {
            const select = document.getElementById('med-alert-threshold-select');
            const customInput = document.getElementById('med-alert-threshold-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // è–¬ã®å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleMedicationPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageDataUrl = e.target.result;
                
                // ç”»åƒã‚’åœ§ç¸®
                const compressedImage = await compressImage(imageDataUrl, 400, 0.8);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                const preview = document.getElementById('med-photo-preview');
                const thumbnail = document.getElementById('med-photo-thumbnail');
                
                thumbnail.src = compressedImage;
                preview.style.display = 'block';
                
                // åœ§ç¸®æ¸ˆã¿ç”»åƒã‚’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
                preview.dataset.photo = compressedImage;
            };
            reader.readAsDataURL(file);
        }
        
        // è–¬ã®å†™çœŸå‰Šé™¤
        function removeMedicationPhoto() {
            const preview = document.getElementById('med-photo-preview');
            const thumbnail = document.getElementById('med-photo-thumbnail');
            const fileInput = document.getElementById('med-photo');
            
            preview.style.display = 'none';
            thumbnail.src = '';
            fileInput.value = '';
            delete preview.dataset.photo;
        }
        
        // è–¬ã®è¿½åŠ /ç·¨é›†
        document.getElementById('add-medication-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dosageNumber = document.getElementById('med-dosage-number').value;
            const dosageUnit = document.getElementById('med-dosage-unit').value;
            const editId = document.getElementById('add-modal').dataset.editId;
            
            // è–¬ã®ç”¨é€”ã‚’å–å¾—
            const purposeSelect = document.getElementById('med-purpose-select').value;
            const purposeCustom = document.getElementById('med-purpose-custom').value;
            const purpose = purposeSelect === 'custom' ? purposeCustom : purposeSelect;
            
            // åœ¨åº«è­¦å‘Šã—ãã„å€¤ã‚’å–å¾—
            const thresholdSelect = document.getElementById('med-alert-threshold-select').value;
            const thresholdCustom = document.getElementById('med-alert-threshold-custom').value;
            const alertThreshold = thresholdSelect === 'custom' ? 
                parseInt(thresholdCustom) : parseInt(thresholdSelect);
            
            const medicationData = {
                name: document.getElementById('med-name').value,
                dosage: dosageNumber + dosageUnit,
                frequency: document.getElementById('med-frequency').value,
                stock: parseInt(document.getElementById('med-stock').value),
                alertThreshold: alertThreshold || 7,
                purpose: purpose || '' // è–¬ã®ç”¨é€”ã‚’è¿½åŠ 
            };
            
            // å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            const preview = document.getElementById('med-photo-preview');
            if (preview.dataset.photo) {
                medicationData.photo = preview.dataset.photo;
            }
            
            if (editId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                const medIndex = medications.findIndex(m => m.id === parseInt(editId));
                if (medIndex !== -1) {
                    medications[medIndex] = {
                        ...medications[medIndex],
                        ...medicationData
                    };
                }
            } else {
                // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                const medication = {
                    id: Date.now(),
                    ...medicationData,
                    createdAt: new Date().toISOString()
                };
                medications.push(medication);
                
                // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: è–¬ç™»éŒ²è¿½è·¡
                if (analyticsManager) {
                    analyticsManager.trackMedicationEvent('add', medication);
                }
                
                // é€šçŸ¥ã®è¨­å®š
                scheduleNotifications(medication);
            }
            
            localStorage.setItem('medications', JSON.stringify(medications));
            
            hideAddModal();
            removeMedicationPhoto();
            updateMedicationsList();
            updateTodayMedications(); // æ–°è¦ç™»éŒ²æ™‚ã«ã‚‚ä»Šæ—¥ã®æœè–¬ã‚’æ›´æ–°
            
            // æ–°è¦ç™»éŒ²ã—ãŸè–¬ãŒç¾åœ¨ã®æœç”¨æ™‚é–“ã«è©²å½“ã™ã‚‹å ´åˆã¯ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
            if (editId) {
                showPage('medications');
            } else {
                const currentMealTime = getCurrentMealTime();
                const newMed = medications[medications.length - 1];
                const nextMedTime = getNextMedicationTime(newMed);
                
                // ç™»éŒ²æ—¥å½“æ—¥ã§ã€ç¾åœ¨ã®æœç”¨æ™‚é–“ã«è©²å½“ã™ã‚‹å ´åˆ
                if (currentMealTime && nextMedTime.canShowToday && 
                    nextMedTime.nextTimes.some(nt => nt.mealName === currentMealTime)) {
                    showPage('home');
                } else {
                    showPage('medications');
                }
            }
        });
        
        // é£Ÿäº‹æ™‚é–“è¨­å®šã‚’ä¿å­˜
        function saveMealTimeSettings() {
            const settings = {
                breakfast: document.getElementById('breakfast-time').value,
                lunch: document.getElementById('lunch-time').value,
                dinner: document.getElementById('dinner-time').value,
                bedtime: document.getElementById('bedtime').value
            };
            localStorage.setItem('mealTimeSettings', JSON.stringify(settings));
        }
        
        // é£Ÿäº‹æ™‚é–“è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadMealTimeSettings() {
            const saved = localStorage.getItem('mealTimeSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('breakfast-time').value = settings.breakfast || '09:00';
                document.getElementById('lunch-time').value = settings.lunch || '13:00';
                document.getElementById('dinner-time').value = settings.dinner || '19:00';
                document.getElementById('bedtime').value = settings.bedtime || '22:00';
            }
        }
        
        // ç¾åœ¨ã®é£Ÿäº‹æ™‚é–“ã‚’å–å¾—
        function getCurrentMealTime() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // æ™‚é–“ã‚’åˆ†ã«å¤‰æ›
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const breakfastTime = toMinutes(settings.breakfast);
            const lunchTime = toMinutes(settings.lunch);
            const dinnerTime = toMinutes(settings.dinner);
            const bedtimeTime = toMinutes(settings.bedtime);
            
            // å„é£Ÿäº‹æ™‚é–“ã®å‰å¾Œ1æ™‚é–“ã‚’æœè–¬æ™‚é–“ã¨ã™ã‚‹
            if (currentTime >= breakfastTime - 60 && currentTime < breakfastTime + 60) return 'æœé£Ÿå¾Œ';
            else if (currentTime >= lunchTime - 60 && currentTime < lunchTime + 60) return 'æ˜¼é£Ÿå¾Œ';
            else if (currentTime >= dinnerTime - 60 && currentTime < dinnerTime + 60) return 'å¤•é£Ÿå¾Œ';
            else if (currentTime >= bedtimeTime - 60 || currentTime < 360) return 'å°±å¯å‰'; // 360 = 6:00 AM
            
            return '';
        }
        
        // æ¬¡ã®æœç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨ˆç®—
        function getNextMedicationTime(medication) {
            const now = new Date();
            // createdAtãŒç„¡ã„å¤ã„è–¬ã¯ã€ç¾åœ¨æ™‚åˆ»ã®1æ—¥å‰ã¨ã—ã¦æ‰±ã†ï¼ˆé€šå¸¸è¡¨ç¤ºï¼‰
            const registeredAt = medication.createdAt ? new Date(medication.createdAt) : new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            // æ™‚é–“è¨­å®šã‚’å–å¾—
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // æ™‚é–“ã‚’åˆ†ã«å¤‰æ›
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const timeMap = {
                'æœé£Ÿå¾Œ': toMinutes(settings.breakfast),
                'æ˜¼é£Ÿå¾Œ': toMinutes(settings.lunch),
                'å¤•é£Ÿå¾Œ': toMinutes(settings.dinner),
                'å°±å¯å‰': toMinutes(settings.bedtime)
            };
            
            // æœç”¨é »åº¦ã«å¿œã˜ãŸæ¬¡å›æœç”¨æ™‚é–“ã‚’è¨ˆç®—
            const frequency = medication.frequency;
            let nextTimes = [];
            
            switch(frequency) {
                case 'æ¯é£Ÿå¾Œ':
                    nextTimes = [timeMap['æœé£Ÿå¾Œ'], timeMap['æ˜¼é£Ÿå¾Œ'], timeMap['å¤•é£Ÿå¾Œ']];
                    break;
                case 'æœé£Ÿå¾Œ':
                    nextTimes = [timeMap['æœé£Ÿå¾Œ']];
                    break;
                case 'æ˜¼é£Ÿå¾Œ':
                    nextTimes = [timeMap['æ˜¼é£Ÿå¾Œ']];
                    break;
                case 'å¤•é£Ÿå¾Œ':
                    nextTimes = [timeMap['å¤•é£Ÿå¾Œ']];
                    break;
                case 'æœå¤•é£Ÿå¾Œ':
                    nextTimes = [timeMap['æœé£Ÿå¾Œ'], timeMap['å¤•é£Ÿå¾Œ']];
                    break;
                case 'å°±å¯å‰':
                    nextTimes = [timeMap['å°±å¯å‰']];
                    break;
                case 'æ¯é£Ÿå¾Œï¼‹å°±å¯å‰':
                    nextTimes = [timeMap['æœé£Ÿå¾Œ'], timeMap['æ˜¼é£Ÿå¾Œ'], timeMap['å¤•é£Ÿå¾Œ'], timeMap['å°±å¯å‰']];
                    break;
            }
            
            // ç™»éŒ²æ™‚åˆ»ä»¥é™ã®æ¬¡å›æœç”¨æ™‚åˆ»ã‚’è¦‹ã¤ã‘ã‚‹
            const registeredTime = registeredAt.getHours() * 60 + registeredAt.getMinutes();
            const registeredDate = registeredAt.toDateString();
            const currentDate = now.toDateString();
            
            // ç™»éŒ²å½“æ—¥ã®å ´åˆ
            if (registeredDate === currentDate) {
                // ç™»éŒ²æ™‚åˆ»ä»¥é™ã®æœç”¨æ™‚é–“ã‚’æ¢ã™
                const todayNextTimes = nextTimes.filter(time => time > registeredTime);
                
                if (todayNextTimes.length > 0) {
                    // ä»Šæ—¥ã®æ®‹ã‚Šã®æœç”¨æ™‚é–“ãŒã‚ã‚‹
                    return {
                        canShowToday: true,
                        nextTimes: todayNextTimes.map(time => {
                            const mealName = Object.keys(timeMap).find(key => timeMap[key] === time);
                            return { time, mealName };
                        })
                    };
                } else {
                    // ä»Šæ—¥ã¯ã‚‚ã†æœç”¨æ™‚é–“ãŒãªã„ã€æ˜æ—¥ã‹ã‚‰
                    return {
                        canShowToday: false,
                        nextTimes: nextTimes.map(time => {
                            const mealName = Object.keys(timeMap).find(key => timeMap[key] === time);
                            return { time, mealName };
                        })
                    };
                }
            } else {
                // ç™»éŒ²ç¿Œæ—¥ä»¥é™ãªã®ã§é€šå¸¸é€šã‚Šè¡¨ç¤º
                return {
                    canShowToday: true,
                    nextTimes: nextTimes.map(time => {
                        const mealName = Object.keys(timeMap).find(key => timeMap[key] === time);
                        return { time, mealName };
                    })
                };
            }
        }
        
        // ä»Šæ—¥ã®æœè–¬ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateTodayMedications() {
            const container = document.getElementById('today-medications');
            container.innerHTML = '';
            
            const mealTime = getCurrentMealTime();
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // æ™‚é–“è¨­å®šã‚’å–å¾—
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // å„é£Ÿäº‹æ™‚é–“ã‚’åˆ†ã«å¤‰æ›
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const mealTimes = {
                'æœé£Ÿå¾Œ': toMinutes(settings.breakfast),
                'æ˜¼é£Ÿå¾Œ': toMinutes(settings.lunch),
                'å¤•é£Ÿå¾Œ': toMinutes(settings.dinner),
                'å°±å¯å‰': toMinutes(settings.bedtime)
            };
            
            // éå»ã®æœªæœç”¨è–¬ã‚’å–å¾—ï¼ˆç¿Œæ—¥ä»¥é™ã‚‚è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼‰
            const overdueWarnings = [];
            const today = new Date();
            
            // ä»Šæ—¥ã¨éå»7æ—¥é–“ã®æœªæœç”¨è–¬ã‚’ãƒã‚§ãƒƒã‚¯
            for (let dayOffset = 0; dayOffset <= 7; dayOffset++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - dayOffset);
                const checkDateStr = checkDate.toDateString();
                
                for (const [meal, time] of Object.entries(mealTimes)) {
                    // ä»Šæ—¥ã®å ´åˆã¯2æ™‚é–“çµŒéã—ãŸã‚‚ã®ã®ã¿ã€éå»ã®æ—¥ä»˜ã¯å…¨ã¦å¯¾è±¡
                    const shouldShow = dayOffset === 0 ? (currentTime >= time + 120) : true;
                    
                    if (shouldShow) {
                        const overdueMeds = medications.filter(med => {
                            // åŸºæœ¬çš„ãªæœç”¨é »åº¦ãƒã‚§ãƒƒã‚¯
                            const isThisMealTime = med.frequency === 'æ¯é£Ÿå¾Œ' || 
                                   med.frequency === meal ||
                                   (med.frequency === 'æœå¤•é£Ÿå¾Œ' && (meal === 'æœé£Ÿå¾Œ' || meal === 'å¤•é£Ÿå¾Œ'));
                            
                            if (!isThisMealTime) {
                                return false;
                            }
                            
                            // ãã®æ—¥ã«æ—¢ã«æœç”¨æ¸ˆã¿ã€ã‚¹ã‚­ãƒƒãƒ—æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
                            const history = JSON.parse(localStorage.getItem('medicationHistory') || '[]');
                            const isTakenOnDate = history.some(h => 
                                h.medicationId === med.id && 
                                h.mealTime === meal && 
                                new Date(h.date).toDateString() === checkDateStr &&
                                (h.action === 'taken' || h.action === 'skipped')
                            );
                            
                            if (isTakenOnDate) {
                                return false;
                            }
                            
                            // ç™»éŒ²æ—¥ã‚ˆã‚Šå‰ã®æ—¥ã¯å¯¾è±¡å¤–
                            const registeredAt = new Date(med.createdAt || checkDate);
                            if (checkDate < registeredAt) {
                                return false;
                            }
                            
                            // ç™»éŒ²æ—¥å½“æ—¥ã®å ´åˆã¯ã€ç™»éŒ²æ™‚åˆ»ä»¥é™ã®æœç”¨æ™‚é–“ã®ã¿å¯¾è±¡
                            if (registeredAt.toDateString() === checkDateStr) {
                                const mealTimeMinutes = time;
                                const registeredTimeMinutes = registeredAt.getHours() * 60 + registeredAt.getMinutes();
                                return mealTimeMinutes > registeredTimeMinutes;
                            }
                            
                            return true;
                        });
                        
                        overdueWarnings.push(...overdueMeds.map(med => ({
                            ...med, 
                            mealTime: meal,
                            overdueDate: checkDate,
                            dayOffset: dayOffset
                        })));
                    }
                }
            }
            
            // é…å»¶è­¦å‘Šã‚’è¡¨ç¤º
            if (overdueWarnings.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning-message';
                warningDiv.style.marginBottom = '20px';
                warningDiv.innerHTML = '<strong>âš ï¸ æœç”¨æ™‚é–“ã‚’éãã¦ã„ã¾ã™</strong>';
                container.appendChild(warningDiv);
                
                overdueWarnings.forEach(warning => {
                    const card = document.createElement('div');
                    card.className = 'medication-card';
                    card.style.border = '2px solid #ff9800';
                    const stockStatus = warning.stock <= (warning.alertThreshold || 7) ? 'low' : 'normal';
                    const stockColor = stockStatus === 'low' ? '#ff6b6b' : '#38a169';
                    
                    // æ—¥ä»˜è¡¨ç¤ºç”¨ã®æ–‡å­—åˆ—
                    const dateLabel = warning.dayOffset === 0 ? 'ä»Šæ—¥' : 
                                     warning.dayOffset === 1 ? 'æ˜¨æ—¥' :
                                     `${warning.dayOffset}æ—¥å‰`;
                    const warningLabel = warning.dayOffset === 0 ? 'â° æœç”¨æ™‚é–“ã‹ã‚‰2æ™‚é–“ä»¥ä¸ŠçµŒé' : 
                                        `ğŸ“… ${dateLabel}ã®æœªæœç”¨`;
                    
                    card.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <!-- è–¬æƒ…å ±éƒ¨åˆ† -->
                            <div style="flex: 1; min-width: 0;">
                                <div class="medication-name" style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${warning.name} - ${warning.mealTime}</div>
                                <div class="medication-info" style="color: #ff6b6b; margin-bottom: 3px; font-weight: bold;">${warningLabel}</div>
                                <div class="medication-info" style="margin-bottom: 3px;">${warning.dosage} - ${warning.frequency}</div>
                                ${warning.purpose ? `<div class="medication-info" style="color: #666; font-size: 13px;">ç”¨é€”: ${warning.purpose}</div>` : ''}
                            </div>
                            
                            <!-- åœ¨åº«è¡¨ç¤ºéƒ¨åˆ† -->
                            <div style="text-align: center; padding: 8px 12px; background: ${stockStatus === 'low' ? '#fff5f5' : '#f0f9ff'}; border-radius: 8px; border: 1px solid ${stockStatus === 'low' ? '#fed7d7' : '#bfdbfe'};">
                                <div style="font-size: 20px; font-weight: bold; color: ${stockColor};">${warning.stock}</div>
                                <div style="font-size: 11px; color: #666;">å€‹</div>
                                ${stockStatus === 'low' ? '<div style="font-size: 10px; color: #f56565; margin-top: 2px;">âš ï¸ å°‘ãªã„</div>' : ''}
                            </div>
                            
                            <!-- ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ -->
                            ${warning.photo ? `
                                <div>
                                    <img src="${warning.photo}" alt="${warning.name}" 
                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                         onclick="showPhotoModal('${warning.photo}')">
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- ãƒœã‚¿ãƒ³éƒ¨åˆ† -->
                        <div style="display: flex; gap: 10px;">
                            <button class="take-button" 
                                    onclick="showCameraModal(${warning.id}, '${warning.mealTime}', '${warning.overdueDate.toISOString()}')"
                                    style="background: #ff9800; flex: 1;">
                                ğŸ“¸ ä»Šã™ãæœç”¨ã™ã‚‹
                            </button>
                            <button class="skip-button" 
                                    onclick="skipMedication(${warning.id}, '${warning.mealTime}', '${warning.overdueDate.toISOString()}')">
                                â­ï¸ æœç”¨ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
                // é…å»¶è­¦å‘Šã®é€šçŸ¥ã‚’é€ä¿¡
                checkOverdueNotifications(overdueWarnings);
            }
            
            // ç¾åœ¨ã®æœç”¨æ™‚é–“ã®è–¬ã‚’è¡¨ç¤ºï¼ˆç™»éŒ²æ—¥æ™‚ã‚’è€ƒæ…®ï¼‰
            const todayMeds = medications.filter(med => {
                // è–¬ã®æ¬¡å›æœç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å–å¾—
                const nextMedTime = getNextMedicationTime(med);
                
                // ä»Šæ—¥è¡¨ç¤ºã§ããªã„è–¬ã¯é™¤å¤–
                if (!nextMedTime.canShowToday) {
                    return false;
                }
                
                // ç¾åœ¨ã®é£Ÿäº‹æ™‚é–“ã«è©²å½“ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const isCurrentMealTime = med.frequency === 'æ¯é£Ÿå¾Œ' || 
                       med.frequency === mealTime ||
                       (med.frequency === 'æœå¤•é£Ÿå¾Œ' && (mealTime === 'æœé£Ÿå¾Œ' || mealTime === 'å¤•é£Ÿå¾Œ')) ||
                       (med.frequency === 'æ¯é£Ÿå¾Œï¼‹å°±å¯å‰' && (mealTime === 'æœé£Ÿå¾Œ' || mealTime === 'æ˜¼é£Ÿå¾Œ' || mealTime === 'å¤•é£Ÿå¾Œ' || mealTime === 'å°±å¯å‰'));
                
                // ç™»éŒ²æ—¥å½“æ—¥ã®å ´åˆã¯ã€æ¬¡å›æœç”¨æ™‚é–“ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚‚ãƒã‚§ãƒƒã‚¯
                if (isCurrentMealTime) {
                    const registeredAt = new Date(med.createdAt);
                    const today = new Date();
                    
                    if (registeredAt.toDateString() === today.toDateString()) {
                        // ç™»éŒ²æ—¥å½“æ—¥ã¯ã€æ¬¡å›æœç”¨æ™‚é–“ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹é£Ÿäº‹æ™‚é–“ã®ã¿è¡¨ç¤º
                        return nextMedTime.nextTimes.some(nt => nt.mealName === mealTime);
                    }
                }
                
                return isCurrentMealTime;
            });
            
            if (todayMeds.length === 0 && overdueWarnings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ç¾åœ¨æœç”¨ã™ã‚‹è–¬ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            todayMeds.forEach(med => {
                const taken = isTakenToday(med.id, mealTime);
                const card = document.createElement('div');
                card.className = 'medication-card';
                const stockStatus = med.stock <= (med.alertThreshold || 7) ? 'low' : 'normal';
                const stockColor = stockStatus === 'low' ? '#ff6b6b' : '#38a169';
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <!-- è–¬æƒ…å ±éƒ¨åˆ† -->
                        <div style="flex: 1; min-width: 0;">
                            <div class="medication-name" style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${med.name}</div>
                            <div class="medication-info" style="margin-bottom: 3px;">${med.dosage} - ${med.frequency}</div>
                            ${med.purpose ? `<div class="medication-info" style="color: #666; font-size: 13px;">ç”¨é€”: ${med.purpose}</div>` : ''}
                        </div>
                        
                        <!-- åœ¨åº«è¡¨ç¤ºéƒ¨åˆ† -->
                        <div style="text-align: center; padding: 8px 12px; background: ${stockStatus === 'low' ? '#fff5f5' : '#f0f9ff'}; border-radius: 8px; border: 1px solid ${stockStatus === 'low' ? '#fed7d7' : '#bfdbfe'};">
                            <div style="font-size: 20px; font-weight: bold; color: ${stockColor};">${med.stock}</div>
                            <div style="font-size: 11px; color: #666;">å€‹</div>
                            ${stockStatus === 'low' ? '<div style="font-size: 10px; color: #f56565; margin-top: 2px;">âš ï¸ å°‘ãªã„</div>' : ''}
                        </div>
                        
                        <!-- ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ -->
                        ${med.photo ? `
                            <div>
                                <img src="${med.photo}" alt="${med.name}" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                     onclick="showPhotoModal('${med.photo}')">
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- ãƒœã‚¿ãƒ³éƒ¨åˆ† -->
                    <button class="take-button ${taken ? 'taken' : ''}" 
                            onclick="showCameraModal(${med.id}, '${mealTime}')"
                            ${taken ? 'disabled' : ''}
                            style="width: 100%; margin-bottom: 8px;">
                        ${taken ? 'âœ“ æœç”¨æ¸ˆã¿' : 'ğŸ“¸ æœç”¨ã™ã‚‹'}
                    </button>
                    ${taken ? `<button class="cancel-button" onclick="undoMedication(${med.id}, '${mealTime}')" style="width: 100%; padding: 8px; font-size: 14px;">ğŸ”„ å–ã‚Šæ¶ˆã—</button>` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        // è–¬ã‚’æœç”¨ï¼ˆå†™çœŸå¿…é ˆï¼‰
        // ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã•ã‚Œãšã€ã™ã¹ã¦ã®æœç”¨è¨˜éŒ²ã¯ showCameraModal ã‚’çµŒç”±ã—ã¦å†™çœŸä»˜ãã§è¡Œã‚ã‚Œã¾ã™
        function takeMedication(medId, mealTime) {
            // å†™çœŸæ’®å½±ãŒå¿…é ˆã®ãŸã‚ã€ç›´æ¥ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’èµ·å‹•
            showCameraModal(medId, mealTime);
        }
        
        // ä»Šæ—¥æœç”¨æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ã‚­ãƒƒãƒ—ã‚‚å«ã‚€ï¼‰
        function isTakenToday(medId, mealTime) {
            const today = new Date().toDateString();
            return history.some(h => {
                const takenDate = new Date(h.date || h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled && // å–ã‚Šæ¶ˆã•ã‚Œã¦ã„ãªã„å±¥æ­´ã®ã¿
                       (h.action === 'taken' || h.action === 'skipped' || !h.action); // taken, skipped, ã¾ãŸã¯å¤ã„æ§‹é€ ï¼ˆactionãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—ï¼‰
            });
        }
        
        // æœç”¨è¨˜éŒ²ã®å–ã‚Šæ¶ˆã—ï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰ï¼‰
        function undoMedication(medId, mealTime) {
            if (!confirm('æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿåœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            const today = new Date().toDateString();
            const historyItem = history.find(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled;
            });
            
            if (historyItem) {
                // å±¥æ­´ã‚’å–ã‚Šæ¶ˆã—æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // åœ¨åº«ã‚’æˆ»ã™
                const med = medications.find(m => m.id === medId);
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                checkStockWarnings();
                
                alert('âœ… æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚åœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã—ãŸã€‚');
            }
        }
        
        // å±¥æ­´ã‹ã‚‰ã®å–ã‚Šæ¶ˆã—
        function undoHistoryItem(medId, takenAt, mealTime) {
            if (!confirm('ã“ã®æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿåœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            const historyItem = history.find(h => 
                h.medicationId === medId && 
                h.takenAt === takenAt && 
                h.mealTime === mealTime &&
                !h.cancelled
            );
            
            if (historyItem) {
                // å±¥æ­´ã‚’å–ã‚Šæ¶ˆã—æ¸ˆã¿ã«ãƒãƒ¼ã‚¯
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // åœ¨åº«ã‚’æˆ»ã™
                const med = medications.find(m => m.id === parseInt(medId));
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                updateHistoryList();
                checkStockWarnings();
                
                alert('âœ… æœç”¨è¨˜éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚åœ¨åº«ãŒ1ã¤æˆ»ã‚Šã¾ã—ãŸã€‚');
            }
        }
        
        // åœ¨åº«è­¦å‘Šã‚’ãƒã‚§ãƒƒã‚¯
        function checkStockWarnings() {
            const container = document.getElementById('stock-warnings');
            container.innerHTML = '';
            
            const warnings = medications.filter(med => med.stock <= (med.alertThreshold || 7));
            if (warnings.length > 0) {
                warnings.forEach(med => {
                    const warning = document.createElement('div');
                    warning.className = 'stock-warning';
                    warning.textContent = `âš ï¸ ${med.name}ã®åœ¨åº«ãŒæ®‹ã‚Š${med.stock}å€‹ã§ã™ã€‚è¿½åŠ è³¼å…¥ã—ã¦ãã ã•ã„ï¼`;
                    container.appendChild(warning);
                });
            }
        }
        
        // è–¬ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateMedicationsList() {
            const container = document.getElementById('medications-list');
            container.innerHTML = '';
            
            if (medications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">è–¬ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            medications.forEach(med => {
                const card = document.createElement('div');
                card.className = 'medication-card';
                const stockStatus = med.stock <= (med.alertThreshold || 7) ? 'low' : 'normal';
                const stockColor = stockStatus === 'low' ? '#ff6b6b' : '#38a169';
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <!-- è–¬æƒ…å ±éƒ¨åˆ† -->
                        <div style="flex: 1; min-width: 0;">
                            <div class="medication-name" style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${med.name}</div>
                            <div class="medication-info" style="margin-bottom: 3px;">${med.dosage} - ${med.frequency}</div>
                            ${med.purpose ? `<div class="medication-info" style="color: #666; font-size: 13px;">ç”¨é€”: ${med.purpose}</div>` : ''}
                        </div>
                        
                        <!-- åœ¨åº«è¡¨ç¤ºéƒ¨åˆ† -->
                        <div style="text-align: center; padding: 8px 12px; background: ${stockStatus === 'low' ? '#fff5f5' : '#f0f9ff'}; border-radius: 8px; border: 1px solid ${stockStatus === 'low' ? '#fed7d7' : '#bfdbfe'};">
                            <div style="font-size: 20px; font-weight: bold; color: ${stockColor};">${med.stock}</div>
                            <div style="font-size: 11px; color: #666;">å€‹</div>
                            ${stockStatus === 'low' ? '<div style="font-size: 10px; color: #f56565; margin-top: 2px;">âš ï¸ å°‘ãªã„</div>' : ''}
                        </div>
                        
                        <!-- ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ -->
                        ${med.photo ? `
                            <div>
                                <img src="${med.photo}" alt="${med.name}" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                     onclick="showPhotoModal('${med.photo}')">
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- ãƒœã‚¿ãƒ³éƒ¨åˆ† -->
                    <div style="margin-top: 15px; display: flex; gap: 8px;">
                        <button onclick="editMedication(${med.id})" style="flex: 1; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">âœï¸ ç·¨é›†</button>
                        <button onclick="deleteMedication(${med.id})" style="flex: 1; padding: 8px 12px; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // å±¥æ­´ã‚’æ›´æ–°
        function updateHistoryList() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æœè–¬å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // å–ã‚Šæ¶ˆã•ã‚Œã¦ã„ãªã„å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆã‚¹ã‚­ãƒƒãƒ—ã‚‚å«ã‚€ï¼‰
            const activeHistory = history.filter(h => !h.cancelled);
            
            if (activeHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æœè–¬å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedHistory = {};
            activeHistory.slice().reverse().forEach(h => {
                const date = new Date(h.takenAt).toLocaleDateString('ja-JP');
                if (!groupedHistory[date]) {
                    groupedHistory[date] = [];
                }
                groupedHistory[date].push(h);
            });
            
            Object.entries(groupedHistory).forEach(([date, items]) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-meds">
                        ${items.map(item => {
                            const time = new Date(item.takenAt).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                            const hasPhoto = item.photo || item.photoVerified;
                            const isSkipped = item.action === 'skipped';
                            return `
                                <div style="display: flex; align-items: center; margin-bottom: 10px; ${isSkipped ? 'opacity: 0.7;' : ''}">
                                    ${!isSkipped && hasPhoto && item.photo ? `
                                        <img class="history-photo" src="${item.photo}" 
                                             onclick="showPhotoModal('${item.photo}')" 
                                             alt="æœç”¨å†™çœŸ">
                                    ` : !isSkipped && hasPhoto ? `
                                        <div class="history-photo" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0;">
                                            ğŸ“¸
                                        </div>
                                    ` : isSkipped ? `
                                        <div class="history-photo" style="display: flex; align-items: center; justify-content: center; background: #f5f5f5; color: #999;">
                                            â­ï¸
                                        </div>
                                    ` : ''}
                                    <div style="flex: 1;">
                                        <div>${item.medicationName} (${item.mealTime})${isSkipped ? ' - ã‚¹ã‚­ãƒƒãƒ—' : ''}</div>
                                        <div style="font-size: 12px; color: #888;">${time}</div>
                                    </div>
                                    ${!isSkipped ? `
                                        <button class="cancel-button" onclick="undoHistoryItem('${item.medicationId}', '${item.takenAt}', '${item.mealTime}')" 
                                                style="padding: 2px 8px; font-size: 12px; margin-left: 10px;">ğŸ”„ å–ã‚Šæ¶ˆã—</button>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }
        
        // é€šçŸ¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        function scheduleNotifications(medication) {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // æœè–¬æ™‚é–“ã®é€šçŸ¥ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
            setMedicationReminders(medication);
        }
        
        // é…å»¶è­¦å‘Šã®é€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        function checkOverdueNotifications(overdueWarnings) {
            if ('Notification' in window && Notification.permission === 'granted') {
                overdueWarnings.forEach(warning => {
                    const notificationKey = `overdue-${warning.id}-${warning.mealTime}-${new Date().toDateString()}`;
                    
                    // ä»Šæ—¥æ—¢ã«é€šçŸ¥ã‚’é€ä¿¡ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                    if (!localStorage.getItem(notificationKey)) {
                        new Notification('âš ï¸ æœç”¨æ™‚é–“ã‚’éãã¦ã„ã¾ã™', {
                            body: `${warning.name}ï¼ˆ${warning.mealTime}ï¼‰ã‚’æœç”¨ã—ã¦ãã ã•ã„`,
                            icon: '/icon-192x192.png',
                            tag: notificationKey,
                            requireInteraction: true
                        });
                        
                        // é€šçŸ¥é€ä¿¡æ¸ˆã¿ã¨ã—ã¦è¨˜éŒ²
                        localStorage.setItem(notificationKey, 'sent');
                    }
                });
            }
        }
        
        // æœè–¬ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®è¨­å®š
        function setMedicationReminders(medication) {
            const frequency = medication.frequency;
            const times = [];
            
            // æœç”¨é »åº¦ã«å¿œã˜ã¦é€šçŸ¥æ™‚é–“ã‚’è¨­å®š
            switch(frequency) {
                case 'æ¯é£Ÿå¾Œ':
                    times.push('08:30', '12:30', '19:30'); // æœæ˜¼å¤•é£Ÿå¾Œ
                    break;
                case 'æœé£Ÿå¾Œ':
                    times.push('08:30');
                    break;
                case 'æ˜¼é£Ÿå¾Œ':
                    times.push('12:30');
                    break;
                case 'å¤•é£Ÿå¾Œ':
                    times.push('19:30');
                    break;
                case 'æœå¤•é£Ÿå¾Œ':
                    times.push('08:30', '19:30');
                    break;
                case 'å°±å¯å‰':
                    times.push('22:00');
                    break;
                case 'æ¯é£Ÿå¾Œï¼‹å°±å¯å‰':
                    times.push('08:30', '12:30', '19:30', '22:00'); // æœæ˜¼å¤•é£Ÿå¾Œï¼‹å°±å¯å‰
                    break;
            }
            
            // å„æ™‚é–“ã«å¯¾ã—ã¦é€šçŸ¥ã‚’è¨­å®š
            times.forEach(time => {
                scheduleNotificationAtTime(medication, time);
            });
        }
        
        // æŒ‡å®šæ™‚é–“ã«é€šçŸ¥ã‚’è¨­å®š
        function scheduleNotificationAtTime(medication, timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const now = new Date();
            const scheduledTime = new Date();
            scheduledTime.setHours(hours, minutes, 0, 0);
            
            // ã‚‚ã—ä»Šæ—¥ã®æ™‚é–“ãŒéãã¦ã„ãŸã‚‰æ˜æ—¥ã«è¨­å®š
            if (scheduledTime <= now) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }
            
            const timeUntilNotification = scheduledTime.getTime() - now.getTime();
            
            setTimeout(() => {
                showMedicationNotification(medication, timeString);
                // ç¿Œæ—¥ä»¥é™ã‚‚ç¶™ç¶šã™ã‚‹ãŸã‚å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                setTimeout(() => {
                    scheduleNotificationAtTime(medication, timeString);
                }, 24 * 60 * 60 * 1000); // 24æ™‚é–“å¾Œ
            }, timeUntilNotification);
        }
        
        // è–¬ã®é€šçŸ¥ã‚’è¡¨ç¤º
        function showMedicationNotification(medication, time) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`ğŸ’Š ãŠè–¬ã®æ™‚é–“ã§ã™`, {
                    body: `${medication.name} (${medication.dosage}) ã‚’æœç”¨ã—ã¦ãã ã•ã„`,
                    icon: 'ğŸ’Š',
                    badge: 'ğŸ’Š',
                    tag: `medication-${medication.id}`,
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'take',
                            title: 'æœç”¨æ¸ˆã¿'
                        },
                        {
                            action: 'later',
                            title: 'å¾Œã§'
                        }
                    ]
                });
                
                notification.onclick = function() {
                    window.focus();
                    // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
                    showPage('home');
                    this.close();
                };
                
                // 10ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
                setTimeout(() => {
                    notification.close();
                }, 10000);
            }
        }
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        function checkLowStockNotifications() {
            medications.forEach(med => {
                const threshold = med.alertThreshold || 7;
                if (med.stock <= threshold && med.stock > 0) {
                    showLowStockNotification(med);
                }
            });
        }
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’è¡¨ç¤º
        function showLowStockNotification(medication) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`âš ï¸ è–¬ã®åœ¨åº«ãŒå°‘ãªããªã£ã¦ã„ã¾ã™`, {
                    body: `${medication.name}ã®åœ¨åº«ãŒæ®‹ã‚Š${medication.stock}å€‹ã§ã™ã€‚è¿½åŠ è³¼å…¥ã—ã¦ãã ã•ã„ã€‚`,
                    icon: 'âš ï¸',
                    badge: 'âš ï¸',
                    tag: `stock-${medication.id}`,
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    showPage('medications');
                    this.close();
                };
            }
        }
        
        // åˆæœŸåŒ–
        updateTodayMedications();
        checkStockWarnings();
        
        // Service Workerã®ç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker ç™»éŒ²å¤±æ•—:', error);
                    });
            });
        }
        
        // é€šçŸ¥æ¨©é™ã®è¦æ±‚
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // æ—¢å­˜ã®è–¬ã«å¯¾ã—ã¦é€šçŸ¥ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        medications.forEach(medication => {
            setMedicationReminders(medication);
        });
        
        // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯
        checkLowStockNotifications();
        
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‡¦ç†
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é˜²ã
            e.preventDefault();
            // å¾Œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
            deferredPrompt = e;
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #2196F3;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 9999;
                cursor: pointer;
            `;
            installBanner.innerHTML = 'ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã™ï¼';
            installBanner.onclick = installApp;
            document.body.appendChild(installBanner);
            
            // 10ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
            setTimeout(() => {
                if (installBanner.parentNode) {
                    installBanner.parentNode.removeChild(installBanner);
                }
            }, 10000);
        }
        
        function installApp() {
            if (deferredPrompt) {
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                deferredPrompt.prompt();
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã‚’å¾…ã¤
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å—ã‘å…¥ã‚Œã¾ã—ãŸ');
                    } else {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ‹’å¦ã—ã¾ã—ãŸ');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showCameraModal(medId, mealTime, overdueDate = null) {
            currentMedId = medId;
            currentMealTime = mealTime;
            currentOverdueDate = overdueDate;
            
            const modal = document.getElementById('camera-modal');
            resetCameraModal();
            modal.style.display = 'block';
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetCameraModal() {
            const capturedImage = document.getElementById('captured-image');
            const analysisResult = document.getElementById('analysis-result');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            const confirmSection = document.getElementById('medication-confirm-section');
            const initialButtons = document.getElementById('camera-initial-buttons');
            const fileInput = document.getElementById('camera-input');
            
            // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            capturedImage.style.display = 'none';
            analysisResult.style.display = 'none';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            confirmSection.style.display = 'none';
            initialButtons.style.display = 'block';
            fileInput.value = '';
        }
        
        // ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hideCameraModal() {
            const modal = document.getElementById('camera-modal');
            modal.style.display = 'none';
            
            currentMedId = null;
            currentMealTime = null;
        }
        
        // OSã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
        function openCameraApp() {
            // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: ã‚«ãƒ¡ãƒ©ä½¿ç”¨è¿½è·¡
            if (analyticsManager) {
                analyticsManager.trackCameraUsage('capture_started');
            }
            
            const fileInput = document.getElementById('camera-input');
            fileInput.click();
        }
        
        // å†™çœŸã‚­ãƒ£ãƒ—ãƒãƒ£å‡¦ç†
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageDataUrl = e.target.result;
                
                // æ’®å½±ã—ãŸç”»åƒã‚’è¡¨ç¤º
                const capturedImage = document.getElementById('captured-image');
                const captureBtn = document.getElementById('capture-btn');
                const retakeBtn = document.getElementById('retake-btn');
                
                capturedImage.src = imageDataUrl;
                capturedImage.style.display = 'block';
                
                // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'block';
                
                // ç”»åƒè§£æã‚’å®Ÿè¡Œ
                analyzeImage(imageDataUrl);
            };
            reader.readAsDataURL(file);
        }
        
        // æ’®ã‚Šç›´ã—
        function retakePhoto() {
            resetCameraModal();
        }
        
        // ç”»åƒåœ§ç¸®ã¨ä¿å­˜
        async function analyzeImage(imageDataUrl) {
            // ç”»åƒåœ§ç¸®
            const compressedImage = await compressImage(imageDataUrl);
            
            // åœ§ç¸®ã—ãŸç”»åƒã‚’ä¸€æ™‚ä¿å­˜
            sessionStorage.setItem('tempMedicationImage', compressedImage);
            
            // æœç”¨ç¢ºèªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            showMedicationConfirmSection();
        }
        
        // æœç”¨ç¢ºèªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        function showMedicationConfirmSection() {
            const med = medications.find(m => m.id === currentMedId);
            if (!med) return;
            
            // è–¬å‰¤æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('confirm-med-name').textContent = med.name;
            
            // ç”¨é‡ã‚’è§£æã—ã¦æ•°å€¤ã¨å˜ä½ã«åˆ†ã‘ã‚‹
            const dosageMatch = med.dosage.match(/(\d+)(.+)/);
            const dosageNumber = dosageMatch ? dosageMatch[1] : '1';
            const dosageUnit = dosageMatch ? dosageMatch[2] : 'éŒ ';
            
            document.getElementById('confirm-dosage').value = dosageNumber;
            document.getElementById('confirm-dosage-unit').textContent = dosageUnit;
            document.getElementById('confirm-current-stock').textContent = med.stock + dosageUnit;
            
            // æœç”¨æ•°é‡å¤‰æ›´æ™‚ã®åœ¨åº«è¨ˆç®—
            updateRemainingStock();
            document.getElementById('confirm-dosage').addEventListener('input', updateRemainingStock);
            
            // UIã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('medication-confirm-section').style.display = 'block';
            document.getElementById('camera-initial-buttons').style.display = 'none';
        }
        
        // æ®‹ã‚Šåœ¨åº«ã‚’æ›´æ–°
        function updateRemainingStock() {
            const med = medications.find(m => m.id === currentMedId);
            if (!med) return;
            
            const dosageInput = document.getElementById('confirm-dosage');
            const takingAmount = parseInt(dosageInput.value) || 1;
            const remaining = med.stock - takingAmount;
            
            const remainingElement = document.getElementById('confirm-remaining-stock');
            remainingElement.textContent = remaining + document.getElementById('confirm-dosage-unit').textContent;
            
            // åœ¨åº«ä¸è¶³ã®å ´åˆã¯è­¦å‘Šè¡¨ç¤º
            if (remaining < 0) {
                remainingElement.style.color = '#f56565';
            } else if (remaining <= med.alertThreshold) {
                remainingElement.style.color = '#ed8936';
            } else {
                remainingElement.style.color = '#38a169';
            }
        }
        
        // æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒåœ§ç¸®é–¢æ•°
        async function compressImage(dataUrl, maxWidth = 800, quality = 0.7) {
            // PerformanceManagerãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯æœ€é©åŒ–ç‰ˆã‚’ä½¿ç”¨
            if (window.performanceManager) {
                const type = maxWidth <= 300 ? 'thumbnail' : maxWidth <= 400 ? 'medication' : 'history';
                return window.performanceManager.optimizedCompressImage(dataUrl, type, {
                    maxWidth: maxWidth,
                    quality: quality
                });
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®åœ§ç¸®æ©Ÿèƒ½
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ãªãŒã‚‰ãƒªã‚µã‚¤ã‚º
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // åœ§ç¸®å¾Œã®ãƒ‡ãƒ¼ã‚¿URLã‚’è¿”ã™
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        // ç”»åƒå±¥æ­´ã®æ›´æ–°ï¼ˆå¤ã„ç”»åƒã‚’å‰Šé™¤ï¼‰
        function cleanupOldPhotos() {
            // 3ãƒ¶æœˆï¼ˆ90æ—¥ï¼‰ä»¥ä¸Šå¤ã„ç”»åƒã‚’æŒã¤å±¥æ­´ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setDate(threeMonthsAgo.getDate() - 90);
            
            let cleaned = false;
            history.forEach(item => {
                if (item.photo && new Date(item.takenAt) < threeMonthsAgo) {
                    item.photo = null; // å¤ã„ç”»åƒã‚’å‰Šé™¤
                    cleaned = true;
                }
            });
            
            if (cleaned) {
                localStorage.setItem('history', JSON.stringify(history));
                console.log('å¤ã„å†™çœŸã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ');
            }
        }
        
        // å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showPhotoModal(photoUrl) {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <img src="${photoUrl}" alt="æœç”¨å†™çœŸ">
            `;
            modal.onclick = function() {
                modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        // æœç”¨ç¢ºèªï¼ˆå†™çœŸä»˜ãï¼‰
        function confirmMedication() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                // åœ¨åº«ã‚’æ¸›ã‚‰ã™
                med.stock -= 1;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // ä¸€æ™‚ä¿å­˜ã—ãŸç”»åƒã‚’å–å¾—
                const photo = sessionStorage.getItem('tempMedicationImage');
                
                // å±¥æ­´ã«è¿½åŠ ï¼ˆå†™çœŸä»˜ãï¼‰
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: med.dosage,
                    takenAt: new Date().toISOString(),
                    mealTime: currentMealTime,
                    photoVerified: true,
                    photo: photo // åœ§ç¸®æ¸ˆã¿ç”»åƒ
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: æœç”¨è¨˜éŒ²è¿½è·¡
                if (analyticsManager) {
                    analyticsManager.trackMedicationTaken(med.id, med.name);
                }
                
                // ä¸€æ™‚ä¿å­˜ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem('tempMedicationImage');
                
                // ç”»åƒå±¥æ­´ã‚‚ç®¡ç†
                updateImageHistory();
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                checkStockWarnings();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                hideCameraModal();
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                alert('ğŸ“¸ å†™çœŸã§æœç”¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸï¼');
            }
        }
        
        // æœç”¨ç¢ºèªï¼ˆå†™çœŸä»˜ãï¼‰
        function confirmMedicationWithPhoto() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                const takingAmount = parseInt(document.getElementById('confirm-dosage').value) || 1;
                
                // åœ¨åº«ãƒã‚§ãƒƒã‚¯
                if (med.stock < takingAmount) {
                    alert('åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚');
                    return;
                }
                
                // åœ¨åº«ã‚’æ¸›ã‚‰ã™
                med.stock -= takingAmount;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // ä¸€æ™‚ä¿å­˜ã•ã‚ŒãŸå†™çœŸã‚’å–å¾—
                const tempImage = sessionStorage.getItem('tempMedicationImage');
                
                // å±¥æ­´ã«è¿½åŠ ã€€
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: takingAmount + document.getElementById('confirm-dosage-unit').textContent,
                    takenAt: new Date().toISOString(),
                    date: currentOverdueDate || new Date().toISOString(),
                    mealTime: currentMealTime,
                    action: 'taken',
                    photoVerified: true,
                    photo: tempImage
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: æœç”¨è¨˜éŒ²è¿½è·¡
                if (analyticsManager) {
                    analyticsManager.trackMedicationTaken(med.id, med.name);
                }
                
                // ä¸€æ™‚ä¿å­˜ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem('tempMedicationImage');
                
                // ç”»åƒå±¥æ­´ã‚‚ç®¡ç†
                cleanupOldPhotos();
                
                // UIã‚’æ›´æ–°
                updateTodayMedications();
                checkStockWarnings();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                hideCameraModal();
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                alert('ğŸ“¸ æœç”¨ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸï¼');
                
                // å±¥æ­´ãƒšãƒ¼ã‚¸ã«ç§»å‹•
                showPage('history');
                updateHistoryList();
            }
        }
        
        // è–¬ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹é–¢æ•°
        function skipMedication(medId, mealTime, overdueDate) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            if (!confirm(`${med.name} - ${mealTime}ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ\nåœ¨åº«ã¯æ¸›ã‚‰ãšã€è­¦å‘Šã‚‚æ¶ˆãˆã¾ã™ã€‚`)) {
                return;
            }
            
            // ã‚¹ã‚­ãƒƒãƒ—å±¥æ­´ã‚’è¿½åŠ ï¼ˆåœ¨åº«ã¯æ¸›ã‚‰ã•ãªã„ï¼‰
            const historyItem = {
                medicationId: medId,
                medicationName: med.name,
                dosage: med.dosage || '1éŒ ',
                takenAt: new Date().toISOString(),
                date: overdueDate || new Date().toISOString(),
                mealTime: mealTime,
                action: 'skipped',
                photoVerified: false,
                photo: null
            };
            
            history.push(historyItem);
            localStorage.setItem('history', JSON.stringify(history));
            
            // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: ã‚¹ã‚­ãƒƒãƒ—è¨˜éŒ²è¿½è·¡
            if (analyticsManager) {
                analyticsManager.trackEvent('medication_skipped', {
                    medication_id: medId,
                    medication_name: med.name,
                    meal_time: mealTime
                });
            }
            
            // UIã‚’æ›´æ–°ï¼ˆè­¦å‘ŠãŒæ¶ˆãˆã‚‹ï¼‰
            updateTodayMedications();
            
            alert(`âœ… ${med.name} - ${mealTime}ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`);
        }
        
        // å±¥æ­´ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function showHistoryView(viewType) {
            const listView = document.getElementById('history-list');
            const galleryView = document.getElementById('history-gallery');
            const listBtn = document.getElementById('list-view-btn');
            const galleryBtn = document.getElementById('gallery-view-btn');
            
            if (viewType === 'list') {
                listView.style.display = 'block';
                galleryView.style.display = 'none';
                listBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                listBtn.style.color = 'white';
                galleryBtn.style.background = '#e2e8f0';
                galleryBtn.style.color = '#4a5568';
                updateHistoryList();
            } else {
                listView.style.display = 'none';
                galleryView.style.display = 'block';
                listBtn.style.background = '#e2e8f0';
                listBtn.style.color = '#4a5568';
                galleryBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                galleryBtn.style.color = 'white';
                updateHistoryGallery();
            }
        }
        
        // å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®æ›´æ–°
        function updateHistoryGallery() {
            const container = document.getElementById('history-gallery');
            container.innerHTML = '';
            
            // å†™çœŸä»˜ãã®å±¥æ­´ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const photoHistory = history.filter(h => !h.cancelled && h.photo);
            
            if (photoHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">å†™çœŸä»˜ãã®æœè–¬è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ–°ã—ã„é †ã«è¡¨ç¤º
            container.innerHTML = '<div class="history-gallery">' + 
                photoHistory.slice().reverse().map(item => {
                    const date = new Date(item.takenAt);
                    const dateStr = date.toLocaleDateString('ja-JP');
                    const timeStr = date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    
                    return `
                        <div class="gallery-item">
                            <img src="${item.photo}" onclick="showPhotoModal('${item.photo}')" alt="æœç”¨å†™çœŸ">
                            <div class="gallery-item-info">
                                <div class="gallery-item-date">${dateStr} ${timeStr}</div>
                                <div class="gallery-item-med">${item.medicationName}</div>
                                <div class="gallery-item-med">${item.mealTime}</div>
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
        }
        
        // è–¬ã®ç·¨é›†
        function editMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            // ç¾åœ¨ã®å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®š
            document.getElementById('med-name').value = med.name;
            
            // ç”¨é‡ã‚’æ•°å­—ã¨å˜ä½ã«åˆ†å‰²
            const dosageMatch = med.dosage.match(/(\d+)(.+)/);
            if (dosageMatch) {
                document.getElementById('med-dosage-number').value = dosageMatch[1];
                document.getElementById('med-dosage-unit').value = dosageMatch[2];
            }
            
            document.getElementById('med-frequency').value = med.frequency;
            document.getElementById('med-stock').value = med.stock;
            
            // åœ¨åº«è­¦å‘Šã—ãã„å€¤ã‚’è¨­å®š
            const threshold = med.alertThreshold || 7;
            if (threshold >= 1 && threshold <= 10) {
                document.getElementById('med-alert-threshold-select').value = threshold.toString();
                document.getElementById('med-alert-threshold-custom').style.display = 'none';
                document.getElementById('med-alert-threshold-custom').required = false;
            } else {
                document.getElementById('med-alert-threshold-select').value = 'custom';
                document.getElementById('med-alert-threshold-custom').value = threshold;
                document.getElementById('med-alert-threshold-custom').style.display = 'block';
                document.getElementById('med-alert-threshold-custom').required = true;
            }
            
            // ç”¨é€”ã‚’è¨­å®š
            if (med.purpose) {
                const standardPurposes = ['é ­ç—›ãƒ»è§£ç†±', 'èƒƒè…¸è–¬', 'é¢¨é‚ªè–¬', 'ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼', 'ãƒ“ã‚¿ãƒŸãƒ³ãƒ»ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ', 'é«˜è¡€åœ§', 'ç³–å°¿ç—…', 'æŠ—ç”Ÿç‰©è³ª', 'ç¡çœ è–¬'];
                if (standardPurposes.includes(med.purpose)) {
                    document.getElementById('med-purpose-select').value = med.purpose;
                    document.getElementById('med-purpose-custom').style.display = 'none';
                    document.getElementById('med-purpose-custom').required = false;
                } else {
                    document.getElementById('med-purpose-select').value = 'custom';
                    document.getElementById('med-purpose-custom').value = med.purpose;
                    document.getElementById('med-purpose-custom').style.display = 'block';
                    document.getElementById('med-purpose-custom').required = true;
                }
            } else {
                document.getElementById('med-purpose-select').value = '';
                document.getElementById('med-purpose-custom').style.display = 'none';
                document.getElementById('med-purpose-custom').required = false;
            }
            
            // å†™çœŸã‚’è¨­å®š
            if (med.photo) {
                const preview = document.getElementById('med-photo-preview');
                const thumbnail = document.getElementById('med-photo-thumbnail');
                
                thumbnail.src = med.photo;
                preview.style.display = 'block';
                preview.dataset.photo = med.photo;
            } else {
                removeMedicationPhoto();
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('add-modal').style.display = 'block';
            document.getElementById('add-modal').dataset.editId = medId;
            document.querySelector('#add-modal h3').textContent = 'è–¬ã®æƒ…å ±ã‚’ç·¨é›†';
        }
        
        // è–¬ã®å‰Šé™¤
        function deleteMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            if (confirm(`ã€Œ${med.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                medications = medications.filter(m => m.id !== medId);
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // UIã‚’æ›´æ–°
                updateMedicationsList();
                updateTodayMedications();
                checkStockWarnings();
                
                alert('âœ… è–¬ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
            }
        }
        
        
        
        // å®šæœŸçš„ã«ç”»é¢ã‚’æ›´æ–°ï¼ˆ1åˆ†ã”ã¨ï¼‰
        setInterval(() => {
            if (document.getElementById('home-page').classList.contains('active')) {
                updateTodayMedications();
                checkStockWarnings();
            }
            // åœ¨åº«åˆ‡ã‚Œé€šçŸ¥ã‚‚å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
            checkLowStockNotifications();
        }, 60000);
        
        // å®šæœŸçš„ã«å¤ã„å†™çœŸã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ1æ—¥1å›ï¼‰
        setInterval(() => {
            cleanupOldPhotos();
        }, 24 * 60 * 60 * 1000); // 24æ™‚é–“ã”ã¨
        
        // Firebaseèªè¨¼é–¢æ•°ç¾¤
        async function handleLogin(email, password) {
            try {
                showMessage('login-message', 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...', 'info');
                
                const userCredential = await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                if (!user.emailVerified) {
                    showMessage('login-message', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'error');
                    await window.signOut(window.firebaseAuth);
                    return;
                }
                
                showMessage('login-message', 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼', 'success');
                
                // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³è¿½è·¡
                if (analyticsManager) {
                    analyticsManager.setUser(user.uid, {
                        email: user.email,
                        display_name: user.displayName,
                        provider: 'oauth'
                    });
                }
                currentUser = user;
                isAuthenticated = true;
                
                setTimeout(() => {
                    hideAuthContainer();
                    showAppContainer();
                }, 1000);
                
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('login-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handleRegister(email, password, passwordConfirm) {
            if (password !== passwordConfirm) {
                showMessage('register-message', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('register-message', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                showMessage('register-message', 'ç™»éŒ²ä¸­...', 'info');
                
                const userCredential = await window.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                // ãƒ¡ãƒ¼ãƒ«èªè¨¼é€ä¿¡
                await window.sendEmailVerification(user);
                
                showMessage('register-message', 'ç™»éŒ²å®Œäº†ï¼ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'success');
                
                // 2ç§’å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                setTimeout(() => {
                    showLoginPage();
                }, 3000);
                
            } catch (error) {
                console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('register-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handlePasswordReset() {
            const email = prompt('ç™»éŒ²æ¸ˆã¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
            if (!email) return;

            try {
                await window.sendPasswordResetEmail(window.firebaseAuth, email);
                showMessage('login-message', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showMessage('login-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handleLogout() {
            try {
                await window.signOut(window.firebaseAuth);
                currentUser = null;
                isAuthenticated = false;
                showAuthContainer();
                hideAppContainer();
                showMessage('login-message', 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // UIåˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function showLoginPage() {
            document.querySelectorAll('#auth-container .page').forEach(page => page.classList.remove('active'));
            document.getElementById('login-page').classList.add('active');
            clearMessages();
        }

        function showRegisterPage() {
            document.querySelectorAll('#auth-container .page').forEach(page => page.classList.remove('active'));
            document.getElementById('register-page').classList.add('active');
            clearMessages();
        }

        function showPasswordReset() {
            handlePasswordReset();
        }

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';
        }

        function hideAuthContainer() {
            document.getElementById('auth-container').style.display = 'none';
        }

        function showAppContainer() {
            document.getElementById('app-container').style.display = 'block';
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
            }
            // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
            updateTodayMedications();
            updateMedicationsList();
            checkStockWarnings();
        }

        function hideAppContainer() {
            document.getElementById('app-container').style.display = 'none';
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(elementId, message, type) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `form-message ${type}`;
            messageEl.style.display = 'block';
        }

        function clearMessages() {
            document.querySelectorAll('.form-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
        }

        // Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/email-already-in-use': 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™',
                'auth/weak-password': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ï¼ˆ6æ–‡å­—ä»¥ä¸Šå¿…è¦ï¼‰',
                'auth/invalid-email': 'ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™',
                'auth/user-not-found': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                'auth/wrong-password': 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™',
                'auth/too-many-requests': 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„',
                'auth/network-request-failed': 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                'auth/invalid-credential': 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™'
            };
            return errorMessages[errorCode] || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await handleLogin(email, password);
            });

            // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;
                await handleRegister(email, password, passwordConfirm);
            });

            // Firebaseèªè¨¼çŠ¶æ…‹ã®ç›£è¦–
            window.onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user && user.emailVerified) {
                    currentUser = user;
                    isAuthenticated = true;
                    hideAuthContainer();
                    showAppContainer();
                } else {
                    currentUser = null;
                    isAuthenticated = false;
                    showAuthContainer();
                    hideAppContainer();
                }
            });
        });

        // å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ©Ÿèƒ½
        function showPhotoModal(photoUrl) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            let modal = document.getElementById('photo-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'photo-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.9);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    cursor: pointer;
                `;
                
                const img = document.createElement('img');
                img.id = 'photo-modal-img';
                img.style.cssText = `
                    max-width: 90vw;
                    max-height: 90vh;
                    object-fit: contain;
                    border-radius: 10px;
                `;
                
                modal.appendChild(img);
                document.body.appendChild(modal);
                
                // ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                modal.addEventListener('click', hidePhotoModal);
            }
            
            // å†™çœŸã‚’è¨­å®šã—ã¦è¡¨ç¤º
            document.getElementById('photo-modal-img').src = photoUrl;
            modal.style.display = 'flex';
        }
        
        // å†™çœŸãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hidePhotoModal() {
            const modal = document.getElementById('photo-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ã‚‚å®Ÿè¡Œ
        cleanupOldPhotos();

        // åºƒå‘Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        class AdManager {
            constructor() {
                this.adProviders = ['google-adsense', 'facebook-ads', 'amazon-ads'];
                this.currentProvider = 0;
                this.adRefreshInterval = 30000; // 30ç§’
                this.init();
            }

            init() {
                this.loadAd();
                // å®šæœŸçš„ãªåºƒå‘Šæ›´æ–°
                setInterval(() => this.loadAd(), this.adRefreshInterval);
            }

            async loadAd() {
                const adBanner = document.getElementById('ad-banner');
                const adContent = document.getElementById('ad-content');
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
                adBanner.classList.add('loading');
                adContent.innerHTML = 'åºƒå‘Šã‚’èª­ã¿è¾¼ã¿ä¸­...';

                // å®Ÿéš›ã®åºƒå‘Šãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æ¥ç¶šã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                setTimeout(() => {
                    this.displayPlaceholderAd();
                    adBanner.classList.remove('loading');
                }, 1000);
            }

            displayPlaceholderAd() {
                const adContent = document.getElementById('ad-content');
                const ads = [
                    'ğŸ¥ å¥åº·ç®¡ç†ã‚¢ãƒ—ãƒª - 30% OFF!',
                    'ğŸ’Š è–¬å±€é…é€ã‚µãƒ¼ãƒ“ã‚¹ - é€æ–™ç„¡æ–™',
                    'ğŸ©º ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¨ºç™‚ - åˆå›ç„¡æ–™ç›¸è«‡',
                    'ğŸ“± å¥åº·ã‚°ãƒƒã‚ºç‰¹é›† - æœŸé–“é™å®šå‰²å¼•'
                ];
                
                const randomAd = ads[Math.floor(Math.random() * ads.length)];
                adContent.innerHTML = `<a href="#" style="text-decoration: none; color: inherit;">${randomAd}</a>`;
            }

            // å°†æ¥çš„ãªGoogle AdSenseçµ±åˆç”¨ãƒ¡ã‚½ãƒƒãƒ‰
            initGoogleAdsense() {
                // Google AdSenseã®åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰
                // (adsbygoogle = window.adsbygoogle || []).push({});
            }

            // åºƒå‘Šã‚¯ãƒªãƒƒã‚¯è¿½è·¡
            trackAdClick(adId, provider) {
                console.log(`Ad clicked: ${adId} from ${provider}`);
                // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã«é€ä¿¡
            }
        }

        // åºƒå‘Šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
        const adManager = new AdManager();

        // Firebase OAuthèªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
        class OAuthManager {
            constructor() {
                // Firebaseè¨­å®š
                this.firebaseConfig = {
                    apiKey: "AIzaSyD6_2ioXr3LJU7PpThy7kxXbCfEFatUi_U",
                    authDomain: "medication-tracker-b5d0c.firebaseapp.com",
                    projectId: "medication-tracker-b5d0c",
                    storageBucket: "medication-tracker-b5d0c.firebasestorage.app",
                    messagingSenderId: "112454739779",
                    appId: "1:112454739779:web:225df0ffd166882c1931f6",
                    measurementId: "G-0LPF5Y8NPR"
                };
                
                // Apple Developer Program ã§è¨­å®šã—ãŸ Service ID
                this.appleClientId = 'com.medicationtracker.signin';
                
                this.init();
            }

            async init() {
                // Firebase SDK ã®åˆæœŸåŒ–
                await this.loadFirebaseSDK();
                // Apple Sign-In API ã®åˆæœŸåŒ–
                await this.loadAppleAPI();
            }

            async loadFirebaseSDK() {
                return new Promise((resolve) => {
                    // Firebase SDK ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
                    if (window.firebase) {
                        resolve();
                        return;
                    }
                    
                    // Firebase v9 SDK (ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ç‰ˆ) ã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿
                    const script = document.createElement('script');
                    script.type = 'module';
                    script.innerHTML = `
                        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
                        import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
                        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
                        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';
                        import { getAnalytics, logEvent, setUserId, setUserProperties } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js';
                        
                        // FirebaseåˆæœŸåŒ–
                        const firebaseConfig = ${JSON.stringify(this.firebaseConfig)};
                        window.firebaseApp = initializeApp(firebaseConfig);
                        window.firebaseAuth = getAuth(window.firebaseApp);
                        window.firebaseDb = getFirestore(window.firebaseApp);
                        window.firebaseStorage = getStorage(window.firebaseApp);
                        window.firebaseAnalytics = getAnalytics(window.firebaseApp);
                        
                        // Firebase Auth
                        window.GoogleAuthProvider = GoogleAuthProvider;
                        window.signInWithPopup = signInWithPopup;
                        
                        // Firebase Firestore
                        window.firestoreDoc = doc;
                        window.firestoreSetDoc = setDoc;
                        window.firestoreGetDoc = getDoc;
                        window.firestoreCollection = collection;
                        window.firestoreAddDoc = addDoc;
                        window.firestoreQuery = query;
                        window.firestoreWhere = where;
                        window.firestoreGetDocs = getDocs;
                        window.firestoreOnSnapshot = onSnapshot;
                        window.firestoreServerTimestamp = serverTimestamp;
                        
                        // Firebase Storage
                        window.firebaseStorageRef = ref;
                        window.firebaseUploadBytes = uploadBytes;
                        window.firebaseGetDownloadURL = getDownloadURL;
                        window.firebaseDeleteObject = deleteObject;
                        
                        // Firebase Analytics
                        window.firebaseLogEvent = logEvent;
                        window.firebaseSetUserId = setUserId;
                        window.firebaseSetUserProperties = setUserProperties;
                        
                        console.log('Firebase SDK (Auth + Firestore + Storage + Analytics) åˆæœŸåŒ–å®Œäº†');
                        window.firebaseReady = true;
                    `;
                    
                    document.head.appendChild(script);
                    
                    // åˆæœŸåŒ–å®Œäº†ã‚’å¾…æ©Ÿ
                    const checkReady = () => {
                        if (window.firebaseReady) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });
            }

            async loadAppleAPI() {
                return new Promise((resolve) => {
                    // Apple Sign-In API ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
                    if (window.AppleID) {
                        resolve();
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = 'https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/ja_JP/appleid.auth.js';
                    script.onload = () => {
                        if (window.AppleID) {
                            try {
                                window.AppleID.auth.init({
                                    clientId: this.appleClientId,
                                    scope: 'name email',
                                    redirectURI: window.location.origin,
                                    state: 'signin',
                                    usePopup: true
                                });
                                console.log('Apple Sign-In APIåˆæœŸåŒ–å®Œäº†');
                            } catch (error) {
                                console.error('Apple Sign-In APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                            }
                        }
                        resolve();
                    };
                    script.onerror = () => {
                        console.error('Apple Sign-In APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        resolve();
                    };
                    document.head.appendChild(script);
                });
            }

            async signInWithGoogle() {
                try {
                    if (!window.firebaseReady || !window.firebaseAuth) {
                        throw new Error('Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    // Firebase Googleèªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆ
                    const provider = new window.GoogleAuthProvider();
                    
                    // Firebaseèªè¨¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚µã‚¤ãƒ³ã‚¤ãƒ³
                    const result = await window.signInWithPopup(window.firebaseAuth, provider);
                    
                    // èªè¨¼æˆåŠŸæ™‚ã®å‡¦ç†
                    const user = result.user;
                    const userData = {
                        id: user.uid,
                        email: user.email,
                        name: user.displayName,
                        picture: user.photoURL,
                        provider: 'google'
                    };
                    
                    this.processOAuthSignIn(userData);
                    
                } catch (error) {
                    console.error('Firebase Google Sign-In ã‚¨ãƒ©ãƒ¼:', error);
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                    } else if (error.code === 'auth/popup-blocked') {
                        alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                    } else {
                        alert('Googleèªè¨¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    }
                }
            }


            async signInWithApple() {
                try {
                    if (!window.AppleID) {
                        throw new Error('Apple Sign-In APIãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    const data = await window.AppleID.auth.signIn();
                    this.handleAppleSignIn(data);
                } catch (error) {
                    console.error('Apple Sign-In ã‚¨ãƒ©ãƒ¼:', error);
                    
                    // Apple Sign In ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®å‡¦ç†
                    if (error.error === 'popup_closed_by_user') {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒApple Sign-Inã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                    } else {
                        alert('Apple Sign-InãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\n\nApple Developer Programã§ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚');
                    }
                }
            }


            handleAppleSignIn(response) {
                try {
                    const userData = {
                        id: response.user,
                        email: response.email,
                        name: response.fullName ? `${response.fullName.givenName} ${response.fullName.familyName}` : '',
                        provider: 'apple'
                    };
                    
                    this.processOAuthSignIn(userData);
                } catch (error) {
                    console.error('Apple Sign-In ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            processOAuthSignIn(userData) {
                try {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    const existingUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];
                    
                    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                    let user = existingUsers.find(u => u.email === userData.email);
                    
                    if (!user) {
                        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ç™»éŒ²
                        user = {
                            ...userData,
                            registeredAt: new Date().toISOString(),
                            isOAuthUser: true
                        };
                        existingUsers.push(user);
                        localStorage.setItem('registeredUsers', JSON.stringify(existingUsers));
                    } else {
                        // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’æ›´æ–°
                        user.lastLoginAt = new Date().toISOString();
                        user.provider = userData.provider;
                        if (userData.picture) user.picture = userData.picture;
                        
                        const userIndex = existingUsers.findIndex(u => u.email === userData.email);
                        existingUsers[userIndex] = user;
                        localStorage.setItem('registeredUsers', JSON.stringify(existingUsers));
                    }
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¨­å®š
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    // æˆåŠŸé€šçŸ¥ã‚’è¡¨ç¤º
                    this.showSignInSuccess(userData.provider === 'google' ? 'Google' : 'Apple', userData);
                    
                    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã«é·ç§»
                    setTimeout(() => {
                        this.showMainApp();
                    }, 1000);
                } catch (error) {
                    console.error('OAuth ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            }

            showMainApp() {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                showPage('medications');
            }

            // ã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸæ™‚ã®å‡¦ç†
            showSignInSuccess(provider, userData) {
                // ã‚µã‚¤ãƒ³ã‚¤ãƒ³å®Œäº†é€šçŸ¥
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                notification.textContent = `${provider}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 3000);
            }
        }

        // OAuthèªè¨¼é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
        let oauthManager;

        function signInWithGoogle() {
            if (!oauthManager) {
                oauthManager = new OAuthManager();
            }
            oauthManager.signInWithGoogle();
        }

        function signInWithApple() {
            if (!oauthManager) {
                oauthManager = new OAuthManager();
            }
            oauthManager.signInWithApple();
        }

        // OAuth ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            oauthManager = new OAuthManager();
        });

        // Firebase Firestore ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚·ã‚¹ãƒ†ãƒ 
        class CloudSyncManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.syncQueue = [];
                this.lastSyncTime = localStorage.getItem('lastSyncTime') || '0';
                this.init();
            }

            async init() {
                // Firebaseæº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ
                await this.waitForFirebase();
                this.setupEventListeners();
                
                // èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                this.setupAuthListener();
                
                // è‡ªå‹•åŒæœŸã®è¨­å®š
                setInterval(() => this.autoSync(), 60000); // 1åˆ†ã”ã¨
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseReady && window.firebaseDb) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }

            setupAuthListener() {
                // Firebase AuthçŠ¶æ…‹å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
                if (window.firebaseAuth) {
                    window.firebaseAuth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log('Firebaseèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.uid);
                            this.startRealTimeSync(user.uid);
                        } else {
                            console.log('Firebaseèªè¨¼ãªã— - ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿');
                        }
                    });
                }
            }

            startRealTimeSync(userId) {
                // è–¬ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
                this.syncMedications(userId);
                // æœç”¨å±¥æ­´ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
                this.syncMedicationHistory(userId);
                // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
                this.syncSettings(userId);
            }

            // è–¬ãƒ‡ãƒ¼ã‚¿ã®FirestoreåŒæœŸ
            async syncMedications(userId) {
                try {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const localMedications = JSON.parse(localStorage.getItem('medications')) || [];
                    
                    // Firestore ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const medicationsRef = window.firestoreCollection(window.firebaseDb, `users/${userId}/medications`);
                    const snapshot = await window.firestoreGetDocs(medicationsRef);
                    
                    const cloudMedications = [];
                    snapshot.forEach((doc) => {
                        cloudMedications.push({ id: doc.id, ...doc.data() });
                    });

                    // ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸å‡¦ç†
                    const mergedMedications = this.mergeMedicationData(localMedications, cloudMedications);
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
                    localStorage.setItem('medications', JSON.stringify(mergedMedications));
                    
                    // Firestoreã«åŒæœŸ
                    for (const medication of mergedMedications) {
                        const docRef = window.firestoreDoc(window.firebaseDb, `users/${userId}/medications`, medication.id);
                        await window.firestoreSetDoc(docRef, {
                            ...medication,
                            lastModified: window.firestoreServerTimestamp()
                        });
                    }

                    // å†™çœŸã‚‚åŒæœŸ
                    await this.syncMedicationPhotos(userId, mergedMedications);

                    console.log('è–¬ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†:', mergedMedications.length + 'ä»¶');
                    this.showSyncStatus('è–¬ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†', 'success');
                    
                    // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: åŒæœŸæˆåŠŸè¿½è·¡
                    if (window.analyticsManager) {
                        window.analyticsManager.trackSyncEvent('medications', true);
                    }

                } catch (error) {
                    console.error('è–¬ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    this.showSyncStatus('è–¬ãƒ‡ãƒ¼ã‚¿åŒæœŸå¤±æ•—', 'error');
                    
                    // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹: åŒæœŸå¤±æ•—è¿½è·¡
                    if (window.analyticsManager) {
                        window.analyticsManager.trackSyncEvent('medications', false, error.message);
                    }
                }
            }

            mergeMedicationData(localData, cloudData) {
                const merged = [...localData];
                
                // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
                cloudData.forEach(cloudItem => {
                    const existingIndex = merged.findIndex(item => item.id === cloudItem.id);
                    if (existingIndex >= 0) {
                        // æ›´æ–°æ—¥æ™‚ã§åˆ¤æ–­
                        const localTime = new Date(merged[existingIndex].lastModified || 0);
                        const cloudTime = new Date(cloudItem.lastModified?.seconds * 1000 || 0);
                        
                        if (cloudTime > localTime) {
                            merged[existingIndex] = cloudItem;
                        }
                    } else {
                        // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
                        merged.push(cloudItem);
                    }
                });

                return merged;
            }

            // æœç”¨å±¥æ­´ã®FirestoreåŒæœŸ
            async syncMedicationHistory(userId) {
                try {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const localHistory = JSON.parse(localStorage.getItem('medicationHistory')) || [];
                    
                    // Firestore ã‹ã‚‰æœ€æ–°å±¥æ­´ã‚’å–å¾—
                    const historyRef = window.firestoreCollection(window.firebaseDb, `users/${userId}/history`);
                    const snapshot = await window.firestoreGetDocs(historyRef);
                    
                    const cloudHistory = [];
                    snapshot.forEach((doc) => {
                        cloudHistory.push({ id: doc.id, ...doc.data() });
                    });

                    // ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸å‡¦ç†
                    const mergedHistory = this.mergeHistoryData(localHistory, cloudHistory);
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
                    localStorage.setItem('medicationHistory', JSON.stringify(mergedHistory));
                    
                    // Firestoreã«åŒæœŸï¼ˆæ–°ã—ã„è¨˜éŒ²ã®ã¿ï¼‰
                    for (const record of mergedHistory) {
                        if (!record.synced) {
                            const docRef = window.firestoreDoc(window.firebaseDb, `users/${userId}/history`, record.id);
                            await window.firestoreSetDoc(docRef, {
                                ...record,
                                synced: true,
                                lastModified: window.firestoreServerTimestamp()
                            });
                        }
                    }

                    // å†™çœŸã‚‚åŒæœŸ
                    await this.syncHistoryPhotos(userId, mergedHistory);

                    console.log('æœç”¨å±¥æ­´åŒæœŸå®Œäº†:', mergedHistory.length + 'ä»¶');
                    this.showSyncStatus('æœç”¨å±¥æ­´åŒæœŸå®Œäº†', 'success');

                } catch (error) {
                    console.error('æœç”¨å±¥æ­´åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    this.showSyncStatus('æœç”¨å±¥æ­´åŒæœŸå¤±æ•—', 'error');
                }
            }

            mergeHistoryData(localData, cloudData) {
                const merged = [...localData];
                
                // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
                cloudData.forEach(cloudItem => {
                    const exists = merged.find(item => item.id === cloudItem.id);
                    if (!exists) {
                        merged.push(cloudItem);
                    }
                });

                // é‡è¤‡ã‚’é™¤å»ã—ã€æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆ
                return merged
                    .filter((item, index, self) => 
                        index === self.findIndex(t => t.id === item.id)
                    )
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            // è¨­å®šãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
            async syncSettings(userId) {
                try {
                    const settings = {
                        mealTimeSettings: localStorage.getItem('mealTimeSettings'),
                        userSettings: localStorage.getItem('userSettings')
                    };

                    const settingsRef = window.firestoreDoc(window.firebaseDb, `users/${userId}/settings`, 'userSettings');
                    await window.firestoreSetDoc(settingsRef, {
                        ...settings,
                        lastModified: window.firestoreServerTimestamp()
                    });

                    console.log('è¨­å®šãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†');

                } catch (error) {
                    console.error('è¨­å®šãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            setupEventListeners() {
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncPendingData();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });

                // ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã®ç›£è¦–
                this.setupDataChangeListeners();
            }

            setupDataChangeListeners() {
                // LocalStorageã®å¤‰æ›´ã‚’ç›£è¦–
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = (key, value) => {
                    originalSetItem.call(localStorage, key, value);
                    this.queueForSync(key, value);
                };
            }

            queueForSync(key, value) {
                // åŒæœŸå¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‹ãƒã‚§ãƒƒã‚¯
                const syncableKeys = ['medications', 'medicationHistory', 'userSettings', 'mealTimeSettings'];
                
                if (syncableKeys.includes(key)) {
                    this.syncQueue.push({
                        key,
                        value,
                        timestamp: Date.now(),
                        action: 'update'
                    });

                    if (this.isOnline) {
                        this.syncPendingData();
                    }
                }
            }

            async syncPendingData() {
                if (this.syncQueue.length === 0) return;

                try {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    if (!currentUser) return;

                    // ãƒãƒƒãƒã§ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
                    const batchData = {};
                    this.syncQueue.forEach(item => {
                        batchData[item.key] = {
                            data: item.value,
                            timestamp: item.timestamp
                        };
                    });

                    await this.uploadToCloud(currentUser.id, batchData);
                    
                    // åŒæœŸå®Œäº†å¾Œã€ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                    this.syncQueue = [];
                    this.lastSyncTime = Date.now().toString();
                    localStorage.setItem('lastSyncTime', this.lastSyncTime);

                    this.showSyncStatus('åŒæœŸå®Œäº†', 'success');
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    this.showSyncStatus('åŒæœŸå¤±æ•—', 'error');
                }
            }

            // æ‰‹å‹•åŒæœŸæ©Ÿèƒ½
            async manualSync() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                    return;
                }

                try {
                    this.showSyncStatus('æ‰‹å‹•åŒæœŸé–‹å§‹...', 'info');
                    
                    await this.syncMedications(currentUser.id);
                    await this.syncMedicationHistory(currentUser.id);
                    await this.syncSettings(currentUser.id);
                    
                    this.showSyncStatus('æ‰‹å‹•åŒæœŸå®Œäº†', 'success');
                    
                    // UIæ›´æ–°
                    setTimeout(() => {
                        if (typeof loadMedications === 'function') loadMedications();
                        if (typeof loadHistory === 'function') loadHistory();
                    }, 1000);
                    
                } catch (error) {
                    console.error('æ‰‹å‹•åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    this.showSyncStatus('æ‰‹å‹•åŒæœŸå¤±æ•—', 'error');
                }
            }

            async restoreFromCloud() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) return false;

                try {
                    const cloudData = await this.downloadFromCloud(currentUser.id);
                    
                    if (cloudData) {
                        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æ¯”è¼ƒãƒ»ãƒãƒ¼ã‚¸
                        Object.keys(cloudData).forEach(key => {
                            const localTimestamp = localStorage.getItem(`${key}_timestamp`) || '0';
                            const cloudTimestamp = cloudData[key].timestamp || 0;
                            
                            // ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãŒæ–°ã—ã„å ´åˆã¯å¾©å…ƒ
                            if (cloudTimestamp > parseInt(localTimestamp)) {
                                localStorage.setItem(key, cloudData[key].data);
                                localStorage.setItem(`${key}_timestamp`, cloudTimestamp.toString());
                            }
                        });

                        this.showSyncStatus('ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå®Œäº†', 'success');
                        return true;
                    }
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                    this.showSyncStatus('ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå¤±æ•—', 'error');
                }
                
                return false;
            }

            async autoSync() {
                if (!this.isOnline) return;
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) return;

                // å®šæœŸçš„ãªåŒæ–¹å‘åŒæœŸ
                await this.syncPendingData();
                await this.downloadFromCloud(currentUser.id);
            }

            showSyncStatus(message, type) {
                const statusDiv = document.createElement('div');
                statusDiv.className = `sync-status ${type}`;
                statusDiv.textContent = message;
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 10px 15px;
                    border-radius: 5px;
                    color: white;
                    font-size: 14px;
                    z-index: 1000;
                    ${type === 'success' ? 'background-color: #4CAF50;' : 'background-color: #f44336;'}
                `;

                document.body.appendChild(statusDiv);

                setTimeout(() => {
                    document.body.removeChild(statusDiv);
                }, 3000);
            }

            // å†™çœŸã‚’Firebase Cloud Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            async uploadPhoto(userId, photoDataUrl, photoId) {
                try {
                    if (!window.firebaseStorage) {
                        throw new Error('Firebase Storage not initialized');
                    }

                    // Base64ãƒ‡ãƒ¼ã‚¿ã‚’Blobã«å¤‰æ›
                    const response = await fetch(photoDataUrl);
                    const blob = await response.blob();

                    // Firebase Storageã®å‚ç…§ã‚’ä½œæˆ
                    const photoRef = window.firebaseStorageRef(window.firebaseStorage, `users/${userId}/photos/${photoId}.jpg`);

                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                    const snapshot = await window.firebaseUploadBytes(photoRef, blob);
                    
                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—
                    const downloadURL = await window.firebaseGetDownloadURL(snapshot.ref);
                    
                    console.log('å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†:', photoId);
                    return downloadURL;

                } catch (error) {
                    console.error('å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            // Firebase Cloud Storageã‹ã‚‰å†™çœŸã‚’å–å¾—
            async downloadPhoto(userId, photoId) {
                try {
                    if (!window.firebaseStorage) {
                        throw new Error('Firebase Storage not initialized');
                    }

                    const photoRef = window.firebaseStorageRef(window.firebaseStorage, `users/${userId}/photos/${photoId}.jpg`);
                    const downloadURL = await window.firebaseGetDownloadURL(photoRef);
                    
                    // URLã‹ã‚‰ç”»åƒã‚’Blobã§å–å¾—ã—ã¦Base64ã«å¤‰æ›
                    const response = await fetch(downloadURL);
                    const blob = await response.blob();
                    
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });

                } catch (error) {
                    console.error('å†™çœŸãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }

            // Firebase Cloud Storageã‹ã‚‰å†™çœŸã‚’å‰Šé™¤
            async deletePhoto(userId, photoId) {
                try {
                    if (!window.firebaseStorage) {
                        throw new Error('Firebase Storage not initialized');
                    }

                    const photoRef = window.firebaseStorageRef(window.firebaseStorage, `users/${userId}/photos/${photoId}.jpg`);
                    await window.firebaseDeleteObject(photoRef);
                    
                    console.log('å†™çœŸå‰Šé™¤å®Œäº†:', photoId);
                    return true;

                } catch (error) {
                    console.error('å†™çœŸå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            }

            // è–¬ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸæ™‚ã«å†™çœŸã‚‚åŒæœŸ
            async syncMedicationPhotos(userId, medications) {
                try {
                    for (const medication of medications) {
                        if (medication.photo && medication.photo.startsWith('data:')) {
                            // ãƒ­ãƒ¼ã‚«ãƒ«ã®Base64å†™çœŸã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                            const photoId = medication.id + '_' + Date.now();
                            const cloudURL = await this.uploadPhoto(userId, medication.photo, photoId);
                            
                            // è–¬ãƒ‡ãƒ¼ã‚¿ã®å†™çœŸURLã‚’æ›´æ–°
                            medication.photo = cloudURL;
                            medication.photoId = photoId;
                            
                            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°
                            const localMedications = JSON.parse(localStorage.getItem('medications') || '[]');
                            const localIndex = localMedications.findIndex(m => m.id === medication.id);
                            if (localIndex >= 0) {
                                localMedications[localIndex] = medication;
                                localStorage.setItem('medications', JSON.stringify(localMedications));
                            }
                        }
                    }
                    
                    this.showSyncStatus('å†™çœŸåŒæœŸå®Œäº†', 'success');
                    
                } catch (error) {
                    console.error('å†™çœŸåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    this.showSyncStatus('å†™çœŸåŒæœŸå¤±æ•—', 'error');
                }
            }

            // æœç”¨å±¥æ­´ã®å†™çœŸã‚‚åŒæœŸ
            async syncHistoryPhotos(userId, history) {
                try {
                    for (const record of history) {
                        if (record.photo && record.photo.startsWith('data:')) {
                            // ãƒ­ãƒ¼ã‚«ãƒ«ã®Base64å†™çœŸã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                            const photoId = record.id + '_photo_' + Date.now();
                            const cloudURL = await this.uploadPhoto(userId, record.photo, photoId);
                            
                            // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å†™çœŸURLã‚’æ›´æ–°
                            record.photo = cloudURL;
                            record.photoId = photoId;
                            
                            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°
                            const localHistory = JSON.parse(localStorage.getItem('medicationHistory') || '[]');
                            const localIndex = localHistory.findIndex(h => h.id === record.id);
                            if (localIndex >= 0) {
                                localHistory[localIndex] = record;
                                localStorage.setItem('medicationHistory', JSON.stringify(localHistory));
                            }
                        }
                    }
                    
                    console.log('å±¥æ­´å†™çœŸåŒæœŸå®Œäº†');
                    
                } catch (error) {
                    console.error('å±¥æ­´å†™çœŸåŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // æ‰‹å‹•åŒæœŸæ©Ÿèƒ½
            async manualSync() {
                this.showSyncStatus('åŒæœŸä¸­...', 'info');
                await this.syncPendingData();
                const restored = await this.restoreFromCloud();
                
                if (restored) {
                    // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 
                    location.reload();
                }
            }

            // ç«¯æœ«é–“ã§ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
            async migrateToNewDevice() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
                    return;
                }

                try {
                    const restored = await this.restoreFromCloud();
                    if (restored) {
                        alert('ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ');
                        location.reload();
                    } else {
                        alert('ç§»è¡Œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                } catch (error) {
                    alert('ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            }
        }

        // Firebase Analytics ä½¿ç”¨çŠ¶æ³åˆ†æã‚·ã‚¹ãƒ†ãƒ 
        class AnalyticsManager {
            constructor() {
                this.sessionStartTime = Date.now();
                this.isInitialized = false;
                this.init();
            }

            async init() {
                // Firebaseæº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ
                await this.waitForFirebase();
                this.setupEventListeners();
                this.isInitialized = true;
                
                // åˆæœŸåŒ–å®Œäº†ã‚’ãƒ­ã‚°
                this.logEvent('app_initialized', {
                    timestamp: new Date().toISOString(),
                    user_agent: navigator.userAgent,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    viewport_size: `${window.innerWidth}x${window.innerHeight}`
                });

                console.log('Analytics Manager åˆæœŸåŒ–å®Œäº†');
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseReady && window.firebaseAnalytics) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }

            setupEventListeners() {
                // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“è¨˜éŒ²
                window.addEventListener('beforeunload', () => {
                    const sessionDuration = Date.now() - this.sessionStartTime;
                    this.logEvent('session_end', {
                        session_duration: Math.round(sessionDuration / 1000)
                    });
                });

                // ã‚¨ãƒ©ãƒ¼è¿½è·¡
                window.addEventListener('error', (event) => {
                    this.logEvent('javascript_error', {
                        error_message: event.message,
                        error_filename: event.filename,
                        error_lineno: event.lineno,
                        error_colno: event.colno
                    });
                });

                // æœªå‡¦ç†ã® Promise ãƒªã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è¿½è·¡
                window.addEventListener('unhandledrejection', (event) => {
                    this.logEvent('unhandled_promise_rejection', {
                        reason: event.reason?.toString() || 'Unknown reason'
                    });
                });
            }

            // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°
            logEvent(eventName, parameters = {}) {
                if (!this.isInitialized || !window.firebaseAnalytics) {
                    console.log('Analytics not ready:', eventName, parameters);
                    return;
                }

                try {
                    // å…±é€šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                    const enrichedParams = {
                        ...parameters,
                        timestamp: new Date().toISOString(),
                        page_url: window.location.href,
                        user_logged_in: !!localStorage.getItem('currentUser')
                    };

                    window.firebaseLogEvent(window.firebaseAnalytics, eventName, enrichedParams);
                    console.log('Analytics Event:', eventName, enrichedParams);
                } catch (error) {
                    console.error('Analytics logging error:', error);
                }
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã®åˆ†æè¨­å®š
            setUser(userId, userProperties = {}) {
                if (!this.isInitialized || !window.firebaseAnalytics) return;

                try {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¨­å®š
                    window.firebaseSetUserId(window.firebaseAnalytics, userId);
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®š
                    const defaultProperties = {
                        user_registration_date: new Date().toISOString(),
                        app_version: '2.1',
                        platform: navigator.platform
                    };

                    window.firebaseSetUserProperties(window.firebaseAnalytics, {
                        ...defaultProperties,
                        ...userProperties
                    });

                    this.logEvent('user_login', {
                        user_id: userId,
                        login_method: 'oauth'
                    });

                } catch (error) {
                    console.error('User analytics setup error:', error);
                }
            }

            // è–¬é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆè¿½è·¡
            trackMedicationEvent(action, medicationData = {}) {
                const eventParams = {
                    medication_action: action,
                    medication_count: parseInt(medicationData.totalCount) || 0,
                    medication_category: medicationData.purpose || 'unknown'
                };

                this.logEvent('medication_interaction', eventParams);
            }

            // æœç”¨è¨˜éŒ²ã®è¿½è·¡
            trackMedicationTaken(medicationId, medicationName) {
                this.logEvent('medication_taken', {
                    medication_id: medicationId,
                    medication_name: medicationName,
                    taken_at: new Date().toISOString()
                });
            }

            // ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã®ä½¿ç”¨è¿½è·¡
            trackCameraUsage(action) {
                this.logEvent('camera_usage', {
                    camera_action: action,
                    feature: 'medication_verification'
                });
            }

            // ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¿½è·¡
            trackPageView(pageName) {
                this.logEvent('page_view', {
                    page_name: pageName,
                    previous_page: this.currentPage || 'unknown'
                });
                this.currentPage = pageName;
            }

            // ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¤ãƒ™ãƒ³ãƒˆè¿½è·¡
            trackSyncEvent(syncType, success, errorMessage = null) {
                this.logEvent('data_sync', {
                    sync_type: syncType,
                    sync_success: success,
                    sync_error: errorMessage
                });
            }

            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã®è¿½è·¡
            trackPerformance(metricName, value, unit = 'ms') {
                this.logEvent('performance_metric', {
                    metric_name: metricName,
                    metric_value: value,
                    metric_unit: unit
                });
            }

            // æ©Ÿèƒ½ä½¿ç”¨é »åº¦ã®è¿½è·¡
            trackFeatureUsage(featureName, action = 'used') {
                this.logEvent('feature_usage', {
                    feature_name: featureName,
                    feature_action: action
                });
            }

            // ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæŒ‡æ¨™
            trackEngagement(engagementType, value = 1) {
                this.logEvent('user_engagement', {
                    engagement_type: engagementType,
                    engagement_value: value
                });
            }
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ 
        class PerformanceManager {
            constructor() {
                this.imageCache = new Map();
                this.dataCache = new Map();
                this.compressionWorker = null;
                this.performanceObserver = null;
                this.init();
            }

            init() {
                this.setupImageOptimization();
                this.setupCaching();
                this.setupPerformanceMonitoring();
                this.setupLazyLoading();
                console.log('Performance Manager åˆæœŸåŒ–å®Œäº†');
            }

            // é«˜åº¦ãªç”»åƒåœ§ç¸®æœ€é©åŒ–
            setupImageOptimization() {
                // WebPå¯¾å¿œãƒã‚§ãƒƒã‚¯
                this.supportsWebP = this.checkWebPSupport();
                
                // åœ§ç¸®è¨­å®šã®æœ€é©åŒ–
                this.compressionSettings = {
                    medication: { maxWidth: 400, quality: 0.8, format: 'jpeg' },
                    history: { maxWidth: 300, quality: 0.7, format: 'jpeg' },
                    thumbnail: { maxWidth: 150, quality: 0.6, format: 'jpeg' }
                };
            }

            checkWebPSupport() {
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                return canvas.toDataURL('image/webp').startsWith('data:image/webp');
            }

            // æœ€é©åŒ–ã•ã‚ŒãŸç”»åƒåœ§ç¸®
            async optimizedCompressImage(dataUrl, type = 'medication', options = {}) {
                const startTime = performance.now();
                
                try {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
                    const cacheKey = `${dataUrl.substring(0, 50)}_${type}`;
                    if (this.imageCache.has(cacheKey)) {
                        const endTime = performance.now();
                        this.trackPerformance('image_compression_cached', endTime - startTime);
                        return this.imageCache.get(cacheKey);
                    }

                    const settings = { ...this.compressionSettings[type], ...options };
                    
                    // WebPä½¿ç”¨å¯èƒ½ãªå ´åˆã¯WebPå½¢å¼ã§åœ§ç¸®
                    if (this.supportsWebP && settings.format === 'jpeg') {
                        settings.format = 'webp';
                        settings.quality += 0.1; // WebPã®å ´åˆå“è³ªã‚’å°‘ã—ä¸Šã’ã‚‹
                    }

                    const compressedImage = await this.compressImageAdvanced(dataUrl, settings);
                    
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆæœ€å¤§50ä»¶ï¼‰
                    if (this.imageCache.size >= 50) {
                        const firstKey = this.imageCache.keys().next().value;
                        this.imageCache.delete(firstKey);
                    }
                    this.imageCache.set(cacheKey, compressedImage);

                    const endTime = performance.now();
                    this.trackPerformance('image_compression', endTime - startTime);
                    
                    return compressedImage;
                } catch (error) {
                    console.error('ç”»åƒåœ§ç¸®ã‚¨ãƒ©ãƒ¼:', error);
                    this.trackPerformance('image_compression_error', performance.now() - startTime);
                    return dataUrl; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒç”»åƒã‚’è¿”ã™
                }
            }

            async compressImageAdvanced(dataUrl, settings) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
                        let { width, height } = this.calculateOptimalSize(
                            img.width, img.height, settings.maxWidth
                        );
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // é«˜å“è³ªãƒªã‚µã‚¤ã‚ºè¨­å®š
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // ç”»åƒæç”»
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // åœ§ç¸®å½¢å¼ã«å¿œã˜ã¦å‡ºåŠ›
                        const mimeType = settings.format === 'webp' ? 'image/webp' : 'image/jpeg';
                        const compressed = canvas.toDataURL(mimeType, settings.quality);
                        
                        resolve(compressed);
                    };
                    img.src = dataUrl;
                });
            }

            calculateOptimalSize(originalWidth, originalHeight, maxWidth) {
                if (originalWidth <= maxWidth) {
                    return { width: originalWidth, height: originalHeight };
                }
                
                const ratio = maxWidth / originalWidth;
                return {
                    width: Math.round(originalWidth * ratio),
                    height: Math.round(originalHeight * ratio)
                };
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥
            setupCaching() {
                // LocalStorageæœ€é©åŒ–
                this.optimizeLocalStorage();
                
                // Memory cache for frequently accessed data
                setInterval(() => {
                    this.cleanupCache();
                }, 300000); // 5åˆ†ã”ã¨
            }

            optimizeLocalStorage() {
                try {
                    // LocalStorageã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
                    const usage = this.getLocalStorageUsage();
                    console.log('LocalStorageä½¿ç”¨é‡:', usage);
                    
                    if (usage.percentage > 80) {
                        this.cleanupOldData();
                    }
                } catch (error) {
                    console.error('LocalStorageæœ€é©åŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            getLocalStorageUsage() {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length;
                    }
                }
                
                const quota = 5 * 1024 * 1024; // 5MBæ¦‚ç®—
                return {
                    used: total,
                    quota: quota,
                    percentage: (total / quota) * 100
                };
            }

            cleanupOldData() {
                const history = JSON.parse(localStorage.getItem('medicationHistory') || '[]');
                const cutoffDate = new Date();
                cutoffDate.setMonth(cutoffDate.getMonth() - 6); // 6ãƒ¶æœˆã‚ˆã‚Šå¤ã„ãƒ‡ãƒ¼ã‚¿
                
                const filteredHistory = history.filter(item => 
                    new Date(item.takenAt) > cutoffDate
                );
                
                if (filteredHistory.length < history.length) {
                    localStorage.setItem('medicationHistory', JSON.stringify(filteredHistory));
                    console.log(`å¤ã„å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’ ${history.length - filteredHistory.length} ä»¶å‰Šé™¤`);
                }
            }

            cleanupCache() {
                // ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                if (this.imageCache.size > 30) {
                    const entries = Array.from(this.imageCache.entries());
                    const toKeep = entries.slice(-20); // æœ€æ–°20ä»¶ã‚’ä¿æŒ
                    this.imageCache.clear();
                    toKeep.forEach(([key, value]) => {
                        this.imageCache.set(key, value);
                    });
                }
            }

            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
            setupPerformanceMonitoring() {
                // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚é–“æ¸¬å®š
                window.addEventListener('load', () => {
                    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                    this.trackPerformance('page_load_time', loadTime);
                });

                // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
                if ('memory' in performance) {
                    setInterval(() => {
                        const memoryInfo = performance.memory;
                        this.trackPerformance('memory_usage', {
                            used: memoryInfo.usedJSHeapSize,
                            total: memoryInfo.totalJSHeapSize,
                            limit: memoryInfo.jsHeapSizeLimit
                        });
                    }, 60000); // 1åˆ†ã”ã¨
                }
            }

            // é…å»¶èª­ã¿è¾¼ã¿
            setupLazyLoading() {
                // Intersection Observer for lazy loading
                if ('IntersectionObserver' in window) {
                    this.setupImageLazyLoading();
                }
            }

            setupImageLazyLoading() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                                observer.unobserve(img);
                            }
                        }
                    });
                }, { threshold: 0.1 });

                // æ—¢å­˜ã®ç”»åƒã«é©ç”¨
                document.querySelectorAll('img[data-src]').forEach(img => {
                    observer.observe(img);
                });
                
                this.imageObserver = observer;
            }

            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™è¨˜éŒ²
            trackPerformance(metricName, value) {
                if (window.analyticsManager) {
                    window.analyticsManager.trackPerformance(metricName, value);
                }
                console.log(`Performance: ${metricName}`, value);
            }

            // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // ã‚¹ãƒ­ãƒƒãƒˆãƒ«é–¢æ•°
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }
        }

        // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
        let cloudSyncManager;
        let analyticsManager;
        let performanceManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            cloudSyncManager = new CloudSyncManager();
            analyticsManager = new AnalyticsManager();
            performanceManager = new PerformanceManager();
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨
            window.analyticsManager = analyticsManager;
            window.performanceManager = performanceManager;
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        function manualSync() {
            if (cloudSyncManager) {
                cloudSyncManager.manualSync();
            }
        }

        function migrateData() {
            if (cloudSyncManager) {
                cloudSyncManager.migrateToNewDevice();
            }
        }

        // åŒæœŸçŠ¶æ…‹ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateSyncStatus() {
            const lastSyncElement = document.getElementById('last-sync-time');
            const onlineStatusElement = document.getElementById('online-status');
            
            if (lastSyncElement) {
                const lastSync = localStorage.getItem('lastSyncTime');
                if (lastSync && lastSync !== '0') {
                    const date = new Date(parseInt(lastSync));
                    lastSyncElement.textContent = date.toLocaleString('ja-JP');
                } else {
                    lastSyncElement.textContent = 'æœªåŒæœŸ';
                }
            }
            
            if (onlineStatusElement) {
                onlineStatusElement.textContent = navigator.onLine ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
                onlineStatusElement.style.color = navigator.onLine ? '#4CAF50' : '#f44336';
            }
        }

        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«åŒæœŸçŠ¶æ…‹ã‚’æ›´æ–°
        function showPage(pageId) {
            // æ—¢å­˜ã®showPageæ©Ÿèƒ½
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            const targetTab = document.querySelector(`[onclick="showPage('${pageId}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // è¨­å®šãƒšãƒ¼ã‚¸ã®å ´åˆã€åŒæœŸçŠ¶æ…‹ã¨OAuthçŠ¶æ…‹ã‚’æ›´æ–°
            if (pageId === 'settings') {
                setTimeout(() => {
                    updateSyncStatus();
                    updateOAuthStatus();
                }, 100);
            }
            
            // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®å‡¦ç†
            if (pageId === 'medications') {
                loadMedications();
            } else if (pageId === 'history') {
                loadHistory();
            } else if (pageId === 'home') {
                updateMedicationButtons();
            } else if (pageId === 'settings') {
                loadMealTimeSettings();
                updateCurrentUserEmail();
            }
        }

        // OAuthèªè¨¼çŠ¶æ³ã®æ›´æ–°
        function updateOAuthStatus() {
            const googleStatus = document.getElementById('google-oauth-status');
            const appleStatus = document.getElementById('apple-oauth-status');
            
            if (googleStatus) {
                const isFirebaseReady = window.firebaseReady && window.firebaseAuth;
                googleStatus.innerHTML = isFirebaseReady 
                    ? 'ğŸ” Firebase Google OAuth: <span style="color: #28a745;">åˆ©ç”¨å¯èƒ½</span>'
                    : 'ğŸ” Firebase Google OAuth: <span style="color: #6c757d;">èª­ã¿è¾¼ã¿ä¸­...</span>';
            }
            
            if (appleStatus) {
                const isAppleReady = window.AppleID && window.AppleID.auth;
                appleStatus.innerHTML = isAppleReady 
                    ? 'ğŸ Apple Sign In: <span style="color: #28a745;">åˆ©ç”¨å¯èƒ½</span>'
                    : 'ğŸ Apple Sign In: <span style="color: #ffc107;">èª­ã¿è¾¼ã¿ä¸­...</span>';
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«è¡¨ç¤ºã®æ›´æ–°
        function updateCurrentUserEmail() {
            const currentUserElement = document.getElementById('current-user-email');
            if (currentUserElement) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    currentUserElement.textContent = currentUser.email || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                } else {
                    currentUserElement.textContent = 'ã‚²ã‚¹ãƒˆ';
                }
            }
        }

        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
        window.addEventListener('online', updateSyncStatus);
        window.addEventListener('offline', updateSyncStatus);
    </script>
</body>
</html>