<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü - ÊúçËñ¨ÁÆ°ÁêÜ„Ç¢„Éó„É™ v2.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234CAF50'/%3E%3Ctext x='50' y='65' font-size='50' text-anchor='middle' fill='white'%3Eüíä%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f4f8;
            color: #2d3748;
            padding-bottom: 70px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .ad-banner {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px auto;
            max-width: 600px;
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .ad-banner.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
        }
        
        .tab.active {
            color: #667eea;
            font-weight: bold;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .medication-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .medication-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .medication-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .take-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .take-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .take-button.taken {
            background-color: #ddd;
            color: #666;
            cursor: not-allowed;
        }
        
        .skip-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
        }
        
        .skip-button:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
        
        .add-button {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .save-button {
            background-color: #4CAF50;
            color: white;
        }
        
        .cancel-button {
            background-color: #f44336;
            color: white;
        }
        
        .oauth-buttons {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .oauth-button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: white;
        }
        
        .oauth-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .google-signin {
            border-color: #db4437;
            color: #db4437;
        }
        
        .google-signin:hover {
            background-color: #db4437;
            color: white;
        }
        
        .apple-signin {
            border-color: #000;
            color: #000;
        }
        
        .apple-signin:hover {
            background-color: #000;
            color: white;
        }
        
        .oauth-divider {
            text-align: center;
            margin: 15px 0;
            color: #666;
            font-size: 14px;
        }
        
        .history-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-date {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-meds {
            color: #666;
            font-size: 14px;
        }
        
        .history-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
            cursor: pointer;
            border: 2px solid #ddd;
        }
        
        .history-photo:hover {
            border-color: #4CAF50;
        }
        
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .history-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .gallery-item {
            position: relative;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .gallery-item-info {
            padding: 10px;
            font-size: 12px;
        }
        
        .gallery-item-date {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .gallery-item-med {
            color: #666;
        }
        
        .stock-warning {
            background-color: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .camera-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            width: 100%;
        }
        
        .camera-modal .modal-content {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .camera-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .camera-video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-canvas {
            display: none;
        }
        
        .captured-image {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .camera-controls button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .capture-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .capture-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .retake-button {
            background-color: #e2e8f0;
            color: #4a5568;
        }
        
        .retake-button:hover {
            background-color: #cbd5e0;
        }
        
        .analysis-result {
            background: #edf2f7;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }
        
        .success-message {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .warning-message {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }
        
        .form-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .form-message.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .form-message.error {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }
        
        .form-message.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü</h1>
    </div>
    
    <!-- Â∫ÉÂëä„Éê„Éä„Éº -->
    <div class="ad-banner" id="ad-banner">
        <div id="ad-content">Â∫ÉÂëä„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
    
    <!-- Ë™çË®ºÁîªÈù¢ -->
    <div id="auth-container" style="display: none;">
        <div class="container">
            <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
            <div id="login-page" class="page active">
                <div class="medication-card">
                    <h2>üîê „É≠„Ç∞„Ç§„É≥</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-button">„É≠„Ç∞„Ç§„É≥</button>
                            <button type="button" onclick="showRegisterPage()" class="cancel-button">Êñ∞Ë¶èÁôªÈå≤</button>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="#" onclick="showPasswordReset()" style="color: #4CAF50; text-decoration: none;">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ„ÅØ„Åì„Å°„Çâ</a>
                        </div>
                    </form>
                    
                    <!-- OAuthË™çË®º„Éú„Çø„É≥ -->
                    <div class="oauth-buttons">
                        <div class="oauth-divider">„Åæ„Åü„ÅØ</div>
                        <button class="oauth-button google-signin" onclick="signInWithGoogle()">
                            <span>üîç</span>
                            Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥
                        </button>
                        <button class="oauth-button apple-signin" onclick="signInWithApple()">
                            <span>üçé</span>
                            Apple„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥
                        </button>
                    </div>
                    
                    <!-- Âà©Áî®Ë¶èÁ¥Ñ„Éª„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„ÉºÂêåÊÑè -->
                    <div style="margin: 15px 0; font-size: 12px; color: #666; text-align: center;">
                        „É≠„Ç∞„Ç§„É≥„Åô„Çã„Åì„Å®„Åß„ÄÅ<a href="terms-of-service.html" target="_blank" style="color: #667eea;">Âà©Áî®Ë¶èÁ¥Ñ</a>„Åä„Çà„Å≥<a href="privacy-policy.html" target="_blank" style="color: #667eea;">„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</a>„Å´ÂêåÊÑè„Åó„Åü„ÇÇ„ÅÆ„Å®„Åø„Å™„Åï„Çå„Åæ„Åô„ÄÇ
                    </div>
                    
                    <div id="login-message" class="form-message"></div>
                </div>
            </div>

            <!-- Êñ∞Ë¶èÁôªÈå≤ÁîªÈù¢ -->
            <div id="register-page" class="page">
                <div class="medication-card">
                    <h2>üìù Êñ∞Ë¶èÁôªÈå≤</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="register-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input type="password" id="register-password" required minlength="6" placeholder="6ÊñáÂ≠ó‰ª•‰∏ä">
                        </div>
                        <div class="form-group">
                            <label for="register-password-confirm">„Éë„Çπ„ÉØ„Éº„ÉâÁ¢∫Ë™ç</label>
                            <input type="password" id="register-password-confirm" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-button">ÁôªÈå≤</button>
                            <button type="button" onclick="showLoginPage()" class="cancel-button">„É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã</button>
                        </div>
                    </form>
                    
                    <!-- OAuthË™çË®º„Éú„Çø„É≥ -->
                    <div class="oauth-buttons">
                        <div class="oauth-divider">„Åæ„Åü„ÅØ</div>
                        <button class="oauth-button google-signin" onclick="signInWithGoogle()">
                            <span>üîç</span>
                            Google„Ç¢„Ç´„Ç¶„É≥„Éà„ÅßÁôªÈå≤
                        </button>
                        <button class="oauth-button apple-signin" onclick="signInWithApple()">
                            <span>üçé</span>
                            Apple„Ç¢„Ç´„Ç¶„É≥„Éà„ÅßÁôªÈå≤
                        </button>
                    </div>
                    
                    <!-- Âà©Áî®Ë¶èÁ¥Ñ„Éª„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„ÉºÂêåÊÑè -->
                    <div style="margin: 15px 0; font-size: 12px; color: #666; text-align: center;">
                        ÁôªÈå≤„Åô„Çã„Åì„Å®„Åß„ÄÅ<a href="terms-of-service.html" target="_blank" style="color: #667eea;">Âà©Áî®Ë¶èÁ¥Ñ</a>„Åä„Çà„Å≥<a href="privacy-policy.html" target="_blank" style="color: #667eea;">„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</a>„Å´ÂêåÊÑè„Åó„Åü„ÇÇ„ÅÆ„Å®„Åø„Å™„Åï„Çå„Åæ„Åô„ÄÇ
                    </div>
                    
                    <div id="register-message" class="form-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™ÁîªÈù¢ -->
    <div id="app-container" style="display: none;">
        <div class="container">
            <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
            <div id="home-page" class="page active">
                <div id="stock-warnings"></div>
                <h2>‰ªäÊó•„ÅÆÊúçËñ¨</h2>
                <div id="today-medications"></div>
            </div>
        
        <!-- Ëñ¨ÁÆ°ÁêÜÁîªÈù¢ -->
        <div id="medications-page" class="page">
            <h2>ÁôªÈå≤Ê∏à„Åø„ÅÆËñ¨</h2>
            <div id="medications-list"></div>
        </div>
        
        <!-- Â±•Ê≠¥ÁîªÈù¢ -->
        <div id="history-page" class="page">
            <h2>ÊúçËñ¨Â±•Ê≠¥</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="showHistoryView('list')" id="list-view-btn" style="padding: 8px 15px; margin-right: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">üìã „É™„Çπ„ÉàË°®Á§∫</button>
                <button onclick="showHistoryView('gallery')" id="gallery-view-btn" style="padding: 8px 15px; background: #ddd; color: #666; border: none; border-radius: 5px; cursor: pointer;">üñºÔ∏è ÂÜôÁúü‰∏ÄË¶ß</button>
            </div>
            <div id="history-list"></div>
            <div id="history-gallery" style="display: none;"></div>
        </div>
        
        <!-- Ë®≠ÂÆöÁîªÈù¢ -->
        <div id="settings-page" class="page">
            <h2>Ë®≠ÂÆö</h2>
            
            
            <!-- ÊôÇÈñìË®≠ÂÆö -->
            <div class="medication-card">
                <h3>‚è∞ È£ü‰∫ãÊôÇÈñì„ÅÆË®≠ÂÆö</h3>
                <p style="color: #666; margin-bottom: 15px;">ÊØéÈ£üÂæå„ÅÆÊúçËñ¨ÊôÇÈñì„ÇíË®≠ÂÆö„Åß„Åç„Åæ„Åô</p>
                <div class="form-group">
                    <label for="breakfast-time">ÊúùÈ£üÂæå„ÅÆÊôÇÈñì</label>
                    <input type="time" id="breakfast-time" value="09:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="lunch-time">ÊòºÈ£üÂæå„ÅÆÊôÇÈñì</label>
                    <input type="time" id="lunch-time" value="13:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="dinner-time">Â§ïÈ£üÂæå„ÅÆÊôÇÈñì</label>
                    <input type="time" id="dinner-time" value="19:00" onchange="saveMealTimeSettings()">
                </div>
                <div class="form-group">
                    <label for="bedtime">Â∞±ÂØùÂâç„ÅÆÊôÇÈñì</label>
                    <input type="time" id="bedtime" value="22:00" onchange="saveMealTimeSettings()">
                </div>
            </div>
            
            
            <!-- „Ç¢„Éó„É™ÊÉÖÂ†± -->
            <div class="medication-card">
                <h3>‚ÑπÔ∏è „Ç¢„Éó„É™ÊÉÖÂ†±</h3>
                <div style="color: #666; font-size: 14px; line-height: 1.5;">
                    <div>„Éê„Éº„Ç∏„Éß„É≥: 2.1</div>
                    <div>„Éá„Éº„Çø‰øùÂ≠òÂ†¥ÊâÄ: „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏</div>
                    <div>ÂÜôÁúü‰øùÊåÅÊúüÈñì: 3„É∂ÊúàÈñì</div>
                    <div style="margin-top: 10px;">
                        <p><strong>„ÅäËñ¨„ÅÆ„Çì„Å†Ôºü</strong>„ÅØÊúçËñ¨ÁÆ°ÁêÜ„Çí„Çµ„Éù„Éº„Éà„Åô„ÇãPWA„Ç¢„Éó„É™„Åß„Åô„ÄÇ</p>
                        <p style="margin-top: 5px; font-size: 12px; color: #999;">
                            ‚Äª„Åì„ÅÆ„Ç¢„Éó„É™„ÅØÂåªÁôÇÊ©üÂô®„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂåªÁôÇÂà§Êñ≠„ÅØÂøÖ„ÅöÂåªÂ∏´„Å´„ÅîÁõ∏Ë´á„Åè„Å†„Åï„ÅÑ„ÄÇ
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- „ÇØ„É©„Ç¶„ÉâÂêåÊúü„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="medication-card">
                <h3>‚òÅÔ∏è „ÇØ„É©„Ç¶„ÉâÂêåÊúü</h3>
                <p style="color: #666; margin-bottom: 15px;">„Éá„Éº„Çø„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Å¶Á´ØÊú´Èñì„ÅßÂêåÊúü„Åß„Åç„Åæ„Åô</p>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 14px; color: #666;">
                        ÊúÄÂæå„ÅÆÂêåÊúü: <span id="last-sync-time">Êú™ÂêåÊúü</span>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã: <span id="online-status">„Ç™„Éï„É©„Ç§„É≥</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="manualSync()" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; flex: 1;">ÊâãÂãïÂêåÊúü</button>
                    <button onclick="migrateData()" style="background: #2196F3; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; flex: 1;">„Éá„Éº„ÇøÁßªË°å</button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                    ‚Äª„É≠„Ç∞„Ç§„É≥Âæå„ÄÅ„Éá„Éº„Çø„ÅåËá™ÂãïÁöÑ„Å´„ÇØ„É©„Ç¶„Éâ„Å´ÂêåÊúü„Åï„Çå„Åæ„Åô
                </div>
            </div>
            
            <!-- OAuthË™çË®ºÁä∂Ê≥Å -->
            <div class="medication-card">
                <h3>üîê OAuthË™çË®º„Çπ„ÉÜ„Éº„Çø„Çπ</h3>
                <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <strong>Ë™çË®º„Çµ„Éº„Éì„ÇπÁä∂Ê≥Å:</strong>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
                        <li id="google-oauth-status">üîç Firebase Google OAuth: <span style="color: #6c757d;">Ë™≠„ÅøËæº„Åø‰∏≠...</span></li>
                        <li id="apple-oauth-status">üçé Apple Sign In: <span style="color: #ffc107;">Ë™≠„ÅøËæº„Åø‰∏≠...</span></li>
                    </ul>
                </div>
                <div style="font-size: 12px; color: #666;">
                    <strong>Firebase SDK‰ΩøÁî®:</strong> Firebase Console „ÅÆÊâøË™çÊ∏à„Åø„Éâ„É°„Ç§„É≥Ë®≠ÂÆö„ÅÆ„Åø„ÅßÂãï‰Ωú„Åó„Åæ„Åô„ÄÇ
                </div>
            </div>
            
            <!-- Ê≥ïÁöÑÊñáÊõ∏„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="medication-card">
                <h3>üìã Ë¶èÁ¥Ñ„Éª„Éù„É™„Ç∑„Éº</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <a href="privacy-policy.html" target="_blank" style="background: #4CAF50; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; flex: 1; text-align: center;">„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</a>
                    <a href="terms-of-service.html" target="_blank" style="background: #2196F3; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; flex: 1; text-align: center;">Âà©Áî®Ë¶èÁ¥Ñ</a>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #999; text-align: center;">
                    „Çπ„Éà„Ç¢ÂÖ¨Èñã„Å´ÂøÖË¶Å„Å™Ê≥ïÁöÑÊñáÊõ∏„Åß„Åô
                </div>
            </div>
            
            <!-- „É≠„Ç∞„Ç¢„Ç¶„Éà„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="medication-card">
                <h3>üö™ „Ç¢„Ç´„Ç¶„É≥„Éà</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="current-user-email" style="color: #666;"></span>
                    <button onclick="handleLogout()" style="background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- „Çø„Éñ„Éê„Éº -->
    <div class="tab-bar">
        <button class="tab active" onclick="showPage('home')">
            <div>üíä</div>
            <div>ÊúçÁî®</div>
        </button>
        <button class="tab" onclick="showPage('medications')">
            <div>üóÉÔ∏è</div>
            <div>Ëñ¨ÁÆ±</div>
        </button>
        <button class="tab" onclick="showPage('history')">
            <div>üìä</div>
            <div>Â±•Ê≠¥</div>
        </button>
        <button class="tab" onclick="showPage('settings')">
            <div>‚öôÔ∏è</div>
            <div>Ë®≠ÂÆö</div>
        </button>
    </div>
    
    <!-- ËøΩÂä†„Éú„Çø„É≥ -->
    <button class="add-button" onclick="showAddModal()">+</button>
    
    <!-- Ëñ¨ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <h3>Êñ∞„Åó„ÅÑËñ¨„ÇíËøΩÂä†</h3>
            <form id="add-medication-form">
                <div class="form-group">
                    <label for="med-name">Ëñ¨„ÅÆÂêçÂâç</label>
                    <input type="text" id="med-name" required>
                </div>
                <div class="form-group">
                    <label for="med-purpose">Ëñ¨„ÅÆÁî®ÈÄî</label>
                    <select id="med-purpose-select" onchange="toggleCustomPurpose()" style="width: 100%;">
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        <option value="È†≠Áóõ„ÉªËß£ÁÜ±">È†≠Áóõ„ÉªËß£ÁÜ±</option>
                        <option value="ËÉÉËÖ∏Ëñ¨">ËÉÉËÖ∏Ëñ¨</option>
                        <option value="È¢®ÈÇ™Ëñ¨">È¢®ÈÇ™Ëñ¨</option>
                        <option value="„Ç¢„É¨„É´„ÇÆ„Éº">„Ç¢„É¨„É´„ÇÆ„Éº</option>
                        <option value="„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà">„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà</option>
                        <option value="È´òË°ÄÂúß">È´òË°ÄÂúß</option>
                        <option value="Á≥ñÂ∞øÁóÖ">Á≥ñÂ∞øÁóÖ</option>
                        <option value="ÊäóÁîüÁâ©Ë≥™">ÊäóÁîüÁâ©Ë≥™</option>
                        <option value="Áù°Áú†Ëñ¨">Áù°Áú†Ëñ¨</option>
                        <option value="custom">„Åù„ÅÆ‰ªñÔºàËá™Áî±Ë®òÂÖ•Ôºâ</option>
                    </select>
                    <input type="text" id="med-purpose-custom" placeholder="Ëñ¨„ÅÆÁî®ÈÄî„ÇíÂÖ•Âäõ" style="display: none; margin-top: 10px; width: 100%;">
                </div>
                <div class="form-group">
                    <label for="med-dosage">Áî®ÈáèÔºà1Âõû„ÅÇ„Åü„ÇäÔºâ</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="med-dosage-number" required style="flex: 1;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                        <select id="med-dosage-unit" required style="flex: 1;">
                            <option value="Èå†">Èå†</option>
                            <option value="ÂåÖ">ÂåÖ</option>
                            <option value="ÊùØ">ÊùØ</option>
                            <option value="Êª¥">Êª¥</option>
                            <option value="mL">mL</option>
                            <option value="g">g</option>
                            <option value="ÂÄã">ÂÄã</option>
                            <option value="Á≤í">Á≤í</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="med-frequency">ÊúçÁî®È†ªÂ∫¶</label>
                    <select id="med-frequency" required>
                        <option value="ÊØéÈ£üÂæå">ÊØéÈ£üÂæå</option>
                        <option value="ÊúùÈ£üÂæå">ÊúùÈ£üÂæå</option>
                        <option value="ÊòºÈ£üÂæå">ÊòºÈ£üÂæå</option>
                        <option value="Â§ïÈ£üÂæå">Â§ïÈ£üÂæå</option>
                        <option value="ÊúùÂ§ïÈ£üÂæå">ÊúùÂ§ïÈ£üÂæå</option>
                        <option value="Â∞±ÂØùÂâç">Â∞±ÂØùÂâç</option>
                        <option value="ÊØéÈ£üÂæåÔºãÂ∞±ÂØùÂâç">ÊØéÈ£üÂæåÔºãÂ∞±ÂØùÂâç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="med-stock">ÁèæÂú®„ÅÆÂú®Â∫´Êï∞</label>
                    <input type="number" id="med-stock" required>
                </div>
                <div class="form-group">
                    <label for="med-alert-threshold">Âú®Â∫´Ë≠¶Âëä„Åó„Åç„ÅÑÂÄ§</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="med-alert-threshold-select" onchange="toggleCustomThreshold()" style="flex: 1;">
                            <option value="1">ÊÆã„Çä1ÂÄã</option>
                            <option value="2">ÊÆã„Çä2ÂÄã</option>
                            <option value="3">ÊÆã„Çä3ÂÄã</option>
                            <option value="4">ÊÆã„Çä4ÂÄã</option>
                            <option value="5">ÊÆã„Çä5ÂÄã</option>
                            <option value="6">ÊÆã„Çä6ÂÄã</option>
                            <option value="7" selected>ÊÆã„Çä7ÂÄã</option>
                            <option value="8">ÊÆã„Çä8ÂÄã</option>
                            <option value="9">ÊÆã„Çä9ÂÄã</option>
                            <option value="10">ÊÆã„Çä10ÂÄã</option>
                            <option value="custom">„Åù„ÅÆ‰ªñÔºàÁõ¥Êé•ÂÖ•ÂäõÔºâ</option>
                        </select>
                        <input type="number" id="med-alert-threshold-custom" placeholder="ÂÄãÊï∞„ÇíÂÖ•Âäõ" min="1" style="display: none; width: 100px;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="med-photo">Ëñ¨„ÅÆÂÜôÁúüÔºà‰ªªÊÑèÔºâ</label>
                    <input type="file" id="med-photo" accept="image/*" onchange="handleMedicationPhotoUpload(event)">
                    <div id="med-photo-preview" style="margin-top: 10px; display: none;">
                        <img id="med-photo-thumbnail" style="width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeMedicationPhoto()" style="margin-left: 10px; padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">ÂâäÈô§</button>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="save-button">‰øùÂ≠ò</button>
                    <button type="button" class="cancel-button" onclick="hideAddModal()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- „Ç´„É°„É©„É¢„Éº„ÉÄ„É´ -->
    <div id="camera-modal" class="modal camera-modal">
        <div class="modal-content">
            <h3>ÊúçÁî®ÂÜôÁúü„ÇíÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
            <div class="camera-container">
                <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoCapture(event)">
                <canvas id="camera-canvas" class="camera-canvas" style="display: none;"></canvas>
                <img id="captured-image" class="captured-image" style="display: none;">
                
                <div class="camera-controls">
                    <button id="capture-btn" class="capture-button" onclick="openCameraApp()">üì∑ ÊíÆÂΩ±</button>
                    <button id="retake-btn" class="retake-button" onclick="retakePhoto()" style="display: none;">üîÑ ÊíÆ„ÇäÁõ¥„Åó</button>
                </div>
                
                <div id="analysis-result" class="analysis-result" style="display: none;"></div>
            </div>
            
            <div id="medication-confirm-section" style="display: none;">
                <div class="medication-confirm-info">
                    <h4 id="confirm-med-name" style="margin-bottom: 10px;"></h4>
                    <div class="form-group">
                        <label for="confirm-dosage">ÊúçÁî®Êï∞Èáè</label>
                        <input type="number" id="confirm-dosage" min="1" value="1" style="width: 100px;">
                        <span id="confirm-dosage-unit" style="margin-left: 5px;"></span>
                    </div>
                    <div style="color: #666; margin-bottom: 10px;">
                        <span>ÁèæÂú®„ÅÆÂú®Â∫´: </span><span id="confirm-current-stock"></span>
                        <br>
                        <span>ÊúçÁî®Âæå„ÅÆÂú®Â∫´: </span><span id="confirm-remaining-stock" style="font-weight: bold;"></span>
                    </div>
                </div>
                <div class="form-buttons">
                    <button class="save-button" onclick="confirmMedicationWithPhoto()">ÁôªÈå≤</button>
                    <button class="cancel-button" onclick="resetCameraModal()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </div>
            
            <div class="form-buttons" id="camera-initial-buttons">
                <button class="cancel-button" onclick="hideCameraModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // FirebaseË®≠ÂÆö„Å®„Ç§„É≥„Éù„Éº„Éà
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            sendEmailVerification,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyD6_2ioXr3LJU7PpThy7kxXbCfEFatUi_U",
            authDomain: "medication-tracker-b5d0c.firebaseapp.com",
            projectId: "medication-tracker-b5d0c",
            storageBucket: "medication-tracker-b5d0c.firebasestorage.app",
            messagingSenderId: "112454739779",
            appId: "1:112454739779:web:225df0ffd166882c1931f6",
            measurementId: "G-0LPF5Y8NPR"
        };

        // FirebaseÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        window.firebaseAuth = auth;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.sendEmailVerification = sendEmailVerification;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
    </script>

    <script>
        // „Ç¢„Éó„É™„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let isAuthenticated = false;
        let currentUser = null;
        
        // „Éá„Éº„ÇøÁÆ°ÁêÜ
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];
        
        // „Ç´„É°„É©Èñ¢ÈÄ£„ÅÆÂ§âÊï∞
        let currentMedId = null;
        let currentMealTime = null;
        let currentOverdueDate = null;
        let cameraStream = null;
        
        // „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà
        function showPage(pageName) {
            // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: „Éö„Éº„Ç∏„Éì„É•„ÉºËøΩË∑°
            if (analyticsManager) {
                analyticsManager.trackPageView(pageName);
            }
            
            // „Åô„Åπ„Å¶„ÅÆ„Éö„Éº„Ç∏„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éö„Éº„Ç∏„ÇíË°®Á§∫
            document.getElementById(pageName + '-page').classList.add('active');
            
            // Ë®≠ÂÆö„Éö„Éº„Ç∏„ÇíË°®Á§∫„Åô„ÇãÈöõ„Å´ÊôÇÈñìË®≠ÂÆö„ÇíË™≠„ÅøËæº„ÇÄ
            if (pageName === 'settings') {
                loadMealTimeSettings();
            }
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
            event.target.closest('.tab').classList.add('active');
            
            // „Éö„Éº„Ç∏„Å´Âøú„Åò„Å¶„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            if (pageName === 'home') {
                updateTodayMedications();
                checkStockWarnings();
            } else if (pageName === 'medications') {
                updateMedicationsList();
            } else if (pageName === 'history') {
                updateHistoryList();
            } else if (pageName === 'settings') {
                loadMealTimeSettings();
            }
        }
        
        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫/ÈùûË°®Á§∫
        function showAddModal() {
            document.getElementById('add-modal').style.display = 'block';
        }
        
        function hideAddModal() {
            const modal = document.getElementById('add-modal');
            modal.style.display = 'none';
            modal.dataset.editId = '';
            document.getElementById('add-medication-form').reset();
            document.querySelector('#add-modal h3').textContent = 'Êñ∞„Åó„ÅÑËñ¨„ÇíËøΩÂä†';
            // „Ç´„Çπ„Çø„É†ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('med-purpose-custom').style.display = 'none';
            document.getElementById('med-purpose-custom').required = false;
        }
        
        // Ëñ¨„ÅÆÁî®ÈÄî„ÅÆ„Ç´„Çπ„Çø„É†ÂÖ•ÂäõÂàá„ÇäÊõø„Åà
        function toggleCustomPurpose() {
            const select = document.getElementById('med-purpose-select');
            const customInput = document.getElementById('med-purpose-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Âú®Â∫´Ë≠¶Âëä„Åó„Åç„ÅÑÂÄ§„ÅÆ„Ç´„Çπ„Çø„É†ÂÖ•ÂäõÂàá„ÇäÊõø„Åà
        function toggleCustomThreshold() {
            const select = document.getElementById('med-alert-threshold-select');
            const customInput = document.getElementById('med-alert-threshold-custom');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }
        
        // Ëñ¨„ÅÆÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        function handleMedicationPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageDataUrl = e.target.result;
                
                // ÁîªÂÉè„ÇíÂúßÁ∏Æ
                const compressedImage = await compressImage(imageDataUrl, 400, 0.8);
                
                // „Éó„É¨„Éì„É•„ÉºË°®Á§∫
                const preview = document.getElementById('med-photo-preview');
                const thumbnail = document.getElementById('med-photo-thumbnail');
                
                thumbnail.src = compressedImage;
                preview.style.display = 'block';
                
                // ÂúßÁ∏ÆÊ∏à„ÅøÁîªÂÉè„Çí„Éá„Éº„Çø„Å®„Åó„Å¶‰øùÂ≠ò
                preview.dataset.photo = compressedImage;
            };
            reader.readAsDataURL(file);
        }
        
        // Ëñ¨„ÅÆÂÜôÁúüÂâäÈô§
        function removeMedicationPhoto() {
            const preview = document.getElementById('med-photo-preview');
            const thumbnail = document.getElementById('med-photo-thumbnail');
            const fileInput = document.getElementById('med-photo');
            
            preview.style.display = 'none';
            thumbnail.src = '';
            fileInput.value = '';
            delete preview.dataset.photo;
        }
        
        // Ëñ¨„ÅÆËøΩÂä†/Á∑®ÈõÜ
        document.getElementById('add-medication-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dosageNumber = document.getElementById('med-dosage-number').value;
            const dosageUnit = document.getElementById('med-dosage-unit').value;
            const editId = document.getElementById('add-modal').dataset.editId;
            
            // Ëñ¨„ÅÆÁî®ÈÄî„ÇíÂèñÂæó
            const purposeSelect = document.getElementById('med-purpose-select').value;
            const purposeCustom = document.getElementById('med-purpose-custom').value;
            const purpose = purposeSelect === 'custom' ? purposeCustom : purposeSelect;
            
            // Âú®Â∫´Ë≠¶Âëä„Åó„Åç„ÅÑÂÄ§„ÇíÂèñÂæó
            const thresholdSelect = document.getElementById('med-alert-threshold-select').value;
            const thresholdCustom = document.getElementById('med-alert-threshold-custom').value;
            const alertThreshold = thresholdSelect === 'custom' ? 
                parseInt(thresholdCustom) : parseInt(thresholdSelect);
            
            const medicationData = {
                name: document.getElementById('med-name').value,
                dosage: dosageNumber + dosageUnit,
                frequency: document.getElementById('med-frequency').value,
                stock: parseInt(document.getElementById('med-stock').value),
                alertThreshold: alertThreshold || 7,
                purpose: purpose || '' // Ëñ¨„ÅÆÁî®ÈÄî„ÇíËøΩÂä†
            };
            
            // ÂÜôÁúü„Éá„Éº„Çø„ÇíËøΩÂä†
            const preview = document.getElementById('med-photo-preview');
            if (preview.dataset.photo) {
                medicationData.photo = preview.dataset.photo;
            }
            
            if (editId) {
                // Á∑®ÈõÜ„É¢„Éº„Éâ
                const medIndex = medications.findIndex(m => m.id === parseInt(editId));
                if (medIndex !== -1) {
                    medications[medIndex] = {
                        ...medications[medIndex],
                        ...medicationData
                    };
                }
            } else {
                // Êñ∞Ë¶èËøΩÂä†„É¢„Éº„Éâ
                const medication = {
                    id: Date.now(),
                    ...medicationData,
                    createdAt: new Date().toISOString()
                };
                medications.push(medication);
                
                // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: Ëñ¨ÁôªÈå≤ËøΩË∑°
                if (analyticsManager) {
                    analyticsManager.trackMedicationEvent('add', medication);
                }
                
                // ÈÄöÁü•„ÅÆË®≠ÂÆö
                scheduleNotifications(medication);
            }
            
            localStorage.setItem('medications', JSON.stringify(medications));
            
            hideAddModal();
            removeMedicationPhoto();
            updateMedicationsList();
            updateTodayMedications(); // Êñ∞Ë¶èÁôªÈå≤ÊôÇ„Å´„ÇÇ‰ªäÊó•„ÅÆÊúçËñ¨„ÇíÊõ¥Êñ∞
            
            // Êñ∞Ë¶èÁôªÈå≤„Åó„ÅüËñ¨„ÅåÁèæÂú®„ÅÆÊúçÁî®ÊôÇÈñì„Å´Ë©≤ÂΩì„Åô„ÇãÂ†¥Âêà„ÅØ„Éõ„Éº„É†ÁîªÈù¢„ÇíË°®Á§∫
            if (editId) {
                showPage('medications');
            } else {
                const currentMealTime = getCurrentMealTime();
                const newMed = medications[medications.length - 1];
                const nextMedTime = getNextMedicationTime(newMed);
                
                // ÁôªÈå≤Êó•ÂΩìÊó•„Åß„ÄÅÁèæÂú®„ÅÆÊúçÁî®ÊôÇÈñì„Å´Ë©≤ÂΩì„Åô„ÇãÂ†¥Âêà
                if (currentMealTime && nextMedTime.canShowToday && 
                    nextMedTime.nextTimes.some(nt => nt.mealName === currentMealTime)) {
                    showPage('home');
                } else {
                    showPage('medications');
                }
            }
        });
        
        // È£ü‰∫ãÊôÇÈñìË®≠ÂÆö„Çí‰øùÂ≠ò
        function saveMealTimeSettings() {
            const settings = {
                breakfast: document.getElementById('breakfast-time').value,
                lunch: document.getElementById('lunch-time').value,
                dinner: document.getElementById('dinner-time').value,
                bedtime: document.getElementById('bedtime').value
            };
            localStorage.setItem('mealTimeSettings', JSON.stringify(settings));
        }
        
        // È£ü‰∫ãÊôÇÈñìË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        function loadMealTimeSettings() {
            const saved = localStorage.getItem('mealTimeSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('breakfast-time').value = settings.breakfast || '09:00';
                document.getElementById('lunch-time').value = settings.lunch || '13:00';
                document.getElementById('dinner-time').value = settings.dinner || '19:00';
                document.getElementById('bedtime').value = settings.bedtime || '22:00';
            }
        }
        
        // ÁèæÂú®„ÅÆÈ£ü‰∫ãÊôÇÈñì„ÇíÂèñÂæó
        function getCurrentMealTime() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // ÊôÇÈñì„ÇíÂàÜ„Å´Â§âÊèõ
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const breakfastTime = toMinutes(settings.breakfast);
            const lunchTime = toMinutes(settings.lunch);
            const dinnerTime = toMinutes(settings.dinner);
            const bedtimeTime = toMinutes(settings.bedtime);
            
            // ÂêÑÈ£ü‰∫ãÊôÇÈñì„ÅÆÂâçÂæå1ÊôÇÈñì„ÇíÊúçËñ¨ÊôÇÈñì„Å®„Åô„Çã
            if (currentTime >= breakfastTime - 60 && currentTime < breakfastTime + 60) return 'ÊúùÈ£üÂæå';
            else if (currentTime >= lunchTime - 60 && currentTime < lunchTime + 60) return 'ÊòºÈ£üÂæå';
            else if (currentTime >= dinnerTime - 60 && currentTime < dinnerTime + 60) return 'Â§ïÈ£üÂæå';
            else if (currentTime >= bedtimeTime - 60 || currentTime < 360) return 'Â∞±ÂØùÂâç'; // 360 = 6:00 AM
            
            return '';
        }
        
        // Ê¨°„ÅÆÊúçÁî®„Çø„Ç§„Éü„É≥„Ç∞„ÇíË®àÁÆó
        function getNextMedicationTime(medication) {
            const now = new Date();
            // createdAt„ÅåÁÑ°„ÅÑÂè§„ÅÑËñ¨„ÅØ„ÄÅÁèæÂú®ÊôÇÂàª„ÅÆ1Êó•Ââç„Å®„Åó„Å¶Êâ±„ÅÜÔºàÈÄöÂ∏∏Ë°®Á§∫Ôºâ
            const registeredAt = medication.createdAt ? new Date(medication.createdAt) : new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            // ÊôÇÈñìË®≠ÂÆö„ÇíÂèñÂæó
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // ÊôÇÈñì„ÇíÂàÜ„Å´Â§âÊèõ
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const timeMap = {
                'ÊúùÈ£üÂæå': toMinutes(settings.breakfast),
                'ÊòºÈ£üÂæå': toMinutes(settings.lunch),
                'Â§ïÈ£üÂæå': toMinutes(settings.dinner),
                'Â∞±ÂØùÂâç': toMinutes(settings.bedtime)
            };
            
            // ÊúçÁî®È†ªÂ∫¶„Å´Âøú„Åò„ÅüÊ¨°ÂõûÊúçÁî®ÊôÇÈñì„ÇíË®àÁÆó
            const frequency = medication.frequency;
            let nextTimes = [];
            
            switch(frequency) {
                case 'ÊØéÈ£üÂæå':
                    nextTimes = [timeMap['ÊúùÈ£üÂæå'], timeMap['ÊòºÈ£üÂæå'], timeMap['Â§ïÈ£üÂæå']];
                    break;
                case 'ÊúùÈ£üÂæå':
                    nextTimes = [timeMap['ÊúùÈ£üÂæå']];
                    break;
                case 'ÊòºÈ£üÂæå':
                    nextTimes = [timeMap['ÊòºÈ£üÂæå']];
                    break;
                case 'Â§ïÈ£üÂæå':
                    nextTimes = [timeMap['Â§ïÈ£üÂæå']];
                    break;
                case 'ÊúùÂ§ïÈ£üÂæå':
                    nextTimes = [timeMap['ÊúùÈ£üÂæå'], timeMap['Â§ïÈ£üÂæå']];
                    break;
                case 'Â∞±ÂØùÂâç':
                    nextTimes = [timeMap['Â∞±ÂØùÂâç']];
                    break;
                case 'ÊØéÈ£üÂæåÔºãÂ∞±ÂØùÂâç':
                    nextTimes = [timeMap['ÊúùÈ£üÂæå'], timeMap['ÊòºÈ£üÂæå'], timeMap['Â§ïÈ£üÂæå'], timeMap['Â∞±ÂØùÂâç']];
                    break;
            }
            
            // ÁôªÈå≤ÊôÇÂàª‰ª•Èôç„ÅÆÊ¨°ÂõûÊúçÁî®ÊôÇÂàª„ÇíË¶ã„Å§„Åë„Çã
            const registeredTime = registeredAt.getHours() * 60 + registeredAt.getMinutes();
            const registeredDate = registeredAt.toDateString();
            const currentDate = now.toDateString();
            
            // ÁôªÈå≤ÂΩìÊó•„ÅÆÂ†¥Âêà
            if (registeredDate === currentDate) {
                // ÁôªÈå≤ÊôÇÂàª‰ª•Èôç„ÅÆÊúçÁî®ÊôÇÈñì„ÇíÊé¢„Åô
                const todayNextTimes = nextTimes.filter(time => time > registeredTime);
                
                if (todayNextTimes.length > 0) {
                    // ‰ªäÊó•„ÅÆÊÆã„Çä„ÅÆÊúçÁî®ÊôÇÈñì„Åå„ÅÇ„Çã
                    return {
                        canShowToday: true,
                        nextTimes: todayNextTimes.map(time => {
                            const mealName = Object.keys(timeMap).find(key => timeMap[key] === time);
                            return { time, mealName };
                        })
                    };
                } else {
                    // ‰ªäÊó•„ÅØ„ÇÇ„ÅÜÊúçÁî®ÊôÇÈñì„Åå„Å™„ÅÑ„ÄÅÊòéÊó•„Åã„Çâ
                    return {
                        canShowToday: false,
                        nextTimes: nextTimes.map(time => {
                            const mealName = Object.keys(timeMap).find(key => timeMap[key] === time);
                            return { time, mealName };
                        })
                    };
                }
            } else {
                // ÁôªÈå≤ÁøåÊó•‰ª•Èôç„Å™„ÅÆ„ÅßÈÄöÂ∏∏ÈÄö„ÇäË°®Á§∫
                return {
                    canShowToday: true,
                    nextTimes: nextTimes.map(time => {
                        const mealName = Object.keys(timeMap).find(key => timeMap[key] === time);
                        return { time, mealName };
                    })
                };
            }
        }
        
        // ‰ªäÊó•„ÅÆÊúçËñ¨„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateTodayMedications() {
            const container = document.getElementById('today-medications');
            container.innerHTML = '';
            
            const mealTime = getCurrentMealTime();
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // ÊôÇÈñìË®≠ÂÆö„ÇíÂèñÂæó
            const saved = localStorage.getItem('mealTimeSettings');
            let settings = {
                breakfast: '09:00',
                lunch: '13:00',
                dinner: '19:00',
                bedtime: '22:00'
            };
            if (saved) {
                settings = JSON.parse(saved);
            }
            
            // ÂêÑÈ£ü‰∫ãÊôÇÈñì„ÇíÂàÜ„Å´Â§âÊèõ
            const toMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            
            const mealTimes = {
                'ÊúùÈ£üÂæå': toMinutes(settings.breakfast),
                'ÊòºÈ£üÂæå': toMinutes(settings.lunch),
                'Â§ïÈ£üÂæå': toMinutes(settings.dinner),
                'Â∞±ÂØùÂâç': toMinutes(settings.bedtime)
            };
            
            // ÈÅéÂéª„ÅÆÊú™ÊúçÁî®Ëñ¨„ÇíÂèñÂæóÔºàÁøåÊó•‰ª•Èôç„ÇÇË°®Á§∫„ÅóÁ∂ö„Åë„ÇãÔºâ
            const overdueWarnings = [];
            const today = new Date();
            
            // ‰ªäÊó•„Å®ÈÅéÂéª7Êó•Èñì„ÅÆÊú™ÊúçÁî®Ëñ¨„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            for (let dayOffset = 0; dayOffset <= 7; dayOffset++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - dayOffset);
                const checkDateStr = checkDate.toDateString();
                
                for (const [meal, time] of Object.entries(mealTimes)) {
                    // ‰ªäÊó•„ÅÆÂ†¥Âêà„ÅØ2ÊôÇÈñìÁµåÈÅé„Åó„Åü„ÇÇ„ÅÆ„ÅÆ„Åø„ÄÅÈÅéÂéª„ÅÆÊó•‰ªò„ÅØÂÖ®„Å¶ÂØæË±°
                    const shouldShow = dayOffset === 0 ? (currentTime >= time + 120) : true;
                    
                    if (shouldShow) {
                        const overdueMeds = medications.filter(med => {
                            // Âü∫Êú¨ÁöÑ„Å™ÊúçÁî®È†ªÂ∫¶„ÉÅ„Çß„ÉÉ„ÇØ
                            const isThisMealTime = med.frequency === 'ÊØéÈ£üÂæå' || 
                                   med.frequency === meal ||
                                   (med.frequency === 'ÊúùÂ§ïÈ£üÂæå' && (meal === 'ÊúùÈ£üÂæå' || meal === 'Â§ïÈ£üÂæå'));
                            
                            if (!isThisMealTime) {
                                return false;
                            }
                            
                            // „Åù„ÅÆÊó•„Å´Êó¢„Å´ÊúçÁî®Ê∏à„Åø„ÄÅ„Çπ„Ç≠„ÉÉ„ÉóÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                            const history = JSON.parse(localStorage.getItem('medicationHistory') || '[]');
                            const isTakenOnDate = history.some(h => 
                                h.medicationId === med.id && 
                                h.mealTime === meal && 
                                new Date(h.date).toDateString() === checkDateStr &&
                                (h.action === 'taken' || h.action === 'skipped')
                            );
                            
                            if (isTakenOnDate) {
                                return false;
                            }
                            
                            // ÁôªÈå≤Êó•„Çà„ÇäÂâç„ÅÆÊó•„ÅØÂØæË±°Â§ñ
                            const registeredAt = new Date(med.createdAt || checkDate);
                            if (checkDate < registeredAt) {
                                return false;
                            }
                            
                            // ÁôªÈå≤Êó•ÂΩìÊó•„ÅÆÂ†¥Âêà„ÅØ„ÄÅÁôªÈå≤ÊôÇÂàª‰ª•Èôç„ÅÆÊúçÁî®ÊôÇÈñì„ÅÆ„ÅøÂØæË±°
                            if (registeredAt.toDateString() === checkDateStr) {
                                const mealTimeMinutes = time;
                                const registeredTimeMinutes = registeredAt.getHours() * 60 + registeredAt.getMinutes();
                                return mealTimeMinutes > registeredTimeMinutes;
                            }
                            
                            return true;
                        });
                        
                        overdueWarnings.push(...overdueMeds.map(med => ({
                            ...med, 
                            mealTime: meal,
                            overdueDate: checkDate,
                            dayOffset: dayOffset
                        })));
                    }
                }
            }
            
            // ÈÅÖÂª∂Ë≠¶Âëä„ÇíË°®Á§∫
            if (overdueWarnings.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning-message';
                warningDiv.style.marginBottom = '20px';
                warningDiv.innerHTML = '<strong>‚ö†Ô∏è ÊúçÁî®ÊôÇÈñì„ÇíÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô</strong>';
                container.appendChild(warningDiv);
                
                overdueWarnings.forEach(warning => {
                    const card = document.createElement('div');
                    card.className = 'medication-card';
                    card.style.border = '2px solid #ff9800';
                    const stockStatus = warning.stock <= (warning.alertThreshold || 7) ? 'low' : 'normal';
                    const stockColor = stockStatus === 'low' ? '#ff6b6b' : '#38a169';
                    
                    // Êó•‰ªòË°®Á§∫Áî®„ÅÆÊñáÂ≠óÂàó
                    const dateLabel = warning.dayOffset === 0 ? '‰ªäÊó•' : 
                                     warning.dayOffset === 1 ? 'Êò®Êó•' :
                                     `${warning.dayOffset}Êó•Ââç`;
                    const warningLabel = warning.dayOffset === 0 ? '‚è∞ ÊúçÁî®ÊôÇÈñì„Åã„Çâ2ÊôÇÈñì‰ª•‰∏äÁµåÈÅé' : 
                                        `üìÖ ${dateLabel}„ÅÆÊú™ÊúçÁî®`;
                    
                    card.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <!-- Ëñ¨ÊÉÖÂ†±ÈÉ®ÂàÜ -->
                            <div style="flex: 1; min-width: 0;">
                                <div class="medication-name" style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${warning.name} - ${warning.mealTime}</div>
                                <div class="medication-info" style="color: #ff6b6b; margin-bottom: 3px; font-weight: bold;">${warningLabel}</div>
                                <div class="medication-info" style="margin-bottom: 3px;">${warning.dosage} - ${warning.frequency}</div>
                                ${warning.purpose ? `<div class="medication-info" style="color: #666; font-size: 13px;">Áî®ÈÄî: ${warning.purpose}</div>` : ''}
                            </div>
                            
                            <!-- Âú®Â∫´Ë°®Á§∫ÈÉ®ÂàÜ -->
                            <div style="text-align: center; padding: 8px 12px; background: ${stockStatus === 'low' ? '#fff5f5' : '#f0f9ff'}; border-radius: 8px; border: 1px solid ${stockStatus === 'low' ? '#fed7d7' : '#bfdbfe'};">
                                <div style="font-size: 20px; font-weight: bold; color: ${stockColor};">${warning.stock}</div>
                                <div style="font-size: 11px; color: #666;">ÂÄã</div>
                                ${stockStatus === 'low' ? '<div style="font-size: 10px; color: #f56565; margin-top: 2px;">‚ö†Ô∏è Â∞ë„Å™„ÅÑ</div>' : ''}
                            </div>
                            
                            <!-- „Çµ„É†„Éç„Ç§„É´ÁîªÂÉè -->
                            ${warning.photo ? `
                                <div>
                                    <img src="${warning.photo}" alt="${warning.name}" 
                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                         onclick="showPhotoModal('${warning.photo}')">
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- „Éú„Çø„É≥ÈÉ®ÂàÜ -->
                        <div style="display: flex; gap: 10px;">
                            <button class="take-button" 
                                    onclick="showCameraModal(${warning.id}, '${warning.mealTime}', '${warning.overdueDate.toISOString()}')"
                                    style="background: #ff9800; flex: 1;">
                                üì∏ ‰ªä„Åô„ÅêÊúçÁî®„Åô„Çã
                            </button>
                            <button class="skip-button" 
                                    onclick="skipMedication(${warning.id}, '${warning.mealTime}', '${warning.overdueDate.toISOString()}')">
                                ‚è≠Ô∏è ÊúçÁî®„Çí„Çπ„Ç≠„ÉÉ„Éó„Åô„Çã
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
                // ÈÅÖÂª∂Ë≠¶Âëä„ÅÆÈÄöÁü•„ÇíÈÄÅ‰ø°
                checkOverdueNotifications(overdueWarnings);
            }
            
            // ÁèæÂú®„ÅÆÊúçÁî®ÊôÇÈñì„ÅÆËñ¨„ÇíË°®Á§∫ÔºàÁôªÈå≤Êó•ÊôÇ„ÇíËÄÉÊÖÆÔºâ
            const todayMeds = medications.filter(med => {
                // Ëñ¨„ÅÆÊ¨°ÂõûÊúçÁî®„Çø„Ç§„Éü„É≥„Ç∞„ÇíÂèñÂæó
                const nextMedTime = getNextMedicationTime(med);
                
                // ‰ªäÊó•Ë°®Á§∫„Åß„Åç„Å™„ÅÑËñ¨„ÅØÈô§Â§ñ
                if (!nextMedTime.canShowToday) {
                    return false;
                }
                
                // ÁèæÂú®„ÅÆÈ£ü‰∫ãÊôÇÈñì„Å´Ë©≤ÂΩì„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const isCurrentMealTime = med.frequency === 'ÊØéÈ£üÂæå' || 
                       med.frequency === mealTime ||
                       (med.frequency === 'ÊúùÂ§ïÈ£üÂæå' && (mealTime === 'ÊúùÈ£üÂæå' || mealTime === 'Â§ïÈ£üÂæå')) ||
                       (med.frequency === 'ÊØéÈ£üÂæåÔºãÂ∞±ÂØùÂâç' && (mealTime === 'ÊúùÈ£üÂæå' || mealTime === 'ÊòºÈ£üÂæå' || mealTime === 'Â§ïÈ£üÂæå' || mealTime === 'Â∞±ÂØùÂâç'));
                
                // ÁôªÈå≤Êó•ÂΩìÊó•„ÅÆÂ†¥Âêà„ÅØ„ÄÅÊ¨°ÂõûÊúçÁî®ÊôÇÈñì„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åã„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØ
                if (isCurrentMealTime) {
                    const registeredAt = new Date(med.createdAt);
                    const today = new Date();
                    
                    if (registeredAt.toDateString() === today.toDateString()) {
                        // ÁôªÈå≤Êó•ÂΩìÊó•„ÅØ„ÄÅÊ¨°ÂõûÊúçÁî®ÊôÇÈñì„É™„Çπ„Éà„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„ÇãÈ£ü‰∫ãÊôÇÈñì„ÅÆ„ÅøË°®Á§∫
                        return nextMedTime.nextTimes.some(nt => nt.mealName === mealTime);
                    }
                }
                
                return isCurrentMealTime;
            });
            
            if (todayMeds.length === 0 && overdueWarnings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÁèæÂú®ÊúçÁî®„Åô„ÇãËñ¨„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            todayMeds.forEach(med => {
                const taken = isTakenToday(med.id, mealTime);
                const card = document.createElement('div');
                card.className = 'medication-card';
                const stockStatus = med.stock <= (med.alertThreshold || 7) ? 'low' : 'normal';
                const stockColor = stockStatus === 'low' ? '#ff6b6b' : '#38a169';
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <!-- Ëñ¨ÊÉÖÂ†±ÈÉ®ÂàÜ -->
                        <div style="flex: 1; min-width: 0;">
                            <div class="medication-name" style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${med.name}</div>
                            <div class="medication-info" style="margin-bottom: 3px;">${med.dosage} - ${med.frequency}</div>
                            ${med.purpose ? `<div class="medication-info" style="color: #666; font-size: 13px;">Áî®ÈÄî: ${med.purpose}</div>` : ''}
                        </div>
                        
                        <!-- Âú®Â∫´Ë°®Á§∫ÈÉ®ÂàÜ -->
                        <div style="text-align: center; padding: 8px 12px; background: ${stockStatus === 'low' ? '#fff5f5' : '#f0f9ff'}; border-radius: 8px; border: 1px solid ${stockStatus === 'low' ? '#fed7d7' : '#bfdbfe'};">
                            <div style="font-size: 20px; font-weight: bold; color: ${stockColor};">${med.stock}</div>
                            <div style="font-size: 11px; color: #666;">ÂÄã</div>
                            ${stockStatus === 'low' ? '<div style="font-size: 10px; color: #f56565; margin-top: 2px;">‚ö†Ô∏è Â∞ë„Å™„ÅÑ</div>' : ''}
                        </div>
                        
                        <!-- „Çµ„É†„Éç„Ç§„É´ÁîªÂÉè -->
                        ${med.photo ? `
                            <div>
                                <img src="${med.photo}" alt="${med.name}" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                     onclick="showPhotoModal('${med.photo}')">
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- „Éú„Çø„É≥ÈÉ®ÂàÜ -->
                    <button class="take-button ${taken ? 'taken' : ''}" 
                            onclick="showCameraModal(${med.id}, '${mealTime}')"
                            ${taken ? 'disabled' : ''}
                            style="width: 100%; margin-bottom: 8px;">
                        ${taken ? '‚úì ÊúçÁî®Ê∏à„Åø' : 'üì∏ ÊúçÁî®„Åô„Çã'}
                    </button>
                    ${taken ? `<button class="cancel-button" onclick="undoMedication(${med.id}, '${mealTime}')" style="width: 100%; padding: 8px; font-size: 14px;">üîÑ Âèñ„ÇäÊ∂à„Åó</button>` : ''}
                `;
                container.appendChild(card);
            });
        }
        
        // Ëñ¨„ÇíÊúçÁî®ÔºàÂÜôÁúüÂøÖÈ†àÔºâ
        // „Åì„ÅÆÈñ¢Êï∞„ÅØ‰ΩøÁî®„Åï„Çå„Åö„ÄÅ„Åô„Åπ„Å¶„ÅÆÊúçÁî®Ë®òÈå≤„ÅØ showCameraModal „ÇíÁµåÁî±„Åó„Å¶ÂÜôÁúü‰ªò„Åç„ÅßË°å„Çè„Çå„Åæ„Åô
        function takeMedication(medId, mealTime) {
            // ÂÜôÁúüÊíÆÂΩ±„ÅåÂøÖÈ†à„ÅÆ„Åü„ÇÅ„ÄÅÁõ¥Êé•„Ç´„É°„É©„É¢„Éº„ÉÄ„É´„ÇíËµ∑Âãï
            showCameraModal(medId, mealTime);
        }
        
        // ‰ªäÊó•ÊúçÁî®Ê∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà„Çπ„Ç≠„ÉÉ„Éó„ÇÇÂê´„ÇÄÔºâ
        function isTakenToday(medId, mealTime) {
            const today = new Date().toDateString();
            return history.some(h => {
                const takenDate = new Date(h.date || h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled && // Âèñ„ÇäÊ∂à„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ±•Ê≠¥„ÅÆ„Åø
                       (h.action === 'taken' || h.action === 'skipped' || !h.action); // taken, skipped, „Åæ„Åü„ÅØÂè§„ÅÑÊßãÈÄ†Ôºàaction„Éï„Ç£„Éº„É´„Éâ„Å™„ÅóÔºâ
            });
        }
        
        // ÊúçÁî®Ë®òÈå≤„ÅÆÂèñ„ÇäÊ∂à„ÅóÔºà„Éõ„Éº„É†ÁîªÈù¢„Åã„ÇâÔºâ
        function undoMedication(medId, mealTime) {
            if (!confirm('ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºüÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            const today = new Date().toDateString();
            const historyItem = history.find(h => {
                const takenDate = new Date(h.takenAt).toDateString();
                return h.medicationId === medId && 
                       takenDate === today && 
                       h.mealTime === mealTime &&
                       !h.cancelled;
            });
            
            if (historyItem) {
                // Â±•Ê≠¥„ÇíÂèñ„ÇäÊ∂à„ÅóÊ∏à„Åø„Å´„Éû„Éº„ÇØ
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // Âú®Â∫´„ÇíÊàª„Åô
                const med = medications.find(m => m.id === medId);
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                checkStockWarnings();
                
                alert('‚úÖ ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü„ÄÇÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // Â±•Ê≠¥„Åã„Çâ„ÅÆÂèñ„ÇäÊ∂à„Åó
        function undoHistoryItem(medId, takenAt, mealTime) {
            if (!confirm('„Åì„ÅÆÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºüÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            const historyItem = history.find(h => 
                h.medicationId === medId && 
                h.takenAt === takenAt && 
                h.mealTime === mealTime &&
                !h.cancelled
            );
            
            if (historyItem) {
                // Â±•Ê≠¥„ÇíÂèñ„ÇäÊ∂à„ÅóÊ∏à„Åø„Å´„Éû„Éº„ÇØ
                historyItem.cancelled = true;
                historyItem.cancelledAt = new Date().toISOString();
                
                // Âú®Â∫´„ÇíÊàª„Åô
                const med = medications.find(m => m.id === parseInt(medId));
                if (med) {
                    med.stock += 1;
                    localStorage.setItem('medications', JSON.stringify(medications));
                }
                
                localStorage.setItem('history', JSON.stringify(history));
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                updateHistoryList();
                checkStockWarnings();
                
                alert('‚úÖ ÊúçÁî®Ë®òÈå≤„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü„ÄÇÂú®Â∫´„Åå1„Å§Êàª„Çä„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        // Âú®Â∫´Ë≠¶Âëä„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkStockWarnings() {
            const container = document.getElementById('stock-warnings');
            container.innerHTML = '';
            
            const warnings = medications.filter(med => med.stock <= (med.alertThreshold || 7));
            if (warnings.length > 0) {
                warnings.forEach(med => {
                    const warning = document.createElement('div');
                    warning.className = 'stock-warning';
                    warning.textContent = `‚ö†Ô∏è ${med.name}„ÅÆÂú®Â∫´„ÅåÊÆã„Çä${med.stock}ÂÄã„Åß„Åô„ÄÇËøΩÂä†Ë≥ºÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`;
                    container.appendChild(warning);
                });
            }
        }
        
        // Ëñ¨„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
        function updateMedicationsList() {
            const container = document.getElementById('medications-list');
            container.innerHTML = '';
            
            if (medications.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ëñ¨„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }
            
            medications.forEach(med => {
                const card = document.createElement('div');
                card.className = 'medication-card';
                const stockStatus = med.stock <= (med.alertThreshold || 7) ? 'low' : 'normal';
                const stockColor = stockStatus === 'low' ? '#ff6b6b' : '#38a169';
                
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <!-- Ëñ¨ÊÉÖÂ†±ÈÉ®ÂàÜ -->
                        <div style="flex: 1; min-width: 0;">
                            <div class="medication-name" style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${med.name}</div>
                            <div class="medication-info" style="margin-bottom: 3px;">${med.dosage} - ${med.frequency}</div>
                            ${med.purpose ? `<div class="medication-info" style="color: #666; font-size: 13px;">Áî®ÈÄî: ${med.purpose}</div>` : ''}
                        </div>
                        
                        <!-- Âú®Â∫´Ë°®Á§∫ÈÉ®ÂàÜ -->
                        <div style="text-align: center; padding: 8px 12px; background: ${stockStatus === 'low' ? '#fff5f5' : '#f0f9ff'}; border-radius: 8px; border: 1px solid ${stockStatus === 'low' ? '#fed7d7' : '#bfdbfe'};">
                            <div style="font-size: 20px; font-weight: bold; color: ${stockColor};">${med.stock}</div>
                            <div style="font-size: 11px; color: #666;">ÂÄã</div>
                            ${stockStatus === 'low' ? '<div style="font-size: 10px; color: #f56565; margin-top: 2px;">‚ö†Ô∏è Â∞ë„Å™„ÅÑ</div>' : ''}
                        </div>
                        
                        <!-- „Çµ„É†„Éç„Ç§„É´ÁîªÂÉè -->
                        ${med.photo ? `
                            <div>
                                <img src="${med.photo}" alt="${med.name}" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                     onclick="showPhotoModal('${med.photo}')">
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- „Éú„Çø„É≥ÈÉ®ÂàÜ -->
                    <div style="margin-top: 15px; display: flex; gap: 8px;">
                        <button onclick="editMedication(${med.id})" style="flex: 1; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">‚úèÔ∏è Á∑®ÈõÜ</button>
                        <button onclick="deleteMedication(${med.id})" style="flex: 1; padding: 8px 12px; background: #f56565; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">üóëÔ∏è ÂâäÈô§</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
        function updateHistoryList() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÊúçËñ¨Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // Âèñ„ÇäÊ∂à„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ±•Ê≠¥„ÇíË°®Á§∫Ôºà„Çπ„Ç≠„ÉÉ„Éó„ÇÇÂê´„ÇÄÔºâ
            const activeHistory = history.filter(h => !h.cancelled);
            
            if (activeHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÊúçËñ¨Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // Êó•‰ªò„Åß„Ç∞„É´„Éº„ÉóÂåñ
            const groupedHistory = {};
            activeHistory.slice().reverse().forEach(h => {
                const date = new Date(h.takenAt).toLocaleDateString('ja-JP');
                if (!groupedHistory[date]) {
                    groupedHistory[date] = [];
                }
                groupedHistory[date].push(h);
            });
            
            Object.entries(groupedHistory).forEach(([date, items]) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-meds">
                        ${items.map(item => {
                            const time = new Date(item.takenAt).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                            const hasPhoto = item.photo || item.photoVerified;
                            const isSkipped = item.action === 'skipped';
                            return `
                                <div style="display: flex; align-items: center; margin-bottom: 10px; ${isSkipped ? 'opacity: 0.7;' : ''}">
                                    ${!isSkipped && hasPhoto && item.photo ? `
                                        <img class="history-photo" src="${item.photo}" 
                                             onclick="showPhotoModal('${item.photo}')" 
                                             alt="ÊúçÁî®ÂÜôÁúü">
                                    ` : !isSkipped && hasPhoto ? `
                                        <div class="history-photo" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0;">
                                            üì∏
                                        </div>
                                    ` : isSkipped ? `
                                        <div class="history-photo" style="display: flex; align-items: center; justify-content: center; background: #f5f5f5; color: #999;">
                                            ‚è≠Ô∏è
                                        </div>
                                    ` : ''}
                                    <div style="flex: 1;">
                                        <div>${item.medicationName} (${item.mealTime})${isSkipped ? ' - „Çπ„Ç≠„ÉÉ„Éó' : ''}</div>
                                        <div style="font-size: 12px; color: #888;">${time}</div>
                                    </div>
                                    ${!isSkipped ? `
                                        <button class="cancel-button" onclick="undoHistoryItem('${item.medicationId}', '${item.takenAt}', '${item.mealTime}')" 
                                                style="padding: 2px 8px; font-size: 12px; margin-left: 10px;">üîÑ Âèñ„ÇäÊ∂à„Åó</button>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }
        
        // ÈÄöÁü•„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´
        function scheduleNotifications(medication) {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // ÊúçËñ¨ÊôÇÈñì„ÅÆÈÄöÁü•„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
            setMedicationReminders(medication);
        }
        
        // ÈÅÖÂª∂Ë≠¶Âëä„ÅÆÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkOverdueNotifications(overdueWarnings) {
            if ('Notification' in window && Notification.permission === 'granted') {
                overdueWarnings.forEach(warning => {
                    const notificationKey = `overdue-${warning.id}-${warning.mealTime}-${new Date().toDateString()}`;
                    
                    // ‰ªäÊó•Êó¢„Å´ÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!localStorage.getItem(notificationKey)) {
                        new Notification('‚ö†Ô∏è ÊúçÁî®ÊôÇÈñì„ÇíÈÅé„Åé„Å¶„ÅÑ„Åæ„Åô', {
                            body: `${warning.name}Ôºà${warning.mealTime}Ôºâ„ÇíÊúçÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ`,
                            icon: '/icon-192x192.png',
                            tag: notificationKey,
                            requireInteraction: true
                        });
                        
                        // ÈÄöÁü•ÈÄÅ‰ø°Ê∏à„Åø„Å®„Åó„Å¶Ë®òÈå≤
                        localStorage.setItem(notificationKey, 'sent');
                    }
                });
            }
        }
        
        // ÊúçËñ¨„É™„Éû„Ç§„É≥„ÉÄ„Éº„ÅÆË®≠ÂÆö
        function setMedicationReminders(medication) {
            const frequency = medication.frequency;
            const times = [];
            
            // ÊúçÁî®È†ªÂ∫¶„Å´Âøú„Åò„Å¶ÈÄöÁü•ÊôÇÈñì„ÇíË®≠ÂÆö
            switch(frequency) {
                case 'ÊØéÈ£üÂæå':
                    times.push('08:30', '12:30', '19:30'); // ÊúùÊòºÂ§ïÈ£üÂæå
                    break;
                case 'ÊúùÈ£üÂæå':
                    times.push('08:30');
                    break;
                case 'ÊòºÈ£üÂæå':
                    times.push('12:30');
                    break;
                case 'Â§ïÈ£üÂæå':
                    times.push('19:30');
                    break;
                case 'ÊúùÂ§ïÈ£üÂæå':
                    times.push('08:30', '19:30');
                    break;
                case 'Â∞±ÂØùÂâç':
                    times.push('22:00');
                    break;
                case 'ÊØéÈ£üÂæåÔºãÂ∞±ÂØùÂâç':
                    times.push('08:30', '12:30', '19:30', '22:00'); // ÊúùÊòºÂ§ïÈ£üÂæåÔºãÂ∞±ÂØùÂâç
                    break;
            }
            
            // ÂêÑÊôÇÈñì„Å´ÂØæ„Åó„Å¶ÈÄöÁü•„ÇíË®≠ÂÆö
            times.forEach(time => {
                scheduleNotificationAtTime(medication, time);
            });
        }
        
        // ÊåáÂÆöÊôÇÈñì„Å´ÈÄöÁü•„ÇíË®≠ÂÆö
        function scheduleNotificationAtTime(medication, timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            const now = new Date();
            const scheduledTime = new Date();
            scheduledTime.setHours(hours, minutes, 0, 0);
            
            // „ÇÇ„Åó‰ªäÊó•„ÅÆÊôÇÈñì„ÅåÈÅé„Åé„Å¶„ÅÑ„Åü„ÇâÊòéÊó•„Å´Ë®≠ÂÆö
            if (scheduledTime <= now) {
                scheduledTime.setDate(scheduledTime.getDate() + 1);
            }
            
            const timeUntilNotification = scheduledTime.getTime() - now.getTime();
            
            setTimeout(() => {
                showMedicationNotification(medication, timeString);
                // ÁøåÊó•‰ª•Èôç„ÇÇÁ∂ôÁ∂ö„Åô„Çã„Åü„ÇÅÂÜç„Çπ„Ç±„Ç∏„É•„Éº„É´
                setTimeout(() => {
                    scheduleNotificationAtTime(medication, timeString);
                }, 24 * 60 * 60 * 1000); // 24ÊôÇÈñìÂæå
            }, timeUntilNotification);
        }
        
        // Ëñ¨„ÅÆÈÄöÁü•„ÇíË°®Á§∫
        function showMedicationNotification(medication, time) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`üíä „ÅäËñ¨„ÅÆÊôÇÈñì„Åß„Åô`, {
                    body: `${medication.name} (${medication.dosage}) „ÇíÊúçÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ`,
                    icon: 'üíä',
                    badge: 'üíä',
                    tag: `medication-${medication.id}`,
                    requireInteraction: true,
                    actions: [
                        {
                            action: 'take',
                            title: 'ÊúçÁî®Ê∏à„Åø'
                        },
                        {
                            action: 'later',
                            title: 'Âæå„Åß'
                        }
                    ]
                });
                
                notification.onclick = function() {
                    window.focus();
                    // „Éõ„Éº„É†ÁîªÈù¢„ÇíË°®Á§∫
                    showPage('home');
                    this.close();
                };
                
                // 10ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
                setTimeout(() => {
                    notification.close();
                }, 10000);
            }
        }
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkLowStockNotifications() {
            medications.forEach(med => {
                const threshold = med.alertThreshold || 7;
                if (med.stock <= threshold && med.stock > 0) {
                    showLowStockNotification(med);
                }
            });
        }
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„ÇíË°®Á§∫
        function showLowStockNotification(medication) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(`‚ö†Ô∏è Ëñ¨„ÅÆÂú®Â∫´„ÅåÂ∞ë„Å™„Åè„Å™„Å£„Å¶„ÅÑ„Åæ„Åô`, {
                    body: `${medication.name}„ÅÆÂú®Â∫´„ÅåÊÆã„Çä${medication.stock}ÂÄã„Åß„Åô„ÄÇËøΩÂä†Ë≥ºÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    icon: '‚ö†Ô∏è',
                    badge: '‚ö†Ô∏è',
                    tag: `stock-${medication.id}`,
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    showPage('medications');
                    this.close();
                };
            }
        }
        
        // ÂàùÊúüÂåñ
        updateTodayMedications();
        checkStockWarnings();
        
        // Service Worker„ÅÆÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('Service Worker ÁôªÈå≤ÊàêÂäü:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker ÁôªÈå≤Â§±Êïó:', error);
                    });
            });
        }
        
        // ÈÄöÁü•Ê®©Èôê„ÅÆË¶ÅÊ±Ç
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        
        // Êó¢Â≠ò„ÅÆËñ¨„Å´ÂØæ„Åó„Å¶ÈÄöÁü•„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
        medications.forEach(medication => {
            setMedicationReminders(medication);
        });
        
        // Âú®Â∫´Âàá„ÇåÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        checkLowStockNotifications();
        
        // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÅÆÂá¶ÁêÜ
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÈò≤„Åê
            e.preventDefault();
            // Âæå„Åß‰ΩøÁî®„Åô„Çã„Åü„ÇÅ„Å´„Ç§„Éô„É≥„Éà„Çí‰øùÂ≠ò
            deferredPrompt = e;
            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éú„Çø„É≥„ÇíË°®Á§∫
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            // „Ç§„É≥„Çπ„Éà„Éº„É´„Éê„Éä„Éº„ÇíË°®Á§∫
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #2196F3;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 9999;
                cursor: pointer;
            `;
            installBanner.innerHTML = 'üì± „Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Å¶„Ç¢„Éó„É™„Å®„Åó„Å¶‰ΩøÁî®„Åß„Åç„Åæ„ÅôÔºÅ';
            installBanner.onclick = installApp;
            document.body.appendChild(installBanner);
            
            // 10ÁßíÂæå„Å´Ëá™Âãï„ÅßÈñâ„Åò„Çã
            setTimeout(() => {
                if (installBanner.parentNode) {
                    installBanner.parentNode.removeChild(installBanner);
                }
            }, 10000);
        }
        
        function installApp() {
            if (deferredPrompt) {
                // „Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
                deferredPrompt.prompt();
                // „É¶„Éº„Ç∂„Éº„ÅÆÈÅ∏Êäû„ÇíÂæÖ„Å§
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('„É¶„Éº„Ç∂„Éº„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„ÇíÂèó„ÅëÂÖ•„Çå„Åæ„Åó„Åü');
                    } else {
                        console.log('„É¶„Éº„Ç∂„Éº„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„ÇíÊãíÂê¶„Åó„Åæ„Åó„Åü');
                    }
                    deferredPrompt = null;
                });
            }
        }
        
        // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showCameraModal(medId, mealTime, overdueDate = null) {
            currentMedId = medId;
            currentMealTime = mealTime;
            currentOverdueDate = overdueDate;
            
            const modal = document.getElementById('camera-modal');
            resetCameraModal();
            modal.style.display = 'block';
        }
        
        // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´„Çí„É™„Çª„ÉÉ„Éà
        function resetCameraModal() {
            const capturedImage = document.getElementById('captured-image');
            const analysisResult = document.getElementById('analysis-result');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            const confirmSection = document.getElementById('medication-confirm-section');
            const initialButtons = document.getElementById('camera-initial-buttons');
            const fileInput = document.getElementById('camera-input');
            
            // Ë°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
            capturedImage.style.display = 'none';
            analysisResult.style.display = 'none';
            captureBtn.style.display = 'block';
            retakeBtn.style.display = 'none';
            confirmSection.style.display = 'none';
            initialButtons.style.display = 'block';
            fileInput.value = '';
        }
        
        // „Ç´„É°„É©„É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫
        function hideCameraModal() {
            const modal = document.getElementById('camera-modal');
            modal.style.display = 'none';
            
            currentMedId = null;
            currentMealTime = null;
        }
        
        // OS„Ç´„É°„É©„Ç¢„Éó„É™„ÇíËµ∑Âãï
        function openCameraApp() {
            // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: „Ç´„É°„É©‰ΩøÁî®ËøΩË∑°
            if (analyticsManager) {
                analyticsManager.trackCameraUsage('capture_started');
            }
            
            const fileInput = document.getElementById('camera-input');
            fileInput.click();
        }
        
        // ÂÜôÁúü„Ç≠„É£„Éó„ÉÅ„É£Âá¶ÁêÜ
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageDataUrl = e.target.result;
                
                // ÊíÆÂΩ±„Åó„ÅüÁîªÂÉè„ÇíË°®Á§∫
                const capturedImage = document.getElementById('captured-image');
                const captureBtn = document.getElementById('capture-btn');
                const retakeBtn = document.getElementById('retake-btn');
                
                capturedImage.src = imageDataUrl;
                capturedImage.style.display = 'block';
                
                // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
                captureBtn.style.display = 'none';
                retakeBtn.style.display = 'block';
                
                // ÁîªÂÉèËß£Êûê„ÇíÂÆüË°å
                analyzeImage(imageDataUrl);
            };
            reader.readAsDataURL(file);
        }
        
        // ÊíÆ„ÇäÁõ¥„Åó
        function retakePhoto() {
            resetCameraModal();
        }
        
        // ÁîªÂÉèÂúßÁ∏Æ„Å®‰øùÂ≠ò
        async function analyzeImage(imageDataUrl) {
            // ÁîªÂÉèÂúßÁ∏Æ
            const compressedImage = await compressImage(imageDataUrl);
            
            // ÂúßÁ∏Æ„Åó„ÅüÁîªÂÉè„Çí‰∏ÄÊôÇ‰øùÂ≠ò
            sessionStorage.setItem('tempMedicationImage', compressedImage);
            
            // ÊúçÁî®Á¢∫Ë™ç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
            showMedicationConfirmSection();
        }
        
        // ÊúçÁî®Á¢∫Ë™ç„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
        function showMedicationConfirmSection() {
            const med = medications.find(m => m.id === currentMedId);
            if (!med) return;
            
            // Ëñ¨Ââ§ÊÉÖÂ†±„ÇíË°®Á§∫
            document.getElementById('confirm-med-name').textContent = med.name;
            
            // Áî®Èáè„ÇíËß£Êûê„Åó„Å¶Êï∞ÂÄ§„Å®Âçò‰Ωç„Å´ÂàÜ„Åë„Çã
            const dosageMatch = med.dosage.match(/(\d+)(.+)/);
            const dosageNumber = dosageMatch ? dosageMatch[1] : '1';
            const dosageUnit = dosageMatch ? dosageMatch[2] : 'Èå†';
            
            document.getElementById('confirm-dosage').value = dosageNumber;
            document.getElementById('confirm-dosage-unit').textContent = dosageUnit;
            document.getElementById('confirm-current-stock').textContent = med.stock + dosageUnit;
            
            // ÊúçÁî®Êï∞ÈáèÂ§âÊõ¥ÊôÇ„ÅÆÂú®Â∫´Ë®àÁÆó
            updateRemainingStock();
            document.getElementById('confirm-dosage').addEventListener('input', updateRemainingStock);
            
            // UI„ÇíÂàá„ÇäÊõø„Åà
            document.getElementById('medication-confirm-section').style.display = 'block';
            document.getElementById('camera-initial-buttons').style.display = 'none';
        }
        
        // ÊÆã„ÇäÂú®Â∫´„ÇíÊõ¥Êñ∞
        function updateRemainingStock() {
            const med = medications.find(m => m.id === currentMedId);
            if (!med) return;
            
            const dosageInput = document.getElementById('confirm-dosage');
            const takingAmount = parseInt(dosageInput.value) || 1;
            const remaining = med.stock - takingAmount;
            
            const remainingElement = document.getElementById('confirm-remaining-stock');
            remainingElement.textContent = remaining + document.getElementById('confirm-dosage-unit').textContent;
            
            // Âú®Â∫´‰∏çË∂≥„ÅÆÂ†¥Âêà„ÅØË≠¶ÂëäË°®Á§∫
            if (remaining < 0) {
                remainingElement.style.color = '#f56565';
            } else if (remaining <= med.alertThreshold) {
                remainingElement.style.color = '#ed8936';
            } else {
                remainingElement.style.color = '#38a169';
            }
        }
        
        // ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÁîªÂÉèÂúßÁ∏ÆÈñ¢Êï∞
        async function compressImage(dataUrl, maxWidth = 800, quality = 0.7) {
            // PerformanceManager„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÅØÊúÄÈÅ©ÂåñÁâà„Çí‰ΩøÁî®
            if (window.performanceManager) {
                const type = maxWidth <= 300 ? 'thumbnail' : maxWidth <= 400 ? 'medication' : 'history';
                return window.performanceManager.optimizedCompressImage(dataUrl, type, {
                    maxWidth: maxWidth,
                    quality: quality
                });
            }
            
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Êó¢Â≠ò„ÅÆÂúßÁ∏ÆÊ©üËÉΩ
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Çí‰øùÊåÅ„Åó„Å™„Åå„Çâ„É™„Çµ„Ç§„Ç∫
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ÂúßÁ∏ÆÂæå„ÅÆ„Éá„Éº„ÇøURL„ÇíËøî„Åô
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }
        
        // ÁîªÂÉèÂ±•Ê≠¥„ÅÆÊõ¥Êñ∞ÔºàÂè§„ÅÑÁîªÂÉè„ÇíÂâäÈô§Ôºâ
        function cleanupOldPhotos() {
            // 3„É∂ÊúàÔºà90Êó•Ôºâ‰ª•‰∏äÂè§„ÅÑÁîªÂÉè„ÇíÊåÅ„Å§Â±•Ê≠¥„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setDate(threeMonthsAgo.getDate() - 90);
            
            let cleaned = false;
            history.forEach(item => {
                if (item.photo && new Date(item.takenAt) < threeMonthsAgo) {
                    item.photo = null; // Âè§„ÅÑÁîªÂÉè„ÇíÂâäÈô§
                    cleaned = true;
                }
            });
            
            if (cleaned) {
                localStorage.setItem('history', JSON.stringify(history));
                console.log('Âè§„ÅÑÂÜôÁúü„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åó„Åæ„Åó„Åü');
            }
        }
        
        // ÂÜôÁúü„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showPhotoModal(photoUrl) {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <img src="${photoUrl}" alt="ÊúçÁî®ÂÜôÁúü">
            `;
            modal.onclick = function() {
                modal.remove();
            };
            document.body.appendChild(modal);
        }
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        // ÊúçÁî®Á¢∫Ë™çÔºàÂÜôÁúü‰ªò„ÅçÔºâ
        function confirmMedication() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                // Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
                med.stock -= 1;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // ‰∏ÄÊôÇ‰øùÂ≠ò„Åó„ÅüÁîªÂÉè„ÇíÂèñÂæó
                const photo = sessionStorage.getItem('tempMedicationImage');
                
                // Â±•Ê≠¥„Å´ËøΩÂä†ÔºàÂÜôÁúü‰ªò„ÅçÔºâ
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: med.dosage,
                    takenAt: new Date().toISOString(),
                    mealTime: currentMealTime,
                    photoVerified: true,
                    photo: photo // ÂúßÁ∏ÆÊ∏à„ÅøÁîªÂÉè
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: ÊúçÁî®Ë®òÈå≤ËøΩË∑°
                if (analyticsManager) {
                    analyticsManager.trackMedicationTaken(med.id, med.name);
                }
                
                // ‰∏ÄÊôÇ‰øùÂ≠ò„Çí„ÇØ„É™„Ç¢
                sessionStorage.removeItem('tempMedicationImage');
                
                // ÁîªÂÉèÂ±•Ê≠¥„ÇÇÁÆ°ÁêÜ
                updateImageHistory();
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                checkStockWarnings();
                
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                hideCameraModal();
                
                // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                alert('üì∏ ÂÜôÁúü„ÅßÊúçÁî®„ÅåÁ¢∫Ë™ç„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
            }
        }
        
        // ÊúçÁî®Á¢∫Ë™çÔºàÂÜôÁúü‰ªò„ÅçÔºâ
        function confirmMedicationWithPhoto() {
            if (currentMedId && currentMealTime) {
                const med = medications.find(m => m.id === currentMedId);
                if (!med) return;
                
                const takingAmount = parseInt(document.getElementById('confirm-dosage').value) || 1;
                
                // Âú®Â∫´„ÉÅ„Çß„ÉÉ„ÇØ
                if (med.stock < takingAmount) {
                    alert('Âú®Â∫´„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
                    return;
                }
                
                // Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
                med.stock -= takingAmount;
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // ‰∏ÄÊôÇ‰øùÂ≠ò„Åï„Çå„ÅüÂÜôÁúü„ÇíÂèñÂæó
                const tempImage = sessionStorage.getItem('tempMedicationImage');
                
                // Â±•Ê≠¥„Å´ËøΩÂä†„ÄÄ
                const historyItem = {
                    medicationId: currentMedId,
                    medicationName: med.name,
                    dosage: takingAmount + document.getElementById('confirm-dosage-unit').textContent,
                    takenAt: new Date().toISOString(),
                    date: currentOverdueDate || new Date().toISOString(),
                    mealTime: currentMealTime,
                    action: 'taken',
                    photoVerified: true,
                    photo: tempImage
                };
                history.push(historyItem);
                localStorage.setItem('history', JSON.stringify(history));
                
                // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: ÊúçÁî®Ë®òÈå≤ËøΩË∑°
                if (analyticsManager) {
                    analyticsManager.trackMedicationTaken(med.id, med.name);
                }
                
                // ‰∏ÄÊôÇ‰øùÂ≠ò„Çí„ÇØ„É™„Ç¢
                sessionStorage.removeItem('tempMedicationImage');
                
                // ÁîªÂÉèÂ±•Ê≠¥„ÇÇÁÆ°ÁêÜ
                cleanupOldPhotos();
                
                // UI„ÇíÊõ¥Êñ∞
                updateTodayMedications();
                checkStockWarnings();
                
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                hideCameraModal();
                
                // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                alert('üì∏ ÊúçÁî®„ÅåË®òÈå≤„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                
                // Â±•Ê≠¥„Éö„Éº„Ç∏„Å´ÁßªÂãï
                showPage('history');
                updateHistoryList();
            }
        }
        
        // Ëñ¨„Çí„Çπ„Ç≠„ÉÉ„Éó„Åô„ÇãÈñ¢Êï∞
        function skipMedication(medId, mealTime, overdueDate) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            if (!confirm(`${med.name} - ${mealTime}„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÅãÔºü\nÂú®Â∫´„ÅØÊ∏õ„Çâ„Åö„ÄÅË≠¶Âëä„ÇÇÊ∂à„Åà„Åæ„Åô„ÄÇ`)) {
                return;
            }
            
            // „Çπ„Ç≠„ÉÉ„ÉóÂ±•Ê≠¥„ÇíËøΩÂä†ÔºàÂú®Â∫´„ÅØÊ∏õ„Çâ„Åï„Å™„ÅÑÔºâ
            const historyItem = {
                medicationId: medId,
                medicationName: med.name,
                dosage: med.dosage || '1Èå†',
                takenAt: new Date().toISOString(),
                date: overdueDate || new Date().toISOString(),
                mealTime: mealTime,
                action: 'skipped',
                photoVerified: false,
                photo: null
            };
            
            history.push(historyItem);
            localStorage.setItem('history', JSON.stringify(history));
            
            // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: „Çπ„Ç≠„ÉÉ„ÉóË®òÈå≤ËøΩË∑°
            if (analyticsManager) {
                analyticsManager.trackEvent('medication_skipped', {
                    medication_id: medId,
                    medication_name: med.name,
                    meal_time: mealTime
                });
            }
            
            // UI„ÇíÊõ¥Êñ∞ÔºàË≠¶Âëä„ÅåÊ∂à„Åà„ÇãÔºâ
            updateTodayMedications();
            
            alert(`‚úÖ ${med.name} - ${mealTime}„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åó„Åü„ÄÇ`);
        }
        
        // Â±•Ê≠¥„Éì„É•„ÉºÂàá„ÇäÊõø„Åà
        function showHistoryView(viewType) {
            const listView = document.getElementById('history-list');
            const galleryView = document.getElementById('history-gallery');
            const listBtn = document.getElementById('list-view-btn');
            const galleryBtn = document.getElementById('gallery-view-btn');
            
            if (viewType === 'list') {
                listView.style.display = 'block';
                galleryView.style.display = 'none';
                listBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                listBtn.style.color = 'white';
                galleryBtn.style.background = '#e2e8f0';
                galleryBtn.style.color = '#4a5568';
                updateHistoryList();
            } else {
                listView.style.display = 'none';
                galleryView.style.display = 'block';
                listBtn.style.background = '#e2e8f0';
                listBtn.style.color = '#4a5568';
                galleryBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                galleryBtn.style.color = 'white';
                updateHistoryGallery();
            }
        }
        
        // ÂÜôÁúü„ÇÆ„É£„É©„É™„Éº„ÅÆÊõ¥Êñ∞
        function updateHistoryGallery() {
            const container = document.getElementById('history-gallery');
            container.innerHTML = '';
            
            // ÂÜôÁúü‰ªò„Åç„ÅÆÂ±•Ê≠¥„ÅÆ„Åø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const photoHistory = history.filter(h => !h.cancelled && h.photo);
            
            if (photoHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ÂÜôÁúü‰ªò„Åç„ÅÆÊúçËñ¨Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            // Êñ∞„Åó„ÅÑÈ†Ü„Å´Ë°®Á§∫
            container.innerHTML = '<div class="history-gallery">' + 
                photoHistory.slice().reverse().map(item => {
                    const date = new Date(item.takenAt);
                    const dateStr = date.toLocaleDateString('ja-JP');
                    const timeStr = date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                    
                    return `
                        <div class="gallery-item">
                            <img src="${item.photo}" onclick="showPhotoModal('${item.photo}')" alt="ÊúçÁî®ÂÜôÁúü">
                            <div class="gallery-item-info">
                                <div class="gallery-item-date">${dateStr} ${timeStr}</div>
                                <div class="gallery-item-med">${item.medicationName}</div>
                                <div class="gallery-item-med">${item.mealTime}</div>
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
        }
        
        // Ëñ¨„ÅÆÁ∑®ÈõÜ
        function editMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            // ÁèæÂú®„ÅÆÂÄ§„Çí„Éï„Ç©„Éº„É†„Å´Ë®≠ÂÆö
            document.getElementById('med-name').value = med.name;
            
            // Áî®Èáè„ÇíÊï∞Â≠ó„Å®Âçò‰Ωç„Å´ÂàÜÂâ≤
            const dosageMatch = med.dosage.match(/(\d+)(.+)/);
            if (dosageMatch) {
                document.getElementById('med-dosage-number').value = dosageMatch[1];
                document.getElementById('med-dosage-unit').value = dosageMatch[2];
            }
            
            document.getElementById('med-frequency').value = med.frequency;
            document.getElementById('med-stock').value = med.stock;
            
            // Âú®Â∫´Ë≠¶Âëä„Åó„Åç„ÅÑÂÄ§„ÇíË®≠ÂÆö
            const threshold = med.alertThreshold || 7;
            if (threshold >= 1 && threshold <= 10) {
                document.getElementById('med-alert-threshold-select').value = threshold.toString();
                document.getElementById('med-alert-threshold-custom').style.display = 'none';
                document.getElementById('med-alert-threshold-custom').required = false;
            } else {
                document.getElementById('med-alert-threshold-select').value = 'custom';
                document.getElementById('med-alert-threshold-custom').value = threshold;
                document.getElementById('med-alert-threshold-custom').style.display = 'block';
                document.getElementById('med-alert-threshold-custom').required = true;
            }
            
            // Áî®ÈÄî„ÇíË®≠ÂÆö
            if (med.purpose) {
                const standardPurposes = ['È†≠Áóõ„ÉªËß£ÁÜ±', 'ËÉÉËÖ∏Ëñ¨', 'È¢®ÈÇ™Ëñ¨', '„Ç¢„É¨„É´„ÇÆ„Éº', '„Éì„Çø„Éü„É≥„Éª„Çµ„Éó„É™„É°„É≥„Éà', 'È´òË°ÄÂúß', 'Á≥ñÂ∞øÁóÖ', 'ÊäóÁîüÁâ©Ë≥™', 'Áù°Áú†Ëñ¨'];
                if (standardPurposes.includes(med.purpose)) {
                    document.getElementById('med-purpose-select').value = med.purpose;
                    document.getElementById('med-purpose-custom').style.display = 'none';
                    document.getElementById('med-purpose-custom').required = false;
                } else {
                    document.getElementById('med-purpose-select').value = 'custom';
                    document.getElementById('med-purpose-custom').value = med.purpose;
                    document.getElementById('med-purpose-custom').style.display = 'block';
                    document.getElementById('med-purpose-custom').required = true;
                }
            } else {
                document.getElementById('med-purpose-select').value = '';
                document.getElementById('med-purpose-custom').style.display = 'none';
                document.getElementById('med-purpose-custom').required = false;
            }
            
            // ÂÜôÁúü„ÇíË®≠ÂÆö
            if (med.photo) {
                const preview = document.getElementById('med-photo-preview');
                const thumbnail = document.getElementById('med-photo-thumbnail');
                
                thumbnail.src = med.photo;
                preview.style.display = 'block';
                preview.dataset.photo = med.photo;
            } else {
                removeMedicationPhoto();
            }
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
            document.getElementById('add-modal').style.display = 'block';
            document.getElementById('add-modal').dataset.editId = medId;
            document.querySelector('#add-modal h3').textContent = 'Ëñ¨„ÅÆÊÉÖÂ†±„ÇíÁ∑®ÈõÜ';
        }
        
        // Ëñ¨„ÅÆÂâäÈô§
        function deleteMedication(medId) {
            const med = medications.find(m => m.id === medId);
            if (!med) return;
            
            if (confirm(`„Äå${med.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\\n„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
                medications = medications.filter(m => m.id !== medId);
                localStorage.setItem('medications', JSON.stringify(medications));
                
                // UI„ÇíÊõ¥Êñ∞
                updateMedicationsList();
                updateTodayMedications();
                checkStockWarnings();
                
                alert('‚úÖ Ëñ¨„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
            }
        }
        
        
        
        // ÂÆöÊúüÁöÑ„Å´ÁîªÈù¢„ÇíÊõ¥Êñ∞Ôºà1ÂàÜ„Åî„Å®Ôºâ
        setInterval(() => {
            if (document.getElementById('home-page').classList.contains('active')) {
                updateTodayMedications();
                checkStockWarnings();
            }
            // Âú®Â∫´Âàá„ÇåÈÄöÁü•„ÇÇÂÆöÊúüÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
            checkLowStockNotifications();
        }, 60000);
        
        // ÂÆöÊúüÁöÑ„Å´Âè§„ÅÑÂÜôÁúü„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºà1Êó•1ÂõûÔºâ
        setInterval(() => {
            cleanupOldPhotos();
        }, 24 * 60 * 60 * 1000); // 24ÊôÇÈñì„Åî„Å®
        
        // FirebaseË™çË®ºÈñ¢Êï∞Áæ§
        async function handleLogin(email, password) {
            try {
                showMessage('login-message', '„É≠„Ç∞„Ç§„É≥‰∏≠...', 'info');
                
                const userCredential = await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                if (!user.emailVerified) {
                    showMessage('login-message', '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅÆË™çË®º„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁ¢∫Ë™ç„É°„Éº„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    await window.signOut(window.firebaseAuth);
                    return;
                }
                
                showMessage('login-message', '„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                
                // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: „É¶„Éº„Ç∂„Éº„É≠„Ç∞„Ç§„É≥ËøΩË∑°
                if (analyticsManager) {
                    analyticsManager.setUser(user.uid, {
                        email: user.email,
                        display_name: user.displayName,
                        provider: 'oauth'
                    });
                }
                currentUser = user;
                isAuthenticated = true;
                
                setTimeout(() => {
                    hideAuthContainer();
                    showAppContainer();
                }, 1000);
                
            } catch (error) {
                console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
                showMessage('login-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handleRegister(email, password, passwordConfirm) {
            if (password !== passwordConfirm) {
                showMessage('register-message', '„Éë„Çπ„ÉØ„Éº„Éâ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('register-message', '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            try {
                showMessage('register-message', 'ÁôªÈå≤‰∏≠...', 'info');
                
                const userCredential = await window.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                
                // „É°„Éº„É´Ë™çË®ºÈÄÅ‰ø°
                await window.sendEmailVerification(user);
                
                showMessage('register-message', 'ÁôªÈå≤ÂÆå‰∫ÜÔºÅÁ¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„ÅÆ„É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
                
                // 2ÁßíÂæå„Å´„É≠„Ç∞„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çã
                setTimeout(() => {
                    showLoginPage();
                }, 3000);
                
            } catch (error) {
                console.error('ÁôªÈå≤„Ç®„É©„Éº:', error);
                showMessage('register-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handlePasswordReset() {
            const email = prompt('ÁôªÈå≤Ê∏à„Åø„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
            if (!email) return;

            try {
                await window.sendPasswordResetEmail(window.firebaseAuth, email);
                showMessage('login-message', '„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                console.error('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                showMessage('login-message', getAuthErrorMessage(error.code), 'error');
            }
        }

        async function handleLogout() {
            try {
                await window.signOut(window.firebaseAuth);
                currentUser = null;
                isAuthenticated = false;
                showAuthContainer();
                hideAppContainer();
                showMessage('login-message', '„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'info');
            } catch (error) {
                console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
            }
        }

        // UIÂàá„ÇäÊõø„ÅàÈñ¢Êï∞
        function showLoginPage() {
            document.querySelectorAll('#auth-container .page').forEach(page => page.classList.remove('active'));
            document.getElementById('login-page').classList.add('active');
            clearMessages();
        }

        function showRegisterPage() {
            document.querySelectorAll('#auth-container .page').forEach(page => page.classList.remove('active'));
            document.getElementById('register-page').classList.add('active');
            clearMessages();
        }

        function showPasswordReset() {
            handlePasswordReset();
        }

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('app-container').style.display = 'none';
        }

        function hideAuthContainer() {
            document.getElementById('auth-container').style.display = 'none';
        }

        function showAppContainer() {
            document.getElementById('app-container').style.display = 'block';
            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
            if (currentUser) {
                document.getElementById('current-user-email').textContent = currentUser.email;
            }
            // „É°„Ç§„É≥„Ç¢„Éó„É™„ÇíÂàùÊúüÂåñ
            updateTodayMedications();
            updateMedicationsList();
            checkStockWarnings();
        }

        function hideAppContainer() {
            document.getElementById('app-container').style.display = 'none';
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showMessage(elementId, message, type) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = message;
            messageEl.className = `form-message ${type}`;
            messageEl.style.display = 'block';
        }

        function clearMessages() {
            document.querySelectorAll('.form-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
        }

        // FirebaseË™çË®º„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/email-already-in-use': '„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô',
                'auth/weak-password': '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÂº±„Åô„Åé„Åæ„ÅôÔºà6ÊñáÂ≠ó‰ª•‰∏äÂøÖË¶ÅÔºâ',
                'auth/invalid-email': 'ÁÑ°Âäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„Åô',
                'auth/user-not-found': '„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
                'auth/wrong-password': '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô',
                'auth/too-many-requests': '„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§ö„Åô„Åé„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                'auth/network-request-failed': '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü',
                'auth/invalid-credential': '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô'
            };
            return errorMessages[errorCode] || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
        }

        // „Éï„Ç©„Éº„É†„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', () => {
            // „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await handleLogin(email, password);
            });

            // Êñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É†
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;
                await handleRegister(email, password, passwordConfirm);
            });

            // FirebaseË™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
            window.onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user && user.emailVerified) {
                    currentUser = user;
                    isAuthenticated = true;
                    hideAuthContainer();
                    showAppContainer();
                } else {
                    currentUser = null;
                    isAuthenticated = false;
                    showAuthContainer();
                    hideAppContainer();
                }
            });
        });

        // ÂÜôÁúü„É¢„Éº„ÉÄ„É´Ë°®Á§∫Ê©üËÉΩ
        function showPhotoModal(photoUrl) {
            // „É¢„Éº„ÉÄ„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
            let modal = document.getElementById('photo-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'photo-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.9);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                    cursor: pointer;
                `;
                
                const img = document.createElement('img');
                img.id = 'photo-modal-img';
                img.style.cssText = `
                    max-width: 90vw;
                    max-height: 90vh;
                    object-fit: contain;
                    border-radius: 10px;
                `;
                
                modal.appendChild(img);
                document.body.appendChild(modal);
                
                // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
                modal.addEventListener('click', hidePhotoModal);
            }
            
            // ÂÜôÁúü„ÇíË®≠ÂÆö„Åó„Å¶Ë°®Á§∫
            document.getElementById('photo-modal-img').src = photoUrl;
            modal.style.display = 'flex';
        }
        
        // ÂÜôÁúü„É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫
        function hidePhotoModal() {
            const modal = document.getElementById('photo-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // „Ç¢„Éó„É™Ëµ∑ÂãïÊôÇ„Å´„ÇÇÂÆüË°å
        cleanupOldPhotos();

        // Â∫ÉÂëäÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
        class AdManager {
            constructor() {
                this.adProviders = ['google-adsense', 'facebook-ads', 'amazon-ads'];
                this.currentProvider = 0;
                this.adRefreshInterval = 30000; // 30Áßí
                this.init();
            }

            init() {
                this.loadAd();
                // ÂÆöÊúüÁöÑ„Å™Â∫ÉÂëäÊõ¥Êñ∞
                setInterval(() => this.loadAd(), this.adRefreshInterval);
            }

            async loadAd() {
                const adBanner = document.getElementById('ad-banner');
                const adContent = document.getElementById('ad-content');
                
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
                adBanner.classList.add('loading');
                adContent.innerHTML = 'Â∫ÉÂëä„ÇíË™≠„ÅøËæº„Åø‰∏≠...';

                // ÂÆüÈöõ„ÅÆÂ∫ÉÂëä„Éó„É≠„Éê„Ç§„ÉÄ„ÉºÊé•Á∂ö„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
                setTimeout(() => {
                    this.displayPlaceholderAd();
                    adBanner.classList.remove('loading');
                }, 1000);
            }

            displayPlaceholderAd() {
                const adContent = document.getElementById('ad-content');
                const ads = [
                    'üè• ÂÅ•Â∫∑ÁÆ°ÁêÜ„Ç¢„Éó„É™ - 30% OFF!',
                    'üíä Ëñ¨Â±ÄÈÖçÈÄÅ„Çµ„Éº„Éì„Çπ - ÈÄÅÊñôÁÑ°Êñô',
                    'ü©∫ „Ç™„É≥„É©„Ç§„É≥Ë®∫ÁôÇ - ÂàùÂõûÁÑ°ÊñôÁõ∏Ë´á',
                    'üì± ÂÅ•Â∫∑„Ç∞„ÉÉ„Ç∫ÁâπÈõÜ - ÊúüÈñìÈôêÂÆöÂâ≤Âºï'
                ];
                
                const randomAd = ads[Math.floor(Math.random() * ads.length)];
                adContent.innerHTML = `<a href="#" style="text-decoration: none; color: inherit;">${randomAd}</a>`;
            }

            // Â∞ÜÊù•ÁöÑ„Å™Google AdSenseÁµ±ÂêàÁî®„É°„ÇΩ„ÉÉ„Éâ
            initGoogleAdsense() {
                // Google AdSense„ÅÆÂàùÊúüÂåñ„Ç≥„Éº„Éâ
                // (adsbygoogle = window.adsbygoogle || []).push({});
            }

            // Â∫ÉÂëä„ÇØ„É™„ÉÉ„ÇØËøΩË∑°
            trackAdClick(adId, provider) {
                console.log(`Ad clicked: ${adId} from ${provider}`);
                // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ„Å´ÈÄÅ‰ø°
            }
        }

        // Â∫ÉÂëä„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ
        const adManager = new AdManager();

        // Firebase OAuthË™çË®º„Ç∑„Çπ„ÉÜ„É†
        class OAuthManager {
            constructor() {
                // FirebaseË®≠ÂÆö
                this.firebaseConfig = {
                    apiKey: "AIzaSyD6_2ioXr3LJU7PpThy7kxXbCfEFatUi_U",
                    authDomain: "medication-tracker-b5d0c.firebaseapp.com",
                    projectId: "medication-tracker-b5d0c",
                    storageBucket: "medication-tracker-b5d0c.firebasestorage.app",
                    messagingSenderId: "112454739779",
                    appId: "1:112454739779:web:225df0ffd166882c1931f6",
                    measurementId: "G-0LPF5Y8NPR"
                };
                
                // Apple Developer Program „ÅßË®≠ÂÆö„Åó„Åü Service ID
                this.appleClientId = 'com.medicationtracker.signin';
                
                this.init();
            }

            async init() {
                // Firebase SDK „ÅÆÂàùÊúüÂåñ
                await this.loadFirebaseSDK();
                // Apple Sign-In API „ÅÆÂàùÊúüÂåñ
                await this.loadAppleAPI();
            }

            async loadFirebaseSDK() {
                return new Promise((resolve) => {
                    // Firebase SDK „ÅÆ„Çπ„ÇØ„É™„Éó„Éà„É≠„Éº„Éá„Ç£„É≥„Ç∞
                    if (window.firebase) {
                        resolve();
                        return;
                    }
                    
                    // Firebase v9 SDK („É¢„Ç∏„É•„É©„ÉºÁâà) „ÇíCDN„Åã„ÇâË™≠„ÅøËæº„Åø
                    const script = document.createElement('script');
                    script.type = 'module';
                    script.innerHTML = `
                        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
                        import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
                        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
                        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';
                        import { getAnalytics, logEvent, setUserId, setUserProperties } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js';
                        
                        // FirebaseÂàùÊúüÂåñ
                        const firebaseConfig = ${JSON.stringify(this.firebaseConfig)};
                        window.firebaseApp = initializeApp(firebaseConfig);
                        window.firebaseAuth = getAuth(window.firebaseApp);
                        window.firebaseDb = getFirestore(window.firebaseApp);
                        window.firebaseStorage = getStorage(window.firebaseApp);
                        window.firebaseAnalytics = getAnalytics(window.firebaseApp);
                        
                        // Firebase Auth
                        window.GoogleAuthProvider = GoogleAuthProvider;
                        window.signInWithPopup = signInWithPopup;
                        
                        // Firebase Firestore
                        window.firestoreDoc = doc;
                        window.firestoreSetDoc = setDoc;
                        window.firestoreGetDoc = getDoc;
                        window.firestoreCollection = collection;
                        window.firestoreAddDoc = addDoc;
                        window.firestoreQuery = query;
                        window.firestoreWhere = where;
                        window.firestoreGetDocs = getDocs;
                        window.firestoreOnSnapshot = onSnapshot;
                        window.firestoreServerTimestamp = serverTimestamp;
                        
                        // Firebase Storage
                        window.firebaseStorageRef = ref;
                        window.firebaseUploadBytes = uploadBytes;
                        window.firebaseGetDownloadURL = getDownloadURL;
                        window.firebaseDeleteObject = deleteObject;
                        
                        // Firebase Analytics
                        window.firebaseLogEvent = logEvent;
                        window.firebaseSetUserId = setUserId;
                        window.firebaseSetUserProperties = setUserProperties;
                        
                        console.log('Firebase SDK (Auth + Firestore + Storage + Analytics) ÂàùÊúüÂåñÂÆå‰∫Ü');
                        window.firebaseReady = true;
                    `;
                    
                    document.head.appendChild(script);
                    
                    // ÂàùÊúüÂåñÂÆå‰∫Ü„ÇíÂæÖÊ©ü
                    const checkReady = () => {
                        if (window.firebaseReady) {
                            resolve();
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    checkReady();
                });
            }

            async loadAppleAPI() {
                return new Promise((resolve) => {
                    // Apple Sign-In API „ÅÆ„Çπ„ÇØ„É™„Éó„Éà„É≠„Éº„Éá„Ç£„É≥„Ç∞
                    if (window.AppleID) {
                        resolve();
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = 'https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/ja_JP/appleid.auth.js';
                    script.onload = () => {
                        if (window.AppleID) {
                            try {
                                window.AppleID.auth.init({
                                    clientId: this.appleClientId,
                                    scope: 'name email',
                                    redirectURI: window.location.origin,
                                    state: 'signin',
                                    usePopup: true
                                });
                                console.log('Apple Sign-In APIÂàùÊúüÂåñÂÆå‰∫Ü');
                            } catch (error) {
                                console.error('Apple Sign-In APIÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                            }
                        }
                        resolve();
                    };
                    script.onerror = () => {
                        console.error('Apple Sign-In API„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                        resolve();
                    };
                    document.head.appendChild(script);
                });
            }

            async signInWithGoogle() {
                try {
                    if (!window.firebaseReady || !window.firebaseAuth) {
                        throw new Error('Firebase SDK„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    // Firebase GoogleË™çË®º„Éó„É≠„Éê„Ç§„ÉÄ„Éº„Çí‰ΩúÊàê
                    const provider = new window.GoogleAuthProvider();
                    
                    // FirebaseË™çË®º„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Çµ„Ç§„É≥„Ç§„É≥
                    const result = await window.signInWithPopup(window.firebaseAuth, provider);
                    
                    // Ë™çË®ºÊàêÂäüÊôÇ„ÅÆÂá¶ÁêÜ
                    const user = result.user;
                    const userData = {
                        id: user.uid,
                        email: user.email,
                        name: user.displayName,
                        picture: user.photoURL,
                        provider: 'google'
                    };
                    
                    this.processOAuthSignIn(userData);
                    
                } catch (error) {
                    console.error('Firebase Google Sign-In „Ç®„É©„Éº:', error);
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        console.log('„É¶„Éº„Ç∂„Éº„Åå„Çµ„Ç§„É≥„Ç§„É≥„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü');
                    } else if (error.code === 'auth/popup-blocked') {
                        alert('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    } else {
                        alert('GoogleË™çË®º„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                    }
                }
            }


            async signInWithApple() {
                try {
                    if (!window.AppleID) {
                        throw new Error('Apple Sign-In API„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    }

                    const data = await window.AppleID.auth.signIn();
                    this.handleAppleSignIn(data);
                } catch (error) {
                    console.error('Apple Sign-In „Ç®„É©„Éº:', error);
                    
                    // Apple Sign In „ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅÆÂá¶ÁêÜ
                    if (error.error === 'popup_closed_by_user') {
                        console.log('„É¶„Éº„Ç∂„Éº„ÅåApple Sign-In„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü');
                    } else {
                        alert('Apple Sign-In„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\n\nApple Developer Program„Åß„ÅÆË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                    }
                }
            }


            handleAppleSignIn(response) {
                try {
                    const userData = {
                        id: response.user,
                        email: response.email,
                        name: response.fullName ? `${response.fullName.givenName} ${response.fullName.familyName}` : '',
                        provider: 'apple'
                    };
                    
                    this.processOAuthSignIn(userData);
                } catch (error) {
                    console.error('Apple Sign-In „É¨„Çπ„Éù„É≥„ÇπÂá¶ÁêÜ„Ç®„É©„Éº:', error);
                }
            }

            processOAuthSignIn(userData) {
                try {
                    // „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
                    const existingUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];
                    
                    // Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    let user = existingUsers.find(u => u.email === userData.email);
                    
                    if (!user) {
                        // Êñ∞Ë¶è„É¶„Éº„Ç∂„Éº„Å®„Åó„Å¶ÁôªÈå≤
                        user = {
                            ...userData,
                            registeredAt: new Date().toISOString(),
                            isOAuthUser: true
                        };
                        existingUsers.push(user);
                        localStorage.setItem('registeredUsers', JSON.stringify(existingUsers));
                    } else {
                        // Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„ÅÆÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                        user.lastLoginAt = new Date().toISOString();
                        user.provider = userData.provider;
                        if (userData.picture) user.picture = userData.picture;
                        
                        const userIndex = existingUsers.findIndex(u => u.email === userData.email);
                        existingUsers[userIndex] = user;
                        localStorage.setItem('registeredUsers', JSON.stringify(existingUsers));
                    }
                    
                    // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÇíË®≠ÂÆö
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    // ÊàêÂäüÈÄöÁü•„ÇíË°®Á§∫
                    this.showSignInSuccess(userData.provider === 'google' ? 'Google' : 'Apple', userData);
                    
                    // „É°„Ç§„É≥„Ç¢„Éó„É™„Å´ÈÅ∑Áßª
                    setTimeout(() => {
                        this.showMainApp();
                    }, 1000);
                } catch (error) {
                    console.error('OAuth „Çµ„Ç§„É≥„Ç§„É≥Âá¶ÁêÜ„Ç®„É©„Éº:', error);
                    alert('„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
            }

            showMainApp() {
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                showPage('medications');
            }

            // „Çµ„Ç§„É≥„Ç§„É≥ÊàêÂäüÊôÇ„ÅÆÂá¶ÁêÜ
            showSignInSuccess(provider, userData) {
                // „Çµ„Ç§„É≥„Ç§„É≥ÂÆå‰∫ÜÈÄöÁü•
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                notification.textContent = `${provider}„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü`;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 3000);
            }
        }

        // OAuthË™çË®ºÈñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´Ôºâ
        let oauthManager;

        function signInWithGoogle() {
            if (!oauthManager) {
                oauthManager = new OAuthManager();
            }
            oauthManager.signInWithGoogle();
        }

        function signInWithApple() {
            if (!oauthManager) {
                oauthManager = new OAuthManager();
            }
            oauthManager.signInWithApple();
        }

        // OAuth „Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            oauthManager = new OAuthManager();
        });

        // Firebase Firestore „ÇØ„É©„Ç¶„Éâ„Éá„Éº„ÇøÂêåÊúü„Ç∑„Çπ„ÉÜ„É†
        class CloudSyncManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.syncQueue = [];
                this.lastSyncTime = localStorage.getItem('lastSyncTime') || '0';
                this.init();
            }

            async init() {
                // FirebaseÊ∫ñÂÇôÂÆå‰∫Ü„ÇíÂæÖÊ©ü
                await this.waitForFirebase();
                this.setupEventListeners();
                
                // Ë™çË®º„É¶„Éº„Ç∂„Éº„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†„É™„Çπ„Éä„ÉºË®≠ÂÆö
                this.setupAuthListener();
                
                // Ëá™ÂãïÂêåÊúü„ÅÆË®≠ÂÆö
                setInterval(() => this.autoSync(), 60000); // 1ÂàÜ„Åî„Å®
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseReady && window.firebaseDb) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }

            setupAuthListener() {
                // Firebase AuthÁä∂ÊÖãÂ§âÊõ¥„É™„Çπ„Éä„Éº
                if (window.firebaseAuth) {
                    window.firebaseAuth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log('FirebaseË™çË®º„É¶„Éº„Ç∂„Éº:', user.uid);
                            this.startRealTimeSync(user.uid);
                        } else {
                            console.log('FirebaseË™çË®º„Å™„Åó - „É≠„Éº„Ç´„É´„ÅÆ„Åø');
                        }
                    });
                }
            }

            startRealTimeSync(userId) {
                // Ëñ¨„Éá„Éº„Çø„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü
                this.syncMedications(userId);
                // ÊúçÁî®Â±•Ê≠¥„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü
                this.syncMedicationHistory(userId);
                // Ë®≠ÂÆö„Éá„Éº„Çø„ÅÆÂêåÊúü
                this.syncSettings(userId);
            }

            // Ëñ¨„Éá„Éº„Çø„ÅÆFirestoreÂêåÊúü
            async syncMedications(userId) {
                try {
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÂèñÂæó
                    const localMedications = JSON.parse(localStorage.getItem('medications')) || [];
                    
                    // Firestore „Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó
                    const medicationsRef = window.firestoreCollection(window.firebaseDb, `users/${userId}/medications`);
                    const snapshot = await window.firestoreGetDocs(medicationsRef);
                    
                    const cloudMedications = [];
                    snapshot.forEach((doc) => {
                        cloudMedications.push({ id: doc.id, ...doc.data() });
                    });

                    // „Éá„Éº„Çø„Éû„Éº„Ç∏Âá¶ÁêÜ
                    const mergedMedications = this.mergeMedicationData(localMedications, cloudMedications);
                    
                    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇíÊõ¥Êñ∞
                    localStorage.setItem('medications', JSON.stringify(mergedMedications));
                    
                    // Firestore„Å´ÂêåÊúü
                    for (const medication of mergedMedications) {
                        const docRef = window.firestoreDoc(window.firebaseDb, `users/${userId}/medications`, medication.id);
                        await window.firestoreSetDoc(docRef, {
                            ...medication,
                            lastModified: window.firestoreServerTimestamp()
                        });
                    }

                    // ÂÜôÁúü„ÇÇÂêåÊúü
                    await this.syncMedicationPhotos(userId, mergedMedications);

                    console.log('Ëñ¨„Éá„Éº„ÇøÂêåÊúüÂÆå‰∫Ü:', mergedMedications.length + '‰ª∂');
                    this.showSyncStatus('Ëñ¨„Éá„Éº„ÇøÂêåÊúüÂÆå‰∫Ü', 'success');
                    
                    // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: ÂêåÊúüÊàêÂäüËøΩË∑°
                    if (window.analyticsManager) {
                        window.analyticsManager.trackSyncEvent('medications', true);
                    }

                } catch (error) {
                    console.error('Ëñ¨„Éá„Éº„ÇøÂêåÊúü„Ç®„É©„Éº:', error);
                    this.showSyncStatus('Ëñ¨„Éá„Éº„ÇøÂêåÊúüÂ§±Êïó', 'error');
                    
                    // „Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ: ÂêåÊúüÂ§±ÊïóËøΩË∑°
                    if (window.analyticsManager) {
                        window.analyticsManager.trackSyncEvent('medications', false, error.message);
                    }
                }
            }

            mergeMedicationData(localData, cloudData) {
                const merged = [...localData];
                
                // „ÇØ„É©„Ç¶„Éâ„Éá„Éº„Çø„Çí„Éû„Éº„Ç∏
                cloudData.forEach(cloudItem => {
                    const existingIndex = merged.findIndex(item => item.id === cloudItem.id);
                    if (existingIndex >= 0) {
                        // Êõ¥Êñ∞Êó•ÊôÇ„ÅßÂà§Êñ≠
                        const localTime = new Date(merged[existingIndex].lastModified || 0);
                        const cloudTime = new Date(cloudItem.lastModified?.seconds * 1000 || 0);
                        
                        if (cloudTime > localTime) {
                            merged[existingIndex] = cloudItem;
                        }
                    } else {
                        // Êñ∞„Åó„ÅÑ„Ç¢„Ç§„ÉÜ„É†„ÇíËøΩÂä†
                        merged.push(cloudItem);
                    }
                });

                return merged;
            }

            // ÊúçÁî®Â±•Ê≠¥„ÅÆFirestoreÂêåÊúü
            async syncMedicationHistory(userId) {
                try {
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÂèñÂæó
                    const localHistory = JSON.parse(localStorage.getItem('medicationHistory')) || [];
                    
                    // Firestore „Åã„ÇâÊúÄÊñ∞Â±•Ê≠¥„ÇíÂèñÂæó
                    const historyRef = window.firestoreCollection(window.firebaseDb, `users/${userId}/history`);
                    const snapshot = await window.firestoreGetDocs(historyRef);
                    
                    const cloudHistory = [];
                    snapshot.forEach((doc) => {
                        cloudHistory.push({ id: doc.id, ...doc.data() });
                    });

                    // „Éá„Éº„Çø„Éû„Éº„Ç∏Âá¶ÁêÜ
                    const mergedHistory = this.mergeHistoryData(localHistory, cloudHistory);
                    
                    // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇíÊõ¥Êñ∞
                    localStorage.setItem('medicationHistory', JSON.stringify(mergedHistory));
                    
                    // Firestore„Å´ÂêåÊúüÔºàÊñ∞„Åó„ÅÑË®òÈå≤„ÅÆ„ÅøÔºâ
                    for (const record of mergedHistory) {
                        if (!record.synced) {
                            const docRef = window.firestoreDoc(window.firebaseDb, `users/${userId}/history`, record.id);
                            await window.firestoreSetDoc(docRef, {
                                ...record,
                                synced: true,
                                lastModified: window.firestoreServerTimestamp()
                            });
                        }
                    }

                    // ÂÜôÁúü„ÇÇÂêåÊúü
                    await this.syncHistoryPhotos(userId, mergedHistory);

                    console.log('ÊúçÁî®Â±•Ê≠¥ÂêåÊúüÂÆå‰∫Ü:', mergedHistory.length + '‰ª∂');
                    this.showSyncStatus('ÊúçÁî®Â±•Ê≠¥ÂêåÊúüÂÆå‰∫Ü', 'success');

                } catch (error) {
                    console.error('ÊúçÁî®Â±•Ê≠¥ÂêåÊúü„Ç®„É©„Éº:', error);
                    this.showSyncStatus('ÊúçÁî®Â±•Ê≠¥ÂêåÊúüÂ§±Êïó', 'error');
                }
            }

            mergeHistoryData(localData, cloudData) {
                const merged = [...localData];
                
                // „ÇØ„É©„Ç¶„Éâ„Éá„Éº„Çø„Çí„Éû„Éº„Ç∏
                cloudData.forEach(cloudItem => {
                    const exists = merged.find(item => item.id === cloudItem.id);
                    if (!exists) {
                        merged.push(cloudItem);
                    }
                });

                // ÈáçË§á„ÇíÈô§Âéª„Åó„ÄÅÊó•ÊôÇ„Åß„ÇΩ„Éº„Éà
                return merged
                    .filter((item, index, self) => 
                        index === self.findIndex(t => t.id === item.id)
                    )
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            // Ë®≠ÂÆö„Éá„Éº„Çø„ÅÆÂêåÊúü
            async syncSettings(userId) {
                try {
                    const settings = {
                        mealTimeSettings: localStorage.getItem('mealTimeSettings'),
                        userSettings: localStorage.getItem('userSettings')
                    };

                    const settingsRef = window.firestoreDoc(window.firebaseDb, `users/${userId}/settings`, 'userSettings');
                    await window.firestoreSetDoc(settingsRef, {
                        ...settings,
                        lastModified: window.firestoreServerTimestamp()
                    });

                    console.log('Ë®≠ÂÆö„Éá„Éº„ÇøÂêåÊúüÂÆå‰∫Ü');

                } catch (error) {
                    console.error('Ë®≠ÂÆö„Éá„Éº„ÇøÂêåÊúü„Ç®„É©„Éº:', error);
                }
            }

            setupEventListeners() {
                // „Ç™„É≥„É©„Ç§„É≥/„Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncPendingData();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });

                // „Éá„Éº„ÇøÂ§âÊõ¥„ÅÆÁõ£Ë¶ñ
                this.setupDataChangeListeners();
            }

            setupDataChangeListeners() {
                // LocalStorage„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = (key, value) => {
                    originalSetItem.call(localStorage, key, value);
                    this.queueForSync(key, value);
                };
            }

            queueForSync(key, value) {
                // ÂêåÊúüÂØæË±°„ÅÆ„Éá„Éº„Çø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const syncableKeys = ['medications', 'medicationHistory', 'userSettings', 'mealTimeSettings'];
                
                if (syncableKeys.includes(key)) {
                    this.syncQueue.push({
                        key,
                        value,
                        timestamp: Date.now(),
                        action: 'update'
                    });

                    if (this.isOnline) {
                        this.syncPendingData();
                    }
                }
            }

            async syncPendingData() {
                if (this.syncQueue.length === 0) return;

                try {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    if (!currentUser) return;

                    // „Éê„ÉÉ„ÉÅ„Åß„Éá„Éº„Çø„ÇíÂêåÊúü
                    const batchData = {};
                    this.syncQueue.forEach(item => {
                        batchData[item.key] = {
                            data: item.value,
                            timestamp: item.timestamp
                        };
                    });

                    await this.uploadToCloud(currentUser.id, batchData);
                    
                    // ÂêåÊúüÂÆå‰∫ÜÂæå„ÄÅ„Ç≠„É•„Éº„Çí„ÇØ„É™„Ç¢
                    this.syncQueue = [];
                    this.lastSyncTime = Date.now().toString();
                    localStorage.setItem('lastSyncTime', this.lastSyncTime);

                    this.showSyncStatus('ÂêåÊúüÂÆå‰∫Ü', 'success');
                } catch (error) {
                    console.error('„Éá„Éº„ÇøÂêåÊúü„Ç®„É©„Éº:', error);
                    this.showSyncStatus('ÂêåÊúüÂ§±Êïó', 'error');
                }
            }

            // ÊâãÂãïÂêåÊúüÊ©üËÉΩ
            async manualSync() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) {
                    alert('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                try {
                    this.showSyncStatus('ÊâãÂãïÂêåÊúüÈñãÂßã...', 'info');
                    
                    await this.syncMedications(currentUser.id);
                    await this.syncMedicationHistory(currentUser.id);
                    await this.syncSettings(currentUser.id);
                    
                    this.showSyncStatus('ÊâãÂãïÂêåÊúüÂÆå‰∫Ü', 'success');
                    
                    // UIÊõ¥Êñ∞
                    setTimeout(() => {
                        if (typeof loadMedications === 'function') loadMedications();
                        if (typeof loadHistory === 'function') loadHistory();
                    }, 1000);
                    
                } catch (error) {
                    console.error('ÊâãÂãïÂêåÊúü„Ç®„É©„Éº:', error);
                    this.showSyncStatus('ÊâãÂãïÂêåÊúüÂ§±Êïó', 'error');
                }
            }

            async restoreFromCloud() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) return false;

                try {
                    const cloudData = await this.downloadFromCloud(currentUser.id);
                    
                    if (cloudData) {
                        // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Å®„ÇØ„É©„Ç¶„Éâ„Éá„Éº„Çø„ÅÆÊØîËºÉ„Éª„Éû„Éº„Ç∏
                        Object.keys(cloudData).forEach(key => {
                            const localTimestamp = localStorage.getItem(`${key}_timestamp`) || '0';
                            const cloudTimestamp = cloudData[key].timestamp || 0;
                            
                            // „ÇØ„É©„Ç¶„Éâ„ÅÆ„Éá„Éº„Çø„ÅåÊñ∞„Åó„ÅÑÂ†¥Âêà„ÅØÂæ©ÂÖÉ
                            if (cloudTimestamp > parseInt(localTimestamp)) {
                                localStorage.setItem(key, cloudData[key].data);
                                localStorage.setItem(`${key}_timestamp`, cloudTimestamp.toString());
                            }
                        });

                        this.showSyncStatus('„Éá„Éº„ÇøÂæ©ÂÖÉÂÆå‰∫Ü', 'success');
                        return true;
                    }
                } catch (error) {
                    console.error('„Éá„Éº„ÇøÂæ©ÂÖÉ„Ç®„É©„Éº:', error);
                    this.showSyncStatus('„Éá„Éº„ÇøÂæ©ÂÖÉÂ§±Êïó', 'error');
                }
                
                return false;
            }

            async autoSync() {
                if (!this.isOnline) return;
                
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) return;

                // ÂÆöÊúüÁöÑ„Å™ÂèåÊñπÂêëÂêåÊúü
                await this.syncPendingData();
                await this.downloadFromCloud(currentUser.id);
            }

            showSyncStatus(message, type) {
                const statusDiv = document.createElement('div');
                statusDiv.className = `sync-status ${type}`;
                statusDiv.textContent = message;
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 10px 15px;
                    border-radius: 5px;
                    color: white;
                    font-size: 14px;
                    z-index: 1000;
                    ${type === 'success' ? 'background-color: #4CAF50;' : 'background-color: #f44336;'}
                `;

                document.body.appendChild(statusDiv);

                setTimeout(() => {
                    document.body.removeChild(statusDiv);
                }, 3000);
            }

            // ÂÜôÁúü„ÇíFirebase Cloud Storage„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
            async uploadPhoto(userId, photoDataUrl, photoId) {
                try {
                    if (!window.firebaseStorage) {
                        throw new Error('Firebase Storage not initialized');
                    }

                    // Base64„Éá„Éº„Çø„ÇíBlob„Å´Â§âÊèõ
                    const response = await fetch(photoDataUrl);
                    const blob = await response.blob();

                    // Firebase Storage„ÅÆÂèÇÁÖß„Çí‰ΩúÊàê
                    const photoRef = window.firebaseStorageRef(window.firebaseStorage, `users/${userId}/photos/${photoId}.jpg`);

                    // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆüË°å
                    const snapshot = await window.firebaseUploadBytes(photoRef, blob);
                    
                    // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL„ÇíÂèñÂæó
                    const downloadURL = await window.firebaseGetDownloadURL(snapshot.ref);
                    
                    console.log('ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü:', photoId);
                    return downloadURL;

                } catch (error) {
                    console.error('ÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                    throw error;
                }
            }

            // Firebase Cloud Storage„Åã„ÇâÂÜôÁúü„ÇíÂèñÂæó
            async downloadPhoto(userId, photoId) {
                try {
                    if (!window.firebaseStorage) {
                        throw new Error('Firebase Storage not initialized');
                    }

                    const photoRef = window.firebaseStorageRef(window.firebaseStorage, `users/${userId}/photos/${photoId}.jpg`);
                    const downloadURL = await window.firebaseGetDownloadURL(photoRef);
                    
                    // URL„Åã„ÇâÁîªÂÉè„ÇíBlob„ÅßÂèñÂæó„Åó„Å¶Base64„Å´Â§âÊèõ
                    const response = await fetch(downloadURL);
                    const blob = await response.blob();
                    
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });

                } catch (error) {
                    console.error('ÂÜôÁúü„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                    return null;
                }
            }

            // Firebase Cloud Storage„Åã„ÇâÂÜôÁúü„ÇíÂâäÈô§
            async deletePhoto(userId, photoId) {
                try {
                    if (!window.firebaseStorage) {
                        throw new Error('Firebase Storage not initialized');
                    }

                    const photoRef = window.firebaseStorageRef(window.firebaseStorage, `users/${userId}/photos/${photoId}.jpg`);
                    await window.firebaseDeleteObject(photoRef);
                    
                    console.log('ÂÜôÁúüÂâäÈô§ÂÆå‰∫Ü:', photoId);
                    return true;

                } catch (error) {
                    console.error('ÂÜôÁúüÂâäÈô§„Ç®„É©„Éº:', error);
                    return false;
                }
            }

            // Ëñ¨„Éá„Éº„Çø„ÅÆÂêåÊúüÊôÇ„Å´ÂÜôÁúü„ÇÇÂêåÊúü
            async syncMedicationPhotos(userId, medications) {
                try {
                    for (const medication of medications) {
                        if (medication.photo && medication.photo.startsWith('data:')) {
                            // „É≠„Éº„Ç´„É´„ÅÆBase64ÂÜôÁúü„Çí„ÇØ„É©„Ç¶„Éâ„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                            const photoId = medication.id + '_' + Date.now();
                            const cloudURL = await this.uploadPhoto(userId, medication.photo, photoId);
                            
                            // Ëñ¨„Éá„Éº„Çø„ÅÆÂÜôÁúüURL„ÇíÊõ¥Êñ∞
                            medication.photo = cloudURL;
                            medication.photoId = photoId;
                            
                            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇÇÊõ¥Êñ∞
                            const localMedications = JSON.parse(localStorage.getItem('medications') || '[]');
                            const localIndex = localMedications.findIndex(m => m.id === medication.id);
                            if (localIndex >= 0) {
                                localMedications[localIndex] = medication;
                                localStorage.setItem('medications', JSON.stringify(localMedications));
                            }
                        }
                    }
                    
                    this.showSyncStatus('ÂÜôÁúüÂêåÊúüÂÆå‰∫Ü', 'success');
                    
                } catch (error) {
                    console.error('ÂÜôÁúüÂêåÊúü„Ç®„É©„Éº:', error);
                    this.showSyncStatus('ÂÜôÁúüÂêåÊúüÂ§±Êïó', 'error');
                }
            }

            // ÊúçÁî®Â±•Ê≠¥„ÅÆÂÜôÁúü„ÇÇÂêåÊúü
            async syncHistoryPhotos(userId, history) {
                try {
                    for (const record of history) {
                        if (record.photo && record.photo.startsWith('data:')) {
                            // „É≠„Éº„Ç´„É´„ÅÆBase64ÂÜôÁúü„Çí„ÇØ„É©„Ç¶„Éâ„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                            const photoId = record.id + '_photo_' + Date.now();
                            const cloudURL = await this.uploadPhoto(userId, record.photo, photoId);
                            
                            // Â±•Ê≠¥„Éá„Éº„Çø„ÅÆÂÜôÁúüURL„ÇíÊõ¥Êñ∞
                            record.photo = cloudURL;
                            record.photoId = photoId;
                            
                            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇÇÊõ¥Êñ∞
                            const localHistory = JSON.parse(localStorage.getItem('medicationHistory') || '[]');
                            const localIndex = localHistory.findIndex(h => h.id === record.id);
                            if (localIndex >= 0) {
                                localHistory[localIndex] = record;
                                localStorage.setItem('medicationHistory', JSON.stringify(localHistory));
                            }
                        }
                    }
                    
                    console.log('Â±•Ê≠¥ÂÜôÁúüÂêåÊúüÂÆå‰∫Ü');
                    
                } catch (error) {
                    console.error('Â±•Ê≠¥ÂÜôÁúüÂêåÊúü„Ç®„É©„Éº:', error);
                }
            }

            // ÊâãÂãïÂêåÊúüÊ©üËÉΩ
            async manualSync() {
                this.showSyncStatus('ÂêåÊúü‰∏≠...', 'info');
                await this.syncPendingData();
                const restored = await this.restoreFromCloud();
                
                if (restored) {
                    // „Éö„Éº„Ç∏„É™„É≠„Éº„Éâ„Åó„Å¶ÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèçÊò†
                    location.reload();
                }
            }

            // Á´ØÊú´Èñì„Åß„ÅÆ„Éá„Éº„ÇøÁßªË°å
            async migrateToNewDevice() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) {
                    alert('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                try {
                    const restored = await this.restoreFromCloud();
                    if (restored) {
                        alert('„Éá„Éº„Çø„ÅÆÁßªË°å„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
                        location.reload();
                    } else {
                        alert('ÁßªË°å„Åô„Çã„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    }
                } catch (error) {
                    alert('„Éá„Éº„ÇøÁßªË°å„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            }
        }

        // Firebase Analytics ‰ΩøÁî®Áä∂Ê≥ÅÂàÜÊûê„Ç∑„Çπ„ÉÜ„É†
        class AnalyticsManager {
            constructor() {
                this.sessionStartTime = Date.now();
                this.isInitialized = false;
                this.init();
            }

            async init() {
                // FirebaseÊ∫ñÂÇôÂÆå‰∫Ü„ÇíÂæÖÊ©ü
                await this.waitForFirebase();
                this.setupEventListeners();
                this.isInitialized = true;
                
                // ÂàùÊúüÂåñÂÆå‰∫Ü„Çí„É≠„Ç∞
                this.logEvent('app_initialized', {
                    timestamp: new Date().toISOString(),
                    user_agent: navigator.userAgent,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    viewport_size: `${window.innerWidth}x${window.innerHeight}`
                });

                console.log('Analytics Manager ÂàùÊúüÂåñÂÆå‰∫Ü');
            }

            async waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseReady && window.firebaseAnalytics) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }

            setupEventListeners() {
                // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñìË®òÈå≤
                window.addEventListener('beforeunload', () => {
                    const sessionDuration = Date.now() - this.sessionStartTime;
                    this.logEvent('session_end', {
                        session_duration: Math.round(sessionDuration / 1000)
                    });
                });

                // „Ç®„É©„ÉºËøΩË∑°
                window.addEventListener('error', (event) => {
                    this.logEvent('javascript_error', {
                        error_message: event.message,
                        error_filename: event.filename,
                        error_lineno: event.lineno,
                        error_colno: event.colno
                    });
                });

                // Êú™Âá¶ÁêÜ„ÅÆ Promise „É™„Ç∏„Çß„ÇØ„Ç∑„Éß„É≥ËøΩË∑°
                window.addEventListener('unhandledrejection', (event) => {
                    this.logEvent('unhandled_promise_rejection', {
                        reason: event.reason?.toString() || 'Unknown reason'
                    });
                });
            }

            // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„É≠„Ç∞
            logEvent(eventName, parameters = {}) {
                if (!this.isInitialized || !window.firebaseAnalytics) {
                    console.log('Analytics not ready:', eventName, parameters);
                    return;
                }

                try {
                    // ÂÖ±ÈÄö„Éë„É©„É°„Éº„Çø„ÇíËøΩÂä†
                    const enrichedParams = {
                        ...parameters,
                        timestamp: new Date().toISOString(),
                        page_url: window.location.href,
                        user_logged_in: !!localStorage.getItem('currentUser')
                    };

                    window.firebaseLogEvent(window.firebaseAnalytics, eventName, enrichedParams);
                    console.log('Analytics Event:', eventName, enrichedParams);
                } catch (error) {
                    console.error('Analytics logging error:', error);
                }
            }

            // „É¶„Éº„Ç∂„ÉºÈñ¢ÈÄ£„ÅÆÂàÜÊûêË®≠ÂÆö
            setUser(userId, userProperties = {}) {
                if (!this.isInitialized || !window.firebaseAnalytics) return;

                try {
                    // „É¶„Éº„Ç∂„ÉºID„ÇíË®≠ÂÆö
                    window.firebaseSetUserId(window.firebaseAnalytics, userId);
                    
                    // „É¶„Éº„Ç∂„Éº„Éó„É≠„Éë„ÉÜ„Ç£„ÇíË®≠ÂÆö
                    const defaultProperties = {
                        user_registration_date: new Date().toISOString(),
                        app_version: '2.1',
                        platform: navigator.platform
                    };

                    window.firebaseSetUserProperties(window.firebaseAnalytics, {
                        ...defaultProperties,
                        ...userProperties
                    });

                    this.logEvent('user_login', {
                        user_id: userId,
                        login_method: 'oauth'
                    });

                } catch (error) {
                    console.error('User analytics setup error:', error);
                }
            }

            // Ëñ¨Èñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„ÉàËøΩË∑°
            trackMedicationEvent(action, medicationData = {}) {
                const eventParams = {
                    medication_action: action,
                    medication_count: parseInt(medicationData.totalCount) || 0,
                    medication_category: medicationData.purpose || 'unknown'
                };

                this.logEvent('medication_interaction', eventParams);
            }

            // ÊúçÁî®Ë®òÈå≤„ÅÆËøΩË∑°
            trackMedicationTaken(medicationId, medicationName) {
                this.logEvent('medication_taken', {
                    medication_id: medicationId,
                    medication_name: medicationName,
                    taken_at: new Date().toISOString()
                });
            }

            // „Ç´„É°„É©Ê©üËÉΩ„ÅÆ‰ΩøÁî®ËøΩË∑°
            trackCameraUsage(action) {
                this.logEvent('camera_usage', {
                    camera_action: action,
                    feature: 'medication_verification'
                });
            }

            // „Éö„Éº„Ç∏„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ËøΩË∑°
            trackPageView(pageName) {
                this.logEvent('page_view', {
                    page_name: pageName,
                    previous_page: this.currentPage || 'unknown'
                });
                this.currentPage = pageName;
            }

            // „Éá„Éº„ÇøÂêåÊúü„Ç§„Éô„É≥„ÉàËøΩË∑°
            trackSyncEvent(syncType, success, errorMessage = null) {
                this.logEvent('data_sync', {
                    sync_type: syncType,
                    sync_success: success,
                    sync_error: errorMessage
                });
            }

            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊåáÊ®ô„ÅÆËøΩË∑°
            trackPerformance(metricName, value, unit = 'ms') {
                this.logEvent('performance_metric', {
                    metric_name: metricName,
                    metric_value: value,
                    metric_unit: unit
                });
            }

            // Ê©üËÉΩ‰ΩøÁî®È†ªÂ∫¶„ÅÆËøΩË∑°
            trackFeatureUsage(featureName, action = 'used') {
                this.logEvent('feature_usage', {
                    feature_name: featureName,
                    feature_action: action
                });
            }

            // „Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„ÉàÊåáÊ®ô
            trackEngagement(engagementType, value = 1) {
                this.logEvent('user_engagement', {
                    engagement_type: engagementType,
                    engagement_value: value
                });
            }
        }

        // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ„Ç∑„Çπ„ÉÜ„É†
        class PerformanceManager {
            constructor() {
                this.imageCache = new Map();
                this.dataCache = new Map();
                this.compressionWorker = null;
                this.performanceObserver = null;
                this.init();
            }

            init() {
                this.setupImageOptimization();
                this.setupCaching();
                this.setupPerformanceMonitoring();
                this.setupLazyLoading();
                console.log('Performance Manager ÂàùÊúüÂåñÂÆå‰∫Ü');
            }

            // È´òÂ∫¶„Å™ÁîªÂÉèÂúßÁ∏ÆÊúÄÈÅ©Âåñ
            setupImageOptimization() {
                // WebPÂØæÂøú„ÉÅ„Çß„ÉÉ„ÇØ
                this.supportsWebP = this.checkWebPSupport();
                
                // ÂúßÁ∏ÆË®≠ÂÆö„ÅÆÊúÄÈÅ©Âåñ
                this.compressionSettings = {
                    medication: { maxWidth: 400, quality: 0.8, format: 'jpeg' },
                    history: { maxWidth: 300, quality: 0.7, format: 'jpeg' },
                    thumbnail: { maxWidth: 150, quality: 0.6, format: 'jpeg' }
                };
            }

            checkWebPSupport() {
                const canvas = document.createElement('canvas');
                canvas.width = 1;
                canvas.height = 1;
                return canvas.toDataURL('image/webp').startsWith('data:image/webp');
            }

            // ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÁîªÂÉèÂúßÁ∏Æ
            async optimizedCompressImage(dataUrl, type = 'medication', options = {}) {
                const startTime = performance.now();
                
                try {
                    // „Ç≠„É£„ÉÉ„Ç∑„É•„ÉÅ„Çß„ÉÉ„ÇØ
                    const cacheKey = `${dataUrl.substring(0, 50)}_${type}`;
                    if (this.imageCache.has(cacheKey)) {
                        const endTime = performance.now();
                        this.trackPerformance('image_compression_cached', endTime - startTime);
                        return this.imageCache.get(cacheKey);
                    }

                    const settings = { ...this.compressionSettings[type], ...options };
                    
                    // WebP‰ΩøÁî®ÂèØËÉΩ„Å™Â†¥Âêà„ÅØWebPÂΩ¢Âºè„ÅßÂúßÁ∏Æ
                    if (this.supportsWebP && settings.format === 'jpeg') {
                        settings.format = 'webp';
                        settings.quality += 0.1; // WebP„ÅÆÂ†¥ÂêàÂìÅË≥™„ÇíÂ∞ë„Åó‰∏ä„Åí„Çã
                    }

                    const compressedImage = await this.compressImageAdvanced(dataUrl, settings);
                    
                    // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠òÔºàÊúÄÂ§ß50‰ª∂Ôºâ
                    if (this.imageCache.size >= 50) {
                        const firstKey = this.imageCache.keys().next().value;
                        this.imageCache.delete(firstKey);
                    }
                    this.imageCache.set(cacheKey, compressedImage);

                    const endTime = performance.now();
                    this.trackPerformance('image_compression', endTime - startTime);
                    
                    return compressedImage;
                } catch (error) {
                    console.error('ÁîªÂÉèÂúßÁ∏Æ„Ç®„É©„Éº:', error);
                    this.trackPerformance('image_compression_error', performance.now() - startTime);
                    return dataUrl; // „Ç®„É©„ÉºÊôÇ„ÅØÂÖÉÁîªÂÉè„ÇíËøî„Åô
                }
            }

            async compressImageAdvanced(dataUrl, settings) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Çí‰øùÊåÅ„Åó„Å¶„É™„Çµ„Ç§„Ç∫
                        let { width, height } = this.calculateOptimalSize(
                            img.width, img.height, settings.maxWidth
                        );
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // È´òÂìÅË≥™„É™„Çµ„Ç§„Ç∫Ë®≠ÂÆö
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // ÁîªÂÉèÊèèÁîª
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ÂúßÁ∏ÆÂΩ¢Âºè„Å´Âøú„Åò„Å¶Âá∫Âäõ
                        const mimeType = settings.format === 'webp' ? 'image/webp' : 'image/jpeg';
                        const compressed = canvas.toDataURL(mimeType, settings.quality);
                        
                        resolve(compressed);
                    };
                    img.src = dataUrl;
                });
            }

            calculateOptimalSize(originalWidth, originalHeight, maxWidth) {
                if (originalWidth <= maxWidth) {
                    return { width: originalWidth, height: originalHeight };
                }
                
                const ratio = maxWidth / originalWidth;
                return {
                    width: Math.round(originalWidth * ratio),
                    height: Math.round(originalHeight * ratio)
                };
            }

            // „Éá„Éº„Çø„Ç≠„É£„ÉÉ„Ç∑„É≥„Ç∞Êà¶Áï•
            setupCaching() {
                // LocalStorageÊúÄÈÅ©Âåñ
                this.optimizeLocalStorage();
                
                // Memory cache for frequently accessed data
                setInterval(() => {
                    this.cleanupCache();
                }, 300000); // 5ÂàÜ„Åî„Å®
            }

            optimizeLocalStorage() {
                try {
                    // LocalStorage„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
                    const usage = this.getLocalStorageUsage();
                    console.log('LocalStorage‰ΩøÁî®Èáè:', usage);
                    
                    if (usage.percentage > 80) {
                        this.cleanupOldData();
                    }
                } catch (error) {
                    console.error('LocalStorageÊúÄÈÅ©Âåñ„Ç®„É©„Éº:', error);
                }
            }

            getLocalStorageUsage() {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length;
                    }
                }
                
                const quota = 5 * 1024 * 1024; // 5MBÊ¶ÇÁÆó
                return {
                    used: total,
                    quota: quota,
                    percentage: (total / quota) * 100
                };
            }

            cleanupOldData() {
                const history = JSON.parse(localStorage.getItem('medicationHistory') || '[]');
                const cutoffDate = new Date();
                cutoffDate.setMonth(cutoffDate.getMonth() - 6); // 6„É∂Êúà„Çà„ÇäÂè§„ÅÑ„Éá„Éº„Çø
                
                const filteredHistory = history.filter(item => 
                    new Date(item.takenAt) > cutoffDate
                );
                
                if (filteredHistory.length < history.length) {
                    localStorage.setItem('medicationHistory', JSON.stringify(filteredHistory));
                    console.log(`Âè§„ÅÑÂ±•Ê≠¥„Éá„Éº„Çø„Çí ${history.length - filteredHistory.length} ‰ª∂ÂâäÈô§`);
                }
            }

            cleanupCache() {
                // „É°„É¢„É™„Ç≠„É£„ÉÉ„Ç∑„É•„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                if (this.imageCache.size > 30) {
                    const entries = Array.from(this.imageCache.entries());
                    const toKeep = entries.slice(-20); // ÊúÄÊñ∞20‰ª∂„Çí‰øùÊåÅ
                    this.imageCache.clear();
                    toKeep.forEach(([key, value]) => {
                        this.imageCache.set(key, value);
                    });
                }
            }

            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÁõ£Ë¶ñ
            setupPerformanceMonitoring() {
                // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇÈñìÊ∏¨ÂÆö
                window.addEventListener('load', () => {
                    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                    this.trackPerformance('page_load_time', loadTime);
                });

                // „É°„É¢„É™‰ΩøÁî®ÈáèÁõ£Ë¶ñÔºàÂà©Áî®ÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
                if ('memory' in performance) {
                    setInterval(() => {
                        const memoryInfo = performance.memory;
                        this.trackPerformance('memory_usage', {
                            used: memoryInfo.usedJSHeapSize,
                            total: memoryInfo.totalJSHeapSize,
                            limit: memoryInfo.jsHeapSizeLimit
                        });
                    }, 60000); // 1ÂàÜ„Åî„Å®
                }
            }

            // ÈÅÖÂª∂Ë™≠„ÅøËæº„Åø
            setupLazyLoading() {
                // Intersection Observer for lazy loading
                if ('IntersectionObserver' in window) {
                    this.setupImageLazyLoading();
                }
            }

            setupImageLazyLoading() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.removeAttribute('data-src');
                                observer.unobserve(img);
                            }
                        }
                    });
                }, { threshold: 0.1 });

                // Êó¢Â≠ò„ÅÆÁîªÂÉè„Å´ÈÅ©Áî®
                document.querySelectorAll('img[data-src]').forEach(img => {
                    observer.observe(img);
                });
                
                this.imageObserver = observer;
            }

            // „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊåáÊ®ôË®òÈå≤
            trackPerformance(metricName, value) {
                if (window.analyticsManager) {
                    window.analyticsManager.trackPerformance(metricName, value);
                }
                console.log(`Performance: ${metricName}`, value);
            }

            // „Éá„Éê„Ç¶„É≥„ÇπÈñ¢Êï∞
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // „Çπ„É≠„ÉÉ„Éà„É´Èñ¢Êï∞
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }
        }

        // „Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ
        let cloudSyncManager;
        let analyticsManager;
        let performanceManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            cloudSyncManager = new CloudSyncManager();
            analyticsManager = new AnalyticsManager();
            performanceManager = new PerformanceManager();
            
            // „Ç∞„É≠„Éº„Éê„É´„Ç¢„ÇØ„Çª„ÇπÁî®
            window.analyticsManager = analyticsManager;
            window.performanceManager = performanceManager;
        });

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
        function manualSync() {
            if (cloudSyncManager) {
                cloudSyncManager.manualSync();
            }
        }

        function migrateData() {
            if (cloudSyncManager) {
                cloudSyncManager.migrateToNewDevice();
            }
        }

        // ÂêåÊúüÁä∂ÊÖã„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateSyncStatus() {
            const lastSyncElement = document.getElementById('last-sync-time');
            const onlineStatusElement = document.getElementById('online-status');
            
            if (lastSyncElement) {
                const lastSync = localStorage.getItem('lastSyncTime');
                if (lastSync && lastSync !== '0') {
                    const date = new Date(parseInt(lastSync));
                    lastSyncElement.textContent = date.toLocaleString('ja-JP');
                } else {
                    lastSyncElement.textContent = 'Êú™ÂêåÊúü';
                }
            }
            
            if (onlineStatusElement) {
                onlineStatusElement.textContent = navigator.onLine ? '„Ç™„É≥„É©„Ç§„É≥' : '„Ç™„Éï„É©„Ç§„É≥';
                onlineStatusElement.style.color = navigator.onLine ? '#4CAF50' : '#f44336';
            }
        }

        // „Éö„Éº„Ç∏Ë°®Á§∫ÊôÇ„Å´ÂêåÊúüÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function showPage(pageId) {
            // Êó¢Â≠ò„ÅÆshowPageÊ©üËÉΩ
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            const targetTab = document.querySelector(`[onclick="showPage('${pageId}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Ë®≠ÂÆö„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÄÅÂêåÊúüÁä∂ÊÖã„Å®OAuthÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            if (pageId === 'settings') {
                setTimeout(() => {
                    updateSyncStatus();
                    updateOAuthStatus();
                }, 100);
            }
            
            // „Éö„Éº„Ç∏Âõ∫Êúâ„ÅÆÂá¶ÁêÜ
            if (pageId === 'medications') {
                loadMedications();
            } else if (pageId === 'history') {
                loadHistory();
            } else if (pageId === 'home') {
                updateMedicationButtons();
            } else if (pageId === 'settings') {
                loadMealTimeSettings();
                updateCurrentUserEmail();
            }
        }

        // OAuthË™çË®ºÁä∂Ê≥Å„ÅÆÊõ¥Êñ∞
        function updateOAuthStatus() {
            const googleStatus = document.getElementById('google-oauth-status');
            const appleStatus = document.getElementById('apple-oauth-status');
            
            if (googleStatus) {
                const isFirebaseReady = window.firebaseReady && window.firebaseAuth;
                googleStatus.innerHTML = isFirebaseReady 
                    ? 'üîç Firebase Google OAuth: <span style="color: #28a745;">Âà©Áî®ÂèØËÉΩ</span>'
                    : 'üîç Firebase Google OAuth: <span style="color: #6c757d;">Ë™≠„ÅøËæº„Åø‰∏≠...</span>';
            }
            
            if (appleStatus) {
                const isAppleReady = window.AppleID && window.AppleID.auth;
                appleStatus.innerHTML = isAppleReady 
                    ? 'üçé Apple Sign In: <span style="color: #28a745;">Âà©Áî®ÂèØËÉΩ</span>'
                    : 'üçé Apple Sign In: <span style="color: #ffc107;">Ë™≠„ÅøËæº„Åø‰∏≠...</span>';
            }
        }

        // „É¶„Éº„Ç∂„Éº„É°„Éº„É´Ë°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateCurrentUserEmail() {
            const currentUserElement = document.getElementById('current-user-email');
            if (currentUserElement) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    currentUserElement.textContent = currentUser.email || '„É¶„Éº„Ç∂„Éº';
                } else {
                    currentUserElement.textContent = '„Ç≤„Çπ„Éà';
                }
            }
        }

        // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        window.addEventListener('online', updateSyncStatus);
        window.addEventListener('offline', updateSyncStatus);
    </script>
</body>
</html>